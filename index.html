<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      :root {
        --primary-gold: #d4af37;
        --dark-green: #0d4d3f;
        --medium-green: #1a6b54;
        --light-green: #e8f5e9;
        --cream: #fefdf8;
        --white: #ffffff;
        --text-dark: #2c2c2c;
        --border-light: #e0dfd5;
        --accent-gold: #f0c850;
      }
      body { font-family: "Cairo", sans-serif; background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%); min-height: 100vh; padding: 8px; overflow-x: hidden; }
      .container { max-width: 900px; margin: 0 auto; }
      .header { text-align: center; margin-bottom: 8px; }
      .logo { width: 50px; height: 50px; margin: 0 auto 8px; background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.5); }
      .logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
      h1 { font-family: "Amiri", serif; color: var(--white); font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
      .subtitle { color: var(--primary-gold); font-size: 0.9rem; font-weight: 600; }
      .card { background: var(--white); border-radius: 12px; padding: 15px 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.15); margin-bottom: 8px; }
      .form-group { margin-bottom: 12px; position: relative; }
      .password-toggle { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; color: #666; user-select: none; }
      .password-input-wrapper { position: relative; }
      label { display: block; color: var(--dark-green); font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; }
      input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 0.95rem; font-family: "Cairo", sans-serif; transition: all 0.3s ease; background: var(--cream); }
      input:focus { outline: none; border-color: var(--primary-gold); background: var(--white); }
      .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; font-family: "Cairo", sans-serif; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px; }
      .btn-primary { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); color: var(--dark-green); box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
      .btn-primary:hover { transform: translateY(-2px); }
      .btn-secondary { background: var(--dark-green); color: var(--white); }
      .btn-secondary:hover { background: var(--medium-green); transform: translateY(-2px); }
      .btn-danger { background: #dc2626; color: white; }
      .btn-danger:hover { background: #b91c1c; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
      .big-icon-btn { font-size: 1.3rem; padding: 15px; margin: 6px 0; }
      .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 12px; }
      .stat-card { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); padding: 10px; border-radius: 10px; text-align: center; }
      .stat-card .icon { font-size: 1.4rem; margin-bottom: 3px; }
      .stat-card .number { font-size: 1.5rem; font-weight: 900; color: var(--dark-green); margin-bottom: 2px; }
      .stat-card .label { font-size: 0.75rem; color: var(--dark-green); font-weight: 600; }
      .record-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
      .type-card { background: white; border: 2px solid var(--border-light); border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
      .type-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); }
      .type-card.selected { border-color: var(--primary-gold); background: linear-gradient(to bottom, #fff9e6, white); }
      .type-card .icon { font-size: 2.5rem; margin-bottom: 6px; }
      .type-card h3 { font-size: 1rem; color: var(--dark-green); }
      .recording-controls { margin-top: 12px; }
      .timer { text-align: center; font-size: 1.8rem; font-weight: 700; color: var(--dark-green); margin: 12px 0; font-family: "Courier New", monospace; }
      .live-preview { margin: 12px 0; padding: 10px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .live-preview.recording { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #dc2626; }
      .live-preview video { width: 100%; border-radius: 8px; background: #000; }
      .recording-preview { margin: 12px 0; padding: 12px; background: linear-gradient(to bottom, #fff9e6, white); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .recording-preview video, .recording-preview audio { width: 100%; border-radius: 8px; margin-top: 10px; }
      .recording-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .recording-item video, .recording-item audio { width: 100%; margin-top: 8px; border-radius: 8px; }
      .recording-date { color: #666; font-size: 0.8rem; margin-bottom: 8px; }
      .three-dots { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; cursor: pointer; color: #666; padding: 5px; }
      .menu-popup { position: absolute; top: 40px; left: 10px; background: white; border: 2px solid var(--primary-gold); border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 100; min-width: 160px; }
      .menu-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
      .menu-item:last-child { border-bottom: none; }
      .menu-item:hover { background: var(--cream); }
      .menu-item.danger { color: #dc2626; }
      .logout-btn { position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; z-index: 1000; }
      .back-btn { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; z-index: 1000; }
      .hidden { display: none !important; }
      .error-message { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
      .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
      .participant-card { background: white; padding: 12px 8px; border-radius: 10px; border: 2px solid var(--border-light); cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; }
      .participant-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); }
      .participant-card .icon { font-size: 2.2rem; margin-bottom: 6px; }
      .participant-card h3 { color: var(--dark-green); font-size: 0.95rem; margin-bottom: 5px; word-break: break-word; }
      .participant-card .count { color: #666; font-size: 0.8rem; }
      .new-recordings-badge { position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 2px solid white; }
      .empty-state { text-align: center; padding: 25px 15px; color: #999; }
      .empty-state .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 3000; pointer-events: none; }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--primary-gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loading-spinner { text-align: center; color: white; background: rgba(0,0,0,0.7); padding: 20px 30px; border-radius: 12px; }
      .loading-spinner p { font-size: 0.95rem; font-weight: 600; }
      .upload-progress { background: #e5e7eb; border-radius: 8px; height: 8px; margin: 10px 0; overflow: hidden; }
      .upload-progress-bar { background: linear-gradient(90deg, var(--primary-gold), var(--accent-gold)); height: 100%; border-radius: 8px; transition: width 0.3s ease; }
      .upload-status { text-align: center; color: var(--dark-green); font-size: 0.9rem; font-weight: 600; margin: 6px 0; }
      .player-wrap { margin-top: 8px; }
      .player-wrap audio, .player-wrap video { width: 100%; border-radius: 6px; }
      .player-loading { display: flex; align-items: center; gap: 8px; padding: 10px; color: #888; font-size: 0.85rem; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0; }
      .mini-spinner { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--primary-gold); border-radius: 50%; width: 18px; height: 18px; animation: spin 0.8s linear infinite; flex-shrink: 0; }
      .player-error { color: #dc2626; font-size: 0.82rem; padding: 8px; text-align: center; background: #fee2e2; border-radius: 8px; }
      .message-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
      .message-modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; }
      .message-modal h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .message-type-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
      .message-type-btn { padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; font-family: "Cairo", sans-serif; }
      .message-type-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); color: var(--dark-green); }
      .message-modal textarea { width: 100%; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-family: "Cairo", sans-serif; font-size: 0.95rem; min-height: 100px; resize: vertical; }
      .voice-recorder { background: linear-gradient(to bottom, #f0f9ff, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); }
      .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
      .unread-badge { position: absolute; top: -6px; left: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }
      .message-item { background: linear-gradient(135deg, #fff9e6, white); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-right: 3px solid var(--primary-gold); }
      .message-item.unread { background: linear-gradient(135deg, #fff4d6, #fff9e6); box-shadow: 0 3px 15px rgba(212,175,55,0.2); }
      .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border-light); }
      .message-content { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
      .message-recording { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border-light); }
      .linked-recording { background: linear-gradient(135deg, #e8f5e9, #f0fff4); padding: 12px; border-radius: 8px; margin-top: 10px; border: 2px solid #4caf50; }
      .linked-recording p { color: var(--dark-green); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
      .rating-container { background: linear-gradient(to bottom, #fff9e6, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); text-align: center; }
      .stars-display { display: flex; justify-content: center; gap: 8px; margin: 15px 0; font-size: 2.5rem; }
      .star { cursor: pointer; transition: all 0.2s ease; color: #d1d5db; }
      .star.filled { color: #fbbf24; }
      .rating-value { font-size: 1.5rem; font-weight: 700; color: var(--dark-green); margin-top: 10px; }
      .rating-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 12px; }
      .rating-btn { padding: 8px; border: 2px solid var(--border-light); border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: "Cairo", sans-serif; }
      .rating-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); }
      .message-rating { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px; border-radius: 8px; margin-top: 8px; text-align: center; border: 2px solid #fbbf24; }
      .message-stars { font-size: 2rem; margin: 8px 0; }
      .contact-info-section { background: linear-gradient(135deg, #dbeafe, #e0f2fe); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--primary-gold); }
      .contact-info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .contact-info-title { color: var(--dark-green); font-weight: 700; font-size: 1rem; }
      .toggle-contact-btn { background: var(--primary-gold); color: var(--dark-green); padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: "Cairo", sans-serif; }
      .contact-info-content { margin-top: 10px; }
      .info-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-light); }
      .info-label { color: #666; font-size: 0.85rem; margin-bottom: 4px; }
      .info-value { color: var(--dark-green); font-size: 1rem; font-weight: 700; word-break: break-all; }
      .copy-btn { background: var(--dark-green); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; font-family: "Cairo", sans-serif; }
      .copy-btn.copied { background: #10b981; }
      .total-rating-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; border: 2px solid #fbbf24; }
      .total-rating-badge .text { color: var(--dark-green); font-weight: 700; font-size: 0.9rem; }
      .total-rating-badge .value { color: var(--dark-green); font-weight: 900; font-size: 1.1rem; }
      .broadcast-banner { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 14px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #fbbf24; position: relative; }
      .broadcast-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
      .admin-msg-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .admin-msg-item .msg-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; font-family: "Cairo", sans-serif; }
      .leaderboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display: flex; align-items: flex-start; justify-content: center; z-index: 2000; padding: 15px; overflow-y: auto; }
      .leaderboard-content { background: var(--white); border-radius: 16px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; }
      .leaderboard-header { background: linear-gradient(135deg, var(--dark-green), var(--medium-green)); padding: 20px 15px; text-align: center; position: relative; }
      .leaderboard-header h2 { color: var(--white); font-family: "Amiri", serif; font-size: 1.5rem; margin-bottom: 4px; }
      .leaderboard-header p { color: var(--primary-gold); font-size: 0.85rem; }
      .leaderboard-close { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; font-family: "Cairo", sans-serif; }
      .leaderboard-body { padding: 15px; }
      .leaderboard-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 2px solid transparent; }
      .leaderboard-row.rank-1 { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-color: #f59e0b; }
      .leaderboard-row.rank-2 { background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-color: #94a3b8; }
      .leaderboard-row.rank-3 { background: linear-gradient(135deg, #fff7ed, #ffedd5); border-color: #f97316; }
      .leaderboard-row.rank-other { background: var(--cream); border-color: var(--border-light); }
      .rank-badge { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 900; flex-shrink: 0; }
      .rank-1 .rank-badge { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
      .rank-2 .rank-badge { background: linear-gradient(135deg, #94a3b8, #cbd5e1); color: white; }
      .rank-3 .rank-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; }
      .rank-other .rank-badge { background: var(--light-green); color: var(--dark-green); font-size: 1rem; }
      .rank-info { flex: 1; }
      .rank-name { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 3px; }
      .rank-details { color: #777; font-size: 0.8rem; }
      .rank-score .score-num { font-size: 1.4rem; font-weight: 900; color: var(--dark-green); line-height: 1; }
      .rank-score .score-label { font-size: 0.7rem; color: #888; }
      .rank-stars { color: #fbbf24; font-size: 0.85rem; margin-top: 2px; }
      .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; }
      .confirm-content { background: white; padding: 20px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center; }
      .confirm-content h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .confirm-content p { font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; }
      .confirm-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      /* âœ… Ø´Ø±ÙŠØ· ØªØ´Ø®ÙŠØµ Ø§Ù„Ø§ØªØµØ§Ù„ */
      #debugBar { position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 8px 10px; border-radius: 10px; border: 2px solid #d4af37; font-family: Cairo, sans-serif; z-index: 9999; font-size: 12px; color: #0d4d3f; box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
      @media (max-width: 768px) {
        h1 { font-size: 1.3rem; } .card { padding: 12px 10px; } .btn { font-size: 0.95rem; padding: 10px; }
        .record-type-grid { grid-template-columns: 1fr; } .message-type-btns { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <!-- âœ… Ø´Ø±ÙŠØ· ØªØ´Ø®ÙŠØµ Ø§Ù„Ø§ØªØµØ§Ù„ -->
    <div id="debugBar">ğŸŸ¡ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</div>

    <div class="container">
      <div class="header">
        <div class="logo">
          <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="Ø´Ø¹Ø§Ø±" onerror="this.style.display='none'" />
        </div>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
        <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</p>
      </div>
      <div id="globalBroadcastsBar"></div>

      <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="homePage" class="card">
        <button class="btn btn-primary big-icon-btn" onclick="showRegisterPage()">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-secondary big-icon-btn" onclick="showLoginPage()">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" onclick="showAdminLogin()" style="margin-top:20px;">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</button>
      </div>

      <div id="registerPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="registerForm">
          <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="participantName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" /></div>
          <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('password', event)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="registerSubmitBtn">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <div id="loginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
        <div id="loginError" class="error-message hidden"></div>
        <form id="loginForm">
          <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ" /></div>
          <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('loginPassword', event)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary" id="loginSubmitBtn">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <div id="adminLoginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h2>
        <div id="adminError" class="error-message hidden"></div>
        <form id="adminLoginForm">
          <div class="form-group"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="adminPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('adminPassword', event)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <div id="participantPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:8px;text-align:center;">Ø£Ù‡Ù„Ø§Ù‹ <span id="participantDisplayName"></span> ğŸŒ™</h2>
        <div style="display:flex;gap:8px;margin:12px 0;">
          <button class="btn btn-secondary" onclick="showRecordingSection()" style="flex:1;">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</button>
          <button class="btn btn-secondary" onclick="showMessagesSection()" style="flex:1;position:relative;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„<span id="unreadBadge" class="unread-badge hidden"></span>
          </button>
        </div>
        <div id="recordingSection">
          <h3 style="color:var(--dark-green);margin-bottom:10px;text-align:center;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
          <div class="record-type-grid">
            <div class="type-card selected" onclick="selectType('audio', this)"><div class="icon">ğŸ¤</div><h3>ØµÙˆØª</h3></div>
            <div class="type-card" onclick="selectType('video', this)"><div class="icon">ğŸ¥</div><h3>ÙÙŠØ¯ÙŠÙˆ</h3></div>
          </div>
          <div id="livePreview" class="live-preview hidden"><video id="liveVideo" autoplay muted playsinline></video></div>
          <div class="recording-controls">
            <button class="btn btn-primary big-icon-btn" id="recordBtn" onclick="startRecording()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div class="timer hidden" id="timer">00:00</div>
            <button class="btn btn-danger big-icon-btn hidden" id="stopBtn" onclick="stopRecording()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>
          <div id="recordingPreview" class="recording-preview hidden">
            <h3 style="color:var(--dark-green);margin-bottom:10px;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
            <div id="previewMedia"></div>
            <button class="btn btn-primary" id="saveRecordingBtn" onclick="saveRecording()" style="margin-top:12px;">ğŸ’¾ Ø­ÙØ¸ ÙˆØ±ÙØ¹</button>
            <button class="btn btn-secondary" onclick="cancelRecording()">ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙˆØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
          </div>
          <div style="margin-top:20px;">
            <h3 style="color:var(--dark-green);margin-bottom:10px;">ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ</h3>
            <div id="myRecordingsList"></div>
          </div>
        </div>
        <div id="messagesSection" class="hidden">
          <h3 style="color:var(--dark-green);margin-bottom:12px;">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h3>
          <div id="messagesList"></div>
        </div>
      </div>

      <div id="adminParticipantsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:12px;text-align:center;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>
        <div class="stats-container">
          <div class="stat-card"><div class="icon">ğŸ‘¥</div><div class="number" id="totalParticipants">0</div><div class="label">Ù…Ø´Ø§Ø±Ùƒ</div></div>
          <div class="stat-card"><div class="icon">ğŸ™ï¸</div><div class="number" id="totalRecordings">0</div><div class="label">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠ</div></div>
          <div class="stat-card"><div class="icon">ğŸ†•</div><div class="number" id="newRecordings">0</div><div class="label">Ø¬Ø¯ÙŠØ¯</div></div>
        </div>
        <button class="btn btn-primary" onclick="showBroadcastModal()" style="margin-bottom:8px;">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</button>
        <button class="btn btn-secondary" onclick="showLeaderboard()" style="margin-bottom:10px;">ğŸ† Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <div id="adminBroadcastsList" style="margin-bottom:12px;"></div>
        <div id="participantsList" class="participants-grid"></div>
      </div>

      <div id="adminRecordingsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <button class="back-btn" onclick="backToParticipants()">â† Ø±Ø¬ÙˆØ¹</button>
        <h2 id="participantTitle" style="color:var(--dark-green);margin-bottom:12px;text-align:center;"></h2>
        <div style="text-align:center;margin-bottom:12px;">
          <div class="total-rating-badge" id="totalRatingBadge" style="display:none;">
            <span>â­</span><span class="text">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span class="value" id="totalRatingValue">0</span><span class="text">/</span><span class="value" id="totalRatingMax">0</span>
          </div>
        </div>
        <div style="text-align:center;margin-bottom:12px;">
          <button class="btn btn-danger" onclick="confirmDeleteAccount()" style="width:auto;padding:10px 20px;font-size:0.9rem;">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
        </div>
        <div class="contact-info-section">
          <div class="contact-info-header">
            <span class="contact-info-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
            <button class="toggle-contact-btn" onclick="toggleContactInfo()"><span id="contactToggleText">Ø¹Ø±Ø¶</span></button>
          </div>
          <div id="contactInfoContent" class="contact-info-content hidden">
            <div class="info-row"><div><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value" id="contactName">-</div></div><button class="copy-btn" onclick="copyToClipboard('name',this)">ğŸ“‹ Ù†Ø³Ø®</button></div>
            <div class="info-row"><div><div class="info-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div class="info-value" id="contactPassword">-</div></div><button class="copy-btn" onclick="copyToClipboard('password',this)">ğŸ“‹ Ù†Ø³Ø®</button></div>
          </div>
        </div>
        <div id="adminSentMessages" style="margin-bottom:12px;"></div>
        <div id="adminRecordingsList"></div>
      </div>
    </div>

    <!-- âœ… [Ø¥ØµÙ„Ø§Ø­ 0] ØªØ­Ù…ÙŠÙ„ Supabase Ù…Ø¹ fallback CDN Ø«Ø§Ù†ÙŠ -->
    <script>
      (function(){
        function load(url){
          return new Promise((res, rej)=>{
            const s=document.createElement('script');
            s.src=url;
            s.onload=()=>res();
            s.onerror=()=>rej();
            document.head.appendChild(s);
          });
        }
        window.__loadSupabase = async function(){
          if(window.supabase) return true;
          try { await load('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'); }
          catch(e1){
            try { await load('https://unpkg.com/@supabase/supabase-js@2'); }
            catch(e2){ return false; }
          }
          return !!window.supabase;
        };
      })();
    </script>
    <script>
      // =============================================
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 0] ØªØ£ÙƒØ¯ Supabase Ø¬Ø§Ù‡Ø²Ø© (Ù…Ø¹ fallback)
      // =============================================
      (async ()=>{
        const ok = await window.__loadSupabase?.();
        if(!ok){
          document.body.innerHTML = `
            <div style="direction:rtl;font-family:Cairo,sans-serif;max-width:720px;margin:20px auto;background:#fff;padding:16px;border-radius:12px">
              <h2 style="color:#b91c1c;margin-bottom:8px">âš ï¸ ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Supabase</h2>
              <p style="line-height:1.9">Ø¹Ù†Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ø´Ø¨ÙƒØ§Øª ÙŠÙ†Ø­Ø¬Ø¨ CDN. Ø¬Ø±Ù‘Ø¨ Ø´Ø¨ÙƒØ© Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø§ÙØªØ­ Ù…Ù† Ù…ØªØµÙØ­ Chrome Ù…Ø¨Ø§Ø´Ø±.</p>
              <button onclick="location.reload()" style="margin-top:14px;padding:10px 20px;background:#d4af37;border:none;border-radius:8px;font-family:Cairo,sans-serif;font-weight:700;cursor:pointer;font-size:1rem;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</button>
            </div>`;
          return;
        }
      })();

      // =============================================
      // âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      // =============================================
      const SUPABASE_URL  = 'https://jimrkqewuafaoxmpmhbp.supabase.co';
      const SUPABASE_KEY  = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppbXJrcWV3dWFmYW94bXBtaGJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODM1NzUsImV4cCI6MjA4NzI1OTU3NX0.Qihj4BnB0FErseE0j8Gq8ydbOf8Bu7lW2sRTfTudZ7Q';
      const BUCKET = 'recordings';

      const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // âœ… [Ø¥ØµÙ„Ø§Ø­ 1] ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ db Ù…Ø¨Ø§Ø´Ø±Ø©
      (async () => {
        const bar = document.getElementById('debugBar');
        try {
          const { error } = await db.from('participants').select('id', { head: true, count: 'exact' }).limit(1);
          if (error) throw error;
          if (bar) bar.textContent = 'ğŸŸ¢ Ø§Ù„Ø§ØªØµØ§Ù„ Ø´ØºØ§Ù„';
          setTimeout(() => { if (bar) bar.style.display = 'none'; }, 4000);
        } catch (e) {
          console.error('Supabase connection error:', e);
          if (bar) bar.textContent = 'ğŸ”´ Ù…Ø´ÙƒÙ„Ø© Ø§ØªØµØ§Ù„ â€” Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©';
        }
      })();

      // =============================================
      // Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø©
      // =============================================
      let currentUser = null, isAdmin = false;
      let mediaRecorder = null, recordedChunks = [], recordingType = 'audio';
      let timerInterval = null, recordingStartTime = null, previewStream = null;
      let currentParticipant = null;
      let adminVoiceRecorder = null, adminVoiceChunks = [], adminVoiceTimer = null, adminVoiceBlob = null;
      let currentRecordingForMessage = null, viewedRecordings = new Set(), selectedRating = 0;
      let broadcastVoiceRecorder = null, broadcastVoiceChunks = [], broadcastVoiceTimerInterval = null, broadcastVoiceBlob = null;
      let _loadingEl = null;
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 2] Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³ØªØ±ÙŠÙ… ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø¶ØºØ·Ø§Øª Ø§Ù„Ù…ØªØ¹Ø¯Ø¯Ø©
      let recordStream = null;
      let extraAudioStream = null;
      let isSaving = false;
      let isStarting = false;

      // =============================================
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 3] Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù â€” Ù…Ø¹ ØªØ´Ø®ÙŠØµ ÙˆØ§Ø¶Ø­
      // =============================================
      async function uploadToStorage(blob, folder) {
        const ext  = getExtension(blob.type);
        const name = `${folder}/${Date.now()}_${Math.random().toString(36).slice(2)}.${ext}`;

        const t0 = Date.now();
        const { error } = await db.storage.from(BUCKET).upload(name, blob, {
          cacheControl: '3600',
          upsert: false,
          contentType: blob.type || 'audio/webm',
        });

        if (error) {
          throw new Error('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + (error.message || JSON.stringify(error)));
        }

        const ms = Date.now() - t0;
        console.log('Upload ms:', ms, 'size:', blob.size);

        const { data: urlData } = db.storage.from(BUCKET).getPublicUrl(name);
        if (!urlData?.publicUrl) throw new Error('ØªÙ… Ø§Ù„Ø±ÙØ¹ Ù„ÙƒÙ† ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¹Ø§Ù…');

        return urlData.publicUrl;
      }

      function getExtension(mimeType) {
        if (!mimeType) return 'webm';
        if (mimeType.includes('mp4'))  return 'mp4';
        if (mimeType.includes('ogg'))  return 'ogg';
        if (mimeType.includes('webm')) return 'webm';
        if (mimeType.includes('wav'))  return 'wav';
        return 'webm';
      }

      // =============================================
      // Ù…Ø³Ø§Ø¹Ø¯Ø§Øª
      // =============================================
      function getSupportedMimeType() {
        const types = ['audio/mp4','audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg',''];
        for (const t of types) { try { if (!t || MediaRecorder.isTypeSupported(t)) return t; } catch(e) {} }
        return '';
      }
      function getSupportedVideoMimeType() {
        const types = ['video/mp4','video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm',''];
        for (const t of types) { try { if (!t || MediaRecorder.isTypeSupported(t)) return t; } catch(e) {} }
        return '';
      }
      function escapeHtml(t) {
        if (!t) return '';
        return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }
      function fixDuration(el) {
        if (!el || isFinite(el.duration)) return;
        try { el.currentTime = 1e101; el.addEventListener('timeupdate', function h(){ el.removeEventListener('timeupdate',h); el.currentTime=0; },{once:true}); } catch(e){}
      }

      // =============================================
      // Loading
      // =============================================
      function showLoading(msg) {
        if (_loadingEl) return;
        _loadingEl = document.createElement('div');
        _loadingEl.className = 'loading-overlay';
        _loadingEl.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>${msg||'Ø¬Ø§Ø±ÙŠ...'}</p></div>`;
        document.body.appendChild(_loadingEl);
      }
      function hideLoading() { if (_loadingEl){ _loadingEl.remove(); _loadingEl=null; } }

      // =============================================
      // Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      // =============================================
      function saveSession(userData) {
        try {
          localStorage.setItem('currentSession', JSON.stringify(
            isAdmin ? {isAdmin:true} : {isAdmin:false, user: userData||currentUser}
          ));
        } catch(e){}
      }
      async function loadCurrentSession() {
        try {
          const s = localStorage.getItem('currentSession');
          if (!s) { showHomePage(); return; }
          const session = JSON.parse(s);
          if (session.isAdmin) { isAdmin=true; showAdminParticipantsPage(); }
          else if (session.user) { currentUser=session.user; showParticipantPage(); refreshUserInBackground(session.user.id); }
          else { localStorage.removeItem('currentSession'); showHomePage(); }
        } catch(e) { localStorage.removeItem('currentSession'); showHomePage(); }
      }
      async function refreshUserInBackground(id) {
        try {
          const {data:u} = await db.from('participants').select('id,name,password').eq('id',id).single();
          if (u) { currentUser=u; saveSession(u); }
        } catch(e){}
      }
      function loadViewedRecordings() {
        try { const s=localStorage.getItem('viewedRecordings'); if(s) viewedRecordings=new Set(JSON.parse(s)); } catch(e){}
      }
      function saveViewedRecordings() { try { localStorage.setItem('viewedRecordings',JSON.stringify([...viewedRecordings])); }catch(e){} }
      function markRecordingAsViewed(pId,rId){ viewedRecordings.add(`${pId}_${rId}`); saveViewedRecordings(); }
      function isRecordingViewed(pId,rId){ return viewedRecordings.has(`${pId}_${rId}`); }

      // =============================================
      // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
      // =============================================
      function hideAllPages() {
        ['homePage','registerPage','loginPage','adminLoginPage','participantPage','adminParticipantsPage','adminRecordingsPage']
          .forEach(id=>{ const el=document.getElementById(id); if(el) el.classList.add('hidden'); });
      }
      function showHomePage()       { hideAllPages(); document.getElementById('homePage').classList.remove('hidden'); }
      function showRegisterPage()   { hideAllPages(); document.getElementById('registerPage').classList.remove('hidden'); }
      function showLoginPage()      { hideAllPages(); document.getElementById('loginPage').classList.remove('hidden'); }
      function showAdminLogin()     { hideAllPages(); document.getElementById('adminLoginPage').classList.remove('hidden'); }

      function showParticipantPage() {
        hideAllPages();
        document.getElementById('participantPage').classList.remove('hidden');
        document.getElementById('participantDisplayName').textContent = currentUser.name;
        showRecordingSection();
        loadMyRecordings();
        updateUnreadBadge();
      }
      async function showAdminParticipantsPage() {
        hideAllPages();
        document.getElementById('adminParticipantsPage').classList.remove('hidden');
        await Promise.all([loadParticipants(), loadAdminBroadcasts()]);
      }
      async function showAdminRecordingsPage(participant) {
        hideAllPages();
        currentParticipant = participant;
        document.getElementById('adminRecordingsPage').classList.remove('hidden');
        document.getElementById('participantTitle').textContent = 'ØªØ³Ø¬ÙŠÙ„Ø§Øª: '+participant.name;
        document.getElementById('contactName').textContent     = participant.name;
        document.getElementById('contactPassword').textContent = participant.password;
        const cc = document.getElementById('contactInfoContent');
        if (cc && !cc.classList.contains('hidden')) { cc.classList.add('hidden'); document.getElementById('contactToggleText').textContent='Ø¹Ø±Ø¶'; }
        document.getElementById('totalRatingBadge').style.display = 'none';
        await Promise.all([loadParticipantRecordingsAndRating(), loadAdminSentMessages()]);
      }
      function backToParticipants() { currentParticipant=null; showAdminParticipantsPage(); }

      function showRecordingSection() {
        document.getElementById('recordingSection').classList.remove('hidden');
        document.getElementById('messagesSection').classList.add('hidden');
        if (recordingType==='video' && !previewStream) startVideoPreview();
      }
      async function showMessagesSection() {
        document.getElementById('recordingSection').classList.add('hidden');
        document.getElementById('messagesSection').classList.remove('hidden');
        stopVideoPreview();
        await loadMessages();
        await markMessagesAsRead();
      }
      function logout() {
        stopVideoPreview();
        if (mediaRecorder && mediaRecorder.state!=='inactive') { try{mediaRecorder.stop();}catch(e){} }
        clearInterval(timerInterval);
        localStorage.removeItem('currentSession');
        currentUser=null; isAdmin=false; currentParticipant=null; recordedChunks=[];
        showHomePage();
      }
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 1] togglePassword ØªØ³ØªÙ‚Ø¨Ù„ event Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­
      function togglePassword(id, ev) {
        const el = document.getElementById(id);
        const icon = ev?.target;
        if(!el || !icon) return;
        if (el.type === 'password') { el.type = 'text'; icon.textContent = 'ğŸ™ˆ'; }
        else { el.type = 'password'; icon.textContent = 'ğŸ‘ï¸'; }
      }

      // =============================================
      // Ø¹Ø±Ø¶ Ù…Ø´ØºÙ‘Ù„
      // =============================================
      function playerHtml(url, type) {
        if (!url) return '<div class="player-error">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„</div>';
        if (type==='video') return `<video controls src="${url}" style="width:100%;border-radius:6px;background:#000;max-height:280px;" onloadedmetadata="fixDuration(this)" preload="metadata"></video>`;
        return `<audio controls src="${url}" style="width:100%;" onloadedmetadata="fixDuration(this)" preload="metadata"></audio>`;
      }

      // =============================================
      // Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      // =============================================
      async function loadGlobalBroadcasts() {
        const bar = document.getElementById('globalBroadcastsBar');
        if (!bar) return;
        try {
          // âœ… [Ø¥ØµÙ„Ø§Ø­ 5] limit(3) Ù„ØªÙ‚Ù„ÙŠÙ„ Ø¶ØºØ· Ø§Ù„Ø´Ø¨ÙƒØ©
          const {data} = await db.from('broadcasts').select('id,message,type,voice_url,voice_data,created_at').order('created_at',{ascending:false}).limit(3);
          if (!data || data.length===0) { bar.innerHTML=''; return; }
          bar.innerHTML = data.map(b=>`
            <div class="broadcast-banner" style="margin-bottom:8px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:1.3rem;">ğŸ“¢</span>
                <span style="color:var(--dark-green);font-weight:700;">Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
                <span style="color:#888;font-size:0.75rem;margin-right:auto;">${new Date(b.created_at).toLocaleDateString('ar-SA')}</span>
              </div>
              <div style="color:var(--text-dark);font-size:0.95rem;line-height:1.7;">${escapeHtml(b.message||'')}</div>
              ${b.type==='voice' && (b.voice_url||b.voice_data) ? playerHtml(b.voice_url||b.voice_data,'audio') : ''}
            </div>`).join('');
        } catch(e){}
      }

      async function loadAdminBroadcasts() {
        const div = document.getElementById('adminBroadcastsList');
        if (!div) return;
        try {
          // âœ… [Ø¥ØµÙ„Ø§Ø­ 5] limit(10) Ù„Ù„Ø£Ø¯Ù…Ù†
          const {data} = await db.from('broadcasts').select('id,message,type,voice_url,voice_data,created_at').order('created_at',{ascending:false}).limit(10);
          let html=`<h3 style="color:var(--dark-green);margin-bottom:8px;">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>`;
          data.forEach(b=>{
            html+=`<div class="broadcast-banner" style="position:relative;">
              <button class="broadcast-delete-btn" onclick="deleteBroadcast(${b.id})">ğŸ—‘ï¸</button>
              <div style="font-size:1.3rem;margin-bottom:4px;">ğŸ“¢</div>
              <div style="color:var(--dark-green);font-weight:700;margin-bottom:6px;">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</div>
              <div style="font-size:0.95rem;line-height:1.7;">${escapeHtml(b.message||'')}</div>
              ${b.type==='voice'&&(b.voice_url||b.voice_data)?playerHtml(b.voice_url||b.voice_data,'audio'):''}
              <div style="color:#888;font-size:0.78rem;margin-top:6px;">${new Date(b.created_at).toLocaleString('ar-SA')}</div>
            </div>`;
          });
          div.innerHTML=html;
        } catch(e){}
      }

      async function deleteBroadcast(id) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
        try { await db.from('broadcasts').delete().eq('id',id); hideLoading(); await Promise.all([loadAdminBroadcasts(),loadGlobalBroadcasts()]); }
        catch(e){ hideLoading(); alert('Ø®Ø·Ø£: '+e.message); }
      }

      function showBroadcastModal() {
        const modal = document.createElement('div');
        modal.className='message-modal'; modal.id='broadcastModal';
        modal.innerHTML=`<div class="message-modal-content">
          <h3>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</h3>
          <div class="message-type-btns" style="grid-template-columns:1fr 1fr;">
            <button class="message-type-btn active" onclick="switchBroadcastType('text',this)">âœï¸ Ù†ØµÙŠ</button>
            <button class="message-type-btn" onclick="switchBroadcastType('voice',this)">ğŸ¤ ØµÙˆØªÙŠ</button>
          </div>
          <div id="broadcastTextDiv"><textarea id="broadcastText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..."></textarea></div>
          <div id="broadcastVoiceDiv" class="voice-recorder hidden">
            <button class="btn btn-primary" id="bVoiceRecordBtn" onclick="startBroadcastVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div class="timer hidden" id="bVoiceTimer">00:00</div>
            <button class="btn btn-danger hidden" id="bVoiceStopBtn" onclick="stopBroadcastVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
            <div id="bVoicePreviewDiv" class="hidden"><audio id="bVoicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
          </div>
          <div class="modal-buttons">
            <button class="btn btn-primary" onclick="sendBroadcast()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
            <button class="btn btn-secondary" onclick="closeBroadcastModal()">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>`;
        document.body.appendChild(modal);
      }
      function switchBroadcastType(type,btn) {
        document.querySelectorAll('#broadcastModal .message-type-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('broadcastTextDiv').classList.toggle('hidden',type!=='text');
        document.getElementById('broadcastVoiceDiv').classList.toggle('hidden',type!=='voice');
      }
      async function startBroadcastVoice() {
        try {
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          broadcastVoiceChunks=[]; broadcastVoiceBlob=null;
          const mt=getSupportedMimeType();
          broadcastVoiceRecorder = mt?new MediaRecorder(stream,{mimeType:mt}):new MediaRecorder(stream);
          broadcastVoiceRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)broadcastVoiceChunks.push(e.data);};
          broadcastVoiceRecorder.onstop=()=>{
            stream.getTracks().forEach(t=>t.stop());
            if(broadcastVoiceChunks.length>0){
              broadcastVoiceBlob=new Blob(broadcastVoiceChunks,{type:broadcastVoiceRecorder.mimeType||'audio/webm'});
              document.getElementById('bVoicePreview').src=URL.createObjectURL(broadcastVoiceBlob);
              document.getElementById('bVoicePreviewDiv').classList.remove('hidden');
            }
          };
          broadcastVoiceRecorder.start(100);
          document.getElementById('bVoiceRecordBtn').classList.add('hidden');
          document.getElementById('bVoiceStopBtn').classList.remove('hidden');
          document.getElementById('bVoiceTimer').classList.remove('hidden');
          const s=Date.now();
          broadcastVoiceTimerInterval=setInterval(()=>{
            const e=Math.floor((Date.now()-s)/1000);
            const el=document.getElementById('bVoiceTimer');
            if(el) el.textContent=`${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
          },1000);
        } catch(err){alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: '+err.message);}
      }
      function stopBroadcastVoice(){
        if(broadcastVoiceRecorder&&broadcastVoiceRecorder.state!=='inactive'){
          broadcastVoiceRecorder.stop(); clearInterval(broadcastVoiceTimerInterval);
          document.getElementById('bVoiceRecordBtn').classList.remove('hidden');
          document.getElementById('bVoiceStopBtn').classList.add('hidden');
          document.getElementById('bVoiceTimer').classList.add('hidden');
        }
      }
      async function sendBroadcast(){
        const activeBtn=document.querySelector('#broadcastModal .message-type-btn.active');
        const isVoice=activeBtn&&activeBtn.textContent.includes('ØµÙˆØªÙŠ');
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        try {
          let bd={type:isVoice?'voice':'text'};
          if(isVoice){
            if(!broadcastVoiceBlob){hideLoading();alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©!');return;}
            bd.message='Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ“¢';
            bd.voice_url=await uploadToStorage(broadcastVoiceBlob,'broadcasts');
          } else {
            const text=document.getElementById('broadcastText').value.trim();
            if(!text){hideLoading();alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†!');return;}
            bd.message=text;
          }
          const {error}=await db.from('broadcasts').insert(bd);
          if(error) throw error;
          hideLoading(); closeBroadcastModal();
          await Promise.all([loadAdminBroadcasts(),loadGlobalBroadcasts()]);
          alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…');
        } catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }
      function closeBroadcastModal(){
        const m=document.getElementById('broadcastModal'); if(m)m.remove();
        broadcastVoiceChunks=[]; broadcastVoiceBlob=null;
        if(broadcastVoiceRecorder&&broadcastVoiceRecorder.state!=='inactive'){try{broadcastVoiceRecorder.stop();}catch(e){}}
        clearInterval(broadcastVoiceTimerInterval);
      }

      // =============================================
      // ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ø±Ùƒ Ø¬Ø¯ÙŠØ¯ + ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ (Ù…Ø±Ø¨ÙˆØ·Ø© ÙÙŠ window.onload Ø£Ø¯Ù†Ø§Ù‡)
      // =============================================
      function showLoginError(msg){const el=document.getElementById('loginError');el.textContent=msg;el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),4000);}

      // =============================================
      // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ/Ø§Ù„Ù…Ø±Ø¦ÙŠ
      // =============================================
      function selectType(type,card){
        recordingType=type;
        document.querySelectorAll('.type-card').forEach(el=>el.classList.remove('selected'));
        card.classList.add('selected');
        if(type==='video') startVideoPreview(); else stopVideoPreview();
      }
      async function startVideoPreview(){
        try {
          if(previewStream)return;
          const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
          previewStream=stream;
          document.getElementById('liveVideo').srcObject=stream;
          document.getElementById('livePreview').classList.remove('hidden');
        } catch(err){alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: '+err.message);}
      }
      function stopVideoPreview(){
        if(previewStream){
          previewStream.getTracks().forEach(t=>{try{t.stop();}catch(e){}});
          previewStream=null;
          const lv=document.getElementById('liveVideo'); if(lv)lv.srcObject=null;
          document.getElementById('livePreview').classList.add('hidden');
        }
      }
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 2] resetRecordingUI â€” Ø¯Ø§Ù„Ø© Ù…Ø´ØªØ±ÙƒØ© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
      function resetRecordingUI(){
        clearInterval(timerInterval);
        const lp = document.getElementById('livePreview'); if(lp) lp.classList.remove('recording');
        document.getElementById('recordBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        const t = document.getElementById('timer');
        if(t){ t.classList.add('hidden'); t.textContent='00:00'; }
      }

      // âœ… [Ø¥ØµÙ„Ø§Ø­ 2+7] startRecording â€” Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø³ØªØ±ÙŠÙ… ÙˆØ­Ù…Ø§ÙŠØ© Ø¶ØºØ·Ø§Øª Ù…Ø²Ø¯ÙˆØ¬Ø©
      async function startRecording(){
        if(isStarting) return;
        isStarting = true;

        try {
          let stream;

          if(recordingType === 'video'){
            if(previewStream){
              extraAudioStream = await navigator.mediaDevices.getUserMedia({ audio:true });
              stream = new MediaStream([
                ...previewStream.getVideoTracks(),
                ...extraAudioStream.getAudioTracks()
              ]);
            } else {
              stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
            }
          } else {
            stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          }

          recordStream = stream;
          recordedChunks = [];

          const mt = recordingType==='video' ? getSupportedVideoMimeType() : getSupportedMimeType();
          try { mediaRecorder = mt ? new MediaRecorder(stream, { mimeType: mt }) : new MediaRecorder(stream); }
          catch(e) { mediaRecorder = new MediaRecorder(stream); }

          mediaRecorder.ondataavailable = (e)=>{ if(e.data && e.data.size>0) recordedChunks.push(e.data); };

          mediaRecorder.onstop = ()=>{
            // âœ… Ù‚ÙÙ„ Ø³ØªØ±ÙŠÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¯Ø§Ø¦Ù…Ù‹Ø§
            try { recordStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
            recordStream = null;
            // âœ… Ù‚ÙÙ„ Ø³ØªØ±ÙŠÙ… Ø§Ù„ØµÙˆØª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
            try { extraAudioStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
            extraAudioStream = null;
            showPreview();
          };

          // âœ… [Ø¥ØµÙ„Ø§Ø­ 7] timeslice 200ms Ø¨Ø¯Ù„ 100ms Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¶Ø¹ÙŠÙØ©
          mediaRecorder.start(200);

          document.getElementById('recordBtn').classList.add('hidden');
          document.getElementById('stopBtn').classList.remove('hidden');
          document.getElementById('timer').classList.remove('hidden');
          if(recordingType==='video') document.getElementById('livePreview').classList.add('recording');

          recordingStartTime = Date.now();
          clearInterval(timerInterval);
          timerInterval = setInterval(()=>{
            const sec = Math.floor((Date.now()-recordingStartTime)/1000);
            const t = document.getElementById('timer');
            if(t) t.textContent = `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
          }, 1000);

        } catch(err){
          alert('Ø®Ø·Ø£: ' + (err?.message || err));
          resetRecordingUI();
          try { recordStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
          recordStream = null;
          try { extraAudioStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
          extraAudioStream = null;
        } finally {
          isStarting = false;
        }
      }

      // âœ… [Ø¥ØµÙ„Ø§Ø­ 2] stopRecording Ø§Ù„Ù…Ø­Ø³Ù‘Ù†
      function stopRecording(){
        if(mediaRecorder && mediaRecorder.state!=='inactive'){
          try { mediaRecorder.stop(); } catch(e){}
        }
        resetRecordingUI();
      }

      // âœ… [Ø¥ØµÙ„Ø§Ø­ 2] cancelRecording Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ù„Ù„Ø³ØªØ±ÙŠÙ…
      function cancelRecording(){
        try { if(mediaRecorder && mediaRecorder.state!=='inactive') mediaRecorder.stop(); } catch(e){}
        try { recordStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
        recordStream = null;
        try { extraAudioStream?.getTracks().forEach(t=>t.stop()); } catch(e){}
        extraAudioStream = null;

        recordedChunks = [];
        resetRecordingUI();
        document.getElementById('recordingPreview').classList.add('hidden');
        document.getElementById('previewMedia').innerHTML='';
      }
      function showPreview(){
        if(recordedChunks.length===0){alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.');cancelRecording();return;}
        const mt=(mediaRecorder&&mediaRecorder.mimeType)?mediaRecorder.mimeType:(recordingType==='video'?'video/webm':'audio/webm');
        const blob=new Blob(recordedChunks,{type:mt});
        const url=URL.createObjectURL(blob);
        const pd=document.getElementById('previewMedia');
        pd.innerHTML=recordingType==='video'
          ?`<video controls src="${url}" style="width:100%;border-radius:8px;"></video>`
          :`<audio controls src="${url}" style="width:100%;"></audio>`;
        document.getElementById('recordingPreview').classList.remove('hidden');
        const lp=document.getElementById('livePreview'); if(lp)lp.classList.remove('recording');
        document.getElementById('recordBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('timer').classList.add('hidden');
        document.getElementById('timer').textContent='00:00';
      }

      // =============================================
      // âœ… [Ø¥ØµÙ„Ø§Ø­ 3] Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â€” Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø¶ØºØ·Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© + finally
      // =============================================
      async function saveRecording(){
        if(isSaving) return;

        if(!recordedChunks || recordedChunks.length===0){
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
          return;
        }

        const mt = (mediaRecorder && mediaRecorder.mimeType) ? mediaRecorder.mimeType : (recordingType==='video'?'video/webm':'audio/webm');
        const blob = new Blob([...recordedChunks], { type: mt || 'audio/webm' });
        if(blob.size===0){ alert('Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙØ§Ø±Øº! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); return; }

        isSaving = true;

        const saveBtn = document.getElementById('saveRecordingBtn');
        if(saveBtn){ saveBtn.disabled = true; saveBtn.textContent = 'â¬†ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...'; }

        showLoading('â¬†ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...');

        try {
          if(blob.size > 30 * 1024 * 1024){
            console.warn('Large blob:', blob.size);
          }

          const fileUrl = await uploadToStorage(blob, `participant_${currentUser.id}`);

          const { error } = await db.from('recordings').insert({
            participant_id: currentUser.id,
            type: recordingType,
            file_url: fileUrl,
            data: null
          });

          if(error) throw error;

          recordedChunks = [];
          document.getElementById('recordingPreview').classList.add('hidden');
          document.getElementById('previewMedia').innerHTML='';
          hideLoading();
          alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…');
          await loadMyRecordings();

        } catch(err){
          hideLoading();
          let msg = err?.message || String(err);
          if(msg.includes('not found')||msg.includes('bucket')){
            alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:\nÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ bucket Ø¨Ø§Ø³Ù… "recordings" ÙÙŠ Supabase Storage Ø£ÙˆÙ„Ø§Ù‹!');
          } else {
            alert('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸/Ø§Ù„Ø±ÙØ¹:\n' + msg);
          }
          console.error(err);
        } finally {
          isSaving = false;
          if(saveBtn){ saveBtn.disabled = false; saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ ÙˆØ±ÙØ¹'; }
        }
      }

      // =============================================
      // ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ
      // =============================================
      async function loadMyRecordings(){
        const listDiv=document.getElementById('myRecordingsList');
        if(!listDiv)return;
        listDiv.innerHTML='<div class="empty-state"><div class="icon">â³</div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
        try {
          const {data,error}=await db.from('recordings').select('id,type,created_at,file_url,data')
            .eq('participant_id',currentUser.id).order('created_at',{ascending:true});
          if(error) throw error;
          if(!data||data.length===0){listDiv.innerHTML='<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</p></div>';return;}
          const seen=new Set();
          const unique=data.filter(r=>{if(seen.has(r.id))return false;seen.add(r.id);return true;});
          listDiv.innerHTML=unique.map((rec,i)=>`
            <div class="recording-item">
              <div class="three-dots" onclick="showRecordingMenu(event,${rec.id})">â‹®</div>
              <p style="color:var(--dark-green);font-weight:700;margin-bottom:4px;">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} â€” ${rec.type==='video'?'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ':'ğŸ¤ ØµÙˆØª'}</p>
              <p class="recording-date">${new Date(rec.created_at).toLocaleDateString('ar-SA')}</p>
              ${playerHtml(rec.file_url||rec.data, rec.type)}
            </div>`).join('');
        } catch(err){listDiv.innerHTML='<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';}
      }

      function showRecordingMenu(e,id){
        e.stopPropagation();
        document.querySelectorAll('.menu-popup').forEach(m=>m.remove());
        const menu=document.createElement('div');
        menu.className='menu-popup';
        menu.innerHTML=`<div class="menu-item danger" onclick="confirmDeleteRecording(${id})">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        e.target.closest('.recording-item').appendChild(menu);
        setTimeout(()=>{document.addEventListener('click',function h(ev){if(!menu.contains(ev.target)){menu.remove();document.removeEventListener('click',h);}});},10);
      }
      function confirmDeleteRecording(id){
        document.querySelectorAll('.confirm-dialog').forEach(d=>d.remove());
        const d=document.createElement('div'); d.className='confirm-dialog';
        d.innerHTML=`<div class="confirm-content"><h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3><p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ</p>
          <div class="confirm-buttons"><button class="btn btn-danger" onclick="deleteRecording(${id})">Ø­Ø°Ù</button><button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`;
        document.body.appendChild(d);
      }
      function closeConfirmDialog(){document.querySelectorAll('.confirm-dialog').forEach(d=>d.remove());}
      async function deleteRecording(id){
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
        try {
          await db.from('messages').delete().eq('recording_id',id);
          await db.from('recordings').delete().eq('id',id);
          hideLoading(); closeConfirmDialog();
          await loadMyRecordings(); await updateUnreadBadge();
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
        } catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }

      // =============================================
      // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ)
      // =============================================
      async function updateUnreadBadge(){
        if(!currentUser)return;
        try {
          const {count}=await db.from('messages').select('id',{count:'exact',head:true}).eq('participant_id',currentUser.id).eq('read',false);
          const badge=document.getElementById('unreadBadge');
          if(badge){if(count>0){badge.textContent=count;badge.classList.remove('hidden');}else badge.classList.add('hidden');}
        }catch(e){}
      }
      async function markMessagesAsRead(){
        if(!currentUser)return;
        try{await db.from('messages').update({read:true}).eq('participant_id',currentUser.id).eq('read',false);await updateUnreadBadge();}catch(e){}
      }
      async function loadMessages(){
        const listDiv=document.getElementById('messagesList');
        if(!listDiv)return;
        listDiv.innerHTML='<div class="empty-state"><div class="icon">â³</div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
        try {
          const {data,error}=await db.from('messages').select('id,message,message_type,rating,read,created_at,recording_id,voice_url,voice_data')
            .eq('participant_id',currentUser.id).order('created_at',{ascending:false});
          if(error) throw error;
          if(!data||data.length===0){listDiv.innerHTML='<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';return;}
          let html='';
          for(const msg of data){
            const icon=msg.message_type==='voice'?'ğŸ¤':msg.message_type==='rating'?'â­':'âœ‰ï¸';
            html+=`<div class="message-item ${!msg.read?'unread':''}">
              <div class="message-header">
                <span style="color:var(--primary-gold);font-weight:700;">${icon} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
                <span style="color:#666;font-size:0.75rem;">${new Date(msg.created_at).toLocaleDateString('ar-SA')}</span>
              </div>
              <div class="message-content">${escapeHtml(msg.message||'')}</div>`;
            if(msg.message_type==='voice'){
              const voiceUrl=msg.voice_url||msg.voice_data;
              html+=`<div class="message-recording"><p style="color:var(--dark-green);font-weight:600;margin-bottom:6px;">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</p>${playerHtml(voiceUrl,'audio')}</div>`;
            }
            if(msg.message_type==='rating'&&msg.rating){
              html+=`<div class="message-rating">
                <p style="color:var(--dark-green);font-weight:700;margin-bottom:6px;">ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>
                <div class="message-stars">${generateStarsDisplay(msg.rating)}</div>
                <p style="color:var(--dark-green);font-weight:700;font-size:1.3rem;margin-top:6px;">${msg.rating} / 5</p>
              </div>`;
            }
            if(msg.recording_id){
              html+=`<div class="linked-recording"><p>ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø¹Ù„Ù‘Ù‚Øª Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©:</p><div id="lnk_${msg.recording_id}"><div class="player-loading"><div class="mini-spinner"></div><span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div></div></div>`;
              loadLinkedRecording(msg.recording_id);
            }
            html+='</div>';
          }
          listDiv.innerHTML=html;
        } catch(err){listDiv.innerHTML='<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';}
      }
      async function loadLinkedRecording(id){
        try {
          const {data}=await db.from('recordings').select('file_url,data,type').eq('id',id).single();
          const el=document.getElementById('lnk_'+id);
          if(el&&data) el.innerHTML=playerHtml(data.file_url||data.data,data.type);
        }catch(e){}
      }
      function generateStarsDisplay(r){
        let h='';
        for(let i=1;i<=5;i++) h+=r>=i?'<span class="star filled">â­</span>':'<span class="star" style="opacity:0.3;">â­</span>';
        return h;
      }

      // =============================================
      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
      // =============================================
      async function loadParticipants(){
        showLoading();
        try {
          const [pRes,rRes]=await Promise.all([
            db.from('participants').select('id,name,password').order('name',{ascending:true}),
            db.from('recordings').select('id,participant_id,created_at')
          ]);
          hideLoading();
          const participants=pRes.data||[], allRecs=rRes.data||[];
          const listDiv=document.getElementById('participantsList');
          if(pRes.error||participants.length===0){listDiv.innerHTML='<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</p></div>';updateAdminStats(0,0,0);return;}
          let totalRec=0,newRec=0; window._participantsCache={};
          participants.forEach(p=>{
            p.recordings=allRecs.filter(r=>r.participant_id===p.id);
            totalRec+=p.recordings.length;
            p.recordings.forEach(r=>{if(!isRecordingViewed(p.id,r.id))newRec++;});
            window._participantsCache[p.id]=p;
          });
          updateAdminStats(participants.length,totalRec,newRec);
          listDiv.innerHTML=participants.map(p=>{
            const nc=p.recordings.filter(r=>!isRecordingViewed(p.id,r.id)).length;
            return `<div class="participant-card" data-pid="${p.id}">
              ${nc>0?`<div class="new-recordings-badge">${nc}</div>`:''}
              <div class="icon">ğŸ‘¤</div><h3>${escapeHtml(p.name)}</h3>
              <p class="count">${p.recordings.length} ØªØ³Ø¬ÙŠÙ„</p></div>`;
          }).join('');
          listDiv.querySelectorAll('.participant-card').forEach(card=>{
            card.addEventListener('click',function(){
              const p=window._participantsCache[parseInt(this.getAttribute('data-pid'))];
              if(p) showAdminRecordingsPage(p);
            });
          });
        }catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }
      function updateAdminStats(p,r,n){
        document.getElementById('totalParticipants').textContent=p;
        document.getElementById('totalRecordings').textContent=r;
        document.getElementById('newRecordings').textContent=n;
      }

      // =============================================
      // ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ (Ù„Ù„Ø£Ø³ØªØ§Ø°Ø©)
      // =============================================
      async function loadParticipantRecordingsAndRating(){
        const listDiv=document.getElementById('adminRecordingsList');
        if(!listDiv||!currentParticipant)return;
        listDiv.innerHTML='<div class="empty-state"><div class="icon">â³</div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
        try {
          const [recRes,ratRes]=await Promise.all([
            db.from('recordings').select('id,type,created_at,file_url,data').eq('participant_id',currentParticipant.id).order('created_at',{ascending:true}),
            db.from('messages').select('rating,recording_id').eq('participant_id',currentParticipant.id).eq('message_type','rating').not('rating','is',null)
          ]);
          const ratings=ratRes.data||[];
          let total=0; const ratedSet=new Set();
          ratings.forEach(r=>{if(!ratedSet.has(r.recording_id)){total+=r.rating;ratedSet.add(r.recording_id);}});
          const badge=document.getElementById('totalRatingBadge');
          document.getElementById('totalRatingValue').textContent=total.toFixed(1);
          document.getElementById('totalRatingMax').textContent=ratedSet.size*5;
          if(badge) badge.style.display=ratedSet.size===0?'none':'inline-flex';

          const recs=recRes.data||[];
          if(recRes.error) throw recRes.error;
          if(recs.length===0){listDiv.innerHTML='<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';return;}
          const seen=new Set();
          const unique=recs.filter(r=>{if(seen.has(r.id))return false;seen.add(r.id);markRecordingAsViewed(currentParticipant.id,r.id);return true;});
          listDiv.innerHTML=unique.map((rec,i)=>`
            <div class="recording-item">
              <div class="three-dots" onclick="showAdminRecordingMenu(event,${rec.id})">â‹®</div>
              <p style="color:var(--dark-green);font-weight:700;margin-bottom:4px;">Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} â€” ${rec.type==='video'?'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ':'ğŸ¤ ØµÙˆØª'}</p>
              <p class="recording-date">${new Date(rec.created_at).toLocaleDateString('ar-SA')}</p>
              ${playerHtml(rec.file_url||rec.data, rec.type)}
            </div>`).join('');
        }catch(err){listDiv.innerHTML='<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';}
      }
      async function loadParticipantRecordings(){await loadParticipantRecordingsAndRating();}

      function showAdminRecordingMenu(e,id){
        e.stopPropagation();
        document.querySelectorAll('.menu-popup').forEach(m=>m.remove());
        const menu=document.createElement('div'); menu.className='menu-popup';
        menu.innerHTML=`<div class="menu-item" onclick="openMessageModal(${id},'text')">âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal(${id},'voice')">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal(${id},'rating')">â­ ØªÙ‚ÙŠÙŠÙ…</div>
          <div class="menu-item danger" onclick="confirmDeleteRecordingAdmin(${id})">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        e.target.closest('.recording-item').appendChild(menu);
        setTimeout(()=>{document.addEventListener('click',function h(ev){if(!menu.contains(ev.target)){menu.remove();document.removeEventListener('click',h);}});},10);
      }

      async function loadAdminSentMessages(){
        const div=document.getElementById('adminSentMessages');
        if(!div||!currentParticipant)return;
        try {
          const {data}=await db.from('messages').select('id,message,message_type,rating,created_at,voice_url,voice_data')
            .eq('participant_id',currentParticipant.id).order('created_at',{ascending:false});
          if(!data||data.length===0){div.innerHTML='';return;}
          let html=`<h3 style="color:var(--dark-green);margin-bottom:10px;">ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>`;
          data.forEach(msg=>{
            const icon=msg.message_type==='voice'?'ğŸ¤':msg.message_type==='rating'?'â­':'âœ‰ï¸';
            html+=`<div class="admin-msg-item">
              <button class="msg-delete-btn" onclick="deleteMessage(${msg.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <p style="color:var(--dark-green);font-weight:700;margin-bottom:4px;margin-left:55px;">${icon} ${escapeHtml(msg.message||'')}</p>
              <p style="color:#888;font-size:0.78rem;">${new Date(msg.created_at).toLocaleString('ar-SA')}</p>
              ${msg.message_type==='voice'?playerHtml(msg.voice_url||msg.voice_data,'audio'):''}
              ${msg.message_type==='rating'&&msg.rating?`<div style="margin-top:6px;color:var(--dark-green);font-weight:700;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${msg.rating}/5 â­</div>`:''}
            </div>`;
          });
          div.innerHTML=html;
        }catch(e){}
      }
      async function deleteMessage(id){
        if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ'))return;
        showLoading();
        try{await db.from('messages').delete().eq('id',id);hideLoading();await loadAdminSentMessages();await calculateAndDisplayTotalRating();alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');}
        catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }
      async function calculateAndDisplayTotalRating(){
        if(!currentParticipant)return;
        try {
          const {data}=await db.from('messages').select('rating,recording_id').eq('participant_id',currentParticipant.id).eq('message_type','rating').not('rating','is',null);
          let total=0; const rs=new Set();
          if(data) data.forEach(r=>{if(!rs.has(r.recording_id)){total+=r.rating;rs.add(r.recording_id);}});
          const badge=document.getElementById('totalRatingBadge');
          document.getElementById('totalRatingValue').textContent=total.toFixed(1);
          document.getElementById('totalRatingMax').textContent=rs.size*5;
          if(badge) badge.style.display=rs.size===0?'none':'inline-flex';
        }catch(e){}
      }

      // =============================================
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ
      // =============================================
      function openMessageModal(recordingId,type){
        currentRecordingForMessage=recordingId; selectedRating=0; adminVoiceChunks=[]; adminVoiceBlob=null;
        const modal=document.createElement('div'); modal.className='message-modal'; modal.id='messageModal';
        modal.innerHTML=`<div class="message-modal-content">
          <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
          <div class="message-type-btns">
            <button class="message-type-btn ${type==='text'?'active':''}" onclick="switchMessageType('text',this)">âœï¸ Ù†ØµÙŠØ©</button>
            <button class="message-type-btn ${type==='voice'?'active':''}" onclick="switchMessageType('voice',this)">ğŸ¤ ØµÙˆØªÙŠØ©</button>
            <button class="message-type-btn ${type==='rating'?'active':''}" onclick="switchMessageType('rating',this)">â­ ØªÙ‚ÙŠÙŠÙ…</button>
          </div>
          <div id="textMessageDiv" class="${type!=='text'?'hidden':''}"><textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea></div>
          <div id="voiceMessageDiv" class="voice-recorder ${type!=='voice'?'hidden':''}">
            <button class="btn btn-primary" id="voiceRecordBtn" onclick="startAdminVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div class="timer hidden" id="voiceTimer">00:00</div>
            <button class="btn btn-danger hidden" id="voiceStopBtn" onclick="stopAdminVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
            <div id="voicePreviewDiv" class="hidden"><audio id="voicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
          </div>
          <div id="ratingMessageDiv" class="rating-container ${type!=='rating'?'hidden':''}">
            <p style="color:var(--dark-green);font-weight:700;margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
            <div class="stars-display" id="starsDisplay">${[1,2,3,4,5].map(i=>`<span class="star" onclick="setRating(${i})">â­</span>`).join('')}</div>
            <div class="rating-value" id="ratingValue">0 / 5</div>
            <div class="rating-buttons">${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(v=>`<button class="rating-btn" onclick="setRating(${v})">${v}</button>`).join('')}</div>
          </div>
          <div class="modal-buttons">
            <button class="btn btn-primary" onclick="sendMessageToParticipant()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
            <button class="btn btn-secondary" onclick="closeMessageModal()">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>`;
        document.body.appendChild(modal);
      }
      function switchMessageType(type,btn){
        document.querySelectorAll('#messageModal .message-type-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        ['textMessageDiv','voiceMessageDiv','ratingMessageDiv'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.add('hidden');});
        if(type==='text') document.getElementById('textMessageDiv').classList.remove('hidden');
        else if(type==='voice') document.getElementById('voiceMessageDiv').classList.remove('hidden');
        else document.getElementById('ratingMessageDiv').classList.remove('hidden');
      }
      function setRating(v){
        selectedRating=v;
        const vEl=document.getElementById('ratingValue'); if(vEl)vEl.textContent=`${v}/5`;
        document.querySelectorAll('#starsDisplay .star').forEach((s,i)=>s.classList.toggle('filled',v>=i+1));
        document.querySelectorAll('.rating-btn').forEach(b=>b.classList.toggle('active',parseFloat(b.textContent)===v));
      }
      async function startAdminVoice(){
        try {
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          adminVoiceChunks=[]; adminVoiceBlob=null;
          const mt=getSupportedMimeType();
          try{adminVoiceRecorder=mt?new MediaRecorder(stream,{mimeType:mt}):new MediaRecorder(stream);}
          catch(e){adminVoiceRecorder=new MediaRecorder(stream);}
          adminVoiceRecorder.ondataavailable=e=>{if(e.data&&e.data.size>0)adminVoiceChunks.push(e.data);};
          adminVoiceRecorder.onstop=()=>{
            stream.getTracks().forEach(t=>{try{t.stop();}catch(e){}});
            if(adminVoiceChunks.length>0){
              adminVoiceBlob=new Blob(adminVoiceChunks,{type:adminVoiceRecorder.mimeType||'audio/webm'});
              document.getElementById('voicePreview').src=URL.createObjectURL(adminVoiceBlob);
              document.getElementById('voicePreviewDiv').classList.remove('hidden');
            }
          };
          adminVoiceRecorder.start(100);
          document.getElementById('voiceRecordBtn').classList.add('hidden');
          document.getElementById('voiceStopBtn').classList.remove('hidden');
          document.getElementById('voiceTimer').classList.remove('hidden');
          const s=Date.now();
          adminVoiceTimer=setInterval(()=>{
            const e=Math.floor((Date.now()-s)/1000);
            const el=document.getElementById('voiceTimer');
            if(el)el.textContent=`${Math.floor(e/60).toString().padStart(2,'0')}:${(e%60).toString().padStart(2,'0')}`;
          },1000);
        }catch(err){alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: '+err.message);}
      }
      function stopAdminVoice(){
        if(adminVoiceRecorder&&adminVoiceRecorder.state!=='inactive'){
          try{adminVoiceRecorder.stop();}catch(e){}; clearInterval(adminVoiceTimer);
          const b=document.getElementById('voiceRecordBtn');if(b)b.classList.remove('hidden');
          const s=document.getElementById('voiceStopBtn');if(s)s.classList.add('hidden');
          const t=document.getElementById('voiceTimer');if(t){t.classList.add('hidden');t.textContent='00:00';}
        }
      }
      async function sendMessageToParticipant(){
        const activeBtn=document.querySelector('#messageModal .message-type-btn.active');
        if(!activeBtn)return;
        const messageType=activeBtn.textContent.includes('Ù†ØµÙŠØ©')?'text':activeBtn.textContent.includes('ØµÙˆØªÙŠØ©')?'voice':'rating';
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        try {
          let msgData={participant_id:currentParticipant.id,recording_id:currentRecordingForMessage,message_type:messageType,read:false};
          if(messageType==='text'){
            const t=document.getElementById('messageText').value.trim();
            if(!t){hideLoading();alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©!');return;}
            msgData.message=t;
          } else if(messageType==='voice'){
            if(!adminVoiceBlob){hideLoading();alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!');return;}
            msgData.message='Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ¤';
            msgData.voice_url=await uploadToStorage(adminVoiceBlob,'messages');
          } else {
            if(selectedRating===0){hideLoading();alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…!');return;}
            await db.from('messages').delete().eq('participant_id',currentParticipant.id).eq('recording_id',currentRecordingForMessage).eq('message_type','rating');
            msgData.message=`ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selectedRating}/5 Ù†Ø¬ÙˆÙ… â­`;
            msgData.rating=selectedRating;
          }
          const {error}=await db.from('messages').insert(msgData);
          if(error) throw error;
          hideLoading(); closeMessageModal();
          if(messageType==='rating') await calculateAndDisplayTotalRating();
          await loadAdminSentMessages();
          alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­! âœ…');
        }catch(err){hideLoading();alert('Ø®Ø·Ø£: '+err.message);}
      }
      function closeMessageModal(){
        const m=document.getElementById('messageModal');if(m)m.remove();
        adminVoiceChunks=[]; adminVoiceBlob=null;
        if(adminVoiceRecorder&&adminVoiceRecorder.state!=='inactive'){try{adminVoiceRecorder.stop();}catch(e){}}
        clearInterval(adminVoiceTimer); selectedRating=0;
      }

      function confirmDeleteRecordingAdmin(id){
        closeConfirmDialog();
        const d=document.createElement('div');d.className='confirm-dialog';
        d.innerHTML=`<div class="confirm-content"><h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3><p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ</p>
          <div class="confirm-buttons"><button class="btn btn-danger" onclick="deleteRecordingAdmin(${id})">Ø­Ø°Ù</button><button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`;
        document.body.appendChild(d);
      }
      async function deleteRecordingAdmin(id){
        showLoading();
        try{
          await db.from('messages').delete().eq('recording_id',id);
          await db.from('recordings').delete().eq('id',id);
          hideLoading(); closeConfirmDialog();
          await calculateAndDisplayTotalRating(); await loadAdminSentMessages(); await loadParticipantRecordings();
          alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
        }catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }

      function confirmDeleteAccount(){
        closeConfirmDialog();
        const d=document.createElement('div');d.className='confirm-dialog';
        d.innerHTML=`<div class="confirm-content"><h3>âš ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</h3><p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ <strong>${escapeHtml(currentParticipant.name)}</strong>ØŸ</p>
          <div class="confirm-buttons"><button class="btn btn-danger" onclick="deleteParticipantAccount()">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button><button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button></div></div>`;
        document.body.appendChild(d);
      }
      async function deleteParticipantAccount(){
        showLoading();
        try{
          await db.from('messages').delete().eq('participant_id',currentParticipant.id);
          await db.from('recordings').delete().eq('participant_id',currentParticipant.id);
          await db.from('participants').delete().eq('id',currentParticipant.id);
          hideLoading(); closeConfirmDialog();
          alert(`ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${currentParticipant.name} âœ…`);
          currentParticipant=null; showAdminParticipantsPage();
        }catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }
      function toggleContactInfo(){
        const c=document.getElementById('contactInfoContent'),t=document.getElementById('contactToggleText');
        if(!c)return;
        if(c.classList.contains('hidden')){c.classList.remove('hidden');t.textContent='Ø¥Ø®ÙØ§Ø¡';}
        else{c.classList.add('hidden');t.textContent='Ø¹Ø±Ø¶';}
      }
      async function copyToClipboard(type,btn){
        if(!currentParticipant)return;
        const text=type==='name'?currentParticipant.name:currentParticipant.password;
        try{await navigator.clipboard.writeText(text);}
        catch{try{const ta=document.createElement('textarea');ta.value=text;ta.style.cssText='position:fixed;opacity:0';document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);}catch(e2){alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');return;}}
        const orig=btn.innerHTML; btn.innerHTML='âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®'; btn.classList.add('copied');
        setTimeout(()=>{btn.innerHTML=orig;btn.classList.remove('copied');},2000);
      }

      // =============================================
      // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
      // =============================================
      async function showLeaderboard(){
        showLoading();
        try {
          const [pRes,rRes,ratRes]=await Promise.all([
            db.from('participants').select('id,name'),
            db.from('recordings').select('id,participant_id'),
            db.from('messages').select('participant_id,recording_id,rating').eq('message_type','rating').not('rating','is',null)
          ]);
          hideLoading();
          const participants=pRes.data||[],allRecs=rRes.data||[],ratings=ratRes.data||[];
          const rMap={};
          ratings.forEach(r=>{
            if(!rMap[r.participant_id]) rMap[r.participant_id]={total:0,ratedSet:new Set()};
            if(!rMap[r.participant_id].ratedSet.has(r.recording_id)){rMap[r.participant_id].total+=r.rating;rMap[r.participant_id].ratedSet.add(r.recording_id);}
          });
          const ranked=participants.map(p=>{
            const rc=allRecs.filter(r=>r.participant_id===p.id).length;
            const rm=rMap[p.id]||{total:0,ratedSet:new Set()};
            return{...p,totalRating:rm.total,ratedCount:rm.ratedSet.size,recCount:rc};
          }).sort((a,b)=>b.totalRating-a.totalRating||b.ratedCount-a.ratedCount);
          const rankClass=i=>i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-other';
          const rankEmoji=i=>i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':(i+1);
          const starsHtml=(r,c)=>!c?'<span style="color:#bbb;font-size:0.8rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…</span>':'â­'.repeat(Math.floor(r))+'â˜†'.repeat(Math.max(0,5-Math.floor(r)));
          const rowsHtml=ranked.length===0?'<div style="text-align:center;padding:30px;color:#aaa;"><div style="font-size:3rem;">ğŸ†</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</p></div>'
            :ranked.map((p,i)=>`<div class="leaderboard-row ${rankClass(i)}">
              <div class="rank-badge">${rankEmoji(i)}</div>
              <div class="rank-info"><div class="rank-name">${escapeHtml(p.name)}</div>
              <div class="rank-details">${p.recCount} ØªØ³Ø¬ÙŠÙ„ â€¢ ${p.ratedCount} ØªÙ‚ÙŠÙŠÙ…</div>
              <div class="rank-stars">${starsHtml(p.totalRating,p.ratedCount)}</div></div>
              <div class="rank-score"><div class="score-num">${p.totalRating>0?p.totalRating.toFixed(1):'-'}</div>
              ${p.ratedCount>0?`<div class="score-label">Ù…Ù† ${p.ratedCount*5}</div>`:'<div class="score-label">Ù†Ù‚Ø·Ø©</div>'}</div>
            </div>`).join('');
          const modal=document.createElement('div'); modal.className='leaderboard-modal'; modal.id='leaderboardModal';
          modal.innerHTML=`<div class="leaderboard-content">
            <div class="leaderboard-header">
              <button class="leaderboard-close" onclick="document.getElementById('leaderboardModal').remove()">âœ•</button>
              <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</h2><p>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† 1446</p>
            </div><div class="leaderboard-body">${rowsHtml}</div></div>`;
          document.body.appendChild(modal);
          modal.addEventListener('click',e=>{if(e.target===modal)modal.remove();});
        }catch(e){hideLoading();alert('Ø®Ø·Ø£: '+e.message);}
      }

      // =============================================
      // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      // =============================================
      window.onload = function(){
        loadViewedRecordings();
        loadCurrentSession();
        // âœ… [Ø¥ØµÙ„Ø§Ø­ 5] ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙÙˆØ±Ø§Ù‹
        setTimeout(loadGlobalBroadcasts, 400);

        // =============================================
        // âœ… [Ø¥ØµÙ„Ø§Ø­ 6] Ø±Ø¨Ø· Ø§Ù„ÙÙˆØ±Ù…Ø§Øª Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ DOM
        // =============================================

        // ØªØ³Ø¬ÙŠÙ„ Ù…Ø´Ø§Ø±Ùƒ Ø¬Ø¯ÙŠØ¯
        document.getElementById('registerForm').onsubmit = async function(e){
          e.preventDefault();
          const name=document.getElementById('participantName').value.trim();
          const pass=document.getElementById('password').value.trim();
          if(!name||!pass){alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!');return;}
          const btn=document.getElementById('registerSubmitBtn');
          btn.disabled=true; btn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...';
          showLoading();
          try {
            const {data:existing}=await db.from('participants').select('id').ilike('name',name);
            if(existing&&existing.length>0){hideLoading();btn.disabled=false;btn.textContent='ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ';alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!');return;}
            const {data:newUser,error}=await db.from('participants').insert({name,password:pass}).select().single();
            if(error) throw error;
            currentUser=newUser; saveSession(newUser);
            hideLoading(); btn.disabled=false; btn.textContent='ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ';
            showParticipantPage();
          } catch(err){hideLoading();btn.disabled=false;btn.textContent='ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ';alert('Ø­Ø¯Ø« Ø®Ø·Ø£: '+err.message);}
        };

        // âœ… [Ø¥ØµÙ„Ø§Ø­ 4] ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø°ÙƒÙŠ â€” ÙŠØ¬ÙŠØ¨ ÙÙ‚Ø· 25 Ù†ØªÙŠØ¬Ø© Ø¨Ø¯Ù„ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        document.getElementById('loginForm').onsubmit = async function(e) {
          e.preventDefault();
          const nameRaw = document.getElementById('loginName').value.trim();
          const passRaw = document.getElementById('loginPassword').value;
          if (!nameRaw || !passRaw) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!'); return; }
          const btn = document.getElementById('loginSubmitBtn');
          btn.disabled = true; btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
          showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
          const norm = s => (s||'').trim()
            .replace(/[\u0622\u0623\u0625]/g,'\u0627')
            .replace(/\u0629/g,'\u0647')
            .replace(/\s+/g,' ').toLowerCase();
          try {
            const { data: candidates, error } = await db
              .from('participants').select('id,name,password')
              .ilike('name', `%${nameRaw}%`).limit(25);
            hideLoading();
            btn.disabled = false; btn.textContent = 'Ø¯Ø®ÙˆÙ„ ğŸ”“';
            if (error) { showLoginError('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.'); return; }
            if (!candidates || candidates.length === 0) { showLoginError('Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!'); return; }
            const user = candidates.find(u =>
              norm(u.name) === norm(nameRaw) &&
              ((u.password === passRaw) || ((u.password||'').trim() === passRaw.trim()))
            );
            if (!user) { showLoginError('Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!'); return; }
            currentUser = user; saveSession(user); showParticipantPage();
          } catch (err) {
            hideLoading();
            btn.disabled = false; btn.textContent = 'Ø¯Ø®ÙˆÙ„ ğŸ”“';
            showLoginError('Ø­Ø¯Ø« Ø®Ø·Ø£. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            console.error(err);
          }
        };

        // Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©
        document.getElementById('adminLoginForm').onsubmit = function(e){
          e.preventDefault();
          const pass=document.getElementById('adminPassword').value;
          if(pass==='Qur@n2025#Admin$Ramadan'){isAdmin=true;saveSession();showAdminParticipantsPage();}
          else{const el=document.getElementById('adminError');el.textContent='ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';el.classList.remove('hidden');setTimeout(()=>el.classList.add('hidden'),3000);}
        };
      };
    </script>
  </body>
</html>
