<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      :root {
        --primary-gold: #d4af37;
        --dark-green: #0d4d3f;
        --medium-green: #1a6b54;
        --light-green: #e8f5e9;
        --cream: #fefdf8;
        --white: #ffffff;
        --text-dark: #2c2c2c;
        --border-light: #e0dfd5;
        --accent-gold: #f0c850;
      }
      body {
        font-family: "Cairo", sans-serif;
        background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%);
        min-height: 100vh;
        padding: 8px;
        position: relative;
        overflow-x: hidden;
      }
      .container { max-width: 900px; margin: 0 auto; }
      .header { text-align: center; margin-bottom: 8px; }
      .logo {
        width: 50px; height: 50px; margin: 0 auto 8px;
        background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold));
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.5);
      }
      .logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
      h1 { font-family: "Amiri", serif; color: var(--white); font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
      .subtitle { color: var(--primary-gold); font-size: 0.9rem; font-weight: 600; }
      .card { background: var(--white); border-radius: 12px; padding: 15px 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.15); margin-bottom: 8px; }
      .form-group { margin-bottom: 12px; position: relative; }
      .password-toggle { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; color: #666; transition: color 0.3s ease; user-select: none; }
      .password-input-wrapper { position: relative; }
      label { display: block; color: var(--dark-green); font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; }
      input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 0.95rem; font-family: "Cairo", sans-serif; transition: all 0.3s ease; background: var(--cream); }
      input:focus { outline: none; border-color: var(--primary-gold); background: var(--white); }
      .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; font-family: "Cairo", sans-serif; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px; }
      .btn-primary { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); color: var(--dark-green); box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.5); }
      .btn-secondary { background: var(--dark-green); color: var(--white); box-shadow: 0 4px 15px rgba(13,77,63,0.3); }
      .btn-secondary:hover { background: var(--medium-green); transform: translateY(-2px); }
      .btn-danger { background: #dc2626; color: white; }
      .btn-danger:hover { background: #b91c1c; }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; }
      .big-icon-btn { font-size: 1.3rem; padding: 15px; margin: 6px 0; }
      .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 12px; }
      .stat-card { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 3px 12px rgba(212,175,55,0.3); }
      .stat-card .icon { font-size: 1.4rem; margin-bottom: 3px; }
      .stat-card .number { font-size: 1.5rem; font-weight: 900; color: var(--dark-green); margin-bottom: 2px; }
      .stat-card .label { font-size: 0.75rem; color: var(--dark-green); font-weight: 600; }
      .record-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
      .type-card { background: white; border: 2px solid var(--border-light); border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
      .type-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); }
      .type-card.selected { border-color: var(--primary-gold); background: linear-gradient(to bottom, #fff9e6, white); }
      .type-card .icon { font-size: 2.5rem; margin-bottom: 6px; }
      .type-card h3 { font-size: 1rem; color: var(--dark-green); }
      .recording-controls { margin-top: 12px; }
      .timer { text-align: center; font-size: 1.8rem; font-weight: 700; color: var(--dark-green); margin: 12px 0; font-family: "Courier New", monospace; }
      .live-preview { margin: 12px 0; padding: 10px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .live-preview.recording { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #dc2626; }
      .live-preview video { width: 100%; border-radius: 8px; background: #000; }
      .recording-preview { margin: 12px 0; padding: 12px; background: linear-gradient(to bottom, #fff9e6, white); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .recording-preview video, .recording-preview audio { width: 100%; border-radius: 8px; margin-top: 10px; }
      .recording-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .recording-item video, .recording-item audio { width: 100%; margin-top: 8px; border-radius: 8px; }
      .recording-date { color: #666; font-size: 0.8rem; margin-bottom: 8px; }
      .three-dots { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; cursor: pointer; color: #666; padding: 5px; z-index: 10; }
      .three-dots:hover { color: var(--dark-green); }
      .menu-popup { position: absolute; top: 40px; left: 10px; background: white; border: 2px solid var(--primary-gold); border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 100; min-width: 160px; }
      .menu-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; }
      .menu-item:last-child { border-bottom: none; }
      .menu-item:hover { background: var(--cream); }
      .menu-item.danger { color: #dc2626; }
      .logout-btn { position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
      .logout-btn:hover { background: var(--primary-gold); color: var(--white); }
      .back-btn { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
      .back-btn:hover { background: var(--primary-gold); color: var(--white); }
      .hidden { display: none !important; }
      .error-message { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
      .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
      .participant-card { background: white; padding: 12px 8px; border-radius: 10px; border: 2px solid var(--border-light); cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; }
      .participant-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
      .participant-card .icon { font-size: 2.2rem; margin-bottom: 6px; }
      .participant-card h3 { color: var(--dark-green); font-size: 0.95rem; margin-bottom: 5px; word-break: break-word; }
      .participant-card .count { color: #666; font-size: 0.8rem; }
      .new-recordings-badge { position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4); border: 2px solid white; }
      .empty-state { text-align: center; padding: 25px 15px; color: #999; }
      .empty-state .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
      .empty-state p { font-size: 0.95rem; }
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3000; }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--primary-gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loading-spinner { text-align: center; color: white; }
      .loading-spinner p { font-size: 0.95rem; font-weight: 600; }
      .message-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
      .message-modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; }
      .message-modal h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .message-type-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
      .message-type-btn { padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; font-family: "Cairo", sans-serif; }
      .message-type-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); color: var(--dark-green); }
      .message-modal textarea { width: 100%; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-family: "Cairo", sans-serif; font-size: 0.95rem; min-height: 100px; resize: vertical; }
      .voice-recorder { background: linear-gradient(to bottom, #f0f9ff, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); }
      .voice-recorder audio { width: 100%; margin-top: 10px; }
      .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
      .unread-badge { position: absolute; top: -6px; left: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4); }
      .message-item { background: linear-gradient(135deg, #fff9e6, white); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-right: 3px solid var(--primary-gold); }
      .message-item.unread { background: linear-gradient(135deg, #fff4d6, #fff9e6); box-shadow: 0 3px 15px rgba(212,175,55,0.2); }
      .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border-light); }
      .message-content { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
      .message-recording { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border-light); }
      .message-recording audio { width: 100%; margin-top: 6px; }
      .linked-recording { background: linear-gradient(135deg, #e8f5e9, #f0fff4); padding: 12px; border-radius: 8px; margin-top: 10px; border: 2px solid #4caf50; }
      .linked-recording p { color: var(--dark-green); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
      .linked-recording audio, .linked-recording video { width: 100%; border-radius: 6px; }
      .rating-container { background: linear-gradient(to bottom, #fff9e6, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); text-align: center; }
      .stars-display { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 15px 0; font-size: 2.5rem; }
      .star { cursor: pointer; transition: all 0.2s ease; color: #d1d5db; }
      .star:hover { transform: scale(1.2); }
      .star.filled { color: #fbbf24; }
      .rating-value { font-size: 1.5rem; font-weight: 700; color: var(--dark-green); margin-top: 10px; }
      .rating-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 12px; }
      .rating-btn { padding: 8px; border: 2px solid var(--border-light); border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; font-family: "Cairo", sans-serif; }
      .rating-btn:hover { background: var(--cream); border-color: var(--primary-gold); }
      .rating-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); color: var(--dark-green); }
      .message-rating { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px; border-radius: 8px; margin-top: 8px; text-align: center; border: 2px solid #fbbf24; }
      .message-stars { font-size: 2rem; margin: 8px 0; }
      .message-stars .star { cursor: default; }
      .contact-info-section { background: linear-gradient(135deg, #dbeafe, #e0f2fe); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--primary-gold); }
      .contact-info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .contact-info-title { color: var(--dark-green); font-weight: 700; font-size: 1rem; }
      .toggle-contact-btn { background: var(--primary-gold); color: var(--dark-green); padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; font-family: "Cairo", sans-serif; }
      .toggle-contact-btn:hover { background: var(--accent-gold); transform: scale(1.05); }
      .contact-info-content { margin-top: 10px; }
      .info-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-light); }
      .info-label { color: #666; font-size: 0.85rem; margin-bottom: 4px; }
      .info-value { color: var(--dark-green); font-size: 1rem; font-weight: 700; word-break: break-all; }
      .copy-btn { background: var(--dark-green); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; font-family: "Cairo", sans-serif; }
      .copy-btn:hover { background: var(--medium-green); transform: scale(1.05); }
      .copy-btn.copied { background: #10b981; }
      .total-rating-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; border: 2px solid #fbbf24; box-shadow: 0 2px 8px rgba(251,191,36,0.3); }
      .total-rating-badge .icon { font-size: 1.2rem; }
      .total-rating-badge .text { color: var(--dark-green); font-weight: 700; font-size: 0.9rem; }
      .total-rating-badge .value { color: var(--dark-green); font-weight: 900; font-size: 1.1rem; }
      .broadcast-banner { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 14px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #fbbf24; position: relative; box-shadow: 0 3px 12px rgba(251,191,36,0.3); }
      .broadcast-banner .broadcast-icon { font-size: 1.5rem; margin-bottom: 6px; }
      .broadcast-banner .broadcast-title { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 6px; }
      .broadcast-banner .broadcast-text { color: var(--text-dark); font-size: 0.95rem; line-height: 1.6; }
      .broadcast-banner audio { width: 100%; margin-top: 8px; border-radius: 6px; }
      .broadcast-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
      .broadcast-delete-btn:hover { background: #b91c1c; transform: scale(1.1); }
      .admin-msg-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .admin-msg-item .msg-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; font-family: "Cairo", sans-serif; }
      .admin-msg-item .msg-delete-btn:hover { background: #b91c1c; }
      .leaderboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display: flex; align-items: flex-start; justify-content: center; z-index: 2000; padding: 15px; overflow-y: auto; }
      .leaderboard-content { background: var(--white); border-radius: 16px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
      .leaderboard-header { background: linear-gradient(135deg, var(--dark-green), var(--medium-green)); padding: 20px 15px; text-align: center; position: relative; }
      .leaderboard-header h2 { color: var(--white); font-family: "Amiri", serif; font-size: 1.5rem; margin-bottom: 4px; }
      .leaderboard-header p { color: var(--primary-gold); font-size: 0.85rem; }
      .leaderboard-close { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
      .leaderboard-body { padding: 15px; }
      .leaderboard-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 2px solid transparent; animation: popIn 0.3s ease both; }
      .leaderboard-row.rank-1 { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-color: #f59e0b; }
      .leaderboard-row.rank-2 { background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-color: #94a3b8; }
      .leaderboard-row.rank-3 { background: linear-gradient(135deg, #fff7ed, #ffedd5); border-color: #f97316; }
      .leaderboard-row.rank-other { background: var(--cream); border-color: var(--border-light); }
      .rank-badge { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 900; flex-shrink: 0; }
      .rank-1 .rank-badge { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
      .rank-2 .rank-badge { background: linear-gradient(135deg, #94a3b8, #cbd5e1); color: white; }
      .rank-3 .rank-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; }
      .rank-other .rank-badge { background: var(--light-green); color: var(--dark-green); font-size: 1rem; }
      .rank-info { flex: 1; }
      .rank-name { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 3px; }
      .rank-details { color: #777; font-size: 0.8rem; }
      .rank-score { text-align: center; }
      .rank-score .score-num { font-size: 1.4rem; font-weight: 900; color: var(--dark-green); line-height: 1; }
      .rank-score .score-label { font-size: 0.7rem; color: #888; }
      .rank-stars { color: #fbbf24; font-size: 0.85rem; margin-top: 2px; }
      .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; }
      .confirm-content { background: white; padding: 20px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center; }
      .confirm-content h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .confirm-content p { font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; }
      .confirm-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      /* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ - Ù…Ø¤Ø´Ø± Ù…Ø±Ø¦ÙŠ Ø§Ø­ØªØ±Ø§ÙÙŠ */
      .recording-status-bar {
        background: linear-gradient(135deg, #dc2626, #ef4444);
        color: white; padding: 10px 15px; border-radius: 10px;
        display: flex; align-items: center; gap: 10px;
        margin-bottom: 10px; font-weight: 700; font-size: 0.95rem;
        animation: pulse-red 1.5s infinite;
      }
      @keyframes pulse-red { 0%,100%{opacity:1} 50%{opacity:0.8} }
      .rec-dot { width: 12px; height: 12px; border-radius: 50%; background: white; animation: blink 1s infinite; }
      @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
      @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
      @media (max-width: 768px) {
        h1 { font-size: 1.3rem; }
        .card { padding: 12px 10px; }
        .btn { font-size: 0.95rem; padding: 10px; }
        .record-type-grid { grid-template-columns: 1fr; }
        .participants-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .logout-btn, .back-btn { padding: 6px 12px; font-size: 0.75rem; }
        .message-type-btns { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="Ø´Ø¹Ø§Ø± Ø±Ù…Ø¶Ø§Ù†" onerror="this.style.display='none'" />
        </div>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
        <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</p>
      </div>

      <div id="globalBroadcastsBar"></div>

      <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="homePage" class="card">
        <button class="btn btn-primary big-icon-btn" onclick="showRegisterPage()">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-secondary big-icon-btn" onclick="showLoginPage()">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" onclick="showAdminLogin()" style="margin-top: 20px;">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <div id="registerPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="registerForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="participantName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" autocomplete="off" />
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('password')">ğŸ‘ï¸</span>
            </div>
          </div>
          <div id="registerError" class="error-message hidden"></div>
          <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
        <div id="loginError" class="error-message hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ" autocomplete="off" />
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminLoginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h2>
        <div id="adminError" class="error-message hidden"></div>
        <form id="adminLoginForm">
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="adminPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('adminPassword')">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ -->
      <div id="participantPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:8px;text-align:center;font-size:1.3rem;">
          Ø£Ù‡Ù„Ø§Ù‹ <span id="participantDisplayName"></span> ğŸŒ™
        </h2>
        <div style="display:flex;gap:8px;margin:12px 0;">
          <button class="btn btn-secondary" onclick="showRecordingSection()" style="flex:1;">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</button>
          <button class="btn btn-secondary" onclick="showMessagesSection()" style="flex:1;position:relative;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„
            <span id="unreadBadge" class="unread-badge hidden"></span>
          </button>
        </div>
        <div id="recordingSection">
          <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;text-align:center;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
          <div class="record-type-grid">
            <div class="type-card selected" id="typeAudio" onclick="selectType('audio')">
              <div class="icon">ğŸ¤</div><h3>ØµÙˆØª</h3>
            </div>
            <div class="type-card" id="typeVideo" onclick="selectType('video')">
              <div class="icon">ğŸ¥</div><h3>ÙÙŠØ¯ÙŠÙˆ</h3>
            </div>
          </div>
          <div id="livePreview" class="live-preview hidden">
            <video id="liveVideo" autoplay muted playsinline></video>
          </div>
          <div class="recording-controls">
            <button class="btn btn-primary big-icon-btn" id="recordBtn" onclick="startRecording()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div id="recordingStatusBar" class="recording-status-bar hidden">
              <div class="rec-dot"></div>
              <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...</span>
              <span id="timer" style="margin-right:auto;font-family:monospace;">00:00</span>
            </div>
            <button class="btn btn-danger big-icon-btn hidden" id="stopBtn" onclick="stopRecording()">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
          </div>
          <div id="recordingPreview" class="recording-preview hidden">
            <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">ğŸ‘€ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© - Ø±Ø§Ø¬Ø¹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸</h3>
            <div id="previewMedia"></div>
            <button class="btn btn-primary" id="saveBtn" onclick="saveRecording()" style="margin-top:12px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn btn-secondary" onclick="cancelRecording()">ğŸ”„ Ø¥Ù„ØºØ§Ø¡ ÙˆØ¥Ø¹Ø§Ø¯Ø©</button>
          </div>
          <div style="margin-top:20px;">
            <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">ğŸ“‚ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ</h3>
            <div id="myRecordingsList"></div>
          </div>
        </div>
        <div id="messagesSection" class="hidden">
          <h3 style="color:var(--dark-green);margin-bottom:12px;font-size:1.1rem;">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h3>
          <div id="messagesList"></div>
        </div>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù„Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminParticipantsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>
        <div class="stats-container">
          <div class="stat-card">
            <div class="icon">ğŸ‘¥</div>
            <div class="number" id="totalParticipants">0</div>
            <div class="label">Ù…Ø´Ø§Ø±Ùƒ</div>
          </div>
          <div class="stat-card">
            <div class="icon">ğŸ™ï¸</div>
            <div class="number" id="totalRecordings">0</div>
            <div class="label">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠ</div>
          </div>
          <div class="stat-card">
            <div class="icon">ğŸ†•</div>
            <div class="number" id="newRecordings">0</div>
            <div class="label">Ø¬Ø¯ÙŠØ¯</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="showBroadcastModal()" style="margin-bottom:8px;">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</button>
        <button class="btn btn-secondary" onclick="showLeaderboard()" style="margin-bottom:10px;">ğŸ† Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</button>
        <div id="adminBroadcastsList" style="margin-bottom:12px;"></div>
        <div id="participantsList" class="participants-grid"></div>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù„Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminRecordingsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <button class="back-btn" onclick="backToParticipants()">â† Ø±Ø¬ÙˆØ¹</button>
        <h2 id="participantTitle" style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;"></h2>
        <div style="text-align:center;margin-bottom:12px;">
          <div class="total-rating-badge" id="totalRatingBadge">
            <span class="icon">â­</span>
            <span class="text">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span class="value" id="totalRatingValue">0</span>
            <span class="text">/</span>
            <span class="value" id="totalRatingMax">0</span>
          </div>
        </div>
        <div style="text-align:center;margin-bottom:12px;">
          <button class="btn btn-danger" onclick="confirmDeleteAccount()" style="width:auto;padding:10px 20px;font-size:0.9rem;">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
        </div>
        <div class="contact-info-section">
          <div class="contact-info-header">
            <span class="contact-info-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
            <button class="toggle-contact-btn" onclick="toggleContactInfo()"><span id="contactToggleText">Ø¹Ø±Ø¶</span></button>
          </div>
          <div id="contactInfoContent" class="contact-info-content hidden">
            <div class="info-row">
              <div><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value" id="contactName">-</div></div>
              <button class="copy-btn" onclick="copyToClipboard('name')">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
            <div class="info-row">
              <div><div class="info-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div class="info-value" id="contactPassword">-</div></div>
              <button class="copy-btn" onclick="copyToClipboard('password')">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
          </div>
        </div>
        <div id="adminSentMessages" style="margin-bottom:12px;"></div>
        <div id="adminRecordingsList"></div>
      </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ============================================================
      // Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
      // ============================================================
      const SUPABASE_URL = 'https://jimrkqewuafaoxmpmhbp.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppbXJrcWV3dWFmYW94bXBtaGJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODM1NzUsImV4cCI6MjA4NzI1OTU3NX0.Qihj4BnB0FErseE0j8Gq8ydbOf8Bu7lW2sRTfTudZ7Q';
      const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // ============================================================
      // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© - Ù…Ù†Ø¸Ù…Ø© Ø¨Ø´ÙƒÙ„ Ø§Ø­ØªØ±Ø§ÙÙŠ
      // ============================================================
      let currentUser = null;
      let isAdmin = false;
      let currentParticipant = null;

      // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      const recorder = {
        mediaRecorder: null,
        chunks: [],
        type: 'audio',      // 'audio' | 'video'
        timerInterval: null,
        startTime: null,
        previewStream: null,
        blob: null,         // Ø§Ù„Ø¨Ù„ÙˆØ¨ Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ø­ÙØ¸
        isSaving: false,    // Ù…Ù†Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
        isRecording: false  // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠØ©
      };

      // Ø­Ø§Ù„Ø© Ù…Ø³Ø¬Ù„ ØµÙˆØª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©)
      const adminVoice = {
        recorder: null,
        chunks: [],
        blob: null,
        timer: null
      };

      // Ø­Ø§Ù„Ø© Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
      const broadcastVoice = {
        recorder: null,
        chunks: [],
        blob: null,
        timer: null
      };

      // Ù…ØªØºÙŠØ±Ø§Øª Ø£Ø®Ø±Ù‰
      let selectedRating = 0;
      let currentRecordingForMessage = null;
      let viewedRecordings = new Set();

      // ============================================================
      // Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØµÙˆØª/Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
      // ============================================================
      function getSupportedMimeType() {
        const types = ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg','audio/mp4',''];
        return types.find(t => !t || MediaRecorder.isTypeSupported(t)) || '';
      }

      function getSupportedVideoMimeType() {
        const types = ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4',''];
        return types.find(t => !t || MediaRecorder.isTypeSupported(t)) || '';
      }

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = () => reject(new Error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù'));
          reader.readAsDataURL(blob);
        });
      }

      function dataUriToObjectUrl(dataUri) {
        if (!dataUri) return '';
        if (!dataUri.startsWith('data:')) return dataUri;
        try {
          const [header, base64] = dataUri.split(',');
          if (!header || !base64) return dataUri;
          const mimeMatch = header.match(/:(.*?);/);
          const mimeType = mimeMatch ? mimeMatch[1] : 'audio/webm';
          const binary = atob(base64);
          const array = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) array[i] = binary.charCodeAt(i);
          const blob = new Blob([array], { type: mimeType });
          return URL.createObjectURL(blob);
        } catch(e) { return dataUri; }
      }

      function createMediaElement(data, type) {
        if (!data) return '<p style="color:#999;font-size:0.85rem;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ´ØºÙŠÙ„</p>';
        const url = dataUriToObjectUrl(data);
        if (type === 'video') {
          return `<video controls src="${url}" style="width:100%;border-radius:8px;background:#000;" preload="metadata"></video>`;
        }
        return `<audio controls src="${url}" style="width:100%;" preload="metadata"></audio>`;
      }

      // ============================================================
      // Ø§Ù„Ø¬Ù„Ø³Ø©
      // ============================================================
      function saveSession() {
        const session = isAdmin ? { isAdmin: true } : { isAdmin: false, userId: currentUser.id };
        localStorage.setItem('currentSession', JSON.stringify(session));
      }

      async function loadCurrentSession() {
        try {
          const raw = localStorage.getItem('currentSession');
          if (!raw) { showHomePage(); return; }
          const session = JSON.parse(raw);
          if (session.isAdmin) {
            isAdmin = true;
            showAdminParticipantsPage();
          } else {
            showLoading();
            const { data: user, error } = await db.from('participants').select('*').eq('id', session.userId).single();
            hideLoading();
            if (error || !user) { localStorage.removeItem('currentSession'); showHomePage(); return; }
            currentUser = user;
            showParticipantPage();
          }
        } catch(e) {
          localStorage.removeItem('currentSession');
          showHomePage();
        }
      }

      function loadViewedRecordings() {
        try {
          const stored = localStorage.getItem('viewedRecordings');
          if (stored) viewedRecordings = new Set(JSON.parse(stored));
        } catch(e) { viewedRecordings = new Set(); }
      }

      function saveViewedRecordings() {
        try { localStorage.setItem('viewedRecordings', JSON.stringify([...viewedRecordings])); } catch(e) {}
      }

      function markRecordingAsViewed(participantId, recordingId) {
        viewedRecordings.add(`${participantId}_${recordingId}`);
        saveViewedRecordings();
      }

      function isRecordingViewed(participantId, recordingId) {
        return viewedRecordings.has(`${participantId}_${recordingId}`);
      }

      // ============================================================
      // Loading
      // ============================================================
      function showLoading(msg) {
        if (document.getElementById('loadingOverlay')) return;
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>${msg || 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...'}</p></div>`;
        document.body.appendChild(overlay);
      }
      function hideLoading() {
        const el = document.getElementById('loadingOverlay');
        if (el) el.remove();
      }

      // ============================================================
      // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
      // ============================================================
      const ALL_PAGES = ['homePage','registerPage','loginPage','adminLoginPage','participantPage','adminParticipantsPage','adminRecordingsPage'];

      function hideAllPages() {
        ALL_PAGES.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add('hidden');
        });
      }

      function showHomePage() {
        stopVideoPreview();
        hideAllPages();
        document.getElementById('homePage').classList.remove('hidden');
      }
      function showRegisterPage() {
        hideAllPages();
        document.getElementById('registerPage').classList.remove('hidden');
      }
      function showLoginPage() {
        hideAllPages();
        document.getElementById('loginPage').classList.remove('hidden');
      }
      function showAdminLogin() {
        hideAllPages();
        document.getElementById('adminLoginPage').classList.remove('hidden');
      }

      function showParticipantPage() {
        hideAllPages();
        document.getElementById('participantPage').classList.remove('hidden');
        document.getElementById('participantDisplayName').textContent = currentUser.name;
        // ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        resetRecordingUI();
        showRecordingSection();
        loadMyRecordings();
        updateUnreadBadge();
      }

      async function showAdminParticipantsPage() {
        hideAllPages();
        document.getElementById('adminParticipantsPage').classList.remove('hidden');
        await loadParticipants();
        await loadAdminBroadcasts();
      }

      async function showAdminRecordingsPage(participant) {
        hideAllPages();
        currentParticipant = participant;
        document.getElementById('adminRecordingsPage').classList.remove('hidden');
        document.getElementById('participantTitle').textContent = 'ØªØ³Ø¬ÙŠÙ„Ø§Øª: ' + participant.name;
        document.getElementById('contactName').textContent = participant.name;
        document.getElementById('contactPassword').textContent = participant.password;
        await calculateAndDisplayTotalRating();
        await loadParticipantRecordings();
        await loadAdminSentMessages();
      }

      function backToParticipants() {
        currentParticipant = null;
        const contactContent = document.getElementById('contactInfoContent');
        if (contactContent && !contactContent.classList.contains('hidden')) toggleContactInfo();
        showAdminParticipantsPage();
      }

      function showRecordingSection() {
        document.getElementById('recordingSection').classList.remove('hidden');
        document.getElementById('messagesSection').classList.add('hidden');
        // Ø£Ø¹Ø¯ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ù† ÙƒØ§Ù† Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø­Ø¯Ø¯Ø§Ù‹
        if (recorder.type === 'video' && !recorder.previewStream) startVideoPreview();
      }

      async function showMessagesSection() {
        document.getElementById('recordingSection').classList.add('hidden');
        document.getElementById('messagesSection').classList.remove('hidden');
        stopVideoPreview();
        await loadMessages();
        await markMessagesAsRead();
      }

      function logout() {
        stopAllRecording();
        stopVideoPreview();
        localStorage.removeItem('currentSession');
        currentUser = null; isAdmin = false; currentParticipant = null;
        showHomePage();
      }

      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target;
        if (input.type === 'password') { input.type = 'text'; icon.textContent = 'ğŸ™ˆ'; }
        else { input.type = 'password'; icon.textContent = 'ğŸ‘ï¸'; }
      }

      // ============================================================
      // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ/Ø§Ù„Ù…Ø±Ø¦ÙŠ - Ù…ÙØµÙ„Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
      // ============================================================
      function selectType(type) {
        recorder.type = type;
        document.getElementById('typeAudio').classList.toggle('selected', type === 'audio');
        document.getElementById('typeVideo').classList.toggle('selected', type === 'video');
        if (type === 'video') startVideoPreview();
        else stopVideoPreview();
      }

      async function startVideoPreview() {
        if (recorder.previewStream) return; // Ù„Ø§ ØªØ¹ÙŠØ¯ Ø§Ù„ÙØªØ­ Ø¥Ù† ÙƒØ§Ù†Øª ØªØ¹Ù…Ù„
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          recorder.previewStream = stream;
          const liveVideo = document.getElementById('liveVideo');
          liveVideo.srcObject = stream;
          document.getElementById('livePreview').classList.remove('hidden');
        } catch(err) {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
        }
      }

      function stopVideoPreview() {
        if (recorder.previewStream) {
          recorder.previewStream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
          recorder.previewStream = null;
          const liveVideo = document.getElementById('liveVideo');
          if (liveVideo) liveVideo.srcObject = null;
          const livePreview = document.getElementById('livePreview');
          if (livePreview) livePreview.classList.add('hidden');
        }
      }

      function stopAllRecording() {
        if (recorder.mediaRecorder && recorder.mediaRecorder.state !== 'inactive') {
          try { recorder.mediaRecorder.stop(); } catch(e) {}
        }
        clearInterval(recorder.timerInterval);
        recorder.isRecording = false;
      }

      function resetRecordingUI() {
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· ÙƒØ§Ù…Ù„Ø© Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        const recordBtn = document.getElementById('recordBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusBar = document.getElementById('recordingStatusBar');
        const timer = document.getElementById('timer');
        const preview = document.getElementById('recordingPreview');
        const livePreview = document.getElementById('livePreview');

        if (recordBtn) { recordBtn.classList.remove('hidden'); recordBtn.disabled = false; }
        if (stopBtn) stopBtn.classList.add('hidden');
        if (statusBar) statusBar.classList.add('hidden');
        if (timer) timer.textContent = '00:00';
        if (preview) preview.classList.add('hidden');
        if (livePreview) livePreview.classList.remove('recording');

        // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø¬Ù„
        recorder.chunks = [];
        recorder.blob = null;
        recorder.isSaving = false;
        recorder.isRecording = false;
        clearInterval(recorder.timerInterval);
      }

      async function startRecording() {
        // Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        if (recorder.isRecording) return;

        try {
          let stream;
          if (recorder.type === 'video') {
            if (recorder.previewStream) {
              const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
              stream = new MediaStream([
                ...recorder.previewStream.getVideoTracks(),
                ...audioStream.getAudioTracks()
              ]);
            } else {
              stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            }
          } else {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          }

          // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ‡ÙŠØ¦Ø© ÙƒØ§Ù…Ù„Ø©
          recorder.chunks = [];
          recorder.blob = null;
          recorder.isSaving = false;
          recorder.isRecording = true;

          const mimeType = recorder.type === 'video' ? getSupportedVideoMimeType() : getSupportedMimeType();
          try {
            recorder.mediaRecorder = mimeType
              ? new MediaRecorder(stream, { mimeType })
              : new MediaRecorder(stream);
          } catch(e) {
            recorder.mediaRecorder = new MediaRecorder(stream);
          }

          recorder.mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              recorder.chunks.push(e.data);
            }
          };

          recorder.mediaRecorder.onstop = () => {
            // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ØªØ±ÙŠÙ… (Ù„Ù„ØµÙˆØª ÙÙ‚Ø· - Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¸Ù„ Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©)
            if (recorder.type === 'audio') {
              stream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            } else {
              // Ù„Ù„ÙÙŠØ¯ÙŠÙˆ: Ø£ÙˆÙ‚Ù ÙÙ‚Ø· tracks Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
              stream.getAudioTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            }
            recorder.isRecording = false;
            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ù„ÙˆØ¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
            if (recorder.chunks.length > 0) {
              const mType = recorder.mediaRecorder.mimeType || (recorder.type === 'video' ? 'video/webm' : 'audio/webm');
              recorder.blob = new Blob(recorder.chunks, { type: mType });
              showPreview(recorder.blob);
            } else {
              alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
              resetRecordingUI();
            }
          };

          recorder.mediaRecorder.start(250); // ÙƒÙ„ 250ms chunk

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
          document.getElementById('recordBtn').classList.add('hidden');
          document.getElementById('stopBtn').classList.remove('hidden');
          document.getElementById('recordingStatusBar').classList.remove('hidden');
          document.getElementById('recordingPreview').classList.add('hidden');
          if (recorder.type === 'video') {
            document.getElementById('livePreview').classList.remove('hidden');
            document.getElementById('livePreview').classList.add('recording');
          }

          // Ø§Ù„Ù…Ø¤Ù‚Øª
          recorder.startTime = Date.now();
          clearInterval(recorder.timerInterval);
          recorder.timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recorder.startTime) / 1000);
            const el = document.getElementById('timer');
            if (el) {
              const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
              const s = (elapsed % 60).toString().padStart(2, '0');
              el.textContent = `${m}:${s}`;
            }
          }, 1000);

        } catch(err) {
          recorder.isRecording = false;
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†/Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
        }
      }

      function stopRecording() {
        if (!recorder.isRecording || !recorder.mediaRecorder) return;
        if (recorder.mediaRecorder.state !== 'inactive') {
          try { recorder.mediaRecorder.stop(); } catch(e) {}
        }
        clearInterval(recorder.timerInterval);
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('recordingStatusBar').classList.add('hidden');
      }

      function cancelRecording() {
        stopAllRecording();
        stopVideoPreview();
        resetRecordingUI();
        // Ø£Ø¹Ø¯ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¥Ù† ÙƒØ§Ù† ÙÙŠØ¯ÙŠÙˆ
        if (recorder.type === 'video') {
          startVideoPreview();
        }
      }

      function showPreview(blob) {
        if (!blob || blob.size === 0) {
          alert('Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙØ§Ø±ØºØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
          resetRecordingUI();
          return;
        }
        const url = URL.createObjectURL(blob);
        const previewDiv = document.getElementById('previewMedia');
        if (recorder.type === 'video') {
          previewDiv.innerHTML = `<video controls src="${url}" style="width:100%;border-radius:8px;" preload="auto"></video>`;
        } else {
          previewDiv.innerHTML = `<audio controls src="${url}" style="width:100%;" preload="auto"></audio>`;
        }
        document.getElementById('recordingPreview').classList.remove('hidden');
        document.getElementById('livePreview').classList.remove('recording');
        document.getElementById('recordBtn').classList.remove('hidden');
        document.getElementById('stopBtn').classList.add('hidden');
        document.getElementById('recordingStatusBar').classList.add('hidden');
      }

      async function saveRecording() {
        // ======= Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙƒØ±Ø§Ø± =======
        if (recorder.isSaving) {
          console.warn('ØªØ¬Ø§Ù‡Ù„: Ø§Ù„Ø­ÙØ¸ Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„');
          return;
        }
        if (!recorder.blob || recorder.blob.size === 0) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
          return;
        }

        recorder.isSaving = true; // Ù‚ÙÙ„ ÙÙˆØ±ÙŠ
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; }

        showLoading('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');
        try {
          const blob = recorder.blob; // Ù†Ø³Ø®Ø© Ù…Ø±Ø¬Ø¹ÙŠØ© Ø«Ø§Ø¨ØªØ©

          // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù…
          if (blob.size > 10 * 1024 * 1024) {
            hideLoading();
            alert('Ø­Ø¬Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 10MB). ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.');
            recorder.isSaving = false;
            if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'; }
            return;
          }

          const base64Data = await blobToBase64(blob);

          const { data: saved, error } = await db.from('recordings').insert({
            participant_id: currentUser.id,
            type: recorder.type,
            data: base64Data
          }).select('id').single();

          if (error) throw error;

          hideLoading();
          alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!');

          // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
          recorder.blob = null;
          recorder.chunks = [];
          recorder.isSaving = false;
          resetRecordingUI();

          // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          await loadMyRecordings();

        } catch(err) {
          hideLoading();
          recorder.isSaving = false;
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„'; }
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + err.message);
        }
      }

      async function loadMyRecordings() {
        const listDiv = document.getElementById('myRecordingsList');
        if (!listDiv) return;

        listDiv.innerHTML = '<div style="text-align:center;padding:10px;color:#888;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        const { data: recordings, error } = await db
          .from('recordings')
          .select('id, type, data, created_at')
          .eq('participant_id', currentUser.id)
          .order('created_at', { ascending: true });

        if (error) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p></div>';
          return;
        }
        if (!recordings || recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</p></div>';
          return;
        }

        listDiv.innerHTML = recordings.map((rec, index) => `
          <div class="recording-item" id="recItem_${rec.id}">
            <div class="three-dots" onclick="showRecordingMenu(event, ${rec.id})">â‹®</div>
            <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;padding-left:30px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index + 1} - ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
            </p>
            <p class="recording-date">${new Date(rec.created_at).toLocaleDateString('ar-SA')}</p>
            ${createMediaElement(rec.data, rec.type)}
          </div>`).join('');
      }

      function showRecordingMenu(e, recordingId) {
        e.stopPropagation();
        document.querySelectorAll('.menu-popup').forEach(m => m.remove());
        const menu = document.createElement('div');
        menu.className = 'menu-popup';
        menu.innerHTML = `<div class="menu-item danger" onclick="confirmDeleteRecording(${recordingId})">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        const item = document.getElementById(`recItem_${recordingId}`);
        if (item) item.appendChild(menu);
        setTimeout(() => {
          document.addEventListener('click', function closeMenu(ev) {
            if (!menu.contains(ev.target)) {
              menu.remove();
              document.removeEventListener('click', closeMenu);
            }
          });
        }, 10);
      }

      function confirmDeleteRecording(recordingId) {
        showConfirmDialog(
          'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
          'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.',
          async () => {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            try {
              await db.from('messages').delete().eq('recording_id', recordingId);
              await db.from('recordings').delete().eq('id', recordingId);
              hideLoading();
              closeConfirmDialog();
              await loadMyRecordings();
              await updateUnreadBadge();
            } catch(e) { hideLoading(); alert('Ø®Ø·Ø£: ' + e.message); }
          }
        );
      }

      // ============================================================
      // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ)
      // ============================================================
      async function updateUnreadBadge() {
        if (!currentUser) return;
        const { count } = await db.from('messages').select('id', { count: 'exact', head: true })
          .eq('participant_id', currentUser.id).eq('read', false);
        const badge = document.getElementById('unreadBadge');
        if (badge) {
          if (count > 0) { badge.textContent = count; badge.classList.remove('hidden'); }
          else badge.classList.add('hidden');
        }
      }

      async function markMessagesAsRead() {
        if (!currentUser) return;
        await db.from('messages').update({ read: true })
          .eq('participant_id', currentUser.id).eq('read', false);
        updateUnreadBadge();
      }

      async function loadMessages() {
        const listDiv = document.getElementById('messagesList');
        if (!listDiv) return;
        listDiv.innerHTML = '<div style="text-align:center;padding:10px;color:#888;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        const { data: messages, error } = await db.from('messages').select('*')
          .eq('participant_id', currentUser.id).order('created_at', { ascending: false });

        if (error || !messages || messages.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p></div>';
          return;
        }

        const { data: myRecordings } = await db.from('recordings').select('*').eq('participant_id', currentUser.id);

        let html = '';
        for (const msg of messages) {
          let typeIcon = 'âœ‰ï¸';
          if (msg.message_type === 'voice') typeIcon = 'ğŸ¤';
          if (msg.message_type === 'rating') typeIcon = 'â­';
          let linkedHtml = '';
          if (msg.recording_id && myRecordings) {
            const linked = myRecordings.find(r => r.id === msg.recording_id);
            if (linked && linked.data) {
              linkedHtml = `
                <div class="linked-recording">
                  <p>ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø±Ø¯Ù‘Øª Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©:</p>
                  ${createMediaElement(linked.data, linked.type)}
                </div>`;
            }
          }
          html += `
            <div class="message-item ${!msg.read ? 'unread' : ''}">
              <div class="message-header">
                <span style="color:var(--primary-gold);font-weight:700;font-size:1rem;">${typeIcon} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
                <span style="color:#666;font-size:0.75rem;">${new Date(msg.created_at).toLocaleDateString('ar-SA')}</span>
              </div>
              <div class="message-content">${msg.message || ''}</div>
              ${msg.message_type === 'voice' && msg.voice_data ? `
                <div class="message-recording">
                  <p style="color:var(--dark-green);font-weight:600;margin-bottom:6px;font-size:0.9rem;">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</p>
                  ${createMediaElement(msg.voice_data, 'audio')}
                </div>` : ''}
              ${msg.message_type === 'rating' && msg.rating ? `
                <div class="message-rating">
                  <p style="color:var(--dark-green);font-weight:700;margin-bottom:6px;font-size:1rem;">â­ ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>
                  <div class="message-stars">${generateStarsDisplay(msg.rating)}</div>
                  <p style="color:var(--dark-green);font-weight:700;font-size:1.3rem;margin-top:6px;">${msg.rating} / 5</p>
                </div>` : ''}
              ${linkedHtml}
            </div>`;
        }
        listDiv.innerHTML = html;
      }

      function generateStarsDisplay(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
          html += rating >= i ? '<span class="star filled">â­</span>' : '<span class="star" style="color:#ddd;">â­</span>';
        }
        return html;
      }

      // ============================================================
      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
      // ============================================================
      async function loadGlobalBroadcasts() {
        const bar = document.getElementById('globalBroadcastsBar');
        if (!bar) return;
        const { data, error } = await db.from('broadcasts').select('*').order('created_at', { ascending: false });
        if (error || !data || data.length === 0) { bar.innerHTML = ''; return; }
        bar.innerHTML = data.map(b => `
          <div class="broadcast-banner" style="margin-bottom:8px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
              <span style="font-size:1.3rem;">ğŸ“¢</span>
              <span style="color:var(--dark-green);font-weight:700;font-size:0.95rem;">Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
              <span style="color:#888;font-size:0.75rem;margin-right:auto;">${new Date(b.created_at).toLocaleDateString('ar-SA')}</span>
            </div>
            <div style="color:var(--text-dark);font-size:0.95rem;line-height:1.7;">${b.message || ''}</div>
            ${b.type === 'voice' && b.voice_data ? createMediaElement(b.voice_data, 'audio') : ''}
          </div>`).join('');
      }

      async function loadAdminBroadcasts() {
        const div = document.getElementById('adminBroadcastsList');
        if (!div) return;
        const { data, error } = await db.from('broadcasts').select('*').order('created_at', { ascending: false });
        if (error || !data || data.length === 0) { div.innerHTML = ''; return; }
        let html = `<h3 style="color:var(--dark-green);margin-bottom:8px;font-size:1rem;">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>`;
        for (const b of data) {
          html += `
            <div class="broadcast-banner" style="position:relative;">
              <button class="broadcast-delete-btn" onclick="deleteBroadcast(${b.id})">ğŸ—‘ï¸</button>
              <div class="broadcast-icon">ğŸ“¢</div>
              <div class="broadcast-title">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</div>
              <div class="broadcast-text">${b.message || ''}</div>
              ${b.type === 'voice' && b.voice_data ? createMediaElement(b.voice_data, 'audio') : ''}
              <div style="color:#888;font-size:0.78rem;margin-top:6px;">${new Date(b.created_at).toLocaleString('ar-SA')}</div>
            </div>`;
        }
        div.innerHTML = html;
      }

      async function deleteBroadcast(id) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
        showLoading();
        await db.from('broadcasts').delete().eq('id', id);
        hideLoading();
        await loadAdminBroadcasts();
        await loadGlobalBroadcasts();
      }

      function showBroadcastModal() {
        const modal = document.createElement('div');
        modal.className = 'message-modal';
        modal.id = 'broadcastModal';
        modal.innerHTML = `
          <div class="message-modal-content">
            <h3>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>
            <div class="message-type-btns" style="grid-template-columns:1fr 1fr;">
              <button class="message-type-btn active" id="bTypeText" onclick="switchBroadcastType('text')">âœï¸ Ù†ØµÙŠ</button>
              <button class="message-type-btn" id="bTypeVoice" onclick="switchBroadcastType('voice')">ğŸ¤ ØµÙˆØªÙŠ</button>
            </div>
            <div id="broadcastTextDiv"><textarea id="broadcastText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..."></textarea></div>
            <div id="broadcastVoiceDiv" class="voice-recorder hidden">
              <button class="btn btn-primary" id="bVoiceRecordBtn" onclick="startBroadcastVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <div class="timer hidden" id="bVoiceTimer">00:00</div>
              <button class="btn btn-danger hidden" id="bVoiceStopBtn" onclick="stopBroadcastVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
              <div id="bVoicePreviewDiv" class="hidden"><audio id="bVoicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-primary" onclick="sendBroadcast()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
              <button class="btn btn-secondary" onclick="closeBroadcastModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }

      function switchBroadcastType(type) {
        document.getElementById('bTypeText').classList.toggle('active', type === 'text');
        document.getElementById('bTypeVoice').classList.toggle('active', type === 'voice');
        document.getElementById('broadcastTextDiv').classList.toggle('hidden', type !== 'text');
        document.getElementById('broadcastVoiceDiv').classList.toggle('hidden', type !== 'voice');
      }

      async function startBroadcastVoice() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          broadcastVoice.chunks = [];
          broadcastVoice.blob = null;
          const mimeType = getSupportedMimeType();
          broadcastVoice.recorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
          broadcastVoice.recorder.ondataavailable = e => { if (e.data && e.data.size > 0) broadcastVoice.chunks.push(e.data); };
          broadcastVoice.recorder.onstop = () => {
            stream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            if (broadcastVoice.chunks.length > 0) {
              broadcastVoice.blob = new Blob(broadcastVoice.chunks, { type: broadcastVoice.recorder.mimeType || 'audio/webm' });
              const url = URL.createObjectURL(broadcastVoice.blob);
              const prev = document.getElementById('bVoicePreview');
              if (prev) prev.src = url;
              const div = document.getElementById('bVoicePreviewDiv');
              if (div) div.classList.remove('hidden');
            }
          };
          broadcastVoice.recorder.start(250);
          document.getElementById('bVoiceRecordBtn').classList.add('hidden');
          document.getElementById('bVoiceStopBtn').classList.remove('hidden');
          document.getElementById('bVoiceTimer').classList.remove('hidden');
          const startTime = Date.now();
          broadcastVoice.timer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const el = document.getElementById('bVoiceTimer');
            if (el) {
              const m = Math.floor(elapsed/60).toString().padStart(2,'0');
              const s = (elapsed%60).toString().padStart(2,'0');
              el.textContent = `${m}:${s}`;
            }
          }, 1000);
        } catch(err) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message); }
      }

      function stopBroadcastVoice() {
        if (broadcastVoice.recorder && broadcastVoice.recorder.state !== 'inactive') {
          broadcastVoice.recorder.stop();
          clearInterval(broadcastVoice.timer);
          const recordBtn = document.getElementById('bVoiceRecordBtn');
          const stopBtn = document.getElementById('bVoiceStopBtn');
          const timer = document.getElementById('bVoiceTimer');
          if (recordBtn) recordBtn.classList.remove('hidden');
          if (stopBtn) stopBtn.classList.add('hidden');
          if (timer) { timer.classList.add('hidden'); timer.textContent = '00:00'; }
        }
      }

      async function sendBroadcast() {
        const isVoice = document.getElementById('bTypeVoice') && document.getElementById('bTypeVoice').classList.contains('active');
        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        try {
          let broadcastData = { type: isVoice ? 'voice' : 'text' };
          if (isVoice) {
            if (!broadcastVoice.blob) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!'); return; }
            broadcastData.message = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ“¢';
            broadcastData.voice_data = await blobToBase64(broadcastVoice.blob);
          } else {
            const text = document.getElementById('broadcastText').value.trim();
            if (!text) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†!'); return; }
            broadcastData.message = text;
          }
          const { error } = await db.from('broadcasts').insert(broadcastData);
          if (error) throw error;
          hideLoading();
          closeBroadcastModal();
          await loadAdminBroadcasts();
          await loadGlobalBroadcasts();
          alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ø¬Ù…ÙŠØ¹!');
        } catch(e) { hideLoading(); alert('Ø®Ø·Ø£: ' + e.message); }
      }

      function closeBroadcastModal() {
        const modal = document.getElementById('broadcastModal');
        if (modal) modal.remove();
        broadcastVoice.chunks = [];
        broadcastVoice.blob = null;
        if (broadcastVoice.recorder && broadcastVoice.recorder.state !== 'inactive') {
          try { broadcastVoice.recorder.stop(); } catch(e) {}
        }
        clearInterval(broadcastVoice.timer);
      }

      // ============================================================
      // Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
      // ============================================================
      document.getElementById('registerForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('participantName').value.trim();
        const password = document.getElementById('password').value;
        const errDiv = document.getElementById('registerError');
        errDiv.classList.add('hidden');
        if (!name || !password) { errDiv.textContent = 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!'; errDiv.classList.remove('hidden'); return; }
        showLoading();
        try {
          const { data: existing } = await db.from('participants').select('id').eq('name', name);
          if (existing && existing.length > 0) {
            hideLoading();
            errDiv.textContent = 'Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø¬Ø±Ø¨ Ø§Ø³Ù…Ø§Ù‹ Ø¢Ø®Ø± Ø£Ùˆ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„.';
            errDiv.classList.remove('hidden');
            return;
          }
          const { data: newUser, error } = await db.from('participants').insert({ name, password }).select().single();
          if (error) throw error;
          currentUser = newUser;
          saveSession();
          hideLoading();
          showParticipantPage();
        } catch(err) { hideLoading(); alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + err.message); }
      };

      document.getElementById('loginForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('loginName').value.trim();
        const password = document.getElementById('loginPassword').value;
        if (!name || !password) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!'); return; }
        showLoading();
        const { data, error } = await db.from('participants').select('*').eq('name', name).eq('password', password).single();
        hideLoading();
        if (error || !data) {
          const err = document.getElementById('loginError');
          err.textContent = 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
          err.classList.remove('hidden');
          setTimeout(() => err.classList.add('hidden'), 4000);
          return;
        }
        currentUser = data;
        saveSession();
        showParticipantPage();
      };

      document.getElementById('adminLoginForm').onsubmit = function(e) {
        e.preventDefault();
        const password = document.getElementById('adminPassword').value;
        if (password === 'Qur@n2025#Admin$Ramadan') {
          isAdmin = true;
          saveSession();
          showAdminParticipantsPage();
        } else {
          const err = document.getElementById('adminError');
          err.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
          err.classList.remove('hidden');
          setTimeout(() => err.classList.add('hidden'), 4000);
        }
      };

      // ============================================================
      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©)
      // ============================================================
      async function loadParticipants() {
        showLoading();
        const { data: participants, error } = await db.from('participants').select('*').order('name');
        const { data: allRecordings } = await db.from('recordings').select('id, participant_id, created_at').order('created_at');
        hideLoading();

        const listDiv = document.getElementById('participantsList');
        if (error || !participants || participants.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>';
          updateAdminStats(0, 0, 0);
          return;
        }

        let totalRec = 0, newRec = 0;
        window._participantsCache = {};
        participants.forEach(p => {
          p.recordings = (allRecordings || []).filter(r => r.participant_id === p.id);
          totalRec += p.recordings.length;
          p.recordings.forEach(rec => { if (!isRecordingViewed(p.id, rec.id)) newRec++; });
          window._participantsCache[p.id] = p;
        });

        updateAdminStats(participants.length, totalRec, newRec);
        listDiv.innerHTML = participants.map(p => {
          const newCount = p.recordings.filter(rec => !isRecordingViewed(p.id, rec.id)).length;
          return `
            <div class="participant-card" data-pid="${p.id}">
              ${newCount > 0 ? `<div class="new-recordings-badge">${newCount}</div>` : ''}
              <div class="icon">ğŸ‘¤</div>
              <h3>${p.name}</h3>
              <p class="count">${p.recordings.length} ØªØ³Ø¬ÙŠÙ„</p>
            </div>`;
        }).join('');

        listDiv.querySelectorAll('.participant-card').forEach(card => {
          card.addEventListener('click', function() {
            const pid = parseInt(this.getAttribute('data-pid'));
            const p = window._participantsCache[pid];
            if (p) showAdminRecordingsPage(p);
          });
        });
      }

      function updateAdminStats(p, r, n) {
        document.getElementById('totalParticipants').textContent = p;
        document.getElementById('totalRecordings').textContent = r;
        document.getElementById('newRecordings').textContent = n;
      }

      async function loadParticipantRecordings() {
        const listDiv = document.getElementById('adminRecordingsList');
        if (!listDiv) return;
        listDiv.innerHTML = '<div style="text-align:center;padding:10px;color:#888;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

        const { data: recordings, error } = await db.from('recordings').select('*')
          .eq('participant_id', currentParticipant.id)
          .order('created_at', { ascending: true });

        if (error || !recordings || recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</p></div>';
          return;
        }

        // ØªØ¹Ù„ÙŠÙ… ÙƒÙ…Ø´Ø§Ù‡Ø¯Ø©
        recordings.forEach(rec => markRecordingAsViewed(currentParticipant.id, rec.id));

        listDiv.innerHTML = recordings.map((rec, index) => `
          <div class="recording-item" id="adminRecItem_${rec.id}">
            <div class="three-dots" onclick="showAdminRecordingMenu(event, ${rec.id})">â‹®</div>
            <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;padding-left:30px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index + 1} - ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
            </p>
            <p class="recording-date">${new Date(rec.created_at).toLocaleDateString('ar-SA')}</p>
            ${createMediaElement(rec.data, rec.type)}
          </div>`).join('');
      }

      function showAdminRecordingMenu(e, recordingId) {
        e.stopPropagation();
        document.querySelectorAll('.menu-popup').forEach(m => m.remove());
        const menu = document.createElement('div');
        menu.className = 'menu-popup';
        menu.innerHTML = `
          <div class="menu-item" onclick="openMessageModal(${recordingId}, 'text')">âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal(${recordingId}, 'voice')">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal(${recordingId}, 'rating')">â­ ØªÙ‚ÙŠÙŠÙ…</div>
          <div class="menu-item danger" onclick="confirmDeleteRecordingAdmin(${recordingId})">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        const item = document.getElementById(`adminRecItem_${recordingId}`);
        if (item) item.appendChild(menu);
        setTimeout(() => {
          document.addEventListener('click', function closeMenu(ev) {
            if (!menu.contains(ev.target)) { menu.remove(); document.removeEventListener('click', closeMenu); }
          });
        }, 10);
      }

      async function loadAdminSentMessages() {
        const div = document.getElementById('adminSentMessages');
        if (!div) return;
        const { data: messages } = await db.from('messages').select('*')
          .eq('participant_id', currentParticipant.id).order('created_at', { ascending: false });
        if (!messages || messages.length === 0) { div.innerHTML = ''; return; }
        let html = `<h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1rem;">ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>`;
        for (const msg of messages) {
          let typeIcon = msg.message_type === 'voice' ? 'ğŸ¤' : msg.message_type === 'rating' ? 'â­' : 'âœ‰ï¸';
          html += `
            <div class="admin-msg-item">
              <button class="msg-delete-btn" onclick="deleteMessage(${msg.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <p style="color:var(--dark-green);font-weight:700;font-size:0.9rem;margin-bottom:4px;margin-left:55px;">${typeIcon} ${msg.message || ''}</p>
              <p style="color:#888;font-size:0.78rem;">${new Date(msg.created_at).toLocaleString('ar-SA')}</p>
              ${msg.message_type === 'voice' && msg.voice_data ? `<div style="margin-top:8px;">${createMediaElement(msg.voice_data, 'audio')}</div>` : ''}
              ${msg.message_type === 'rating' && msg.rating ? `<div style="margin-top:6px;color:var(--dark-green);font-weight:700;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${msg.rating} / 5 â­</div>` : ''}
            </div>`;
        }
        div.innerHTML = html;
      }

      async function deleteMessage(msgId) {
        if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
        showLoading();
        await db.from('messages').delete().eq('id', msgId);
        hideLoading();
        await loadAdminSentMessages();
        await calculateAndDisplayTotalRating();
      }

      async function calculateAndDisplayTotalRating() {
        const { data: ratings } = await db.from('messages').select('rating, recording_id')
          .eq('participant_id', currentParticipant.id)
          .eq('message_type', 'rating').not('rating', 'is', null);
        let total = 0;
        const ratedSet = new Set();
        if (ratings) {
          ratings.forEach(r => {
            if (!ratedSet.has(r.recording_id)) {
              total += r.rating;
              ratedSet.add(r.recording_id);
            }
          });
        }
        document.getElementById('totalRatingValue').textContent = total.toFixed(1);
        document.getElementById('totalRatingMax').textContent = ratedSet.size * 5;
        document.getElementById('totalRatingBadge').style.display = ratedSet.size === 0 ? 'none' : 'inline-flex';
      }

      // ============================================================
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ (Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©)
      // ============================================================
      function openMessageModal(recordingId, type) {
        currentRecordingForMessage = recordingId;
        selectedRating = 0;
        adminVoice.chunks = [];
        adminVoice.blob = null;

        const modal = document.createElement('div');
        modal.className = 'message-modal';
        modal.id = 'messageModal';
        modal.innerHTML = `
          <div class="message-modal-content">
            <h3>ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
            <div class="message-type-btns">
              <button class="message-type-btn ${type==='text'?'active':''}" id="mTypeText" onclick="switchMessageType('text')">âœï¸ Ù†ØµÙŠØ©</button>
              <button class="message-type-btn ${type==='voice'?'active':''}" id="mTypeVoice" onclick="switchMessageType('voice')">ğŸ¤ ØµÙˆØªÙŠØ©</button>
              <button class="message-type-btn ${type==='rating'?'active':''}" id="mTypeRating" onclick="switchMessageType('rating')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
            </div>
            <div id="textMessageDiv" class="${type!=='text'?'hidden':''}">
              <textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>
            <div id="voiceMessageDiv" class="voice-recorder ${type!=='voice'?'hidden':''}">
              <button class="btn btn-primary" id="voiceRecordBtn" onclick="startAdminVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <div class="timer hidden" id="voiceTimer">00:00</div>
              <button class="btn btn-danger hidden" id="voiceStopBtn" onclick="stopAdminVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
              <div id="voicePreviewDiv" class="hidden"><audio id="voicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
            </div>
            <div id="ratingMessageDiv" class="rating-container ${type!=='rating'?'hidden':''}">
              <p style="color:var(--dark-green);font-weight:700;font-size:1.1rem;margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
              <div class="stars-display" id="starsDisplay">
                ${[1,2,3,4,5].map(i => `<span class="star" onclick="setRating(${i})" data-value="${i}">â­</span>`).join('')}
              </div>
              <div class="rating-value" id="ratingValue">0 / 5</div>
              <div class="rating-buttons">
                ${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(val =>
                  `<button class="rating-btn" onclick="setRating(${val})">${val}</button>`).join('')}
              </div>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-primary" id="sendMsgBtn" onclick="sendMessageToParticipant()">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„</button>
              <button class="btn btn-secondary" onclick="closeMessageModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }

      function switchMessageType(type) {
        ['text','voice','rating'].forEach(t => {
          const btn = document.getElementById(`mType${t.charAt(0).toUpperCase()+t.slice(1)}`);
          if (btn) btn.classList.toggle('active', t === type);
        });
        document.getElementById('textMessageDiv').classList.toggle('hidden', type !== 'text');
        document.getElementById('voiceMessageDiv').classList.toggle('hidden', type !== 'voice');
        document.getElementById('ratingMessageDiv').classList.toggle('hidden', type !== 'rating');
      }

      function setRating(value) {
        selectedRating = value;
        document.getElementById('ratingValue').textContent = `${value} / 5`;
        document.querySelectorAll('#starsDisplay .star').forEach((star, index) => {
          star.classList.toggle('filled', value >= index + 1);
        });
        document.querySelectorAll('.rating-btn').forEach(btn => {
          btn.classList.toggle('active', parseFloat(btn.textContent) === value);
        });
      }

      async function startAdminVoice() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          adminVoice.chunks = [];
          adminVoice.blob = null;
          const mimeType = getSupportedMimeType();
          adminVoice.recorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
          adminVoice.recorder.ondataavailable = e => { if (e.data && e.data.size > 0) adminVoice.chunks.push(e.data); };
          adminVoice.recorder.onstop = () => {
            stream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            if (adminVoice.chunks.length > 0) {
              adminVoice.blob = new Blob(adminVoice.chunks, { type: adminVoice.recorder.mimeType || 'audio/webm' });
              const url = URL.createObjectURL(adminVoice.blob);
              const prev = document.getElementById('voicePreview');
              if (prev) prev.src = url;
              const div = document.getElementById('voicePreviewDiv');
              if (div) div.classList.remove('hidden');
            }
          };
          adminVoice.recorder.start(250);
          document.getElementById('voiceRecordBtn').classList.add('hidden');
          document.getElementById('voiceStopBtn').classList.remove('hidden');
          document.getElementById('voiceTimer').classList.remove('hidden');
          const startTime = Date.now();
          adminVoice.timer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const el = document.getElementById('voiceTimer');
            if (el) {
              const m = Math.floor(elapsed/60).toString().padStart(2,'0');
              const s = (elapsed%60).toString().padStart(2,'0');
              el.textContent = `${m}:${s}`;
            }
          }, 1000);
        } catch(err) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message); }
      }

      function stopAdminVoice() {
        if (adminVoice.recorder && adminVoice.recorder.state !== 'inactive') {
          adminVoice.recorder.stop();
          clearInterval(adminVoice.timer);
          const btn = document.getElementById('voiceRecordBtn');
          const stopBtn = document.getElementById('voiceStopBtn');
          const timer = document.getElementById('voiceTimer');
          if (btn) btn.classList.remove('hidden');
          if (stopBtn) stopBtn.classList.add('hidden');
          if (timer) { timer.classList.add('hidden'); timer.textContent = '00:00'; }
        }
      }

      async function sendMessageToParticipant() {
        const sendBtn = document.getElementById('sendMsgBtn');
        if (sendBtn && sendBtn.disabled) return;
        if (sendBtn) sendBtn.disabled = true;

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø´Ø·Ø©
        let messageType = 'text';
        if (document.getElementById('mTypeVoice') && document.getElementById('mTypeVoice').classList.contains('active')) messageType = 'voice';
        if (document.getElementById('mTypeRating') && document.getElementById('mTypeRating').classList.contains('active')) messageType = 'rating';

        showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        try {
          let msgData = {
            participant_id: currentParticipant.id,
            recording_id: currentRecordingForMessage,
            message_type: messageType,
            read: false
          };
          if (messageType === 'text') {
            const text = document.getElementById('messageText').value.trim();
            if (!text) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©!'); if (sendBtn) sendBtn.disabled = false; return; }
            msgData.message = text;
          } else if (messageType === 'voice') {
            if (!adminVoice.blob) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!'); if (sendBtn) sendBtn.disabled = false; return; }
            msgData.message = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ¤';
            msgData.voice_data = await blobToBase64(adminVoice.blob);
          } else if (messageType === 'rating') {
            if (selectedRating === 0) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…!'); if (sendBtn) sendBtn.disabled = false; return; }
            // Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù†ÙØ³ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            await db.from('messages').delete()
              .eq('participant_id', currentParticipant.id)
              .eq('recording_id', currentRecordingForMessage)
              .eq('message_type', 'rating');
            msgData.message = `ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selectedRating} / 5 Ù†Ø¬ÙˆÙ… â­`;
            msgData.rating = selectedRating;
          }

          const { error } = await db.from('messages').insert(msgData);
          if (error) throw error;
          hideLoading();
          closeMessageModal();
          if (messageType === 'rating') await calculateAndDisplayTotalRating();
          await loadAdminSentMessages();
          alert('âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!');
        } catch(err) {
          hideLoading();
          if (sendBtn) sendBtn.disabled = false;
          alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message);
        }
      }

      function closeMessageModal() {
        const modal = document.getElementById('messageModal');
        if (modal) modal.remove();
        adminVoice.chunks = [];
        adminVoice.blob = null;
        if (adminVoice.recorder && adminVoice.recorder.state !== 'inactive') {
          try { adminVoice.recorder.stop(); } catch(e) {}
        }
        clearInterval(adminVoice.timer);
        selectedRating = 0;
      }

      function confirmDeleteRecordingAdmin(recordingId) {
        showConfirmDialog(
          'âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
          'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.',
          async () => {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...');
            try {
              await db.from('messages').delete().eq('recording_id', recordingId);
              await db.from('recordings').delete().eq('id', recordingId);
              hideLoading();
              closeConfirmDialog();
              await calculateAndDisplayTotalRating();
              await loadAdminSentMessages();
              await loadParticipantRecordings();
            } catch(e) { hideLoading(); alert('Ø®Ø·Ø£: ' + e.message); }
          }
        );
      }

      function confirmDeleteAccount() {
        showConfirmDialog(
          'âš ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
          `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ <strong>${currentParticipant.name}</strong>ØŸ<br>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡ ÙˆØ±Ø³Ø§Ø¦Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.`,
          async () => {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨...');
            try {
              await db.from('messages').delete().eq('participant_id', currentParticipant.id);
              await db.from('recordings').delete().eq('participant_id', currentParticipant.id);
              await db.from('participants').delete().eq('id', currentParticipant.id);
              hideLoading();
              closeConfirmDialog();
              alert(`âœ… ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${currentParticipant.name}`);
              currentParticipant = null;
              showAdminParticipantsPage();
            } catch(e) { hideLoading(); alert('Ø®Ø·Ø£: ' + e.message); }
          }
        );
      }

      // ============================================================
      // Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ù…ÙˆØ­Ø¯Ø©)
      // ============================================================
      function showConfirmDialog(title, message, onConfirm) {
        closeConfirmDialog(); // Ø£Ø²Ù„ Ø£ÙŠ Ù†Ø§ÙØ°Ø© Ù‚Ø¯ÙŠÙ…Ø©
        const dialog = document.createElement('div');
        dialog.className = 'confirm-dialog';
        dialog.id = 'confirmDialog';
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>${title}</h3>
            <p>${message}</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" id="confirmYesBtn">ØªØ£ÙƒÙŠØ¯</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(dialog);
        document.getElementById('confirmYesBtn').onclick = onConfirm;
      }

      function closeConfirmDialog() {
        document.querySelectorAll('.confirm-dialog').forEach(d => d.remove());
      }

      // ============================================================
      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
      // ============================================================
      function toggleContactInfo() {
        const content = document.getElementById('contactInfoContent');
        const toggleText = document.getElementById('contactToggleText');
        if (content.classList.contains('hidden')) {
          content.classList.remove('hidden');
          toggleText.textContent = 'Ø¥Ø®ÙØ§Ø¡';
        } else {
          content.classList.add('hidden');
          toggleText.textContent = 'Ø¹Ø±Ø¶';
        }
      }

      async function copyToClipboard(type) {
        const textToCopy = type === 'name' ? currentParticipant.name : currentParticipant.password;
        const btn = event.target.closest('.copy-btn');
        try {
          await navigator.clipboard.writeText(textToCopy);
          const orig = btn.innerHTML;
          btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
          btn.classList.add('copied');
          setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
        } catch(err) { alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'); }
      }

      // ============================================================
      // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
      // ============================================================
      async function showLeaderboard() {
        showLoading();
        const { data: participants } = await db.from('participants').select('*');
        const { data: allRecordings } = await db.from('recordings').select('id, participant_id');
        const { data: ratings } = await db.from('messages').select('participant_id, recording_id, rating')
          .eq('message_type', 'rating').not('rating', 'is', null);
        hideLoading();

        const ratingMap = {};
        if (ratings) {
          ratings.forEach(r => {
            if (!ratingMap[r.participant_id]) ratingMap[r.participant_id] = { total: 0, ratedSet: new Set() };
            if (!ratingMap[r.participant_id].ratedSet.has(r.recording_id)) {
              ratingMap[r.participant_id].total += r.rating;
              ratingMap[r.participant_id].ratedSet.add(r.recording_id);
            }
          });
        }

        const ranked = (participants || []).map(p => {
          const recCount = (allRecordings || []).filter(r => r.participant_id === p.id).length;
          const rm = ratingMap[p.id] || { total: 0, ratedSet: new Set() };
          return { ...p, totalRating: rm.total, ratedCount: rm.ratedSet.size, recCount };
        }).sort((a, b) => b.totalRating - a.totalRating || b.ratedCount - a.ratedCount);

        const rankClass = i => i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
        const rankEmoji = i => i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);

        const rowsHtml = ranked.length === 0
          ? `<div style="text-align:center;padding:30px;color:#aaa;"><div style="font-size:3rem;">ğŸ†</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>`
          : ranked.map((p, i) => `
            <div class="leaderboard-row ${rankClass(i)}" style="animation-delay:${i*0.06}s">
              <div class="rank-badge">${rankEmoji(i)}</div>
              <div class="rank-info">
                <div class="rank-name">${p.name}</div>
                <div class="rank-details">${p.recCount} ØªØ³Ø¬ÙŠÙ„ â€¢ ${p.ratedCount} ØªÙ‚ÙŠÙŠÙ…</div>
                <div class="rank-stars">${p.ratedCount ? 'â­'.repeat(Math.floor(p.totalRating)).padEnd(5,'â˜†').slice(0,5) : '<span style="color:#bbb;font-size:0.8rem;">Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ…</span>'}</div>
              </div>
              <div class="rank-score">
                <div class="score-num">${p.totalRating > 0 ? p.totalRating.toFixed(1) : '-'}</div>
                ${p.ratedCount > 0 ? `<div class="score-label">Ù…Ù† ${p.ratedCount * 5}</div>` : '<div class="score-label">Ù†Ù‚Ø·Ø©</div>'}
              </div>
            </div>`).join('');

        const modal = document.createElement('div');
        modal.className = 'leaderboard-modal';
        modal.id = 'leaderboardModal';
        modal.innerHTML = `
          <div class="leaderboard-content">
            <div class="leaderboard-header">
              <button class="leaderboard-close" onclick="document.getElementById('leaderboardModal').remove()">âœ•</button>
              <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</h2>
              <p>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† 1446</p>
            </div>
            <div class="leaderboard-body">${rowsHtml}</div>
          </div>`;
        document.body.appendChild(modal);
        modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
      }

      // ============================================================
      // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      // ============================================================
      window.onload = async function() {
        loadViewedRecordings();
        await loadCurrentSession();
        await loadGlobalBroadcasts();
      };
    </script>
  </body>
</html>
