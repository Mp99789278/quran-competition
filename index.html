<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --gold: #d4af37;
      --dark-green: #0d4d3f;
      --medium-green: #1a6b54;
      --light-green: #e8f5e9;
      --cream: #fefdf8;
      --white: #ffffff;
      --text-dark: #2c2c2c;
      --border: #e0dfd5;
      --accent-gold: #f0c850;
    }
    body {
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%);
      min-height: 100vh;
      padding: 8px;
      overflow-x: hidden;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 8px; }
    .logo {
      width: 54px; height: 54px; margin: 0 auto 8px;
      background: linear-gradient(135deg, var(--gold), var(--accent-gold));
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.25); border: 2px solid rgba(255,255,255,0.5);
      font-size: 1.8rem;
    }
    h1 { font-family: "Amiri", serif; color: var(--white); font-size: 1.4rem; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
    .subtitle { color: var(--gold); font-size: 0.9rem; font-weight: 600; margin-top: 2px; }
    .card { background: var(--white); border-radius: 14px; padding: 16px 13px; box-shadow: 0 6px 25px rgba(0,0,0,0.15); margin-bottom: 8px; }
    .form-group { margin-bottom: 13px; position: relative; }
    label { display: block; color: var(--dark-green); font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 11px; border: 2px solid var(--border);
      border-radius: 8px; font-size: 0.95rem; font-family: "Cairo", sans-serif;
      transition: all 0.3s; background: var(--cream);
    }
    input:focus { outline: none; border-color: var(--gold); background: var(--white); }
    .password-input-wrapper { position: relative; }
    .password-toggle { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; color: #666; user-select: none; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; font-family: "Cairo", sans-serif; cursor: pointer; transition: all 0.3s; margin-bottom: 8px; }
    .btn-primary { background: linear-gradient(135deg, var(--gold), var(--accent-gold)); color: var(--dark-green); box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.5); }
    .btn-secondary { background: var(--dark-green); color: var(--white); box-shadow: 0 4px 15px rgba(13,77,63,0.3); }
    .btn-secondary:hover { background: var(--medium-green); transform: translateY(-2px); }
    .btn-danger { background: #dc2626; color: white; }
    .btn-danger:hover { background: #b91c1c; }
    .big-icon-btn { font-size: 1.3rem; padding: 16px; margin: 6px 0; }
    .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .stat-card { background: linear-gradient(135deg, var(--gold), var(--accent-gold)); padding: 10px; border-radius: 10px; text-align: center; }
    .stat-card .icon { font-size: 1.4rem; margin-bottom: 3px; }
    .stat-card .number { font-size: 1.5rem; font-weight: 900; color: var(--dark-green); }
    .stat-card .label { font-size: 0.75rem; color: var(--dark-green); font-weight: 600; }
    .record-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
    .type-card { background: white; border: 2px solid var(--border); border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.3s; }
    .type-card:hover, .type-card.selected { border-color: var(--gold); background: linear-gradient(to bottom, #fff9e6, white); }
    .type-card .icon { font-size: 2.5rem; margin-bottom: 6px; }
    .type-card h3 { font-size: 1rem; color: var(--dark-green); }
    .timer { text-align: center; font-size: 1.8rem; font-weight: 700; color: var(--dark-green); margin: 12px 0; font-family: monospace; }
    .live-preview { margin: 12px 0; padding: 10px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; border: 2px solid var(--gold); }
    .live-preview.recording { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #dc2626; }
    .live-preview video { width: 100%; border-radius: 8px; background: #000; }
    .recording-preview { margin: 12px 0; padding: 12px; background: linear-gradient(to bottom, #fff9e6, white); border-radius: 10px; border: 2px solid var(--gold); }
    .recording-preview video, .recording-preview audio { width: 100%; border-radius: 8px; margin-top: 10px; }
    .recording-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border); margin-bottom: 10px; position: relative; }
    .recording-item video, .recording-item audio { width: 100%; margin-top: 8px; border-radius: 8px; }
    .recording-date { color: #666; font-size: 0.8rem; margin-bottom: 8px; }
    .three-dots { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; cursor: pointer; color: #666; padding: 5px; }
    .menu-popup { position: absolute; top: 40px; left: 10px; background: white; border: 2px solid var(--gold); border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 100; min-width: 160px; }
    .menu-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; font-size: 0.9rem; transition: background 0.2s; }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:hover { background: var(--cream); }
    .menu-item.danger { color: #dc2626; }
    .logout-btn { position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); transition: all 0.3s; }
    .logout-btn:hover { background: var(--gold); color: white; }
    .back-btn { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); transition: all 0.3s; }
    .back-btn:hover { background: var(--gold); color: white; }
    .hidden { display: none !important; }
    .error-message { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
    .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
    .participant-card { background: white; padding: 12px 8px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s; text-align: center; position: relative; }
    .participant-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    .participant-card .icon { font-size: 2.2rem; margin-bottom: 6px; }
    .participant-card h3 { color: var(--dark-green); font-size: 0.95rem; margin-bottom: 5px; word-break: break-word; }
    .participant-card .count { color: #666; font-size: 0.8rem; }
    .new-recordings-badge { position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; border: 2px solid white; }
    .empty-state { text-align: center; padding: 25px 15px; color: #999; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
    .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-spinner { text-align: center; color: white; }
    .loading-spinner p { font-size: 0.95rem; font-weight: 600; margin-top: 8px; }
    .unread-badge { position: absolute; top: -6px; left: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }
    .message-item { background: linear-gradient(135deg, #fff9e6, white); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-right: 3px solid var(--gold); }
    .message-item.unread { background: linear-gradient(135deg, #fff4d6, #fff9e6); box-shadow: 0 3px 15px rgba(212,175,55,0.2); }
    .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border); }
    .message-content { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
    .message-recording { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border); }
    .linked-recording { background: linear-gradient(135deg, #e8f5e9, #f0fff4); padding: 12px; border-radius: 8px; margin-top: 10px; border: 2px solid #4caf50; }
    .linked-recording p { color: var(--dark-green); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
    .message-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
    .message-modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; }
    .message-modal h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
    .message-type-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
    .message-type-btn { padding: 10px; border: 2px solid var(--border); border-radius: 8px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
    .message-type-btn.active { background: linear-gradient(135deg, var(--gold), var(--accent-gold)); border-color: var(--gold); color: var(--dark-green); }
    .message-modal textarea { width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-family: "Cairo", sans-serif; font-size: 0.95rem; min-height: 100px; resize: vertical; }
    .voice-recorder { background: linear-gradient(to bottom, #f0f9ff, white); padding: 15px; border-radius: 8px; border: 2px solid var(--gold); }
    .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .message-rating { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px; border-radius: 8px; margin-top: 8px; text-align: center; border: 2px solid #fbbf24; }
    .message-stars { font-size: 2rem; margin: 8px 0; }
    .rating-container { background: linear-gradient(to bottom, #fff9e6, white); padding: 15px; border-radius: 8px; border: 2px solid var(--gold); text-align: center; }
    .stars-display { display: flex; justify-content: center; gap: 8px; margin: 15px 0; font-size: 2.5rem; }
    .star { cursor: pointer; transition: all 0.2s; color: #d1d5db; }
    .star.filled { color: #fbbf24; }
    .rating-value { font-size: 1.5rem; font-weight: 700; color: var(--dark-green); margin-top: 10px; }
    .rating-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 12px; }
    .rating-btn { padding: 8px; border: 2px solid var(--border); border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
    .rating-btn.active { background: linear-gradient(135deg, var(--gold), var(--accent-gold)); border-color: var(--gold); }
    .contact-info-section { background: linear-gradient(135deg, #dbeafe, #e0f2fe); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--gold); }
    .contact-info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .info-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
    .info-label { color: #666; font-size: 0.85rem; margin-bottom: 4px; }
    .info-value { color: var(--dark-green); font-size: 1rem; font-weight: 700; }
    .copy-btn { background: var(--dark-green); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s; }
    .copy-btn:hover { background: var(--medium-green); }
    .copy-btn.copied { background: #10b981; }
    .total-rating-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; border: 2px solid #fbbf24; }
    .broadcast-banner { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 14px; border-radius: 12px; margin-bottom: 8px; border: 2px solid #fbbf24; position: relative; }
    .broadcast-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
    .admin-msg-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border); margin-bottom: 10px; position: relative; }
    .msg-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; }
    .leaderboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display: flex; align-items: flex-start; justify-content: center; z-index: 2000; padding: 15px; overflow-y: auto; }
    .leaderboard-content { background: var(--white); border-radius: 16px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; }
    .leaderboard-header { background: linear-gradient(135deg, var(--dark-green), var(--medium-green)); padding: 20px 15px; text-align: center; position: relative; }
    .leaderboard-header h2 { color: var(--white); font-family: "Amiri", serif; font-size: 1.5rem; margin-bottom: 4px; }
    .leaderboard-header p { color: var(--gold); font-size: 0.85rem; }
    .leaderboard-close { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; }
    .leaderboard-body { padding: 15px; }
    .leaderboard-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 8px; border: 2px solid transparent; animation: popIn 0.3s ease both; }
    @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .leaderboard-row.rank-1 { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-color: #f59e0b; }
    .leaderboard-row.rank-2 { background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-color: #94a3b8; }
    .leaderboard-row.rank-3 { background: linear-gradient(135deg, #fff7ed, #ffedd5); border-color: #f97316; }
    .leaderboard-row.rank-other { background: var(--cream); border-color: var(--border); }
    .leaderboard-row.rank-mine { border-color: var(--gold) !important; box-shadow: 0 0 0 3px rgba(212,175,55,0.25); }
    .rank-badge { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 900; flex-shrink: 0; }
    .rank-1 .rank-badge { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
    .rank-2 .rank-badge { background: linear-gradient(135deg, #94a3b8, #cbd5e1); color: white; }
    .rank-3 .rank-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; }
    .rank-other .rank-badge { background: var(--light-green); color: var(--dark-green); font-size: 1rem; }
    .rank-info { flex: 1; }
    .rank-name { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 3px; }
    .rank-name .you-tag { background: var(--gold); color: var(--dark-green); border-radius: 8px; padding: 1px 7px; font-size: 0.72rem; font-weight: 700; margin-right: 6px; }
    .rank-details { color: #777; font-size: 0.8rem; }
    .rank-score { text-align: center; }
    .rank-score .score-num { font-size: 1.4rem; font-weight: 900; color: var(--dark-green); line-height: 1; }
    .rank-score .score-label { font-size: 0.7rem; color: #888; }
    .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; }
    .confirm-content { background: white; padding: 20px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center; }
    .confirm-content h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
    .confirm-content p { font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; }
    .confirm-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .progress-bar-wrapper { background: #e5e7eb; border-radius: 10px; height: 8px; margin: 8px 0; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, var(--gold), var(--accent-gold)); border-radius: 10px; transition: width 0.3s; }
    @media (max-width: 768px) {
      h1 { font-size: 1.2rem; }
      .logout-btn, .back-btn { padding: 6px 12px; font-size: 0.75rem; }
      .record-type-grid { grid-template-columns: 1fr; }
      .message-type-btns { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">ğŸŒ™</div>
    <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
    <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</p>
  </div>

  <div id="globalBroadcastsBar"></div>

  <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="homePage" class="card">
    <button class="btn btn-primary big-icon-btn" onclick="showPage('registerPage')">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
    <button class="btn btn-secondary big-icon-btn" onclick="showPage('loginPage')">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
    <button class="btn btn-secondary" onclick="showPage('adminLoginPage')" style="margin-top:10px;">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</button>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <div id="registerPage" class="card hidden">
    <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
    <div id="registerError" class="error-message hidden"></div>
    <form id="registerForm">
      <div class="form-group">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="participantName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="password-input-wrapper">
          <input type="password" id="regPassword" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
          <span class="password-toggle" onclick="togglePwd('regPassword', this)">ğŸ‘ï¸</span>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
    </form>
    <button class="btn btn-secondary" onclick="showPage('homePage')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div id="loginPage" class="card hidden">
    <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
    <div id="loginError" class="error-message hidden"></div>
    <form id="loginForm">
      <div class="form-group">
        <label>Ø§Ù„Ø§Ø³Ù…</label>
        <input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ" />
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="password-input-wrapper">
          <input type="password" id="loginPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          <span class="password-toggle" onclick="togglePwd('loginPassword', this)">ğŸ‘ï¸</span>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
    </form>
    <button class="btn btn-secondary" onclick="showPage('homePage')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© -->
  <div id="adminLoginPage" class="card hidden">
    <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h2>
    <div id="adminError" class="error-message hidden"></div>
    <form id="adminLoginForm">
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="password-input-wrapper">
          <input type="password" id="adminPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
          <span class="password-toggle" onclick="togglePwd('adminPassword', this)">ğŸ‘ï¸</span>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
    </form>
    <button class="btn btn-secondary" onclick="showPage('homePage')">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ -->
  <div id="participantPage" class="card hidden">
    <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <h2 style="color:var(--dark-green);margin-bottom:8px;text-align:center;font-size:1.3rem;">
      Ø£Ù‡Ù„Ø§Ù‹ <span id="participantDisplayName"></span> ğŸŒ™
    </h2>
    <div style="display:flex;gap:8px;margin:12px 0;">
      <button class="btn btn-secondary" onclick="showRecordingSection()" style="flex:1;">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</button>
      <button class="btn btn-secondary" onclick="showMessagesSection()" id="msgTabBtn" style="flex:1;position:relative;">
        ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„
        <span id="unreadBadge" class="unread-badge hidden"></span>
      </button>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div id="recordingSection">
      <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;text-align:center;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
      <div class="record-type-grid">
        <div class="type-card selected" onclick="selectType('audio', this)">
          <div class="icon">ğŸ¤</div><h3>ØµÙˆØª</h3>
        </div>
        <div class="type-card" onclick="selectType('video', this)">
          <div class="icon">ğŸ¥</div><h3>ÙÙŠØ¯ÙŠÙˆ</h3>
        </div>
      </div>
      <div id="livePreview" class="live-preview hidden">
        <video id="liveVideo" autoplay muted playsinline></video>
      </div>
      <div id="recordingControls">
        <button class="btn btn-primary big-icon-btn" id="recordBtn" onclick="startRecording()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <div class="timer hidden" id="timer">00:00</div>
        <button class="btn btn-danger big-icon-btn hidden" id="stopBtn" onclick="stopRecording()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
      </div>
      <div id="recordingPreview" class="recording-preview hidden">
        <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
        <div id="previewMedia"></div>
        <div id="uploadProgress" class="hidden" style="margin-top:12px;">
          <p style="color:var(--dark-green);font-size:0.9rem;margin-bottom:4px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...</p>
          <div class="progress-bar-wrapper"><div class="progress-bar" id="progressBar" style="width:0%"></div></div>
        </div>
        <button class="btn btn-primary" onclick="saveRecording()" style="margin-top:12px;" id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
        <button class="btn btn-secondary" onclick="cancelRecording()">ğŸ”„ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
      <div style="margin-top:20px;">
        <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ</h3>
        <div id="myRecordingsList"></div>
      </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div id="messagesSection" class="hidden">
      <h3 style="color:var(--dark-green);margin-bottom:12px;font-size:1.1rem;">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h3>
      <div id="messagesList"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©) -->
  <div id="adminParticipantsPage" class="card hidden">
    <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <h2 style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>
    <div class="stats-container">
      <div class="stat-card"><div class="icon">ğŸ‘¥</div><div class="number" id="totalParticipants">0</div><div class="label">Ù…Ø´Ø§Ø±Ùƒ</div></div>
      <div class="stat-card"><div class="icon">ğŸ™ï¸</div><div class="number" id="totalRecordings">0</div><div class="label">ØªØ³Ø¬ÙŠÙ„</div></div>
      <div class="stat-card"><div class="icon">ğŸ†•</div><div class="number" id="newRecordings">0</div><div class="label">Ø¬Ø¯ÙŠØ¯</div></div>
    </div>
    <button class="btn btn-primary" onclick="showBroadcastModal()" style="margin-bottom:8px;">ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</button>
    <button class="btn btn-secondary" onclick="showLeaderboard()" style="margin-bottom:10px;">ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</button>
    <div id="adminBroadcastsList" style="margin-bottom:12px;"></div>
    <div id="participantsList" class="participants-grid"></div>
  </div>

  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù…Ø¹ÙŠÙ† -->
  <div id="adminRecordingsPage" class="card hidden">
    <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    <button class="back-btn" onclick="backToParticipants()">â† Ø±Ø¬ÙˆØ¹</button>
    <h2 id="participantTitle" style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;"></h2>
    <div style="text-align:center;margin-bottom:12px;">
      <div class="total-rating-badge" id="totalRatingBadge" style="display:none;">
        <span>â­</span>
        <span style="color:var(--dark-green);font-weight:700;font-size:0.9rem;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
        <span style="color:var(--dark-green);font-weight:900;font-size:1.1rem;" id="totalRatingValue">0</span>
        <span style="color:var(--dark-green);font-weight:700;font-size:0.9rem;">/</span>
        <span style="color:var(--dark-green);font-weight:900;font-size:1.1rem;" id="totalRatingMax">0</span>
      </div>
    </div>
    <div style="text-align:center;margin-bottom:12px;">
      <button class="btn btn-danger" onclick="confirmDeleteAccount()" style="width:auto;padding:10px 20px;font-size:0.9rem;">ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</button>
    </div>
    <div class="contact-info-section">
      <div class="contact-info-header">
        <span style="color:var(--dark-green);font-weight:700;font-size:1rem;">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
        <button onclick="toggleContactInfo()" style="background:var(--gold);color:var(--dark-green);padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;font-weight:600;"><span id="contactToggleText">Ø¹Ø±Ø¶</span></button>
      </div>
      <div id="contactInfoContent" class="hidden" style="margin-top:10px;">
        <div class="info-row">
          <div><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-value" id="contactName">-</div></div>
          <button class="copy-btn" onclick="copyToClipboard('name')">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>
        <div class="info-row">
          <div><div class="info-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div class="info-value" id="contactPassword">-</div></div>
          <button class="copy-btn" onclick="copyToClipboard('password')">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>
      </div>
    </div>
    <div id="adminSentMessages" style="margin-bottom:12px;"></div>
    <div id="adminRecordingsList"></div>
  </div>
</div>

<script>
// =========================================================
// âš™ï¸ SUPABASE CONFIG
// =========================================================
const SUPABASE_URL = 'https://wofxloietgnbjviyyipl.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndvZnhsb2lldGduYmp2aXl5aXBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODgyNTYsImV4cCI6MjA4NzI2NDI1Nn0.z0Lft3dQTM3ej3CWE__emysgMFRQjL9ys74ceFuQwrM';
const STORAGE_BUCKET = 'recordings';

// =========================================================
// ğŸ”§ SUPABASE API HELPERS
// =========================================================
async function sbFetch(path, opts = {}) {
  const url = `${SUPABASE_URL}${path}`;
  const headers = {
    'apikey': SUPABASE_KEY,
    'Authorization': `Bearer ${SUPABASE_KEY}`,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation',
    ...opts.headers
  };
  const res = await fetch(url, { ...opts, headers });
  if (!res.ok) {
    let errText = await res.text();
    throw new Error(`Supabase error ${res.status}: ${errText}`);
  }
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json') && res.status !== 204) {
    return res.json();
  }
  return null;
}

// DB operations
const db = {
  async select(table, query = '') {
    return await sbFetch(`/rest/v1/${table}?${query}`, { method: 'GET' });
  },
  async insert(table, data) {
    return await sbFetch(`/rest/v1/${table}`, { method: 'POST', body: JSON.stringify(data) });
  },
  async update(table, data, query) {
    return await sbFetch(`/rest/v1/${table}?${query}`, { method: 'PATCH', body: JSON.stringify(data) });
  },
  async delete(table, query) {
    return await sbFetch(`/rest/v1/${table}?${query}`, { method: 'DELETE' });
  }
};

// Storage operations
const storage = {
  async upload(path, file, onProgress) {
    const url = `${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}/${path}`;

    return new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url);
      xhr.setRequestHeader('apikey', SUPABASE_KEY);
      xhr.setRequestHeader('Authorization', `Bearer ${SUPABASE_KEY}`);
      xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
      xhr.setRequestHeader('x-upsert', 'true');

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable && onProgress) {
          onProgress(Math.round((e.loaded / e.total) * 100));
        }
      };

      xhr.onload = () => {
        if (xhr.status >= 200 && xhr.status < 300) {
          resolve({ path });
        } else {
          reject(new Error(`Upload failed: ${xhr.status} ${xhr.responseText}`));
        }
      };
      xhr.onerror = () => reject(new Error('Network error during upload'));
      xhr.send(file);
    });
  },

  getPublicUrl(path) {
    return `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${path}`;
  },

  async delete(paths) {
    const url = `${SUPABASE_URL}/storage/v1/object/${STORAGE_BUCKET}`;
    const res = await fetch(url, {
      method: 'DELETE',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ prefixes: paths })
    });
    return res.ok;
  }
};

// =========================================================
// ğŸŒ STATE
// =========================================================
let currentUser = null;
let isAdmin = false;
let currentParticipant = null;
let mediaRecorder = null;
let recordedChunks = [];
let recordingType = 'audio';
let timerInterval = null;
let recordingStartTime = null;
let previewStream = null;
let selectedRating = 0;
let adminVoiceRecorder = null;
let adminVoiceChunks = [];
let adminVoiceTimer = null;
let adminVoiceBlob = null;
let currentRecordingForMessage = null;
let broadcastVoiceRecorder = null;
let broadcastVoiceChunks = [];
let broadcastVoiceTimerInterval = null;
let broadcastVoiceBlob = null;
let viewedRecordings = new Set();
let participantsCache = {};

// =========================================================
// ğŸš€ INIT
// =========================================================
window.onload = async function() {
  loadViewedRecordings();
  await loadCurrentSession();
  await loadGlobalBroadcasts();
};

async function loadCurrentSession() {
  try {
    const session = localStorage.getItem('currentSession');
    if (!session) { showPage('homePage'); return; }
    const data = JSON.parse(session);
    if (data.isAdmin) {
      isAdmin = true;
      await showAdminParticipantsPage();
    } else if (data.userId) {
      showLoading();
      const rows = await db.select('participants', `id=eq.${data.userId}`);
      hideLoading();
      if (rows && rows.length > 0) {
        currentUser = rows[0];
        showParticipantPage();
      } else {
        localStorage.removeItem('currentSession');
        showPage('homePage');
      }
    } else {
      showPage('homePage');
    }
  } catch(e) {
    localStorage.removeItem('currentSession');
    showPage('homePage');
  }
}

// =========================================================
// ğŸ“„ PAGE MANAGEMENT
// =========================================================
const pages = ['homePage','registerPage','loginPage','adminLoginPage','participantPage','adminParticipantsPage','adminRecordingsPage'];

function showPage(pageId) {
  pages.forEach(id => document.getElementById(id)?.classList.add('hidden'));
  document.getElementById(pageId)?.classList.remove('hidden');
}

function showParticipantPage() {
  showPage('participantPage');
  document.getElementById('participantDisplayName').textContent = currentUser.name;
  showRecordingSection();
  loadMyRecordings();
  updateUnreadBadge();
}

async function showAdminParticipantsPage() {
  showPage('adminParticipantsPage');
  await loadParticipants();
  await loadAdminBroadcasts();
}

function showRecordingSection() {
  document.getElementById('recordingSection').classList.remove('hidden');
  document.getElementById('messagesSection').classList.add('hidden');
}

async function showMessagesSection() {
  document.getElementById('recordingSection').classList.add('hidden');
  document.getElementById('messagesSection').classList.remove('hidden');
  stopVideoPreview();
  await loadMessages();
  await markMessagesAsRead();
}

function backToParticipants() {
  currentParticipant = null;
  showAdminParticipantsPage();
}

function logout() {
  stopVideoPreview();
  if (mediaRecorder && mediaRecorder.state !== 'inactive') try { mediaRecorder.stop(); } catch(e) {}
  clearInterval(timerInterval);
  localStorage.removeItem('currentSession');
  currentUser = null;
  isAdmin = false;
  currentParticipant = null;
  showPage('homePage');
}

function saveSession() {
  const session = isAdmin ? { isAdmin: true } : { isAdmin: false, userId: currentUser.id };
  localStorage.setItem('currentSession', JSON.stringify(session));
}

// =========================================================
// ğŸ“¢ BROADCASTS
// =========================================================
async function loadGlobalBroadcasts() {
  const bar = document.getElementById('globalBroadcastsBar');
  if (!bar) return;
  try {
    const rows = await db.select('broadcasts', 'order=created_at.desc');
    if (!rows || rows.length === 0) { bar.innerHTML = ''; return; }
    bar.innerHTML = rows.map(b => `
      <div class="broadcast-banner">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
          <span style="font-size:1.3rem;">ğŸ“¢</span>
          <span style="color:var(--dark-green);font-weight:700;font-size:0.95rem;">Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
          <span style="color:#888;font-size:0.75rem;margin-right:auto;">${formatDate(b.created_at)}</span>
        </div>
        <div style="color:var(--text-dark);font-size:0.95rem;line-height:1.7;">${b.message || ''}</div>
        ${b.voice_storage_path ? `<audio controls src="${storage.getPublicUrl(b.voice_storage_path)}" style="width:100%;margin-top:8px;border-radius:6px;"></audio>` : ''}
      </div>`).join('');
  } catch(e) { bar.innerHTML = ''; }
}

async function loadAdminBroadcasts() {
  const div = document.getElementById('adminBroadcastsList');
  try {
    const rows = await db.select('broadcasts', 'order=created_at.desc');
    if (!rows || rows.length === 0) { div.innerHTML = ''; return; }
    div.innerHTML = `<h3 style="color:var(--dark-green);margin-bottom:8px;font-size:1rem;">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>` +
      rows.map(b => `
        <div class="broadcast-banner" style="position:relative;">
          <button class="broadcast-delete-btn" onclick="deleteBroadcast('${b.id}')">ğŸ—‘ï¸</button>
          <div style="font-size:1.3rem;">ğŸ“¢</div>
          <div style="color:var(--dark-green);font-weight:700;">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</div>
          <div style="color:var(--text-dark);font-size:0.95rem;">${b.message || ''}</div>
          ${b.voice_storage_path ? `<audio controls src="${storage.getPublicUrl(b.voice_storage_path)}" style="width:100%;margin-top:8px;"></audio>` : ''}
          <div style="color:#888;font-size:0.78rem;margin-top:6px;">${formatDate(b.created_at)}</div>
        </div>`).join('');
  } catch(e) { div.innerHTML = ''; }
}

function showBroadcastModal() {
  const modal = document.createElement('div');
  modal.className = 'message-modal';
  modal.id = 'broadcastModal';
  modal.innerHTML = `
    <div class="message-modal-content">
      <h3>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>
      <div class="message-type-btns" style="grid-template-columns:1fr 1fr;">
        <button class="message-type-btn active" onclick="switchBroadcastType('text',this)">âœï¸ Ù†ØµÙŠ</button>
        <button class="message-type-btn" onclick="switchBroadcastType('voice',this)">ğŸ¤ ØµÙˆØªÙŠ</button>
      </div>
      <div id="broadcastTextDiv"><textarea id="broadcastText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†..."></textarea></div>
      <div id="broadcastVoiceDiv" class="voice-recorder hidden">
        <button class="btn btn-primary" id="bVoiceRecordBtn" onclick="startBroadcastVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <div class="timer hidden" id="bVoiceTimer">00:00</div>
        <button class="btn btn-danger hidden" id="bVoiceStopBtn" onclick="stopBroadcastVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        <div id="bVoicePreviewDiv" class="hidden"><audio id="bVoicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-primary" onclick="sendBroadcast()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„</button>
        <button class="btn btn-secondary" onclick="closeBroadcastModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

function switchBroadcastType(type, btn) {
  document.querySelectorAll('#broadcastModal .message-type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('broadcastTextDiv').classList.toggle('hidden', type !== 'text');
  document.getElementById('broadcastVoiceDiv').classList.toggle('hidden', type !== 'voice');
}

async function startBroadcastVoice() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    broadcastVoiceChunks = [];
    broadcastVoiceBlob = null;
    const mimeType = getSupportedAudioMime();
    broadcastVoiceRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
    broadcastVoiceRecorder.ondataavailable = e => { if (e.data?.size > 0) broadcastVoiceChunks.push(e.data); };
    broadcastVoiceRecorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());
      if (broadcastVoiceChunks.length > 0) {
        broadcastVoiceBlob = new Blob(broadcastVoiceChunks, { type: broadcastVoiceRecorder.mimeType || 'audio/webm' });
        const url = URL.createObjectURL(broadcastVoiceBlob);
        document.getElementById('bVoicePreview').src = url;
        document.getElementById('bVoicePreviewDiv').classList.remove('hidden');
      }
    };
    broadcastVoiceRecorder.start(100);
    document.getElementById('bVoiceRecordBtn').classList.add('hidden');
    document.getElementById('bVoiceStopBtn').classList.remove('hidden');
    document.getElementById('bVoiceTimer').classList.remove('hidden');
    const t0 = Date.now();
    broadcastVoiceTimerInterval = setInterval(() => {
      const s = Math.floor((Date.now()-t0)/1000);
      const el = document.getElementById('bVoiceTimer');
      if (el) el.textContent = pad(Math.floor(s/60)) + ':' + pad(s%60);
    }, 1000);
  } catch(err) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message); }
}

function stopBroadcastVoice() {
  if (broadcastVoiceRecorder?.state !== 'inactive') {
    broadcastVoiceRecorder.stop();
    clearInterval(broadcastVoiceTimerInterval);
    document.getElementById('bVoiceRecordBtn')?.classList.remove('hidden');
    document.getElementById('bVoiceStopBtn')?.classList.add('hidden');
    document.getElementById('bVoiceTimer')?.classList.add('hidden');
  }
}

async function sendBroadcast() {
  const isVoice = document.querySelector('#broadcastModal .message-type-btn.active')?.textContent.includes('ØµÙˆØªÙŠ');
  showLoading();
  try {
    const broadcastData = { type: isVoice ? 'voice' : 'text' };
    if (isVoice) {
      if (!broadcastVoiceBlob) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©!'); return; }
      const path = `broadcasts/b_${Date.now()}.webm`;
      await storage.upload(path, broadcastVoiceBlob);
      broadcastData.voice_storage_path = path;
      broadcastData.message = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ“¢';
    } else {
      const text = document.getElementById('broadcastText').value.trim();
      if (!text) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†!'); return; }
      broadcastData.message = text;
    }
    await db.insert('broadcasts', broadcastData);
    hideLoading();
    closeBroadcastModal();
    await loadAdminBroadcasts();
    await loadGlobalBroadcasts();
    alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† âœ…');
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

function closeBroadcastModal() {
  document.getElementById('broadcastModal')?.remove();
  broadcastVoiceBlob = null;
  broadcastVoiceChunks = [];
  if (broadcastVoiceRecorder?.state !== 'inactive') try { broadcastVoiceRecorder.stop(); } catch(e) {}
  clearInterval(broadcastVoiceTimerInterval);
}

async function deleteBroadcast(id) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ')) return;
  showLoading();
  try {
    // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ Ø¥Ù† ÙˆØ¬Ø¯
    const rows = await db.select('broadcasts', `id=eq.${id}`);
    if (rows?.[0]?.voice_storage_path) {
      await storage.delete([rows[0].voice_storage_path]);
    }
    await db.delete('broadcasts', `id=eq.${id}`);
    hideLoading();
    await loadAdminBroadcasts();
    await loadGlobalBroadcasts();
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

// =========================================================
// ğŸ‘¥ PARTICIPANTS
// =========================================================
async function loadParticipants() {
  showLoading();
  try {
    const participants = await db.select('participants', 'order=registered_at.asc');
    const recordings = await db.select('recordings', 'order=created_at.asc');
    hideLoading();

    participantsCache = {};
    const recsByParticipant = {};

    (recordings || []).forEach(r => {
      if (!recsByParticipant[r.participant_id]) recsByParticipant[r.participant_id] = [];
      recsByParticipant[r.participant_id].push(r);
    });

    (participants || []).forEach(p => {
      p.recordings = recsByParticipant[p.id] || [];
      participantsCache[p.id] = p;
    });

    const totalRecs = Object.values(recsByParticipant).reduce((a, r) => a + r.length, 0);
    let newCount = 0;
    (participants || []).forEach(p => {
      (p.recordings || []).forEach(r => { if (!isViewed(p.id, r.id)) newCount++; });
    });

    document.getElementById('totalParticipants').textContent = (participants || []).length;
    document.getElementById('totalRecordings').textContent = totalRecs;
    document.getElementById('newRecordings').textContent = newCount;

    const listDiv = document.getElementById('participantsList');
    if (!participants || participants.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>';
      return;
    }

    listDiv.innerHTML = participants.map(p => {
      const nc = (p.recordings || []).filter(r => !isViewed(p.id, r.id)).length;
      return `<div class="participant-card" data-pid="${p.id}">
        ${nc > 0 ? `<div class="new-recordings-badge">${nc}</div>` : ''}
        <div class="icon">ğŸ‘¤</div>
        <h3>${p.name}</h3>
        <p class="count">${(p.recordings || []).length} ØªØ³Ø¬ÙŠÙ„</p>
      </div>`;
    }).join('');

    listDiv.querySelectorAll('.participant-card').forEach(card => {
      card.addEventListener('click', () => {
        const p = participantsCache[card.dataset.pid];
        if (p) openParticipant(p);
      });
    });
  } catch(e) {
    hideLoading();
    document.getElementById('participantsList').innerHTML = `<div class="error-message" style="grid-column:1/-1;">âš ï¸ Ø®Ø·Ø£: ${e.message}</div>`;
  }
}

async function openParticipant(participant) {
  currentParticipant = participant;
  showPage('adminRecordingsPage');
  document.getElementById('participantTitle').textContent = 'ØªØ³Ø¬ÙŠÙ„Ø§Øª: ' + participant.name;
  document.getElementById('contactName').textContent = participant.name;
  document.getElementById('contactPassword').textContent = participant.password;
  const ci = document.getElementById('contactInfoContent');
  if (!ci.classList.contains('hidden')) { ci.classList.add('hidden'); document.getElementById('contactToggleText').textContent = 'Ø¹Ø±Ø¶'; }
  await calculateAndDisplayTotalRating();
  await loadParticipantRecordings();
  await loadAdminSentMessages();
}

// =========================================================
// ğŸ™ï¸ RECORDINGS - PARTICIPANT
// =========================================================
async function loadMyRecordings() {
  try {
    const rows = await db.select('recordings', `participant_id=eq.${currentUser.id}&order=created_at.asc`);
    currentUser.recordings = rows || [];
  } catch(e) {
    currentUser.recordings = currentUser.recordings || [];
  }

  const listDiv = document.getElementById('myRecordingsList');
  const recordings = currentUser.recordings;

  if (recordings.length === 0) {
    listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
    return;
  }

  // Ø¬Ù„Ø¨ signed URLs Ø£Ùˆ public URLs
  listDiv.innerHTML = recordings.map((rec, i) => `
    <div class="recording-item">
      <div class="three-dots" onclick="showRecordingMenu(event,'${rec.id}')">â‹®</div>
      <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;">
        Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} - ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
      </p>
      <p class="recording-date">${formatDate(rec.created_at)}</p>
      ${createMediaEl(rec)}
    </div>`).join('');
}

function createMediaEl(rec) {
  const url = storage.getPublicUrl(rec.storage_path);
  if (rec.type === 'video') {
    return `<video controls src="${url}" style="width:100%;border-radius:8px;background:#000;" preload="metadata"></video>`;
  }
  return `<audio controls src="${url}" style="width:100%;" preload="metadata"></audio>`;
}

function showRecordingMenu(e, recId) {
  e.stopPropagation();
  document.querySelector('.menu-popup')?.remove();
  const menu = document.createElement('div');
  menu.className = 'menu-popup';
  menu.innerHTML = `<div class="menu-item danger" onclick="confirmDeleteRecording('${recId}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
  e.target.closest('.recording-item').appendChild(menu);
  setTimeout(() => {
    document.addEventListener('click', function cl(e) {
      if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', cl); }
    });
  }, 10);
}

function confirmDeleteRecording(recId) {
  showConfirm('âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.', () => deleteRecording(recId));
}

async function deleteRecording(recId) {
  showLoading();
  try {
    const rows = await db.select('recordings', `id=eq.${recId}`);
    if (rows?.[0]?.storage_path) await storage.delete([rows[0].storage_path]);
    await db.delete('recordings', `id=eq.${recId}`);
    await db.delete('messages', `recording_id=eq.${recId}`);
    currentUser.recordings = (currentUser.recordings || []).filter(r => r.id !== recId);
    hideLoading();
    closeConfirm();
    loadMyRecordings();
    updateUnreadBadge();
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

// =========================================================
// ğŸ™ï¸ RECORDINGS - ADMIN
// =========================================================
async function loadParticipantRecordings() {
  const listDiv = document.getElementById('adminRecordingsList');
  try {
    const rows = await db.select('recordings', `participant_id=eq.${currentParticipant.id}&order=created_at.asc`);
    currentParticipant.recordings = rows || [];
    participantsCache[currentParticipant.id] = currentParticipant;

    (rows || []).forEach(r => markViewed(currentParticipant.id, r.id));

    if (currentParticipant.recordings.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
      return;
    }

    listDiv.innerHTML = currentParticipant.recordings.map((rec, i) => `
      <div class="recording-item">
        <div class="three-dots" onclick="showAdminRecMenu(event,'${rec.id}')">â‹®</div>
        <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;">
          Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} - ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
        </p>
        <p class="recording-date">${formatDate(rec.created_at)}</p>
        ${createMediaEl(rec)}
      </div>`).join('');
  } catch(e) {
    listDiv.innerHTML = `<div class="error-message">âš ï¸ Ø®Ø·Ø£: ${e.message}</div>`;
  }
}

function showAdminRecMenu(e, recId) {
  e.stopPropagation();
  document.querySelector('.menu-popup')?.remove();
  const menu = document.createElement('div');
  menu.className = 'menu-popup';
  menu.innerHTML = `
    <div class="menu-item" onclick="openMessageModal('${recId}','text')">âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
    <div class="menu-item" onclick="openMessageModal('${recId}','voice')">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
    <div class="menu-item" onclick="openMessageModal('${recId}','rating')">â­ ØªÙ‚ÙŠÙŠÙ…</div>
    <div class="menu-item danger" onclick="confirmDeleteRecAdmin('${recId}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
  e.target.closest('.recording-item').appendChild(menu);
  setTimeout(() => {
    document.addEventListener('click', function cl(e) {
      if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', cl); }
    });
  }, 10);
}

function confirmDeleteRecAdmin(recId) {
  showConfirm('âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.', () => deleteRecordingAdmin(recId));
}

async function deleteRecordingAdmin(recId) {
  showLoading();
  try {
    const rows = await db.select('recordings', `id=eq.${recId}`);
    if (rows?.[0]?.storage_path) await storage.delete([rows[0].storage_path]);
    await db.delete('recordings', `id=eq.${recId}`);
    await db.delete('messages', `recording_id=eq.${recId}`);
    hideLoading();
    closeConfirm();
    await calculateAndDisplayTotalRating();
    await loadAdminSentMessages();
    await loadParticipantRecordings();
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

// =========================================================
// ğŸ¤ RECORDING LOGIC
// =========================================================
function selectType(type, card) {
  recordingType = type;
  document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
  card.classList.add('selected');
  if (type === 'video') startVideoPreview();
  else stopVideoPreview();
}

async function startVideoPreview() {
  try {
    if (previewStream) return;
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    previewStream = stream;
    const vid = document.getElementById('liveVideo');
    vid.srcObject = stream;
    document.getElementById('livePreview').classList.remove('hidden');
  } catch(err) {
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
    recordingType = 'audio';
    document.querySelectorAll('.type-card').forEach((c, i) => c.classList.toggle('selected', i === 0));
  }
}

function stopVideoPreview() {
  if (previewStream) {
    previewStream.getTracks().forEach(t => t.stop());
    previewStream = null;
    const v = document.getElementById('liveVideo');
    if (v) v.srcObject = null;
    document.getElementById('livePreview')?.classList.add('hidden');
  }
}

async function startRecording() {
  try {
    let stream;
    if (recordingType === 'video') {
      if (previewStream) {
        const audio = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream = new MediaStream([...previewStream.getVideoTracks(), ...audio.getAudioTracks()]);
      } else {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        previewStream = new MediaStream(stream.getVideoTracks());
        document.getElementById('liveVideo').srcObject = previewStream;
        document.getElementById('livePreview').classList.remove('hidden');
      }
    } else {
      stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }

    recordedChunks = [];
    const mimeType = recordingType === 'video' ? getSupportedVideoMime() : getSupportedAudioMime();
    try {
      mediaRecorder = mimeType ? new MediaRecorder(stream, { mimeType }) : new MediaRecorder(stream);
    } catch(e) {
      mediaRecorder = new MediaRecorder(stream);
    }

    mediaRecorder.ondataavailable = e => { if (e.data?.size > 0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      if (recordingType === 'audio') stream.getTracks().forEach(t => t.stop());
      showPreview();
    };
    mediaRecorder.start(100);

    document.getElementById('recordBtn').classList.add('hidden');
    document.getElementById('stopBtn').classList.remove('hidden');
    document.getElementById('timer').classList.remove('hidden');
    if (recordingType === 'video') document.getElementById('livePreview').classList.add('recording');

    recordingStartTime = Date.now();
    timerInterval = setInterval(() => {
      const s = Math.floor((Date.now() - recordingStartTime) / 1000);
      const el = document.getElementById('timer');
      if (el) el.textContent = pad(Math.floor(s/60)) + ':' + pad(s%60);
    }, 1000);
  } catch(err) {
    alert('Ø®Ø·Ø£: ' + err.message);
  }
}

function stopRecording() {
  if (mediaRecorder?.state !== 'inactive') {
    try { mediaRecorder.stop(); } catch(e) {}
    clearInterval(timerInterval);
  }
}

function cancelRecording() {
  if (mediaRecorder?.state !== 'inactive') try { mediaRecorder.stop(); } catch(e) {}
  clearInterval(timerInterval);
  recordedChunks = [];
  document.getElementById('livePreview')?.classList.remove('recording');
  document.getElementById('recordBtn').classList.remove('hidden');
  document.getElementById('stopBtn').classList.add('hidden');
  document.getElementById('timer').classList.add('hidden');
  document.getElementById('timer').textContent = '00:00';
  document.getElementById('recordingPreview').classList.add('hidden');
}

function showPreview() {
  if (recordedChunks.length === 0) { alert('Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª.'); cancelRecording(); return; }
  const mime = mediaRecorder?.mimeType || (recordingType === 'video' ? 'video/webm' : 'audio/webm');
  const blob = new Blob(recordedChunks, { type: mime });
  const url = URL.createObjectURL(blob);
  document.getElementById('previewMedia').innerHTML = recordingType === 'video'
    ? `<video controls src="${url}" style="width:100%;border-radius:8px;"></video>`
    : `<audio controls src="${url}" style="width:100%;"></audio>`;
  document.getElementById('recordingPreview').classList.remove('hidden');
  document.getElementById('livePreview')?.classList.remove('recording');
  document.getElementById('recordBtn').classList.remove('hidden');
  document.getElementById('stopBtn').classList.add('hidden');
  document.getElementById('timer').classList.add('hidden');
}

async function saveRecording() {
  if (recordedChunks.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸.'); return; }
  const mime = mediaRecorder?.mimeType || (recordingType === 'video' ? 'video/webm' : 'audio/webm');
  const blob = new Blob(recordedChunks, { type: mime });

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… - Supabase ÙŠØ¯Ø¹Ù… Ù…Ù„ÙØ§Øª ÙƒØ¨ÙŠØ±Ø© (50MB Ù…Ø¬Ø§Ù†Ø§Ù‹)
  if (blob.size > 50 * 1024 * 1024) {
    alert('Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 50MB). ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©.');
    return;
  }

  const ext = recordingType === 'video' ? 'webm' : 'webm';
  const recId = Date.now().toString();
  const path = `${currentUser.id}/${recId}.${ext}`;

  document.getElementById('uploadProgress').classList.remove('hidden');
  document.getElementById('saveBtn').disabled = true;

  try {
    await storage.upload(path, blob, (pct) => {
      document.getElementById('progressBar').style.width = pct + '%';
    });

    await db.insert('recordings', {
      id: recId,
      participant_id: currentUser.id,
      type: recordingType,
      storage_path: path
    });

    document.getElementById('uploadProgress').classList.add('hidden');
    document.getElementById('saveBtn').disabled = false;
    recordedChunks = [];
    document.getElementById('recordingPreview').classList.add('hidden');
    document.getElementById('timer').textContent = '00:00';
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…');
    loadMyRecordings();
  } catch(err) {
    document.getElementById('uploadProgress').classList.add('hidden');
    document.getElementById('saveBtn').disabled = false;
    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + err.message + '\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n1. Ø¥Ù†Ø´Ø§Ø¡ bucket Ø§Ø³Ù…Ù‡ "recordings" ÙÙŠ Supabase Storage\n2. ØªÙØ¹ÙŠÙ„ Public access Ù„Ù„Ù€ bucket\n3. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª');
  }
}

// =========================================================
// ğŸ’¬ MESSAGES
// =========================================================
async function loadMessages() {
  const listDiv = document.getElementById('messagesList');
  try {
    const messages = await db.select('messages', `participant_id=eq.${currentUser.id}&order=created_at.desc`);
    if (!messages || messages.length === 0) {
      listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';
      return;
    }

    const myRecs = await db.select('recordings', `participant_id=eq.${currentUser.id}`);
    const recsMap = {};
    (myRecs || []).forEach(r => { recsMap[r.id] = r; });

    let html = '';
    for (const msg of messages) {
      const typeIcon = msg.message_type === 'voice' ? 'ğŸ¤' : msg.message_type === 'rating' ? 'â­' : 'âœ‰ï¸';
      let linkedHtml = '';
      if (msg.recording_id && recsMap[msg.recording_id]) {
        const rec = recsMap[msg.recording_id];
        linkedHtml = `
          <div class="linked-recording">
            <p>ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø±Ø¯Ù‘Øª Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©:</p>
            ${createMediaEl(rec)}
          </div>`;
      }

      html += `
        <div class="message-item ${!msg.read ? 'unread' : ''}">
          <div class="message-header">
            <span style="color:var(--gold);font-weight:700;">${typeIcon} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
            <span style="color:#666;font-size:0.75rem;">${formatDate(msg.created_at)}</span>
          </div>
          <div class="message-content">${msg.message || ''}</div>
          ${msg.message_type === 'voice' && msg.voice_storage_path ? `
            <div class="message-recording">
              <p style="color:var(--dark-green);font-weight:600;margin-bottom:6px;font-size:0.9rem;">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</p>
              <audio controls src="${storage.getPublicUrl(msg.voice_storage_path)}" style="width:100%;"></audio>
            </div>` : ''}
          ${msg.message_type === 'rating' && msg.rating ? `
            <div class="message-rating">
              <p style="color:var(--dark-green);font-weight:700;margin-bottom:6px;">ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>
              <div class="message-stars">${starsHtml(msg.rating)}</div>
              <p style="color:var(--dark-green);font-weight:700;font-size:1.3rem;">${msg.rating} / 5</p>
            </div>` : ''}
          ${linkedHtml}
        </div>`;
    }
    listDiv.innerHTML = html;
  } catch(err) {
    listDiv.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p></div>`;
  }
}

async function updateUnreadBadge() {
  try {
    const rows = await db.select('messages', `participant_id=eq.${currentUser.id}&read=eq.false&select=id`);
    const count = (rows || []).length;
    const badge = document.getElementById('unreadBadge');
    if (count > 0) { badge.textContent = count; badge.classList.remove('hidden'); }
    else { badge.classList.add('hidden'); }
  } catch(e) {}
}

async function markMessagesAsRead() {
  try {
    await db.update('messages', { read: true }, `participant_id=eq.${currentUser.id}&read=eq.false`);
    updateUnreadBadge();
  } catch(e) {}
}

async function loadAdminSentMessages() {
  const div = document.getElementById('adminSentMessages');
  try {
    const messages = await db.select('messages', `participant_id=eq.${currentParticipant.id}&order=created_at.desc`);
    if (!messages || messages.length === 0) { div.innerHTML = ''; return; }

    let html = `<h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1rem;">ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…Ø±Ø³Ù„Ø©</h3>`;
    for (const msg of messages) {
      const typeIcon = msg.message_type === 'voice' ? 'ğŸ¤' : msg.message_type === 'rating' ? 'â­' : 'âœ‰ï¸';
      html += `
        <div class="admin-msg-item">
          <button class="msg-delete-btn" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          <p style="color:var(--dark-green);font-weight:700;font-size:0.9rem;margin-bottom:4px;margin-left:55px;">${typeIcon} ${msg.message || ''}</p>
          <p style="color:#888;font-size:0.78rem;">${formatDate(msg.created_at)}</p>
          ${msg.message_type === 'voice' && msg.voice_storage_path ? `<audio controls src="${storage.getPublicUrl(msg.voice_storage_path)}" style="width:100%;margin-top:8px;border-radius:8px;"></audio>` : ''}
          ${msg.message_type === 'rating' && msg.rating ? `<div style="margin-top:6px;color:var(--dark-green);font-weight:700;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${msg.rating} / 5 â­</div>` : ''}
        </div>`;
    }
    div.innerHTML = html;
  } catch(e) {
    div.innerHTML = '';
  }
}

async function deleteMessage(id) {
  if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ')) return;
  showLoading();
  try {
    const rows = await db.select('messages', `id=eq.${id}`);
    if (rows?.[0]?.voice_storage_path) await storage.delete([rows[0].voice_storage_path]);
    await db.delete('messages', `id=eq.${id}`);
    hideLoading();
    await loadAdminSentMessages();
    await calculateAndDisplayTotalRating();
    alert('ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…');
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

async function calculateAndDisplayTotalRating() {
  try {
    const rows = await db.select('messages', `participant_id=eq.${currentParticipant.id}&message_type=eq.rating&rating=not.is.null`);
    const ratedSet = new Set();
    let total = 0;
    (rows || []).forEach(msg => {
      if (msg.recording_id && !ratedSet.has(msg.recording_id)) {
        total += parseFloat(msg.rating);
        ratedSet.add(msg.recording_id);
      }
    });
    const max = ratedSet.size * 5;
    document.getElementById('totalRatingValue').textContent = total.toFixed(1);
    document.getElementById('totalRatingMax').textContent = max;
    document.getElementById('totalRatingBadge').style.display = ratedSet.size === 0 ? 'none' : 'inline-flex';
  } catch(e) {}
}

// =========================================================
// ğŸ“© MESSAGE MODAL
// =========================================================
function openMessageModal(recId, type) {
  currentRecordingForMessage = recId;
  selectedRating = 0;
  adminVoiceBlob = null;
  adminVoiceChunks = [];

  const modal = document.createElement('div');
  modal.className = 'message-modal';
  modal.id = 'messageModal';
  modal.innerHTML = `
    <div class="message-modal-content">
      <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
      <div class="message-type-btns">
        <button class="message-type-btn ${type==='text'?'active':''}" onclick="switchMsgType('text',this)">âœï¸ Ù†ØµÙŠØ©</button>
        <button class="message-type-btn ${type==='voice'?'active':''}" onclick="switchMsgType('voice',this)">ğŸ¤ ØµÙˆØªÙŠØ©</button>
        <button class="message-type-btn ${type==='rating'?'active':''}" onclick="switchMsgType('rating',this)">â­ ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
      <div id="textMsgDiv" class="${type!=='text'?'hidden':''}">
        <textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      </div>
      <div id="voiceMsgDiv" class="voice-recorder ${type!=='voice'?'hidden':''}">
        <button class="btn btn-primary" id="voiceRecordBtn" onclick="startAdminVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <div class="timer hidden" id="voiceTimer">00:00</div>
        <button class="btn btn-danger hidden" id="voiceStopBtn" onclick="stopAdminVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
        <div id="voicePreviewDiv" class="hidden"><audio id="voicePreview" controls style="width:100%;margin-top:8px;"></audio></div>
      </div>
      <div id="ratingMsgDiv" class="rating-container ${type!=='rating'?'hidden':''}">
        <p style="color:var(--dark-green);font-weight:700;font-size:1.1rem;margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
        <div class="stars-display" id="starsDisplay">
          ${[1,2,3,4,5].map(i => `<span class="star" onclick="setRating(${i})" data-v="${i}">â­</span>`).join('')}
        </div>
        <div class="rating-value" id="ratingValue">0 / 5</div>
        <div class="rating-buttons">
          ${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(v => `<button class="rating-btn" onclick="setRating(${v})">${v}</button>`).join('')}
        </div>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-primary" onclick="sendMsgToParticipant()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
        <button class="btn btn-secondary" onclick="closeMessageModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>`;
  document.body.appendChild(modal);
}

function switchMsgType(type, btn) {
  document.querySelectorAll('#messageModal .message-type-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  ['text','voice','rating'].forEach(t => {
    const el = document.getElementById(t === 'text' ? 'textMsgDiv' : t === 'voice' ? 'voiceMsgDiv' : 'ratingMsgDiv');
    if (el) el.classList.toggle('hidden', t !== type);
  });
}

function setRating(v) {
  selectedRating = v;
  document.getElementById('ratingValue').textContent = `${v} / 5`;
  document.querySelectorAll('#starsDisplay .star').forEach((s, i) => s.classList.toggle('filled', v >= i+1));
  document.querySelectorAll('.rating-btn').forEach(b => b.classList.toggle('active', parseFloat(b.textContent) === v));
}

async function startAdminVoice() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    adminVoiceChunks = [];
    adminVoiceBlob = null;
    const mt = getSupportedAudioMime();
    try { adminVoiceRecorder = mt ? new MediaRecorder(stream, { mimeType: mt }) : new MediaRecorder(stream); }
    catch(e) { adminVoiceRecorder = new MediaRecorder(stream); }
    adminVoiceRecorder.ondataavailable = e => { if (e.data?.size > 0) adminVoiceChunks.push(e.data); };
    adminVoiceRecorder.onstop = () => {
      stream.getTracks().forEach(t => t.stop());
      if (adminVoiceChunks.length > 0) {
        adminVoiceBlob = new Blob(adminVoiceChunks, { type: adminVoiceRecorder.mimeType || 'audio/webm' });
        const url = URL.createObjectURL(adminVoiceBlob);
        document.getElementById('voicePreview').src = url;
        document.getElementById('voicePreviewDiv').classList.remove('hidden');
      }
    };
    adminVoiceRecorder.start(100);
    document.getElementById('voiceRecordBtn').classList.add('hidden');
    document.getElementById('voiceStopBtn').classList.remove('hidden');
    document.getElementById('voiceTimer').classList.remove('hidden');
    const t0 = Date.now();
    adminVoiceTimer = setInterval(() => {
      const s = Math.floor((Date.now()-t0)/1000);
      const el = document.getElementById('voiceTimer');
      if (el) el.textContent = pad(Math.floor(s/60)) + ':' + pad(s%60);
    }, 1000);
  } catch(err) { alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: ' + err.message); }
}

function stopAdminVoice() {
  if (adminVoiceRecorder?.state !== 'inactive') {
    adminVoiceRecorder.stop();
    clearInterval(adminVoiceTimer);
    document.getElementById('voiceRecordBtn')?.classList.remove('hidden');
    document.getElementById('voiceStopBtn')?.classList.add('hidden');
    document.getElementById('voiceTimer')?.classList.add('hidden');
  }
}

async function sendMsgToParticipant() {
  const activeBtn = document.querySelector('#messageModal .message-type-btn.active');
  if (!activeBtn) return;
  const type = activeBtn.textContent.includes('Ù†ØµÙŠØ©') ? 'text' : activeBtn.textContent.includes('ØµÙˆØªÙŠØ©') ? 'voice' : 'rating';

  showLoading();
  try {
    const msgData = {
      participant_id: currentParticipant.id,
      recording_id: currentRecordingForMessage,
      message_type: type,
      read: false
    };

    if (type === 'text') {
      const text = document.getElementById('messageText').value.trim();
      if (!text) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©!'); return; }
      msgData.message = text;

    } else if (type === 'voice') {
      if (!adminVoiceBlob) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!'); return; }
      const path = `messages/${currentParticipant.id}/${Date.now()}.webm`;
      await storage.upload(path, adminVoiceBlob);
      msgData.voice_storage_path = path;
      msgData.message = 'Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ¤';

    } else if (type === 'rating') {
      if (selectedRating === 0) { hideLoading(); alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…!'); return; }
      // Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
      await db.delete('messages', `participant_id=eq.${currentParticipant.id}&recording_id=eq.${currentRecordingForMessage}&message_type=eq.rating`);
      msgData.rating = selectedRating;
      msgData.message = `ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selectedRating} / 5 Ù†Ø¬ÙˆÙ…`;
    }

    await db.insert('messages', msgData);
    hideLoading();
    closeMessageModal();
    if (type === 'rating') await calculateAndDisplayTotalRating();
    await loadAdminSentMessages();
    alert('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…');
  } catch(err) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + err.message);
  }
}

function closeMessageModal() {
  document.getElementById('messageModal')?.remove();
  adminVoiceBlob = null;
  adminVoiceChunks = [];
  if (adminVoiceRecorder?.state !== 'inactive') try { adminVoiceRecorder.stop(); } catch(e) {}
  clearInterval(adminVoiceTimer);
  selectedRating = 0;
}

// =========================================================
// ğŸ† LEADERBOARD
// =========================================================
async function showLeaderboard() {
  showLoading();
  try {
    const participants = await db.select('participants');
    const ratingMsgs = await db.select('messages', 'message_type=eq.rating&rating=not.is.null');

    const ratingsMap = {};
    (ratingMsgs || []).forEach(msg => {
      if (!ratingsMap[msg.participant_id]) ratingsMap[msg.participant_id] = { total: 0, set: new Set() };
      if (msg.recording_id && !ratingsMap[msg.participant_id].set.has(msg.recording_id)) {
        ratingsMap[msg.participant_id].total += parseFloat(msg.rating);
        ratingsMap[msg.participant_id].set.add(msg.recording_id);
      }
    });

    const recCounts = {};
    const allRecs = await db.select('recordings');
    (allRecs || []).forEach(r => { recCounts[r.participant_id] = (recCounts[r.participant_id] || 0) + 1; });

    const ranked = (participants || []).map(p => ({
      ...p,
      totalRating: ratingsMap[p.id]?.total || 0,
      ratedCount: ratingsMap[p.id]?.set.size || 0,
      recCount: recCounts[p.id] || 0
    })).sort((a, b) => b.totalRating - a.totalRating || b.ratedCount - a.ratedCount);

    hideLoading();
    renderLeaderboard(ranked);
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

function renderLeaderboard(ranked) {
  document.getElementById('leaderboardModal')?.remove();
  const rankCls = i => i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
  const rankEmoji = i => i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i+1);

  const modal = document.createElement('div');
  modal.className = 'leaderboard-modal';
  modal.id = 'leaderboardModal';
  modal.innerHTML = `
    <div class="leaderboard-content">
      <div class="leaderboard-header">
        <button class="leaderboard-close" onclick="document.getElementById('leaderboardModal').remove()">âœ•</button>
        <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</h2>
        <p>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† 1446</p>
      </div>
      <div class="leaderboard-body">
        ${ranked.length === 0 ? '<div style="text-align:center;padding:30px;color:#aaa;"><div style="font-size:3rem;">ğŸ†</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>' :
          ranked.map((p, i) => `
            <div class="leaderboard-row ${rankCls(i)}" style="animation-delay:${i*0.06}s">
              <div class="rank-badge">${rankEmoji(i)}</div>
              <div class="rank-info">
                <div class="rank-name">${p.name}</div>
                <div class="rank-details">${p.recCount} ØªØ³Ø¬ÙŠÙ„ â€¢ ${p.ratedCount} ØªÙ‚ÙŠÙŠÙ…</div>
                <div style="color:#fbbf24;font-size:0.85rem;margin-top:2px;">${'â­'.repeat(Math.floor(p.totalRating))}${'â˜†'.repeat(Math.max(0, 5-Math.floor(p.totalRating)))}</div>
              </div>
              <div class="rank-score">
                <div class="score-num">${p.totalRating > 0 ? p.totalRating.toFixed(1) : '-'}</div>
                <div class="score-label">${p.ratedCount > 0 ? `Ù…Ù† ${p.ratedCount*5}` : 'Ù†Ù‚Ø·Ø©'}</div>
              </div>
            </div>`).join('')}
      </div>
    </div>`;
  document.body.appendChild(modal);
  modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
}

// =========================================================
// ğŸ” AUTH FORMS
// =========================================================
document.getElementById('registerForm').onsubmit = async function(e) {
  e.preventDefault();
  const name = document.getElementById('participantName').value.trim();
  const password = document.getElementById('regPassword').value;
  if (!name || !password) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!'); return; }
  showLoading();
  try {
    const existing = await db.select('participants', `name=eq.${encodeURIComponent(name)}`);
    if (existing && existing.length > 0) { hideLoading(); alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!'); return; }
    const id = Date.now().toString();
    const rows = await db.insert('participants', { id, name, password });
    currentUser = rows?.[0] || { id, name, password, recordings: [] };
    currentUser.recordings = [];
    saveSession();
    hideLoading();
    showParticipantPage();
  } catch(err) {
    hideLoading();
    const errDiv = document.getElementById('registerError');
    errDiv.textContent = 'Ø®Ø·Ø£: ' + err.message;
    errDiv.classList.remove('hidden');
    setTimeout(() => errDiv.classList.add('hidden'), 4000);
  }
};

document.getElementById('loginForm').onsubmit = async function(e) {
  e.preventDefault();
  const name = document.getElementById('loginName').value.trim();
  const password = document.getElementById('loginPassword').value;
  showLoading();
  try {
    const rows = await db.select('participants', `name=eq.${encodeURIComponent(name)}&password=eq.${encodeURIComponent(password)}`);
    hideLoading();
    if (rows && rows.length > 0) {
      currentUser = rows[0];
      currentUser.recordings = [];
      saveSession();
      showParticipantPage();
    } else {
      const err = document.getElementById('loginError');
      err.textContent = 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
      err.classList.remove('hidden');
      setTimeout(() => err.classList.add('hidden'), 3000);
    }
  } catch(err) {
    hideLoading();
    const errEl = document.getElementById('loginError');
    errEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message;
    errEl.classList.remove('hidden');
    setTimeout(() => errEl.classList.add('hidden'), 4000);
  }
};

document.getElementById('adminLoginForm').onsubmit = function(e) {
  e.preventDefault();
  if (document.getElementById('adminPassword').value === 'Qur@n2025#Admin$Ramadan') {
    isAdmin = true;
    saveSession();
    showAdminParticipantsPage();
  } else {
    const err = document.getElementById('adminError');
    err.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!';
    err.classList.remove('hidden');
    setTimeout(() => err.classList.add('hidden'), 3000);
  }
};

// =========================================================
// ğŸ—‘ï¸ DELETE ACCOUNT
// =========================================================
function confirmDeleteAccount() {
  showConfirm(
    'âš ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹',
    `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${currentParticipant.name}ØŸ\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡ ÙˆØ±Ø³Ø§Ø¦Ù„Ù‡.`,
    deleteParticipantAccount
  );
}

async function deleteParticipantAccount() {
  showLoading();
  try {
    // Ø­Ø°Ù Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ù† Storage
    const recs = await db.select('recordings', `participant_id=eq.${currentParticipant.id}`);
    if (recs && recs.length > 0) {
      await storage.delete(recs.map(r => r.storage_path));
    }
    // Ø­Ø°Ù Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØª
    const msgs = await db.select('messages', `participant_id=eq.${currentParticipant.id}&voice_storage_path=not.is.null`);
    if (msgs && msgs.length > 0) {
      await storage.delete(msgs.filter(m => m.voice_storage_path).map(m => m.voice_storage_path));
    }
    // Ø­Ø°Ù Ù…Ù† DB (cascade ÙŠØ­Ø°Ù recordings Ùˆ messages ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
    await db.delete('participants', `id=eq.${currentParticipant.id}`);
    hideLoading();
    closeConfirm();
    alert(`ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${currentParticipant.name} âœ…`);
    currentParticipant = null;
    showAdminParticipantsPage();
  } catch(e) {
    hideLoading();
    alert('Ø®Ø·Ø£: ' + e.message);
  }
}

// =========================================================
// ğŸ”§ UI HELPERS
// =========================================================
function showLoading(msg = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
  if (document.getElementById('loadingOverlay')) return;
  const el = document.createElement('div');
  el.className = 'loading-overlay';
  el.id = 'loadingOverlay';
  el.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>${msg}</p></div>`;
  document.body.appendChild(el);
}

function hideLoading() {
  document.getElementById('loadingOverlay')?.remove();
}

function showConfirm(title, msg, onConfirm) {
  closeConfirm();
  const d = document.createElement('div');
  d.className = 'confirm-dialog';
  d.id = 'confirmDialog';
  d.innerHTML = `
    <div class="confirm-content">
      <h3>${title}</h3>
      <p>${msg}</p>
      <div class="confirm-buttons">
        <button class="btn btn-danger" id="confirmYes">ØªØ£ÙƒÙŠØ¯</button>
        <button class="btn btn-secondary" onclick="closeConfirm()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>`;
  document.body.appendChild(d);
  document.getElementById('confirmYes').onclick = onConfirm;
}

function closeConfirm() {
  document.getElementById('confirmDialog')?.remove();
}

function togglePwd(id, toggle) {
  const inp = document.getElementById(id);
  if (inp.type === 'password') { inp.type = 'text'; toggle.textContent = 'ğŸ™ˆ'; }
  else { inp.type = 'password'; toggle.textContent = 'ğŸ‘ï¸'; }
}

function toggleContactInfo() {
  const content = document.getElementById('contactInfoContent');
  const text = document.getElementById('contactToggleText');
  const hidden = content.classList.toggle('hidden');
  text.textContent = hidden ? 'Ø¹Ø±Ø¶' : 'Ø¥Ø®ÙØ§Ø¡';
}

async function copyToClipboard(type) {
  const text = type === 'name' ? currentParticipant.name : currentParticipant.password;
  const btn = event.target.closest('.copy-btn');
  try {
    await navigator.clipboard.writeText(text);
    btn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
    btn.classList.add('copied');
    setTimeout(() => { btn.innerHTML = 'ğŸ“‹ Ù†Ø³Ø®'; btn.classList.remove('copied'); }, 2000);
  } catch(e) {
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…');
  }
}

// =========================================================
// ğŸ’¾ VIEWED RECORDINGS
// =========================================================
function loadViewedRecordings() {
  try { viewedRecordings = new Set(JSON.parse(localStorage.getItem('viewedRecs') || '[]')); }
  catch(e) { viewedRecordings = new Set(); }
}

function markViewed(pid, rid) {
  viewedRecordings.add(`${pid}_${rid}`);
  try { localStorage.setItem('viewedRecs', JSON.stringify([...viewedRecordings])); } catch(e) {}
}

function isViewed(pid, rid) {
  return viewedRecordings.has(`${pid}_${rid}`);
}

// =========================================================
// ğŸµ MIME TYPE HELPERS
// =========================================================
function getSupportedAudioMime() {
  for (const t of ['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/ogg','audio/mp4']) {
    if (MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

function getSupportedVideoMime() {
  for (const t of ['video/webm;codecs=vp9,opus','video/webm;codecs=vp8,opus','video/webm','video/mp4']) {
    if (MediaRecorder.isTypeSupported(t)) return t;
  }
  return '';
}

// =========================================================
// ğŸŒŸ MISC HELPERS
// =========================================================
function pad(n) { return String(n).padStart(2, '0'); }

function formatDate(ts) {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('ar-SA', { year: 'numeric', month: 'short', day: 'numeric' });
}

function starsHtml(rating) {
  return [1,2,3,4,5].map(i => `<span style="color:${rating >= i ? '#fbbf24' : '#ddd'};">â­</span>`).join('');
}
</script>
</body>
</html>
