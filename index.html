<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-gold: #d4af37;
        --dark-green: #0d4d3f;
        --medium-green: #1a6b54;
        --light-green: #e8f5e9;
        --cream: #fefdf8;
        --white: #ffffff;
        --text-dark: #2c2c2c;
        --border-light: #e0dfd5;
        --accent-gold: #f0c850;
      }

      body {
        font-family: "Cairo", sans-serif;
        background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%);
        min-height: 100vh;
        padding: 20px 15px;
        position: relative;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
      }

      .logo {
        width: 120px;
        height: 120px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        border: 4px solid rgba(255, 255, 255, 0.5);
      }

      .logo img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }

      h1 {
        font-family: "Amiri", serif;
        color: var(--white);
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        text-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        color: var(--primary-gold);
        font-size: 1.3rem;
        font-weight: 600;
      }

      .card {
        background: var(--white);
        border-radius: 20px;
        padding: 40px 30px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.15);
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 25px;
        position: relative;
      }

      .password-toggle {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        font-size: 1.8rem;
        color: #666;
        transition: color 0.3s ease;
        user-select: none;
      }

      .password-toggle:hover {
        color: var(--dark-green);
      }

      .password-input-wrapper {
        position: relative;
      }

      label {
        display: block;
        color: var(--dark-green);
        font-weight: 700;
        margin-bottom: 12px;
        font-size: 1.3rem;
      }

      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 20px;
        border: 3px solid var(--border-light);
        border-radius: 12px;
        font-size: 1.3rem;
        font-family: "Cairo", sans-serif;
        transition: all 0.3s ease;
        background: var(--cream);
      }

      input:focus {
        outline: none;
        border-color: var(--primary-gold);
        background: var(--white);
      }

      .btn {
        width: 100%;
        padding: 25px;
        border: none;
        border-radius: 15px;
        font-size: 1.5rem;
        font-weight: 700;
        font-family: "Cairo", sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 15px;
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold));
        color: var(--dark-green);
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
      }

      .btn-secondary {
        background: var(--dark-green);
        color: var(--white);
        box-shadow: 0 4px 15px rgba(13, 77, 63, 0.3);
      }

      .btn-secondary:hover {
        background: var(--medium-green);
        transform: translateY(-2px);
      }

      .big-icon-btn {
        font-size: 3rem;
        padding: 40px;
        margin: 15px 0;
      }

      .record-type-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 30px 0;
      }

      .type-card {
        background: white;
        border: 4px solid var(--border-light);
        border-radius: 20px;
        padding: 40px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .type-card:hover {
        border-color: var(--primary-gold);
        transform: translateY(-5px);
      }

      .type-card.selected {
        border-color: var(--primary-gold);
        background: linear-gradient(to bottom, #fff9e6, white);
      }

      .type-card .icon {
        font-size: 5rem;
        margin-bottom: 15px;
      }

      .type-card h3 {
        font-size: 1.5rem;
        color: var(--dark-green);
      }

      .recording-controls {
        margin-top: 30px;
      }

      .timer {
        text-align: center;
        font-size: 3.5rem;
        font-weight: 700;
        color: var(--dark-green);
        margin: 30px 0;
        font-family: "Courier New", monospace;
      }

      .live-preview {
        margin: 30px 0;
        padding: 20px;
        background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
        border-radius: 16px;
        border: 3px solid var(--primary-gold);
      }

      .live-preview.recording {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border-color: #dc2626;
      }

      .live-preview video {
        width: 100%;
        border-radius: 12px;
        background: #000;
      }

      .recording-preview {
        margin: 30px 0;
        padding: 30px;
        background: linear-gradient(to bottom, #fff9e6, white);
        border-radius: 16px;
        border: 3px solid var(--primary-gold);
      }

      .recording-preview video,
      .recording-preview audio {
        width: 100%;
        border-radius: 12px;
        margin-top: 20px;
      }

      .recording-item {
        background: white;
        padding: 30px;
        border-radius: 14px;
        border: 2px solid var(--border-light);
        margin-bottom: 20px;
        position: relative;
      }

      .recording-item video,
      .recording-item audio {
        width: 100%;
        margin-top: 15px;
        border-radius: 12px;
      }

      .recording-date {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 15px;
      }

      .three-dots {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 2rem;
        cursor: pointer;
        color: #666;
        padding: 10px;
      }

      .three-dots:hover {
        color: var(--dark-green);
      }

      .menu-popup {
        position: absolute;
        top: 60px;
        left: 20px;
        background: white;
        border: 2px solid var(--primary-gold);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        z-index: 100;
        min-width: 200px;
      }

      .menu-item {
        padding: 20px;
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        font-size: 1.2rem;
        transition: all 0.3s ease;
      }

      .menu-item:last-child {
        border-bottom: none;
      }

      .menu-item:hover {
        background: var(--cream);
      }

      .menu-item.danger {
        color: #dc2626;
      }

      .logout-btn {
        position: fixed;
        top: 20px;
        left: 20px;
        background: rgba(255, 255, 255, 0.95);
        color: var(--dark-green);
        padding: 15px 30px;
        border: 2px solid var(--primary-gold);
        border-radius: 25px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .logout-btn:hover {
        background: var(--primary-gold);
        color: var(--white);
      }

      .back-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.95);
        color: var(--dark-green);
        padding: 15px 30px;
        border: 2px solid var(--primary-gold);
        border-radius: 25px;
        cursor: pointer;
        font-weight: 700;
        font-size: 1.2rem;
        transition: all 0.3s ease;
        z-index: 1000;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
      }

      .back-btn:hover {
        background: var(--primary-gold);
        color: var(--white);
      }

      .hidden {
        display: none !important;
      }

      .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 1.2rem;
        font-weight: 600;
      }

      .participants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 30px;
      }

      .participant-card {
        background: white;
        padding: 30px;
        border-radius: 16px;
        border: 3px solid var(--border-light);
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
      }

      .participant-card:hover {
        border-color: var(--primary-gold);
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .participant-card .icon {
        font-size: 4rem;
        margin-bottom: 15px;
      }

      .participant-card h3 {
        color: var(--dark-green);
        font-size: 1.5rem;
        margin-bottom: 10px;
      }

      .participant-card .count {
        color: #666;
        font-size: 1.1rem;
      }

      .empty-state {
        text-align: center;
        padding: 60px 30px;
        color: #999;
      }

      .empty-state .icon {
        font-size: 5rem;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state p {
        font-size: 1.3rem;
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3000;
      }

      .spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid var(--primary-gold);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .loading-spinner {
        text-align: center;
        color: white;
      }

      .loading-spinner p {
        font-size: 1.3rem;
        font-weight: 600;
      }

      .message-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 20px;
      }

      .message-modal-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        max-width: 600px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .message-modal h3 {
        color: var(--dark-green);
        font-size: 1.8rem;
        margin-bottom: 25px;
      }

      .message-type-btns {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 25px;
      }

      .message-type-btn {
        padding: 20px;
        border: 3px solid var(--border-light);
        border-radius: 12px;
        background: white;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .message-type-btn.active {
        background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold));
        border-color: var(--primary-gold);
        color: var(--dark-green);
      }

      .message-modal textarea {
        width: 100%;
        padding: 20px;
        border: 3px solid var(--border-light);
        border-radius: 12px;
        font-family: "Cairo", sans-serif;
        font-size: 1.2rem;
        min-height: 150px;
        resize: vertical;
      }

      .voice-recorder {
        background: linear-gradient(to bottom, #f0f9ff, white);
        padding: 25px;
        border-radius: 12px;
        border: 2px solid var(--primary-gold);
      }

      .voice-recorder audio {
        width: 100%;
        margin-top: 15px;
      }

      .modal-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 25px;
      }

      .unread-badge {
        position: absolute;
        top: -10px;
        left: -10px;
        background: #dc2626;
        color: white;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        font-weight: 700;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
      }

      .message-item {
        background: linear-gradient(135deg, #fff9e6, white);
        padding: 30px;
        border-radius: 16px;
        margin-bottom: 20px;
        border-right: 5px solid var(--primary-gold);
      }

      .message-item.unread {
        background: linear-gradient(135deg, #fff4d6, #fff9e6);
        box-shadow: 0 4px 20px rgba(212, 175, 55, 0.2);
      }

      .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--border-light);
      }

      .message-content {
        font-size: 1.3rem;
        line-height: 1.8;
        margin-bottom: 15px;
      }

      .message-recording {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-top: 15px;
        border: 1px solid var(--border-light);
      }

      .message-recording audio {
        width: 100%;
        margin-top: 10px;
      }

      @media (max-width: 768px) {
        h1 {
          font-size: 2rem;
        }

        .subtitle {
          font-size: 1.1rem;
        }

        .card {
          padding: 30px 20px;
        }

        .btn {
          font-size: 1.3rem;
          padding: 20px;
        }

        .type-card .icon {
          font-size: 4rem;
        }

        .timer {
          font-size: 2.5rem;
        }

        .record-type-grid {
          grid-template-columns: 1fr;
        }

        .participants-grid {
          grid-template-columns: 1fr;
        }

        .logout-btn, .back-btn {
          padding: 12px 20px;
          font-size: 1rem;
        }
      }

      .confirm-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2500;
        padding: 20px;
      }

      .confirm-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        text-align: center;
      }

      .confirm-content h3 {
        color: var(--dark-green);
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .confirm-content p {
        font-size: 1.3rem;
        margin-bottom: 30px;
        line-height: 1.6;
      }

      .confirm-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .btn-danger {
        background: #dc2626;
        color: white;
      }

      .btn-danger:hover {
        background: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="Ø´Ø¹Ø§Ø± Ø±Ù…Ø¶Ø§Ù†" />
        </div>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
        <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</p>
      </div>

      <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="homePage" class="card">
        <button class="btn btn-primary big-icon-btn" onclick="showRegisterPage()">
          ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </button>

        <button class="btn btn-secondary big-icon-btn" onclick="showLoginPage()">
          ğŸ”‘ Ø¯Ø®ÙˆÙ„
        </button>

        <button class="btn btn-secondary" onclick="showAdminLogin()" style="margin-top: 30px;">
          ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©
        </button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <div id="registerPage" class="card hidden">
        <h2 style="color: var(--dark-green); margin-bottom: 30px; text-align: center; font-size: 2rem;">
          ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </h2>

        <form id="registerForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="participantName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
          </div>

          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('password')">ğŸ‘ï¸</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
        </form>

        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginPage" class="card hidden">
        <h2 style="color: var(--dark-green); margin-bottom: 30px; text-align: center; font-size: 2rem;">
          ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
        </h2>

        <div id="loginError" class="error-message hidden"></div>

        <form id="loginForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ" />
          </div>

          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
        </form>

        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminLoginPage" class="card hidden">
        <h2 style="color: var(--dark-green); margin-bottom: 30px; text-align: center; font-size: 2rem;">
          Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©
        </h2>

        <div id="adminError" class="error-message hidden"></div>

        <form id="adminLoginForm">
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="adminPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('adminPassword')">ğŸ‘ï¸</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
        </form>

        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ -->
      <div id="participantPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>

        <h2 style="color: var(--dark-green); margin-bottom: 10px; text-align: center; font-size: 2rem;">
          Ø£Ù‡Ù„Ø§Ù‹ <span id="participantName"></span> ğŸŒ™
        </h2>

        <div style="display: flex; gap: 15px; margin: 30px 0;">
          <button class="btn btn-secondary" onclick="showRecordingSection()" style="flex: 1;">
            ğŸ¤ ØªØ³Ø¬ÙŠÙ„
          </button>
          <button class="btn btn-secondary" onclick="showMessagesSection()" style="flex: 1; position: relative;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„
            <span id="unreadBadge" class="unread-badge hidden"></span>
          </button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <div id="recordingSection">
          <h3 style="color: var(--dark-green); margin-bottom: 20px; font-size: 1.6rem; text-align: center;">
            Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </h3>

          <div class="record-type-grid">
            <div class="type-card selected" onclick="selectType('audio')">
              <div class="icon">ğŸ¤</div>
              <h3>ØµÙˆØª</h3>
            </div>
            <div class="type-card" onclick="selectType('video')">
              <div class="icon">ğŸ¥</div>
              <h3>ÙÙŠØ¯ÙŠÙˆ</h3>
            </div>
          </div>

          <div id="livePreview" class="live-preview hidden">
            <video id="liveVideo" autoplay muted playsinline></video>
          </div>

          <div class="recording-controls">
            <button class="btn btn-primary big-icon-btn" id="recordBtn" onclick="startRecording()">
              ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            </button>

            <div class="timer hidden" id="timer">00:00</div>

            <button class="btn btn-danger big-icon-btn hidden" id="stopBtn" onclick="stopRecording()">
              â¹ Ø¥ÙŠÙ‚Ø§Ù
            </button>
          </div>

          <div id="recordingPreview" class="recording-preview hidden">
            <h3 style="color: var(--dark-green); margin-bottom: 15px; font-size: 1.5rem;">
              Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            </h3>
            <div id="previewMedia"></div>
            <button class="btn btn-primary" onclick="saveRecording()" style="margin-top: 20px;">
              ğŸ’¾ Ø­ÙØ¸
            </button>
            <button class="btn btn-secondary" onclick="cancelRecording()">
              ğŸ”„ Ø¥Ù„ØºØ§Ø¡
            </button>
          </div>

          <div style="margin-top: 40px;">
            <h3 style="color: var(--dark-green); margin-bottom: 20px; font-size: 1.6rem;">
              ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ
            </h3>
            <div id="myRecordingsList"></div>
          </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="messagesSection" class="hidden">
          <h3 style="color: var(--dark-green); margin-bottom: 25px; font-size: 1.6rem;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©
          </h3>
          <div id="messagesList"></div>
        </div>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©) -->
      <div id="adminParticipantsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>

        <h2 style="color: var(--dark-green); margin-bottom: 30px; text-align: center; font-size: 2rem;">
          Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†
        </h2>

        <div id="participantsList" class="participants-grid"></div>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù…Ø¹ÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©) -->
      <div id="adminRecordingsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <button class="back-btn" onclick="backToParticipants()">â† Ø±Ø¬ÙˆØ¹</button>

        <h2 id="participantTitle" style="color: var(--dark-green); margin-bottom: 30px; text-align: center; font-size: 2rem;">
        </h2>

        <div id="adminRecordingsList"></div>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getDatabase, ref, set, get, push, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

      const firebaseConfig = {
        apiKey: "AIzaSyAfhQL5spF3KcrbngSzunLaHT_7cieHkUk",
        authDomain: "opject-e223d.firebaseapp.com",
        databaseURL: "https://opject-e223d-default-rtdb.firebaseio.com/",
        projectId: "opject-e223d",
        storageBucket: "opject-e223d.firebasestorage.app",
        messagingSenderId: "607939195786",
        appId: "1:607939195786:web:c264710387d50fc2990e73"
      };

      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      window.db = database;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbGet = get;
      window.dbPush = push;
      window.dbUpdate = update;
      window.dbRemove = remove;
      window.firebaseInitialized = true;
    </script>

    <script>
      let currentUser = null;
      let isAdmin = false;
      let mediaRecorder = null;
      let recordedChunks = [];
      let recordingType = "audio";
      let timerInterval = null;
      let recordingStartTime = null;
      let previewStream = null;
      let currentParticipant = null;
      let adminVoiceRecorder = null;
      let adminVoiceChunks = [];
      let adminVoiceTimer = null;
      let currentRecordingForMessage = null;

      window.onload = function () {
        const checkFirebase = setInterval(() => {
          if (window.firebaseInitialized && window.db) {
            clearInterval(checkFirebase);
            loadCurrentSession();
          }
        }, 100);

        setTimeout(() => {
          clearInterval(checkFirebase);
          if (!window.db) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
            showHomePage();
          }
        }, 5000);
      };

      function showLoading() {
        const existing = document.getElementById('loadingOverlay');
        if (existing) return;
        
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
          </div>
        `;
        document.body.appendChild(overlay);
      }

      function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.remove();
      }

      async function loadCurrentSession() {
        const session = localStorage.getItem("currentSession");
        if (session) {
          const data = JSON.parse(session);
          if (data.isAdmin) {
            isAdmin = true;
            showAdminParticipantsPage();
          } else {
            showLoading();
            try {
              const snapshot = await window.dbGet(window.dbRef(window.db, 'participants/' + data.userId));
              hideLoading();
              if (snapshot.exists()) {
                currentUser = { id: data.userId, ...snapshot.val() };
                showParticipantPage();
              } else {
                localStorage.removeItem("currentSession");
                showHomePage();
              }
            } catch (error) {
              hideLoading();
              localStorage.removeItem("currentSession");
              alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
              showHomePage();
            }
          }
        } else {
          showHomePage();
        }
      }

      function saveSession() {
        const session = isAdmin
          ? { isAdmin: true }
          : { isAdmin: false, userId: currentUser.id };
        localStorage.setItem("currentSession", JSON.stringify(session));
      }

      function showHomePage() {
        hideAllPages();
        document.getElementById("homePage").classList.remove("hidden");
      }

      function showRegisterPage() {
        hideAllPages();
        document.getElementById("registerPage").classList.remove("hidden");
      }

      function showLoginPage() {
        hideAllPages();
        document.getElementById("loginPage").classList.remove("hidden");
      }

      function showAdminLogin() {
        hideAllPages();
        document.getElementById("adminLoginPage").classList.remove("hidden");
      }

      function showParticipantPage() {
        hideAllPages();
        document.getElementById("participantPage").classList.remove("hidden");
        document.getElementById("participantName").textContent = currentUser.name;
        showRecordingSection();
        loadMyRecordings();
        updateUnreadBadge();
      }

      function showAdminParticipantsPage() {
        hideAllPages();
        document.getElementById("adminParticipantsPage").classList.remove("hidden");
        loadParticipants();
      }

      function showAdminRecordingsPage(participant) {
        hideAllPages();
        currentParticipant = participant;
        document.getElementById("adminRecordingsPage").classList.remove("hidden");
        document.getElementById("participantTitle").textContent = "ØªØ³Ø¬ÙŠÙ„Ø§Øª: " + participant.name;
        loadParticipantRecordings();
      }

      function backToParticipants() {
        currentParticipant = null;
        showAdminParticipantsPage();
      }

      function hideAllPages() {
        document.getElementById("homePage").classList.add("hidden");
        document.getElementById("registerPage").classList.add("hidden");
        document.getElementById("loginPage").classList.add("hidden");
        document.getElementById("adminLoginPage").classList.add("hidden");
        document.getElementById("participantPage").classList.add("hidden");
        document.getElementById("adminParticipantsPage").classList.add("hidden");
        document.getElementById("adminRecordingsPage").classList.add("hidden");
      }

      function showRecordingSection() {
        document.getElementById("recordingSection").classList.remove("hidden");
        document.getElementById("messagesSection").classList.add("hidden");
        if (recordingType === "video" && !previewStream) {
          startVideoPreview();
        }
      }

      async function showMessagesSection() {
        document.getElementById("recordingSection").classList.add("hidden");
        document.getElementById("messagesSection").classList.remove("hidden");
        stopVideoPreview();
        await loadMessages();
        await markMessagesAsRead();
      }

      async function updateUnreadBadge() {
        const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
        let unreadCount = 0;
        
        if (snapshot.exists()) {
          const messages = snapshot.val();
          Object.values(messages).forEach(msg => {
            if (msg.participantId === currentUser.id && !msg.read) {
              unreadCount++;
            }
          });
        }

        const badge = document.getElementById("unreadBadge");
        if (unreadCount > 0) {
          badge.textContent = unreadCount;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      }

      async function markMessagesAsRead() {
        const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
        
        if (snapshot.exists()) {
          const messages = snapshot.val();
          const updates = {};
          
          Object.entries(messages).forEach(([msgId, msg]) => {
            if (msg.participantId === currentUser.id && !msg.read) {
              updates[`messages/${msgId}/read`] = true;
            }
          });

          if (Object.keys(updates).length > 0) {
            await window.dbUpdate(window.dbRef(window.db), updates);
          }
        }
        
        updateUnreadBadge();
      }

      async function loadMessages() {
        const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
        const listDiv = document.getElementById("messagesList");

        if (!snapshot.exists()) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';
          return;
        }

        const messages = [];
        snapshot.forEach(child => {
          const msg = child.val();
          if (msg.participantId === currentUser.id) {
            messages.push({ id: child.key, ...msg });
          }
        });

        if (messages.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';
          return;
        }

        messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        let html = '';
        for (const msg of messages) {
          html += `
            <div class="message-item ${!msg.read ? "unread" : ""}">
              <div class="message-header">
                <span style="color: var(--primary-gold); font-weight: 700; font-size: 1.3rem;">
                  âœ‰ï¸ Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ${msg.messageType === 'voice' ? 'ğŸ¤' : ''}
                </span>
                <span style="color: #666; font-size: 1rem;">
                  ${new Date(msg.timestamp).toLocaleDateString("ar-SA")}
                </span>
              </div>
              <div class="message-content">${msg.message}</div>
              ${msg.messageType === 'voice' && msg.voiceData ? `
                <div class="message-recording">
                  <p style="color: var(--dark-green); font-weight: 600; margin-bottom: 10px; font-size: 1.2rem;">
                    ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©
                  </p>
                  <audio controls src="${msg.voiceData}"></audio>
                </div>
              ` : ''}
            </div>
          `;
        }

        listDiv.innerHTML = html;
      }

      document.getElementById("registerForm").onsubmit = async function (e) {
        e.preventDefault();
        const name = document.getElementById("participantName").value.trim();
        const password = document.getElementById("password").value;
        
        if (!name || !password) {
          alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!");
          return;
        }

        showLoading();
        
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
          
          if (snapshot.exists()) {
            const participants = snapshot.val();
            const exists = Object.values(participants).some(p => p.name === name);
            
            if (exists) {
              hideLoading();
              alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
              return;
            }
          }

          const participantId = Date.now().toString();
          const participant = {
            name: name,
            password: password,
            registeredAt: new Date().toISOString(),
            recordings: []
          };

          await window.dbSet(window.dbRef(window.db, 'participants/' + participantId), participant);

          currentUser = { id: participantId, ...participant };
          saveSession();
          hideLoading();
          showParticipantPage();
        } catch (error) {
          hideLoading();
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        }
      };

      document.getElementById("loginForm").onsubmit = async function (e) {
        e.preventDefault();
        const name = document.getElementById("loginName").value;
        const password = document.getElementById("loginPassword").value;

        showLoading();
        const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
        hideLoading();

        if (snapshot.exists()) {
          const participants = snapshot.val();
          let foundUser = null;
          let foundId = null;

          Object.entries(participants).forEach(([id, p]) => {
            if (p.name === name && p.password === password) {
              foundUser = p;
              foundId = id;
            }
          });

          if (foundUser) {
            currentUser = { id: foundId, ...foundUser };
            saveSession();
            showParticipantPage();
            return;
          }
        }

        document.getElementById("loginError").textContent = "Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!";
        document.getElementById("loginError").classList.remove("hidden");
        setTimeout(() => {
          document.getElementById("loginError").classList.add("hidden");
        }, 3000);
      };

      document.getElementById("adminLoginForm").onsubmit = function (e) {
        e.preventDefault();
        const password = document.getElementById("adminPassword").value;

        if (password === "Qur@n2025#Admin$Ramadan") {
          isAdmin = true;
          saveSession();
          showAdminParticipantsPage();
        } else {
          document.getElementById("adminError").textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!";
          document.getElementById("adminError").classList.remove("hidden");
          setTimeout(() => {
            document.getElementById("adminError").classList.add("hidden");
          }, 3000);
        }
      };

      function logout() {
        stopVideoPreview();
        localStorage.removeItem("currentSession");
        currentUser = null;
        isAdmin = false;
        currentParticipant = null;
        showHomePage();
      }

      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target;
        
        if (input.type === "password") {
          input.type = "text";
          icon.textContent = "ğŸ™ˆ";
        } else {
          input.type = "password";
          icon.textContent = "ğŸ‘ï¸";
        }
      }

      function selectType(type) {
        recordingType = type;
        document.querySelectorAll(".type-card").forEach((el) => el.classList.remove("selected"));
        event.target.closest(".type-card").classList.add("selected");
        
        if (type === "video") {
          startVideoPreview();
        } else {
          stopVideoPreview();
        }
      }

      async function startVideoPreview() {
        try {
          if (previewStream) return;
          
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          previewStream = stream;
          const liveVideo = document.getElementById("liveVideo");
          liveVideo.srcObject = stream;
          document.getElementById("livePreview").classList.remove("hidden");
        } catch (err) {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
        }
      }

      function stopVideoPreview() {
        if (previewStream) {
          previewStream.getTracks().forEach((track) => track.stop());
          previewStream = null;
          const liveVideo = document.getElementById("liveVideo");
          if (liveVideo.srcObject) {
            liveVideo.srcObject = null;
          }
          document.getElementById("livePreview").classList.add("hidden");
        }
      }

      async function startRecording() {
        try {
          let stream;
          
          if (recordingType === "video") {
            if (previewStream) {
              const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
              stream = new MediaStream([
                ...previewStream.getVideoTracks(),
                ...audioStream.getAudioTracks()
              ]);
            } else {
              stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
              previewStream = stream;
              const liveVideo = document.getElementById("liveVideo");
              liveVideo.srcObject = stream;
              document.getElementById("livePreview").classList.remove("hidden");
            }
          } else {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          }

          recordedChunks = [];
          mediaRecorder = new MediaRecorder(stream);

          mediaRecorder.ondataavailable = function (e) {
            if (e.data.size > 0) {
              recordedChunks.push(e.data);
            }
          };

          mediaRecorder.onstop = function () {
            if (recordingType === "audio") {
              stream.getTracks().forEach((track) => track.stop());
            }
            showPreview();
          };

          mediaRecorder.start();

          document.getElementById("recordBtn").classList.add("hidden");
          document.getElementById("stopBtn").classList.remove("hidden");
          document.getElementById("timer").classList.remove("hidden");
          
          if (recordingType === "video") {
            document.getElementById("livePreview").classList.add("recording");
          }

          recordingStartTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);
        } catch (err) {
          alert("Ø®Ø·Ø£: " + err.message);
        }
      }

      function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, "0");
        const seconds = (elapsed % 60).toString().padStart(2, "0");
        document.getElementById("timer").textContent = `${minutes}:${seconds}`;
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          clearInterval(timerInterval);
        }
      }

      function cancelRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }

        document.getElementById("livePreview").classList.remove("recording");

        if (recordingType === "audio") {
          const liveVideo = document.getElementById("liveVideo");
          if (liveVideo.srcObject) {
            liveVideo.srcObject.getTracks().forEach((track) => track.stop());
            liveVideo.srcObject = null;
          }
          document.getElementById("livePreview").classList.add("hidden");
        }

        clearInterval(timerInterval);
        recordedChunks = [];

        document.getElementById("recordBtn").classList.remove("hidden");
        document.getElementById("stopBtn").classList.add("hidden");
        document.getElementById("timer").classList.add("hidden");
        document.getElementById("timer").textContent = "00:00";
        document.getElementById("recordingPreview").classList.add("hidden");
      }

      function showPreview() {
        const blob = new Blob(recordedChunks, {
          type: recordingType === "video" ? "video/webm" : "audio/webm",
        });

        const url = URL.createObjectURL(blob);
        const previewDiv = document.getElementById("previewMedia");

        if (recordingType === "video") {
          previewDiv.innerHTML = `<video controls src="${url}"></video>`;
        } else {
          previewDiv.innerHTML = `<audio controls src="${url}"></audio>`;
        }

        document.getElementById("recordingPreview").classList.remove("hidden");
      }

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      async function saveRecording() {
        showLoading();
        
        try {
          const blob = new Blob(recordedChunks, {
            type: recordingType === "video" ? "video/webm" : "audio/webm",
          });

          const base64Data = await blobToBase64(blob);

          const recordingId = Date.now().toString();
          const recording = {
            id: recordingId,
            type: recordingType,
            data: base64Data,
            timestamp: new Date().toISOString(),
          };

          const recordings = currentUser.recordings || [];
          recordings.push(recording);

          await window.dbUpdate(window.dbRef(window.db), {
            [`participants/${currentUser.id}/recordings`]: recordings
          });

          currentUser.recordings = recordings;

          hideLoading();
          alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
          
          document.getElementById("livePreview").classList.remove("recording");
          clearInterval(timerInterval);
          recordedChunks = [];

          document.getElementById("recordBtn").classList.remove("hidden");
          document.getElementById("stopBtn").classList.add("hidden");
          document.getElementById("timer").classList.add("hidden");
          document.getElementById("timer").textContent = "00:00";
          document.getElementById("recordingPreview").classList.add("hidden");
          
          loadMyRecordings();
        } catch (error) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message);
        }
      }

      function loadMyRecordings() {
        const listDiv = document.getElementById("myRecordingsList");

        if (!currentUser.recordings || currentUser.recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
          return;
        }

        listDiv.innerHTML = currentUser.recordings
          .map((rec, index) => `
            <div class="recording-item">
              <div class="three-dots" onclick="showRecordingMenu(event, '${rec.id}')">â‹®</div>
              <p style="color: var(--dark-green); font-weight: 700; font-size: 1.3rem; margin-bottom: 8px;">
                Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index + 1} - ${rec.type === "video" ? "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ" : "ğŸ¤ ØµÙˆØª"}
              </p>
              <p class="recording-date">
                ${new Date(rec.timestamp).toLocaleDateString("ar-SA")}
              </p>
              ${rec.type === "video" 
                ? `<video controls src="${rec.data}"></video>`
                : `<audio controls src="${rec.data}"></audio>`
              }
            </div>
          `).join("");
      }

      function showRecordingMenu(e, recordingId) {
        e.stopPropagation();
        
        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚Ø§Ø¦Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©
        const existingMenu = document.querySelector(".menu-popup");
        if (existingMenu) existingMenu.remove();

        const menu = document.createElement("div");
        menu.className = "menu-popup";
        menu.innerHTML = `
          <div class="menu-item danger" onclick="confirmDeleteRecording('${recordingId}')">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </div>
        `;

        e.target.parentElement.appendChild(menu);

        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡Ø§
        setTimeout(() => {
          document.addEventListener("click", function closeMenu(e) {
            if (!menu.contains(e.target)) {
              menu.remove();
              document.removeEventListener("click", closeMenu);
            }
          });
        }, 10);
      }

      function confirmDeleteRecording(recordingId) {
        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" onclick="deleteRecording('${recordingId}')">Ø­Ø°Ù</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>
        `;
        document.body.appendChild(dialog);
      }

      function closeConfirmDialog() {
        const dialog = document.querySelector(".confirm-dialog");
        if (dialog) dialog.remove();
      }

      async function deleteRecording(recordingId) {
        showLoading();

        const recordings = currentUser.recordings.filter(r => r.id !== recordingId);
        
        await window.dbUpdate(window.dbRef(window.db), {
          [`participants/${currentUser.id}/recordings`]: recordings
        });

        const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
        if (messagesSnapshot.exists()) {
          const updates = {};
          messagesSnapshot.forEach(child => {
            const msg = child.val();
            if (msg.recordingId === recordingId) {
              updates[`messages/${child.key}`] = null;
            }
          });

          if (Object.keys(updates).length > 0) {
            await window.dbUpdate(window.dbRef(window.db), updates);
          }
        }

        currentUser.recordings = recordings;

        hideLoading();
        closeConfirmDialog();
        loadMyRecordings();
        updateUnreadBadge();

        alert("ØªÙ… Ø§Ù„Ø­Ø°Ù! âœ…");
      }

      async function loadParticipants() {
        showLoading();
        const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
        hideLoading();

        const listDiv = document.getElementById("participantsList");

        if (!snapshot.exists()) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</p></div>';
          return;
        }

        let participants = [];
        snapshot.forEach(child => {
          const p = { id: child.key, ...child.val() };
          participants.push(p);
        });

        if (participants.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</p></div>';
          return;
        }

        listDiv.innerHTML = participants
          .map(p => `
            <div class="participant-card" onclick='showAdminRecordingsPage(${JSON.stringify(p)})'>
              <div class="icon">ğŸ‘¤</div>
              <h3>${p.name}</h3>
              <p class="count">${(p.recordings || []).length} ØªØ³Ø¬ÙŠÙ„</p>
            </div>
          `).join("");
      }

      function loadParticipantRecordings() {
        const listDiv = document.getElementById("adminRecordingsList");

        if (!currentParticipant.recordings || currentParticipant.recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
          return;
        }

        listDiv.innerHTML = currentParticipant.recordings
          .map((rec, index) => `
            <div class="recording-item">
              <div class="three-dots" onclick="showAdminRecordingMenu(event, '${rec.id}')">â‹®</div>
              <p style="color: var(--dark-green); font-weight: 700; font-size: 1.3rem; margin-bottom: 8px;">
                Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index + 1} - ${rec.type === "video" ? "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ" : "ğŸ¤ ØµÙˆØª"}
              </p>
              <p class="recording-date">
                ${new Date(rec.timestamp).toLocaleDateString("ar-SA")}
              </p>
              ${rec.type === "video" 
                ? `<video controls src="${rec.data}"></video>`
                : `<audio controls src="${rec.data}"></audio>`
              }
            </div>
          `).join("");
      }

      function showAdminRecordingMenu(e, recordingId) {
        e.stopPropagation();
        
        const existingMenu = document.querySelector(".menu-popup");
        if (existingMenu) existingMenu.remove();

        const menu = document.createElement("div");
        menu.className = "menu-popup";
        menu.innerHTML = `
          <div class="menu-item" onclick="openMessageModal('${recordingId}', 'text')">
            âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
          </div>
          <div class="menu-item" onclick="openMessageModal('${recordingId}', 'voice')">
            ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©
          </div>
          <div class="menu-item danger" onclick="confirmDeleteRecordingAdmin('${recordingId}')">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          </div>
        `;

        e.target.parentElement.appendChild(menu);

        setTimeout(() => {
          document.addEventListener("click", function closeMenu(e) {
            if (!menu.contains(e.target)) {
              menu.remove();
              document.removeEventListener("click", closeMenu);
            }
          });
        }, 10);
      }

      function openMessageModal(recordingId, type) {
        currentRecordingForMessage = recordingId;
        
        const modal = document.createElement("div");
        modal.className = "message-modal";
        modal.id = "messageModal";
        
        modal.innerHTML = `
          <div class="message-modal-content">
            <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
            
            <div class="message-type-btns">
              <button class="message-type-btn ${type === 'text' ? 'active' : ''}" onclick="switchMessageType('text')">
                âœï¸ Ù†ØµÙŠØ©
              </button>
              <button class="message-type-btn ${type === 'voice' ? 'active' : ''}" onclick="switchMessageType('voice')">
                ğŸ¤ ØµÙˆØªÙŠØ©
              </button>
            </div>

            <div id="textMessageDiv" class="${type === 'voice' ? 'hidden' : ''}">
              <textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>

            <div id="voiceMessageDiv" class="voice-recorder ${type === 'text' ? 'hidden' : ''}">
              <button class="btn btn-primary" id="voiceRecordBtn" onclick="startAdminVoice()">
                ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
              </button>
              <div class="timer hidden" id="voiceTimer">00:00</div>
              <button class="btn btn-danger hidden" id="voiceStopBtn" onclick="stopAdminVoice()">
                â¹ Ø¥ÙŠÙ‚Ø§Ù
              </button>
              <div id="voicePreviewDiv" class="hidden">
                <audio id="voicePreview" controls></audio>
              </div>
            </div>

            <div class="modal-buttons">
              <button class="btn btn-primary" onclick="sendMessageToParticipant()">Ø¥Ø±Ø³Ø§Ù„</button>
              <button class="btn btn-secondary" onclick="closeMessageModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      function switchMessageType(type) {
        document.querySelectorAll(".message-type-btn").forEach(btn => btn.classList.remove("active"));
        event.target.classList.add("active");

        if (type === 'text') {
          document.getElementById("textMessageDiv").classList.remove("hidden");
          document.getElementById("voiceMessageDiv").classList.add("hidden");
        } else {
          document.getElementById("textMessageDiv").classList.add("hidden");
          document.getElementById("voiceMessageDiv").classList.remove("hidden");
        }
      }

      async function startAdminVoice() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          
          adminVoiceChunks = [];
          adminVoiceRecorder = new MediaRecorder(stream);

          adminVoiceRecorder.ondataavailable = function (e) {
            if (e.data.size > 0) {
              adminVoiceChunks.push(e.data);
            }
          };

          adminVoiceRecorder.onstop = function () {
            stream.getTracks().forEach(track => track.stop());
            
            const blob = new Blob(adminVoiceChunks, { type: "audio/webm" });
            const url = URL.createObjectURL(blob);
            
            document.getElementById("voicePreview").src = url;
            document.getElementById("voicePreviewDiv").classList.remove("hidden");
          };

          adminVoiceRecorder.start();

          document.getElementById("voiceRecordBtn").classList.add("hidden");
          document.getElementById("voiceStopBtn").classList.remove("hidden");
          document.getElementById("voiceTimer").classList.remove("hidden");

          const startTime = Date.now();
          adminVoiceTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, "0");
            const seconds = (elapsed % 60).toString().padStart(2, "0");
            document.getElementById("voiceTimer").textContent = `${minutes}:${seconds}`;
          }, 1000);

        } catch (err) {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + err.message);
        }
      }

      function stopAdminVoice() {
        if (adminVoiceRecorder && adminVoiceRecorder.state !== "inactive") {
          adminVoiceRecorder.stop();
          clearInterval(adminVoiceTimer);
          
          document.getElementById("voiceRecordBtn").classList.remove("hidden");
          document.getElementById("voiceStopBtn").classList.add("hidden");
          document.getElementById("voiceTimer").classList.add("hidden");
          document.getElementById("voiceTimer").textContent = "00:00";
        }
      }

      async function sendMessageToParticipant() {
        const activeBtn = document.querySelector(".message-type-btn.active");
        const messageType = activeBtn.textContent.includes("Ù†ØµÙŠØ©") ? 'text' : 'voice';

        showLoading();

        try {
          if (messageType === 'text') {
            const messageText = document.getElementById("messageText").value.trim();
            if (!messageText) {
              hideLoading();
              alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©!");
              return;
            }

            await sendMessage(currentParticipant.id, currentRecordingForMessage, messageText, 'text', null);
          } else {
            if (!adminVoiceChunks || adminVoiceChunks.length === 0) {
              hideLoading();
              alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©!");
              return;
            }

            const blob = new Blob(adminVoiceChunks, { type: "audio/webm" });
            const base64Data = await blobToBase64(blob);
            
            await sendMessage(currentParticipant.id, currentRecordingForMessage, "Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ¤", 'voice', base64Data);
          }

          hideLoading();
          closeMessageModal();
          alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! âœ…");
        } catch (error) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + error.message);
        }
      }

      async function sendMessage(participantId, recordingId, message, messageType, voiceData) {
        const messagesRef = window.dbRef(window.db, 'messages');
        const newMessageRef = window.dbPush(messagesRef);

        const newMessage = {
          participantId: participantId,
          recordingId: recordingId,
          message: message,
          messageType: messageType,
          timestamp: new Date().toISOString(),
          read: false,
        };

        if (messageType === 'voice' && voiceData) {
          newMessage.voiceData = voiceData;
        }

        await window.dbSet(newMessageRef, newMessage);
        return newMessage;
      }

      function closeMessageModal() {
        const modal = document.getElementById("messageModal");
        if (modal) modal.remove();
        
        adminVoiceChunks = [];
        if (adminVoiceRecorder && adminVoiceRecorder.state !== "inactive") {
          adminVoiceRecorder.stop();
        }
        clearInterval(adminVoiceTimer);
      }

      function confirmDeleteRecordingAdmin(recordingId) {
        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" onclick="deleteRecordingAdmin('${recordingId}')">Ø­Ø°Ù</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>
        `;
        document.body.appendChild(dialog);
      }

      async function deleteRecordingAdmin(recordingId) {
        showLoading();

        const recordings = currentParticipant.recordings.filter(r => r.id !== recordingId);
        
        await window.dbUpdate(window.dbRef(window.db), {
          [`participants/${currentParticipant.id}/recordings`]: recordings
        });

        const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
        if (messagesSnapshot.exists()) {
          const updates = {};
          messagesSnapshot.forEach(child => {
            const msg = child.val();
            if (msg.recordingId === recordingId) {
              updates[`messages/${child.key}`] = null;
            }
          });

          if (Object.keys(updates).length > 0) {
            await window.dbUpdate(window.dbRef(window.db), updates);
          }
        }

        currentParticipant.recordings = recordings;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        const snapshot = await window.dbGet(window.dbRef(window.db, 'participants/' + currentParticipant.id));
        if (snapshot.exists()) {
          currentParticipant = { id: currentParticipant.id, ...snapshot.val() };
        }

        hideLoading();
        closeConfirmDialog();
        loadParticipantRecordings();

        alert("ØªÙ… Ø§Ù„Ø­Ø°Ù! âœ…");
      }
    </script>
  </body>
</html>
