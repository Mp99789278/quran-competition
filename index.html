<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet"/>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      :root {
        --gold: #d4af37;
        --gold-light: #f0c850;
        --green-dark: #0d4d3f;
        --green-med: #1a6b54;
        --green-light: #e8f5e9;
        --cream: #fefdf8;
        --white: #ffffff;
        --text: #2c2c2c;
        --border: #e0dfd5;
        --red: #dc2626;
      }

      body {
        font-family: "Cairo", sans-serif;
        background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%);
        min-height: 100vh;
        padding: 8px;
        overflow-x: hidden;
      }

      .container { max-width: 900px; margin: 0 auto; }

      /* Header */
      .header { text-align: center; margin-bottom: 10px; }
      .logo {
        width: 55px; height: 55px; margin: 0 auto 8px;
        background: linear-gradient(135deg, var(--gold), var(--gold-light));
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.5);
      }
      .logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
      h1 {
        font-family: "Amiri", serif; color: var(--white);
        font-size: 1.4rem; font-weight: 700; margin-bottom: 4px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }
      .subtitle { color: var(--gold); font-size: 0.9rem; font-weight: 600; }

      /* Card */
      .card {
        background: var(--white); border-radius: 14px; padding: 16px 14px;
        box-shadow: 0 6px 25px rgba(0,0,0,0.15); margin-bottom: 10px;
      }

      /* Forms */
      .form-group { margin-bottom: 14px; position: relative; }
      label { display: block; color: var(--green-dark); font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; }
      input[type="text"], input[type="password"] {
        width: 100%; padding: 11px 12px; border: 2px solid var(--border);
        border-radius: 10px; font-size: 0.95rem; font-family: "Cairo", sans-serif;
        transition: all 0.3s; background: var(--cream);
      }
      input:focus { outline: none; border-color: var(--gold); background: var(--white); box-shadow: 0 0 0 3px rgba(212,175,55,0.15); }
      .password-input-wrapper { position: relative; }
      .password-toggle {
        position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
        cursor: pointer; font-size: 1.1rem; color: #666; user-select: none;
      }

      /* Buttons */
      .btn {
        width: 100%; padding: 12px; border: none; border-radius: 10px;
        font-size: 1rem; font-weight: 700; font-family: "Cairo", sans-serif;
        cursor: pointer; transition: all 0.3s; margin-bottom: 8px;
      }
      .btn-primary {
        background: linear-gradient(135deg, var(--gold), var(--gold-light));
        color: var(--green-dark); box-shadow: 0 4px 15px rgba(212,175,55,0.4);
      }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.5); }
      .btn-secondary { background: var(--green-dark); color: var(--white); }
      .btn-secondary:hover { background: var(--green-med); transform: translateY(-2px); }
      .btn-danger { background: var(--red); color: white; }
      .btn-danger:hover { background: #b91c1c; }
      .big-btn { font-size: 1.2rem; padding: 15px; }

      .hidden { display: none !important; }

      /* Error */
      .error-msg {
        background: #fee2e2; color: #991b1b; padding: 10px 14px;
        border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600;
      }

      /* Logout / Back */
      .logout-btn, .back-btn {
        position: fixed; top: 10px; background: rgba(255,255,255,0.95);
        color: var(--green-dark); padding: 8px 14px; border: 2px solid var(--gold);
        border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem;
        transition: all 0.3s; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15);
      }
      .logout-btn { left: 10px; }
      .back-btn { right: 10px; }
      .logout-btn:hover, .back-btn:hover { background: var(--gold); color: white; }

      /* Stats */
      .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 14px; }
      .stat-card {
        background: linear-gradient(135deg, var(--gold), var(--gold-light));
        padding: 10px; border-radius: 10px; text-align: center;
        box-shadow: 0 3px 12px rgba(212,175,55,0.3);
      }
      .stat-card .s-icon { font-size: 1.4rem; margin-bottom: 2px; }
      .stat-card .s-num { font-size: 1.5rem; font-weight: 900; color: var(--green-dark); }
      .stat-card .s-label { font-size: 0.7rem; color: var(--green-dark); font-weight: 600; }

      /* Type cards */
      .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
      .type-card {
        background: white; border: 2px solid var(--border); border-radius: 12px;
        padding: 16px 10px; text-align: center; cursor: pointer; transition: all 0.3s;
      }
      .type-card:hover { border-color: var(--gold); transform: translateY(-2px); }
      .type-card.selected { border-color: var(--gold); background: linear-gradient(to bottom,#fff9e6,white); }
      .type-card .tc-icon { font-size: 2.5rem; margin-bottom: 6px; }
      .type-card h3 { font-size: 1rem; color: var(--green-dark); }

      /* Timer */
      .timer {
        text-align: center; font-size: 1.8rem; font-weight: 700;
        color: var(--green-dark); margin: 12px 0; font-family: "Courier New", monospace;
      }

      /* Live preview */
      .live-preview {
        margin: 12px 0; padding: 10px; border-radius: 10px;
        border: 2px solid var(--gold); background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      }
      .live-preview.recording { background: linear-gradient(135deg,#fef3c7,#fde68a); border-color: var(--red); }
      .live-preview video { width: 100%; border-radius: 8px; background: #000; }

      /* Recording preview */
      .rec-preview { margin: 12px 0; padding: 12px; background: linear-gradient(to bottom,#fff9e6,white); border-radius: 10px; border: 2px solid var(--gold); }
      .rec-preview video, .rec-preview audio { width: 100%; border-radius: 8px; margin-top: 10px; }

      /* Recording item */
      .rec-item {
        background: white; padding: 12px; border-radius: 10px;
        border: 2px solid var(--border); margin-bottom: 10px; position: relative;
      }
      .rec-item video, .rec-item audio { width: 100%; margin-top: 8px; border-radius: 8px; }
      .rec-date { color: #666; font-size: 0.8rem; margin-bottom: 8px; }

      /* Messages attached to recording */
      .rec-messages { margin-top: 10px; }
      .rec-msg-header {
        display: flex; align-items: center; gap: 6px; margin-bottom: 8px;
        padding-top: 10px; border-top: 2px dashed var(--border);
      }
      .rec-msg-header span { color: var(--green-dark); font-weight: 700; font-size: 0.9rem; }
      .attached-msg {
        background: linear-gradient(135deg,#fff9e6,white);
        border: 1.5px solid var(--gold); border-radius: 8px;
        padding: 10px; margin-bottom: 6px; position: relative;
      }
      .attached-msg.unread { box-shadow: 0 2px 10px rgba(212,175,55,0.3); }
      .attached-msg .msg-type { font-size: 0.8rem; color: #888; margin-bottom: 4px; }
      .attached-msg .msg-body { font-size: 0.95rem; color: var(--text); line-height: 1.5; }
      .attached-msg audio { width: 100%; margin-top: 6px; border-radius: 6px; }
      .rating-display {
        background: linear-gradient(135deg,#fef3c7,#fde68a);
        padding: 10px; border-radius: 8px; text-align: center; border: 1.5px solid #fbbf24;
        margin-top: 6px;
      }
      .rating-stars { font-size: 1.5rem; }
      .rating-num { font-size: 1.3rem; font-weight: 900; color: var(--green-dark); }
      .new-badge-msg {
        position: absolute; top: -6px; right: -6px; background: var(--red);
        color: white; border-radius: 50%; width: 18px; height: 18px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.7rem; font-weight: 700; border: 2px solid white;
      }

      /* Three dots */
      .three-dots {
        position: absolute; top: 10px; left: 10px;
        font-size: 1.5rem; cursor: pointer; color: #666; padding: 5px;
        line-height: 1; border-radius: 6px; transition: all 0.2s;
      }
      .three-dots:hover { color: var(--green-dark); background: #f5f5f5; }

      /* Menu popup */
      .menu-popup {
        position: absolute; top: 40px; left: 10px;
        background: white; border: 2px solid var(--gold); border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 100; min-width: 160px; overflow: hidden;
      }
      .menu-item {
        padding: 11px 14px; border-bottom: 1px solid var(--border);
        cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
      }
      .menu-item:last-child { border-bottom: none; }
      .menu-item:hover { background: var(--cream); }
      .menu-item.danger { color: var(--red); }

      /* Participants grid */
      .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
      .participant-card {
        background: white; padding: 12px 8px; border-radius: 12px;
        border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;
        text-align: center; position: relative;
      }
      .participant-card:hover { border-color: var(--gold); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
      .participant-card .p-icon { font-size: 2.2rem; margin-bottom: 6px; }
      .participant-card h3 { color: var(--green-dark); font-size: 0.95rem; margin-bottom: 4px; word-break: break-word; }
      .participant-card .p-count { color: #666; font-size: 0.8rem; }
      .new-rec-badge {
        position: absolute; top: -6px; right: -6px; background: var(--red);
        color: white; border-radius: 50%; width: 24px; height: 24px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4); border: 2px solid white;
      }

      /* Empty state */
      .empty-state { text-align: center; padding: 25px 15px; color: #999; }
      .empty-state .e-icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }

      /* Loading */
      .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 3000;
      }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .loading-text { text-align: center; color: white; font-size: 0.95rem; font-weight: 600; }

      /* Confirm dialog */
      .confirm-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 2500; padding: 15px;
      }
      .confirm-box { background: white; padding: 22px; border-radius: 14px; max-width: 380px; width: 100%; text-align: center; }
      .confirm-box h3 { color: var(--green-dark); font-size: 1.2rem; margin-bottom: 10px; }
      .confirm-box p { font-size: 0.95rem; margin-bottom: 18px; line-height: 1.5; color: #555; }
      .confirm-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

      /* Message modal */
      .msg-modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7); display: flex; align-items: center;
        justify-content: center; z-index: 2000; padding: 15px;
      }
      .msg-modal-box {
        background: white; padding: 20px; border-radius: 14px;
        max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto;
      }
      .msg-modal-box h3 { color: var(--green-dark); font-size: 1.1rem; margin-bottom: 14px; }
      .msg-type-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 14px; }
      .msg-type-btn {
        padding: 10px; border: 2px solid var(--border); border-radius: 8px;
        background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600;
        transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .msg-type-btn.active { background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-color: var(--gold); color: var(--green-dark); }
      .msg-modal-box textarea {
        width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px;
        font-family: "Cairo", sans-serif; font-size: 0.95rem; min-height: 100px; resize: vertical;
      }
      .voice-box { background: linear-gradient(to bottom,#f0f9ff,white); padding: 15px; border-radius: 8px; border: 2px solid var(--gold); }
      .voice-box audio { width: 100%; margin-top: 10px; }
      .modal-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }

      /* Rating */
      .rating-box { background: linear-gradient(to bottom,#fff9e6,white); padding: 15px; border-radius: 8px; border: 2px solid var(--gold); text-align: center; }
      .stars-row { display: flex; justify-content: center; gap: 8px; margin: 12px 0; font-size: 2.5rem; }
      .star { cursor: pointer; transition: all 0.2s; color: #d1d5db; }
      .star:hover { transform: scale(1.2); }
      .star.filled { color: #fbbf24; }
      .rating-val { font-size: 1.5rem; font-weight: 700; color: var(--green-dark); margin-top: 8px; }
      .rating-btns-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 6px; margin-top: 12px; }
      .r-btn {
        padding: 8px; border: 2px solid var(--border); border-radius: 6px;
        background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600;
        transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .r-btn:hover { border-color: var(--gold); }
      .r-btn.active { background: linear-gradient(135deg, var(--gold), var(--gold-light)); border-color: var(--gold); color: var(--green-dark); }

      /* Contact info */
      .contact-section {
        background: linear-gradient(135deg,#dbeafe,#e0f2fe);
        padding: 12px; border-radius: 10px; margin-bottom: 14px; border: 2px solid var(--gold);
      }
      .contact-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .contact-title { color: var(--green-dark); font-weight: 700; font-size: 1rem; }
      .toggle-contact-btn {
        background: var(--gold); color: var(--green-dark); padding: 6px 12px;
        border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;
        transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .info-row {
        background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px;
        display: flex; justify-content: space-between; align-items: center;
        border: 1px solid var(--border);
      }
      .info-label { color: #666; font-size: 0.8rem; margin-bottom: 3px; }
      .info-val { color: var(--green-dark); font-size: 1rem; font-weight: 700; word-break: break-all; }
      .copy-btn {
        background: var(--green-dark); color: white; border: none; padding: 8px 12px;
        border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;
        transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .copy-btn:hover { background: var(--green-med); }
      .copy-btn.copied { background: #10b981; }

      /* Total rating badge */
      .total-rating {
        background: linear-gradient(135deg,#fef3c7,#fde68a);
        padding: 8px 14px; border-radius: 8px; display: inline-flex;
        align-items: center; gap: 6px; margin-bottom: 12px;
        border: 2px solid #fbbf24; box-shadow: 0 2px 8px rgba(251,191,36,0.3);
      }
      .total-rating span { color: var(--green-dark); font-weight: 700; }

      /* Unread badge */
      .unread-badge {
        position: absolute; top: -6px; left: -6px; background: var(--red);
        color: white; border-radius: 50%; width: 22px; height: 22px;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.75rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4);
      }

      /* Nav tabs */
      .nav-tabs { display: flex; gap: 8px; margin: 12px 0; }
      .nav-tab {
        flex: 1; padding: 10px; border: 2px solid var(--border); border-radius: 10px;
        background: white; cursor: pointer; font-weight: 700; font-size: 0.95rem;
        color: var(--green-dark); transition: all 0.3s; text-align: center; position: relative;
        font-family: "Cairo", sans-serif;
      }
      .nav-tab.active { background: linear-gradient(135deg, var(--green-dark), var(--green-med)); color: white; border-color: var(--green-dark); }
      .nav-tab:hover:not(.active) { border-color: var(--gold); }

      /* ========== TUTORIAL STYLES ========== */
      .tutorial-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); z-index: 9999;
        display: flex; align-items: center; justify-content: center; padding: 15px;
      }
      .tutorial-box {
        background: white; border-radius: 16px; max-width: 400px; width: 100%;
        overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        animation: slideUp 0.4s ease;
      }
      @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      .tutorial-header {
        background: linear-gradient(135deg, var(--green-dark), var(--green-med));
        padding: 16px 20px; display: flex; justify-content: space-between; align-items: center;
      }
      .tutorial-header h3 { color: white; font-size: 1.1rem; font-weight: 700; }
      .tutorial-step-indicator { color: rgba(255,255,255,0.8); font-size: 0.85rem; }
      .tutorial-content { padding: 20px; }
      .tutorial-icon { font-size: 3rem; text-align: center; margin-bottom: 12px; }
      .tutorial-title { font-size: 1.2rem; font-weight: 700; color: var(--green-dark); text-align: center; margin-bottom: 8px; }
      .tutorial-desc { font-size: 0.95rem; color: #555; text-align: center; line-height: 1.7; margin-bottom: 16px; }
      .tutorial-highlight {
        background: linear-gradient(135deg,#fff9e6,#fef3c7);
        border: 2px solid var(--gold); border-radius: 10px; padding: 12px; margin-bottom: 16px;
      }
      .tutorial-highlight p { font-size: 0.9rem; color: var(--green-dark); font-weight: 600; text-align: center; }
      .tutorial-footer { padding: 0 20px 20px; }
      .tutorial-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 14px; }
      .t-dot { width: 8px; height: 8px; border-radius: 50%; background: #e0e0e0; transition: all 0.3s; }
      .t-dot.active { background: var(--green-dark); width: 20px; border-radius: 4px; }
      .tutorial-btns { display: grid; grid-template-columns: auto 1fr; gap: 8px; }
      .tutorial-btns.first { grid-template-columns: 1fr; }
      .t-skip-btn {
        padding: 10px 16px; border: 2px solid var(--border); border-radius: 8px;
        background: white; cursor: pointer; font-weight: 600; font-size: 0.9rem;
        color: #666; transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .t-next-btn {
        padding: 10px 20px; border: none; border-radius: 8px;
        background: linear-gradient(135deg, var(--gold), var(--gold-light));
        color: var(--green-dark); cursor: pointer; font-weight: 700; font-size: 0.95rem;
        transition: all 0.3s; font-family: "Cairo", sans-serif;
      }
      .t-next-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212,175,55,0.4); }

      /* Section title */
      .section-title { color: var(--green-dark); font-size: 1.1rem; font-weight: 700; margin-bottom: 12px; text-align: center; }

      @media (max-width: 480px) {
        h1 { font-size: 1.2rem; }
        .card { padding: 12px 10px; }
        .type-grid { grid-template-columns: 1fr; }
        .stats-grid { grid-template-columns: repeat(3,1fr); }
        .stat-card .s-num { font-size: 1.2rem; }
        .timer { font-size: 1.5rem; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="Ø´Ø¹Ø§Ø±" onerror="this.style.display='none';this.parentElement.innerHTML='ğŸŒ™'"/>
        </div>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
        <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446 âœ¨</p>
      </div>

      <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="homePage" class="card hidden">
        <button class="btn btn-primary big-btn" onclick="showPage('registerPage')">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-secondary big-btn" onclick="showPage('loginPage')">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" onclick="showPage('adminLoginPage')" style="margin-top: 10px;">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <div id="registerPage" class="card hidden">
        <h2 class="section-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="registerForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="regName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"/>
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="regPass" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø³Ù‡Ù„Ø©"/>
              <span class="password-toggle" onclick="togglePass('regPass',this)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
        </form>
        <button class="btn btn-secondary" onclick="showPage('homePage')">â—€ Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginPage" class="card hidden">
        <h2 class="section-title">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
        <div id="loginError" class="error-msg hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ"/>
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPass" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
              <span class="password-toggle" onclick="togglePass('loginPass',this)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
        </form>
        <button class="btn btn-secondary" onclick="showPage('homePage')">â—€ Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminLoginPage" class="card hidden">
        <h2 class="section-title">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h2>
        <div id="adminError" class="error-msg hidden"></div>
        <form id="adminLoginForm">
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="adminPass" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"/>
              <span class="password-toggle" onclick="togglePass('adminPass',this)">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
        </form>
        <button class="btn btn-secondary" onclick="showPage('homePage')">â—€ Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ -->
      <div id="participantPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--green-dark);text-align:center;font-size:1.2rem;margin-bottom:10px;padding-top:8px;">
          Ø£Ù‡Ù„Ø§Ù‹ <span id="welcomeName"></span> ğŸŒ™
        </h2>
        <div class="nav-tabs">
          <div class="nav-tab active" id="tabRecord" onclick="switchTab('record')">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</div>
          <div class="nav-tab" id="tabMessages" onclick="switchTab('messages')" style="position:relative;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ÙŠ
            <span id="unreadBadge" class="unread-badge hidden"></span>
          </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <div id="recordSection">
          <h3 class="section-title">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
          <div class="type-grid">
            <div class="type-card selected" id="audioCard" onclick="selectType('audio',this)">
              <div class="tc-icon">ğŸ¤</div>
              <h3>ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ</h3>
            </div>
            <div class="type-card" id="videoCard" onclick="selectType('video',this)">
              <div class="tc-icon">ğŸ¥</div>
              <h3>ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ</h3>
            </div>
          </div>

          <div id="livePreview" class="live-preview hidden">
            <video id="liveVideo" autoplay muted playsinline></video>
          </div>

          <button class="btn btn-primary big-btn" id="recordBtn" onclick="startRecording()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
          <div class="timer hidden" id="timer">00:00</div>
          <button class="btn btn-danger big-btn hidden" id="stopBtn" onclick="stopRecording()">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>

          <div id="recPreviewSection" class="rec-preview hidden">
            <h3 class="section-title">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
            <div id="previewMedia"></div>
            <button class="btn btn-primary" onclick="saveRecording()" style="margin-top:12px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <button class="btn btn-secondary" onclick="cancelRecording()">ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ø¬Ø¯ÙŠØ¯</button>
          </div>

          <div style="margin-top:20px;">
            <h3 class="section-title">ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ ğŸ™ï¸</h3>
            <div id="myRecList"></div>
          </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="messagesSection" class="hidden">
          <h3 class="section-title">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h3>
          <div id="participantMsgList"></div>
        </div>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù„Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminParticipantsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-top:6px;">
          <h2 style="color:var(--green-dark);font-size:1.2rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>
          <button onclick="showTutorial('admin')" style="background:linear-gradient(135deg,var(--gold),var(--gold-light));border:none;padding:7px 12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.85rem;color:var(--green-dark);font-family:'Cairo',sans-serif;">â“ Ù…Ø³Ø§Ø¹Ø¯Ø©</button>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="s-icon">ğŸ‘¥</div><div class="s-num" id="totalPart">0</div><div class="s-label">Ù…Ø´Ø§Ø±Ùƒ</div></div>
          <div class="stat-card"><div class="s-icon">ğŸ™ï¸</div><div class="s-num" id="totalRec">0</div><div class="s-label">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠ</div></div>
          <div class="stat-card"><div class="s-icon">ğŸ†•</div><div class="s-num" id="newRec">0</div><div class="s-label">Ø¬Ø¯ÙŠØ¯</div></div>
        </div>
        <div id="participantsList" class="participants-grid"></div>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù…Ø¹ÙŠÙ† -->
      <div id="adminRecordingsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <button class="back-btn" onclick="backToParticipants()">Ø±Ø¬ÙˆØ¹ â—€</button>
        <h2 id="partTitle" style="color:var(--green-dark);text-align:center;font-size:1.2rem;margin-bottom:10px;padding-top:6px;"></h2>
        
        <div style="text-align:center;margin-bottom:10px;">
          <div class="total-rating" id="totalRatingDiv" style="display:none;">
            <span>â­</span><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span id="totalRatVal" style="font-size:1.1rem;font-weight:900;">0</span>
            <span>/</span>
            <span id="totalRatMax">0</span>
          </div>
        </div>

        <div class="contact-section">
          <div class="contact-header">
            <span class="contact-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
            <button class="toggle-contact-btn" onclick="toggleContact()"><span id="contactToggle">Ø¹Ø±Ø¶</span></button>
          </div>
          <div id="contactContent" class="hidden">
            <div class="info-row">
              <div><div class="info-label">Ø§Ù„Ø§Ø³Ù…</div><div class="info-val" id="cName">-</div></div>
              <button class="copy-btn" onclick="copyInfo('name',this)">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
            <div class="info-row">
              <div><div class="info-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div class="info-val" id="cPass">-</div></div>
              <button class="copy-btn" onclick="copyInfo('pass',this)">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
          </div>
        </div>

        <div id="adminRecList"></div>
      </div>
    </div>

    <!-- ======== TUTORIAL ======== -->
    <div id="tutorialOverlay" class="tutorial-overlay hidden">
      <div class="tutorial-box">
        <div class="tutorial-header">
          <h3 id="tutTitle">ğŸŒŸ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!</h3>
          <span id="tutStepIndicator" class="tutorial-step-indicator">1 / 4</span>
        </div>
        <div class="tutorial-content">
          <div class="tutorial-icon" id="tutIcon">ğŸ‰</div>
          <div class="tutorial-title" id="tutStepTitle"></div>
          <div class="tutorial-desc" id="tutDesc"></div>
          <div class="tutorial-highlight hidden" id="tutHighlight">
            <p id="tutHighlightText"></p>
          </div>
        </div>
        <div class="tutorial-footer">
          <div class="tutorial-dots" id="tutDots"></div>
          <div class="tutorial-btns" id="tutBtns">
            <button class="t-skip-btn" onclick="skipTutorial()">ØªØ®Ø·ÙŠ</button>
            <button class="t-next-btn" id="tutNextBtn" onclick="nextTutorialStep()">Ø§Ù„ØªØ§Ù„ÙŠ â—€</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getDatabase, ref, set, get, push, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';
      const cfg = {
        apiKey: "AIzaSyAfhQL5spF3KcrbngSzunLaHT_7cieHkUk",
        authDomain: "opject-e223d.firebaseapp.com",
        databaseURL: "https://opject-e223d-default-rtdb.firebaseio.com/",
        projectId: "opject-e223d",
        storageBucket: "opject-e223d.firebasestorage.app",
        messagingSenderId: "607939195786",
        appId: "1:607939195786:web:c264710387d50fc2990e73"
      };
      const app = initializeApp(cfg);
      const db = getDatabase(app);
      window.db = db; window.dbRef = ref; window.dbSet = set; window.dbGet = get;
      window.dbPush = push; window.dbUpdate = update; window.dbRemove = remove;
      window.firebaseReady = true;
    </script>

    <script>
    // ========== STATE ==========
    let currentUser = null;
    let isAdmin = false;
    let mediaRecorder = null;
    let recChunks = [];
    let recType = "audio";
    let timerInterval = null;
    let recStartTime = null;
    let previewStream = null;
    let currentParticipant = null;
    let adminVoiceRec = null;
    let adminVoiceChunks = [];
    let adminVoiceTimer = null;
    let currentRecordingForMsg = null;
    let viewedRecs = new Set();
    let selectedRating = 0;
    let tutorialStep = 0;
    let tutorialMode = '';
    let tutorialSteps = [];

    // ========== INIT ==========
    window.onload = function() {
      const check = setInterval(() => {
        if (window.firebaseReady && window.db) {
          clearInterval(check);
          loadViewedRecs();
          loadSession();
        }
      }, 100);
      setTimeout(() => { clearInterval(check); if (!window.db) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."); showPage('homePage'); } }, 5000);
    };

    // ========== SESSION ==========
    function loadSession() {
      const s = localStorage.getItem("session");
      if (!s) { showPage('homePage'); return; }
      const d = JSON.parse(s);
      if (d.isAdmin) {
        isAdmin = true;
        showAdminParticipantsPage();
      } else {
        showLoading();
        window.dbGet(window.dbRef(window.db, 'participants/'+d.userId)).then(snap => {
          hideLoading();
          if (snap.exists()) {
            currentUser = { id: d.userId, ...snap.val() };
            showParticipantPage();
          } else {
            localStorage.removeItem("session");
            showPage('homePage');
          }
        }).catch(() => { hideLoading(); localStorage.removeItem("session"); showPage('homePage'); });
      }
    }

    function saveSession() {
      localStorage.setItem("session", JSON.stringify(isAdmin ? {isAdmin:true} : {isAdmin:false, userId:currentUser.id}));
    }

    // ========== NAVIGATION ==========
    function showPage(pageId) {
      ['homePage','registerPage','loginPage','adminLoginPage','participantPage','adminParticipantsPage','adminRecordingsPage'].forEach(id => {
        document.getElementById(id).classList.add("hidden");
      });
      document.getElementById(pageId).classList.remove("hidden");
    }

    function showParticipantPage() {
      showPage('participantPage');
      document.getElementById('welcomeName').textContent = currentUser.name;
      switchTab('record');
      loadMyRecs();
      updateUnreadBadge();
      // ØªÙˆØªÙˆØ±ÙŠØ§Ù„ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
      const key = 'tutorial_participant_' + currentUser.id;
      if (!localStorage.getItem(key)) {
        localStorage.setItem(key, '1');
        setTimeout(() => showTutorial('participant'), 500);
      }
    }

    async function showAdminParticipantsPage() {
      showPage('adminParticipantsPage');
      await loadParticipants();
      // ØªÙˆØªÙˆØ±ÙŠØ§Ù„ Ù„Ù„Ø§Ø³ØªØ§Ø°Ø© Ø£ÙˆÙ„ Ù…Ø±Ø©
      if (!localStorage.getItem('tutorial_admin')) {
        localStorage.setItem('tutorial_admin', '1');
        setTimeout(() => showTutorial('admin'), 500);
      }
    }

    async function showAdminRecordingsPage(p) {
      currentParticipant = p;
      showPage('adminRecordingsPage');
      document.getElementById('partTitle').textContent = 'ØªØ³Ø¬ÙŠÙ„Ø§Øª: ' + p.name;
      document.getElementById('cName').textContent = p.name;
      document.getElementById('cPass').textContent = p.password;
      // reset contact info
      document.getElementById('contactContent').classList.add('hidden');
      document.getElementById('contactToggle').textContent = 'Ø¹Ø±Ø¶';
      await calcTotalRating();
      await loadParticipantRecs();
    }

    function backToParticipants() {
      currentParticipant = null;
      showAdminParticipantsPage();
    }

    function logout() {
      stopVideoPreview();
      localStorage.removeItem("session");
      currentUser = null; isAdmin = false; currentParticipant = null;
      showPage('homePage');
    }

    // ========== TABS (participant) ==========
    function switchTab(tab) {
      document.getElementById('tabRecord').classList.toggle('active', tab==='record');
      document.getElementById('tabMessages').classList.toggle('active', tab==='messages');
      document.getElementById('recordSection').classList.toggle('hidden', tab!=='record');
      document.getElementById('messagesSection').classList.toggle('hidden', tab!=='messages');
      if (tab === 'record') {
        if (recType === 'video' && !previewStream) startVideoPreview();
      } else {
        stopVideoPreview();
        loadParticipantMessages();
        markMsgsRead();
      }
    }

    // ========== FORMS ==========
    function togglePass(id, el) {
      const inp = document.getElementById(id);
      if (inp.type === "password") { inp.type = "text"; el.textContent = "ğŸ™ˆ"; }
      else { inp.type = "password"; el.textContent = "ğŸ‘ï¸"; }
    }

    document.getElementById("registerForm").onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById("regName").value.trim();
      const pass = document.getElementById("regPass").value;
      if (!name || !pass) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!"); return; }
      showLoading();
      try {
        const snap = await window.dbGet(window.dbRef(window.db, 'participants'));
        if (snap.exists()) {
          if (Object.values(snap.val()).some(p => p.name === name)) {
            hideLoading(); alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!"); return;
          }
        }
        const id = Date.now().toString();
        const p = { name, password: pass, registeredAt: new Date().toISOString(), recordings: [] };
        await window.dbSet(window.dbRef(window.db, 'participants/'+id), p);
        currentUser = { id, ...p };
        saveSession(); hideLoading(); showParticipantPage();
      } catch(err) { hideLoading(); alert("Ø®Ø·Ø£: " + err.message); }
    };

    document.getElementById("loginForm").onsubmit = async function(e) {
      e.preventDefault();
      const name = document.getElementById("loginName").value;
      const pass = document.getElementById("loginPass").value;
      showLoading();
      const snap = await window.dbGet(window.dbRef(window.db, 'participants'));
      hideLoading();
      if (snap.exists()) {
        let found = null, foundId = null;
        Object.entries(snap.val()).forEach(([id, p]) => {
          if (p.name === name && p.password === pass) { found = p; foundId = id; }
        });
        if (found) {
          currentUser = { id: foundId, ...found };
          saveSession(); showParticipantPage(); return;
        }
      }
      showError('loginError', 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
    };

    document.getElementById("adminLoginForm").onsubmit = function(e) {
      e.preventDefault();
      const pass = document.getElementById("adminPass").value;
      if (pass === "Qur@n2025#Admin$Ramadan") {
        isAdmin = true; saveSession(); showAdminParticipantsPage();
      } else {
        showError('adminError', 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
      }
    };

    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg; el.classList.remove('hidden');
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // ========== RECORDING ==========
    function selectType(type, card) {
      recType = type;
      document.querySelectorAll('.type-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      if (type === 'video') startVideoPreview();
      else stopVideoPreview();
    }

    async function startVideoPreview() {
      try {
        if (previewStream) return;
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        previewStream = stream;
        document.getElementById('liveVideo').srcObject = stream;
        document.getElementById('livePreview').classList.remove('hidden');
      } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message); }
    }

    function stopVideoPreview() {
      if (previewStream) {
        previewStream.getTracks().forEach(t => t.stop());
        previewStream = null;
        const v = document.getElementById('liveVideo');
        if (v.srcObject) { v.srcObject = null; }
        document.getElementById('livePreview').classList.add('hidden');
      }
    }

    async function startRecording() {
      try {
        let stream;
        if (recType === 'video') {
          if (previewStream) {
            const a = await navigator.mediaDevices.getUserMedia({ audio: true });
            stream = new MediaStream([...previewStream.getVideoTracks(), ...a.getAudioTracks()]);
          } else {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            previewStream = stream;
            document.getElementById('liveVideo').srcObject = stream;
            document.getElementById('livePreview').classList.remove('hidden');
          }
        } else {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        }

        recChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recChunks.push(e.data); };
        mediaRecorder.onstop = () => {
          if (recType === 'audio') stream.getTracks().forEach(t => t.stop());
          showRecPreview();
        };
        mediaRecorder.start();

        document.getElementById('recordBtn').classList.add('hidden');
        document.getElementById('stopBtn').classList.remove('hidden');
        document.getElementById('timer').classList.remove('hidden');
        if (recType === 'video') document.getElementById('livePreview').classList.add('recording');

        recStartTime = Date.now();
        timerInterval = setInterval(() => {
          const e = Math.floor((Date.now()-recStartTime)/1000);
          document.getElementById('timer').textContent = `${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
        }, 1000);
      } catch(err) { alert("Ø®Ø·Ø£: " + err.message); }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop(); clearInterval(timerInterval);
      }
    }

    function cancelRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
      document.getElementById('livePreview').classList.remove('recording');
      clearInterval(timerInterval); recChunks = [];
      document.getElementById('recordBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('timer').classList.add('hidden');
      document.getElementById('timer').textContent = '00:00';
      document.getElementById('recPreviewSection').classList.add('hidden');
    }

    function showRecPreview() {
      const blob = new Blob(recChunks, { type: recType === 'video' ? 'video/webm' : 'audio/webm' });
      const url = URL.createObjectURL(blob);
      document.getElementById('previewMedia').innerHTML = recType === 'video'
        ? `<video controls src="${url}"></video>`
        : `<audio controls src="${url}"></audio>`;
      document.getElementById('recPreviewSection').classList.remove('hidden');
      document.getElementById('recordBtn').classList.remove('hidden');
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('timer').classList.add('hidden');
    }

    async function saveRecording() {
      showLoading();
      try {
        const blob = new Blob(recChunks, { type: recType === 'video' ? 'video/webm' : 'audio/webm' });
        const b64 = await blobToBase64(blob);
        const recId = Date.now().toString();
        const rec = { id: recId, type: recType, data: b64, timestamp: new Date().toISOString() };
        const recs = [...(currentUser.recordings || []), rec];
        await window.dbUpdate(window.dbRef(window.db), { [`participants/${currentUser.id}/recordings`]: recs });
        currentUser.recordings = recs;
        hideLoading();
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
        document.getElementById('livePreview').classList.remove('recording');
        clearInterval(timerInterval); recChunks = [];
        document.getElementById('recPreviewSection').classList.add('hidden');
        document.getElementById('timer').textContent = '00:00';
        loadMyRecs();
      } catch(err) { hideLoading(); alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + err.message); }
    }

    // ========== MY RECORDINGS with ATTACHED MESSAGES ==========
    async function loadMyRecs() {
      const listDiv = document.getElementById("myRecList");
      if (!currentUser.recordings || currentUser.recordings.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯<br><small>Ø§Ø¨Ø¯Ø£ Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ù„Ùƒ Ø§Ù„Ø¢Ù†!</small></p></div>';
        return;
      }

      // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ
      const msgsSnap = await window.dbGet(window.dbRef(window.db, 'messages'));
      const myMessages = {};
      if (msgsSnap.exists()) {
        msgsSnap.forEach(child => {
          const m = child.val();
          if (m.participantId === currentUser.id) {
            if (!myMessages[m.recordingId]) myMessages[m.recordingId] = [];
            myMessages[m.recordingId].push({ id: child.key, ...m });
          }
        });
      }

      let html = '';
      currentUser.recordings.forEach((rec, i) => {
        const recMsgs = myMessages[rec.id] || [];
        const hasUnread = recMsgs.some(m => !m.read);
        
        html += `
          <div class="rec-item" id="recItem_${rec.id}">
            ${hasUnread ? `<div style="position:absolute;top:-8px;right:-8px;background:var(--red);color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:0.75rem;font-weight:700;border:2px solid white;">!</div>` : ''}
            <div class="three-dots" onclick="showMyRecMenu(event,'${rec.id}')">â‹®</div>
            <p style="color:var(--green-dark);font-weight:700;font-size:1rem;margin-bottom:4px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} â€” ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
            </p>
            <p class="rec-date">${new Date(rec.timestamp).toLocaleDateString('ar-SA')}</p>
            ${rec.type === 'video' ? `<video controls src="${rec.data}"></video>` : `<audio controls src="${rec.data}"></audio>`}
            ${recMsgs.length > 0 ? buildAttachedMessages(recMsgs) : ''}
          </div>
        `;
      });
      listDiv.innerHTML = html;
    }

    function buildAttachedMessages(msgs) {
      // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ù‚Ø¯Ù… Ù„Ù„Ø£Ø­Ø¯Ø«
      msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      let html = `
        <div class="rec-messages">
          <div class="rec-msg-header">
            <span>ğŸ’¬</span>
            <span>Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
          </div>
      `;
      msgs.forEach(msg => {
        let typeIcon = 'âœ‰ï¸';
        if (msg.messageType === 'voice') typeIcon = 'ğŸ¤';
        if (msg.messageType === 'rating') typeIcon = 'â­';
        
        html += `
          <div class="attached-msg ${!msg.read ? 'unread' : ''}">
            <div class="msg-type">${typeIcon} ${new Date(msg.timestamp).toLocaleDateString('ar-SA')}</div>
            <div class="msg-body">${msg.message}</div>
            ${msg.messageType === 'voice' && msg.voiceData ? `<audio controls src="${msg.voiceData}"></audio>` : ''}
            ${msg.messageType === 'rating' && msg.rating ? `
              <div class="rating-display">
                <div class="rating-stars">${generateStars(msg.rating)}</div>
                <div class="rating-num">${msg.rating} / 5 â­</div>
              </div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function generateStars(rating) {
      let html = '';
      for (let i = 1; i <= 5; i++) {
        if (rating >= i) html += '<span style="color:#fbbf24;">â­</span>';
        else if (rating > i-1) html += '<span style="opacity:0.4;">â­</span>';
        else html += '<span style="opacity:0.2;">â­</span>';
      }
      return html;
    }

    function showMyRecMenu(e, recId) {
      e.stopPropagation();
      document.querySelectorAll('.menu-popup').forEach(m => m.remove());
      const menu = document.createElement('div');
      menu.className = 'menu-popup';
      menu.innerHTML = `<div class="menu-item danger" onclick="confirmDelete('${recId}', false)">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
      e.target.parentElement.appendChild(menu);
      setTimeout(() => {
        document.addEventListener('click', function close(e) {
          if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', close); }
        });
      }, 10);
    }

    // ========== PARTICIPANT MESSAGES PAGE ==========
    async function loadParticipantMessages() {
      const listDiv = document.getElementById("participantMsgList");
      const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
      if (!snap.exists()) {
        listDiv.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p></div>';
        return;
      }
      const msgs = [];
      snap.forEach(child => {
        const m = child.val();
        if (m.participantId === currentUser.id) msgs.push({ id: child.key, ...m });
      });
      if (msgs.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</p></div>';
        return;
      }
      msgs.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
      listDiv.innerHTML = msgs.map(msg => `
        <div style="background:linear-gradient(135deg,#fff9e6,white);padding:14px;border-radius:10px;margin-bottom:10px;border-right:3px solid var(--gold);${!msg.read?'box-shadow:0 3px 12px rgba(212,175,55,0.2);':''}">
          <div style="display:flex;justify-content:space-between;margin-bottom:8px;padding-bottom:8px;border-bottom:1px solid var(--border);">
            <span style="color:var(--gold);font-weight:700;">${msg.messageType==='voice'?'ğŸ¤':msg.messageType==='rating'?'â­':'âœ‰ï¸'} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
            <span style="color:#888;font-size:0.75rem;">${new Date(msg.timestamp).toLocaleDateString('ar-SA')}</span>
          </div>
          <p style="font-size:0.95rem;line-height:1.6;">${msg.message}</p>
          ${msg.messageType === 'voice' && msg.voiceData ? `<div style="background:white;padding:8px;border-radius:8px;margin-top:8px;border:1px solid var(--border);"><audio controls src="${msg.voiceData}" style="width:100%;"></audio></div>` : ''}
          ${msg.messageType === 'rating' && msg.rating ? `<div class="rating-display" style="margin-top:8px;"><div class="rating-stars">${generateStars(msg.rating)}</div><div class="rating-num">${msg.rating} / 5</div></div>` : ''}
        </div>
      `).join('');
    }

    async function updateUnreadBadge() {
      const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
      let count = 0;
      if (snap.exists()) {
        snap.forEach(child => {
          const m = child.val();
          if (m.participantId === currentUser.id && !m.read) count++;
        });
      }
      const badge = document.getElementById('unreadBadge');
      if (count > 0) { badge.textContent = count; badge.classList.remove('hidden'); }
      else badge.classList.add('hidden');
    }

    async function markMsgsRead() {
      const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
      if (!snap.exists()) return;
      const updates = {};
      snap.forEach(child => {
        const m = child.val();
        if (m.participantId === currentUser.id && !m.read) updates[`messages/${child.key}/read`] = true;
      });
      if (Object.keys(updates).length > 0) await window.dbUpdate(window.dbRef(window.db), updates);
      updateUnreadBadge();
      loadMyRecs(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ø¥Ø²Ø§Ù„Ø© Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
    }

    // ========== ADMIN: LOAD PARTICIPANTS ==========
    async function loadParticipants() {
      showLoading();
      const snap = await window.dbGet(window.dbRef(window.db, 'participants'));
      hideLoading();
      const listDiv = document.getElementById('participantsList');
      if (!snap.exists()) {
        listDiv.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>';
        updateStats(0,0,0); return;
      }
      let participants = [];
      snap.forEach(child => participants.push({ id: child.key, ...child.val() }));
      let totalR = 0, newR = 0;
      participants.forEach(p => {
        const recs = p.recordings || [];
        totalR += recs.length;
        recs.forEach(r => { if (!isViewed(p.id, r.id)) newR++; });
      });
      updateStats(participants.length, totalR, newR);
      listDiv.innerHTML = participants.map(p => {
        const newCount = (p.recordings||[]).filter(r => !isViewed(p.id, r.id)).length;
        return `
          <div class="participant-card" onclick='showAdminRecordingsPage(${JSON.stringify(p)})'>
            ${newCount > 0 ? `<div class="new-rec-badge">${newCount}</div>` : ''}
            <div class="p-icon">ğŸ‘¤</div>
            <h3>${p.name}</h3>
            <p class="p-count">${(p.recordings||[]).length} ØªØ³Ø¬ÙŠÙ„</p>
          </div>
        `;
      }).join('');
    }

    function updateStats(p, r, n) {
      document.getElementById('totalPart').textContent = p;
      document.getElementById('totalRec').textContent = r;
      document.getElementById('newRec').textContent = n;
    }

    // ========== ADMIN: LOAD PARTICIPANT RECORDINGS (with messages) ==========
    async function loadParticipantRecs() {
      const listDiv = document.getElementById('adminRecList');
      if (!currentParticipant.recordings || currentParticipant.recordings.length === 0) {
        listDiv.innerHTML = '<div class="empty-state"><div class="e-icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
        return;
      }
      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„
      const msgsSnap = await window.dbGet(window.dbRef(window.db, 'messages'));
      const recMsgs = {};
      if (msgsSnap.exists()) {
        msgsSnap.forEach(child => {
          const m = child.val();
          if (m.participantId === currentParticipant.id) {
            if (!recMsgs[m.recordingId]) recMsgs[m.recordingId] = [];
            recMsgs[m.recordingId].push({ id: child.key, ...m });
          }
        });
      }
      // ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ø´Ø§Ù‡ÙØ¯
      currentParticipant.recordings.forEach(r => markViewed(currentParticipant.id, r.id));

      listDiv.innerHTML = currentParticipant.recordings.map((rec, i) => {
        const msgs = recMsgs[rec.id] || [];
        return `
          <div class="rec-item">
            <div class="three-dots" onclick="showAdminRecMenu(event,'${rec.id}')">â‹®</div>
            <p style="color:var(--green-dark);font-weight:700;font-size:1rem;margin-bottom:4px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${i+1} â€” ${rec.type === 'video' ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¤ ØµÙˆØª'}
            </p>
            <p class="rec-date">${new Date(rec.timestamp).toLocaleDateString('ar-SA')}</p>
            ${rec.type === 'video' ? `<video controls src="${rec.data}"></video>` : `<audio controls src="${rec.data}"></audio>`}
            ${msgs.length > 0 ? buildAdminMsgs(msgs) : ''}
          </div>
        `;
      }).join('');
    }

    function buildAdminMsgs(msgs) {
      msgs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      let html = `<div class="rec-messages"><div class="rec-msg-header"><span>ğŸ’¬</span><span>Ø±Ø³Ø§Ø¦Ù„ Ø£ÙØ±Ø³Ù„Øª</span></div>`;
      msgs.forEach(msg => {
        html += `
          <div class="attached-msg">
            <div class="msg-type">${msg.messageType==='voice'?'ğŸ¤':msg.messageType==='rating'?'â­':'âœ‰ï¸'} ${new Date(msg.timestamp).toLocaleDateString('ar-SA')}</div>
            <div class="msg-body">${msg.message}</div>
            ${msg.messageType === 'voice' && msg.voiceData ? `<audio controls src="${msg.voiceData}"></audio>` : ''}
            ${msg.messageType === 'rating' && msg.rating ? `<div class="rating-display"><div class="rating-stars">${generateStars(msg.rating)}</div><div class="rating-num">${msg.rating} / 5</div></div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    function showAdminRecMenu(e, recId) {
      e.stopPropagation();
      document.querySelectorAll('.menu-popup').forEach(m => m.remove());
      const menu = document.createElement('div');
      menu.className = 'menu-popup';
      menu.innerHTML = `
        <div class="menu-item" onclick="openMsgModal('${recId}','text')">âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
        <div class="menu-item" onclick="openMsgModal('${recId}','voice')">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
        <div class="menu-item" onclick="openMsgModal('${recId}','rating')">â­ ØªÙ‚ÙŠÙŠÙ…</div>
        <div class="menu-item danger" onclick="confirmDelete('${recId}', true)">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
      `;
      e.target.parentElement.appendChild(menu);
      setTimeout(() => {
        document.addEventListener('click', function close(e) {
          if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', close); }
        });
      }, 10);
    }

    // ========== MESSAGE MODAL ==========
    function openMsgModal(recId, type) {
      currentRecordingForMsg = recId;
      selectedRating = 0;
      const modal = document.createElement('div');
      modal.className = 'msg-modal-overlay';
      modal.id = 'msgModal';
      modal.innerHTML = `
        <div class="msg-modal-box">
          <h3>ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
          <div class="msg-type-btns">
            <button class="msg-type-btn ${type==='text'?'active':''}" onclick="switchMsgType('text',this)">âœï¸ Ù†ØµÙŠØ©</button>
            <button class="msg-type-btn ${type==='voice'?'active':''}" onclick="switchMsgType('voice',this)">ğŸ¤ ØµÙˆØªÙŠØ©</button>
            <button class="msg-type-btn ${type==='rating'?'active':''}" onclick="switchMsgType('rating',this)">â­ ØªÙ‚ÙŠÙŠÙ…</button>
          </div>
          <div id="textDiv" class="${type!=='text'?'hidden':''}">
            <textarea id="msgText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
          </div>
          <div id="voiceDiv" class="voice-box ${type!=='voice'?'hidden':''}">
            <button class="btn btn-primary" id="vRecBtn" onclick="startAdminVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div class="timer hidden" id="vTimer">00:00</div>
            <button class="btn btn-danger hidden" id="vStopBtn" onclick="stopAdminVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
            <div id="vPreview" class="hidden"><audio id="vAudio" controls></audio></div>
          </div>
          <div id="ratingDiv" class="rating-box ${type!=='rating'?'hidden':''}">
            <p style="color:var(--green-dark);font-weight:700;margin-bottom:8px;">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
            <div class="stars-row" id="starsRow">
              ${[1,2,3,4,5].map(i => `<span class="star" onclick="setRating(${i})" data-v="${i}">â­</span>`).join('')}
            </div>
            <div class="rating-val" id="ratVal">0 / 5</div>
            <div class="rating-btns-grid">
              ${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(v => `<button class="r-btn" onclick="setRating(${v})">${v}</button>`).join('')}
            </div>
          </div>
          <div class="modal-btns">
            <button class="btn btn-primary" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
            <button class="btn btn-secondary" onclick="closeMsgModal()">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function switchMsgType(type, btn) {
      document.querySelectorAll('.msg-type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ['textDiv','voiceDiv','ratingDiv'].forEach(id => document.getElementById(id).classList.add('hidden'));
      if (type==='text') document.getElementById('textDiv').classList.remove('hidden');
      else if (type==='voice') document.getElementById('voiceDiv').classList.remove('hidden');
      else document.getElementById('ratingDiv').classList.remove('hidden');
    }

    function setRating(v) {
      selectedRating = v;
      document.getElementById('ratVal').textContent = `${v} / 5`;
      document.querySelectorAll('#starsRow .star').forEach((s, i) => {
        s.classList.remove('filled');
        if (v >= i+1) s.classList.add('filled');
      });
      document.querySelectorAll('.r-btn').forEach(b => {
        b.classList.toggle('active', parseFloat(b.textContent) === v);
      });
    }

    async function startAdminVoice() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        adminVoiceChunks = [];
        adminVoiceRec = new MediaRecorder(stream);
        adminVoiceRec.ondataavailable = e => { if (e.data.size > 0) adminVoiceChunks.push(e.data); };
        adminVoiceRec.onstop = () => {
          stream.getTracks().forEach(t => t.stop());
          const blob = new Blob(adminVoiceChunks, { type: 'audio/webm' });
          document.getElementById('vAudio').src = URL.createObjectURL(blob);
          document.getElementById('vPreview').classList.remove('hidden');
        };
        adminVoiceRec.start();
        document.getElementById('vRecBtn').classList.add('hidden');
        document.getElementById('vStopBtn').classList.remove('hidden');
        document.getElementById('vTimer').classList.remove('hidden');
        const t0 = Date.now();
        adminVoiceTimer = setInterval(() => {
          const e = Math.floor((Date.now()-t0)/1000);
          document.getElementById('vTimer').textContent = `${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
        }, 1000);
      } catch(err) { alert("Ø®Ø·Ø£: " + err.message); }
    }

    function stopAdminVoice() {
      if (adminVoiceRec && adminVoiceRec.state !== 'inactive') { adminVoiceRec.stop(); clearInterval(adminVoiceTimer); }
      document.getElementById('vRecBtn').classList.remove('hidden');
      document.getElementById('vStopBtn').classList.add('hidden');
      document.getElementById('vTimer').classList.add('hidden');
    }

    async function sendMsg() {
      const activeBtn = document.querySelector('.msg-type-btn.active');
      let type = 'text';
      if (activeBtn.textContent.includes('ØµÙˆØªÙŠØ©')) type = 'voice';
      else if (activeBtn.textContent.includes('ØªÙ‚ÙŠÙŠÙ…')) type = 'rating';

      showLoading();
      try {
        if (type === 'text') {
          const txt = document.getElementById('msgText').value.trim();
          if (!txt) { hideLoading(); alert("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹!"); return; }
          await saveMsg(currentParticipant.id, currentRecordingForMsg, txt, 'text', null, null);
        } else if (type === 'voice') {
          if (!adminVoiceChunks.length) { hideLoading(); alert("Ø³Ø¬Ù‘Ù„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!"); return; }
          const b64 = await blobToBase64(new Blob(adminVoiceChunks, { type: 'audio/webm' }));
          await saveMsg(currentParticipant.id, currentRecordingForMsg, "ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©", 'voice', b64, null);
        } else {
          if (!selectedRating) { hideLoading(); alert("Ø§Ø®ØªØ± ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!"); return; }
          // Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
          const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (snap.exists()) {
            const updates = {};
            snap.forEach(c => { const m = c.val(); if (m.recordingId===currentRecordingForMsg && m.participantId===currentParticipant.id && m.messageType==='rating') updates[`messages/${c.key}`]=null; });
            if (Object.keys(updates).length) await window.dbUpdate(window.dbRef(window.db), updates);
          }
          await saveMsg(currentParticipant.id, currentRecordingForMsg, `ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selectedRating} / 5 Ù†Ø¬ÙˆÙ… â­`, 'rating', null, selectedRating);
        }
        hideLoading(); closeMsgModal();
        await calcTotalRating();
        await loadParticipantRecs();
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! âœ…");
      } catch(err) { hideLoading(); alert("Ø®Ø·Ø£: " + err.message); }
    }

    async function saveMsg(pId, recId, msg, type, voiceData, rating) {
      const ref = window.dbPush(window.dbRef(window.db, 'messages'));
      const obj = { participantId: pId, recordingId: recId, message: msg, messageType: type, timestamp: new Date().toISOString(), read: false };
      if (voiceData) obj.voiceData = voiceData;
      if (rating) obj.rating = rating;
      await window.dbSet(ref, obj);
    }

    function closeMsgModal() {
      document.getElementById('msgModal')?.remove();
      adminVoiceChunks = [];
      if (adminVoiceRec && adminVoiceRec.state !== 'inactive') adminVoiceRec.stop();
      clearInterval(adminVoiceTimer);
      selectedRating = 0;
    }

    // ========== CALC TOTAL RATING ==========
    async function calcTotalRating() {
      const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
      let total = 0, count = 0;
      const ratedSet = new Set();
      if (snap.exists()) {
        snap.forEach(c => {
          const m = c.val();
          if (m.participantId === currentParticipant.id && m.messageType === 'rating' && m.rating && !ratedSet.has(m.recordingId)) {
            total += m.rating; ratedSet.add(m.recordingId); count++;
          }
        });
      }
      const div = document.getElementById('totalRatingDiv');
      if (count === 0) { div.style.display = 'none'; return; }
      div.style.display = 'inline-flex';
      document.getElementById('totalRatVal').textContent = total.toFixed(1);
      document.getElementById('totalRatMax').textContent = count * 5;
    }

    // ========== DELETE ==========
    function confirmDelete(recId, isAdminDelete) {
      const d = document.createElement('div');
      d.className = 'confirm-overlay';
      d.innerHTML = `
        <div class="confirm-box">
          <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
          <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.</p>
          <div class="confirm-btns">
            <button class="btn btn-danger" onclick="doDelete('${recId}',${isAdminDelete})">Ø­Ø°Ù</button>
            <button class="btn btn-secondary" onclick="this.closest('.confirm-overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
      `;
      document.body.appendChild(d);
    }

    async function doDelete(recId, isAdminDelete) {
      showLoading();
      const source = isAdminDelete ? currentParticipant : currentUser;
      const pId = isAdminDelete ? currentParticipant.id : currentUser.id;
      const newRecs = (source.recordings || []).filter(r => r.id !== recId);
      await window.dbUpdate(window.dbRef(window.db), { [`participants/${pId}/recordings`]: newRecs });
      // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©
      const snap = await window.dbGet(window.dbRef(window.db, 'messages'));
      if (snap.exists()) {
        const updates = {};
        snap.forEach(c => { if (c.val().recordingId === recId) updates[`messages/${c.key}`] = null; });
        if (Object.keys(updates).length) await window.dbUpdate(window.dbRef(window.db), updates);
      }
      if (isAdminDelete) {
        currentParticipant.recordings = newRecs;
        await calcTotalRating();
        await loadParticipantRecs();
      } else {
        currentUser.recordings = newRecs;
        loadMyRecs();
        updateUnreadBadge();
      }
      hideLoading();
      document.querySelector('.confirm-overlay')?.remove();
      alert("ØªÙ… Ø§Ù„Ø­Ø°Ù! âœ…");
    }

    // ========== CONTACT INFO ==========
    function toggleContact() {
      const c = document.getElementById('contactContent');
      const t = document.getElementById('contactToggle');
      if (c.classList.contains('hidden')) { c.classList.remove('hidden'); t.textContent = 'Ø¥Ø®ÙØ§Ø¡'; }
      else { c.classList.add('hidden'); t.textContent = 'Ø¹Ø±Ø¶'; }
    }

    async function copyInfo(type, btn) {
      const text = type === 'name' ? currentParticipant.name : currentParticipant.password;
      try {
        await navigator.clipboard.writeText(text);
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ… ØªÙ…'; btn.classList.add('copied');
        setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
      } catch(err) { alert("ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®"); }
    }

    // ========== VIEWED RECORDINGS ==========
    function loadViewedRecs() { const s = localStorage.getItem('viewedRecs'); if (s) viewedRecs = new Set(JSON.parse(s)); }
    function saveViewedRecs() { localStorage.setItem('viewedRecs', JSON.stringify([...viewedRecs])); }
    function markViewed(pId, rId) { viewedRecs.add(`${pId}_${rId}`); saveViewedRecs(); }
    function isViewed(pId, rId) { return viewedRecs.has(`${pId}_${rId}`); }

    // ========== UTILS ==========
    function blobToBase64(blob) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onloadend = () => res(r.result);
        r.onerror = rej;
        r.readAsDataURL(blob);
      });
    }

    function showLoading() {
      if (document.getElementById('loadingOverlay')) return;
      const d = document.createElement('div');
      d.className = 'loading-overlay'; d.id = 'loadingOverlay';
      d.innerHTML = '<div class="loading-text"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>';
      document.body.appendChild(d);
    }
    function hideLoading() { document.getElementById('loadingOverlay')?.remove(); }

    // ========== TUTORIAL ==========
    const PARTICIPANT_STEPS = [
      {
        icon: 'ğŸŒŸ', title: 'Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¡ Ø¹Ù…!',
        desc: 'Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø¹Ù„Ù‰ Ø¥Ø±Ø³Ø§Ù„ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙƒ Ù„Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù† Ù„Ù„Ø§Ø³ØªØ§Ø°Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.',
        highlight: null
      },
      {
        icon: 'ğŸ¤', title: 'ÙƒÙŠÙ ØªØ³Ø¬Ù‘Ù„ØŸ',
        desc: 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„" Ù„ØªØ³Ø¬ÙŠÙ„ Ø­ÙØ¸Ùƒ ØµÙˆØªØ§Ù‹ Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆØŒ Ø«Ù… Ø§Ø¶ØºØ· "Ø¥ÙŠÙ‚Ø§Ù" Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡.',
        highlight: 'ğŸ“Œ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆÙ‚'
      },
      {
        icon: 'ğŸ’¾', title: 'Ø­ÙØ¸ Ø§Ù„ØªØ³Ø¬ÙŠÙ„',
        desc: 'Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø³ØªØ¸Ù‡Ø± Ù„Ùƒ Ù…Ø¹Ø§ÙŠÙ†Ø©ØŒ Ø±Ø§Ø¬Ø¹Ù‡Ø§ Ø«Ù… Ø§Ø¶ØºØ· "Ø­ÙØ¸" Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©.',
        highlight: 'âœ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙŠÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'
      },
      {
        icon: 'ğŸ“¬', title: 'Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©',
        desc: 'Ø³ØªØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ÙˆØªÙ‚ÙŠÙŠÙ…Ø§ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ­Øª ÙƒÙ„ ØªØ³Ø¬ÙŠÙ„ØŒ Ø£Ùˆ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ "Ø±Ø³Ø§Ø¦Ù„ÙŠ".',
        highlight: 'ğŸ”” Ø³ØªØ¸Ù‡Ø± Ù†Ù‚Ø·Ø© Ø­Ù…Ø±Ø§Ø¡ Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©'
      }
    ];

    const ADMIN_STEPS = [
      {
        icon: 'ğŸ‘©â€ğŸ«', title: 'Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
        desc: 'Ù‡Ù†Ø§ ØªØ¬Ø¯ÙŠÙ† Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØ¹Ø¯Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡Ù… ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.',
        highlight: 'ğŸ”´ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£Ø­Ù…Ø± ÙŠØ¹Ù†ÙŠ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ù… ØªØ´Ø§Ù‡Ø¯ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯'
      },
      {
        icon: 'ğŸ™ï¸', title: 'Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª',
        desc: 'Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø£ÙŠ Ù…Ø´Ø§Ø±Ùƒ Ù„ØªØ±Ù‰ Ø¬Ù…ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡ ÙˆØªØ³ØªÙ…Ø¹ÙŠ Ø¥Ù„ÙŠÙ‡Ø§.',
        highlight: null
      },
      {
        icon: 'ğŸ’¬', title: 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ ÙˆØªÙ‚ÙŠÙŠÙ…Ø§Øª',
        desc: 'Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø· (â‹®) Ø¨Ø¬Ø§Ù†Ø¨ Ø£ÙŠ ØªØ³Ø¬ÙŠÙ„ Ù„Ø¥Ø±Ø³Ø§Ù„: Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©ØŒ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©ØŒ Ø£Ùˆ ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ….',
        highlight: 'â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ØªØ¸Ù‡Ø± Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ­Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©'
      },
      {
        icon: 'ğŸ“Š', title: 'Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªÙ‚Ø¯Ù…',
        desc: 'ÙŠØ¸Ù‡Ø± Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· ÙƒÙ„ Ù…Ø´Ø§Ø±Ùƒ ÙÙŠ Ø£Ø¹Ù„Ù‰ ØµÙØ­ØªÙ‡ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø³Ø® Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±Ù‡.',
        highlight: 'ğŸ“‹ Ø§Ø¶ØºØ·ÙŠ "Ø¹Ø±Ø¶" ÙÙŠ Ù‚Ø³Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„'
      }
    ];

    function showTutorial(mode) {
      tutorialMode = mode;
      tutorialStep = 0;
      tutorialSteps = mode === 'admin' ? ADMIN_STEPS : PARTICIPANT_STEPS;
      document.getElementById('tutTitle').textContent = mode === 'admin' ? 'ğŸ‘©â€ğŸ« Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©' : 'ğŸŒŸ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ!';
      document.getElementById('tutorialOverlay').classList.remove('hidden');
      renderTutorialStep();
    }

    function renderTutorialStep() {
      const step = tutorialSteps[tutorialStep];
      const total = tutorialSteps.length;
      document.getElementById('tutStepIndicator').textContent = `${tutorialStep+1} / ${total}`;
      document.getElementById('tutIcon').textContent = step.icon;
      document.getElementById('tutStepTitle').textContent = step.title;
      document.getElementById('tutDesc').textContent = step.desc;
      const hl = document.getElementById('tutHighlight');
      if (step.highlight) {
        hl.classList.remove('hidden');
        document.getElementById('tutHighlightText').textContent = step.highlight;
      } else hl.classList.add('hidden');
      // dots
      const dots = document.getElementById('tutDots');
      dots.innerHTML = tutorialSteps.map((_,i) => `<div class="t-dot ${i===tutorialStep?'active':''}"></div>`).join('');
      // buttons
      const btns = document.getElementById('tutBtns');
      const isLast = tutorialStep === total - 1;
      btns.className = 'tutorial-btns' + (tutorialStep === 0 ? ' first' : '');
      if (tutorialStep === 0) {
        btns.innerHTML = `<button class="t-next-btn" onclick="nextTutorialStep()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¬ÙˆÙ„Ø© â—€</button>`;
      } else if (isLast) {
        btns.innerHTML = `
          <button class="t-skip-btn" onclick="skipTutorial()">â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button class="t-next-btn" onclick="skipTutorial()">âœ… ÙÙ‡Ù…Øª!</button>
        `;
        // override prev button
        btns.querySelector('.t-skip-btn').onclick = prevTutorialStep;
      } else {
        btns.innerHTML = `
          <button class="t-skip-btn" onclick="prevTutorialStep()">â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <button class="t-next-btn" onclick="nextTutorialStep()">Ø§Ù„ØªØ§Ù„ÙŠ â—€</button>
        `;
      }
    }

    function nextTutorialStep() {
      if (tutorialStep < tutorialSteps.length - 1) { tutorialStep++; renderTutorialStep(); }
      else skipTutorial();
    }
    function prevTutorialStep() {
      if (tutorialStep > 0) { tutorialStep--; renderTutorialStep(); }
    }
    function skipTutorial() {
      document.getElementById('tutorialOverlay').classList.add('hidden');
    }
    </script>
  </body>
</html>
