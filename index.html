<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet" />
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      :root {
        --primary-gold: #d4af37;
        --dark-green: #0d4d3f;
        --medium-green: #1a6b54;
        --light-green: #e8f5e9;
        --cream: #fefdf8;
        --white: #ffffff;
        --text-dark: #2c2c2c;
        --border-light: #e0dfd5;
        --accent-gold: #f0c850;
      }
      body {
        font-family: "Cairo", sans-serif;
        background: linear-gradient(135deg, #0d4d3f 0%, #1a6b54 100%);
        min-height: 100vh;
        padding: 8px;
        position: relative;
        overflow-x: hidden;
      }
      .container { max-width: 900px; margin: 0 auto; }
      .header { text-align: center; margin-bottom: 8px; }
      .logo {
        width: 50px; height: 50px; margin: 0 auto 8px;
        background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold));
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.5);
      }
      .logo img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
      h1 { font-family: "Amiri", serif; color: var(--white); font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
      .subtitle { color: var(--primary-gold); font-size: 0.9rem; font-weight: 600; }
      .card { background: var(--white); border-radius: 12px; padding: 15px 12px; box-shadow: 0 6px 25px rgba(0,0,0,0.15); margin-bottom: 8px; }
      .form-group { margin-bottom: 12px; position: relative; }
      .password-toggle { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.1rem; color: #666; transition: color 0.3s ease; user-select: none; }
      .password-input-wrapper { position: relative; }
      label { display: block; color: var(--dark-green); font-weight: 700; margin-bottom: 6px; font-size: 0.95rem; }
      input[type="text"], input[type="password"] { width: 100%; padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; font-size: 0.95rem; font-family: "Cairo", sans-serif; transition: all 0.3s ease; background: var(--cream); }
      input:focus { outline: none; border-color: var(--primary-gold); background: var(--white); }
      .btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-size: 1rem; font-weight: 700; font-family: "Cairo", sans-serif; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px; }
      .btn-primary { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); color: var(--dark-green); box-shadow: 0 4px 15px rgba(212,175,55,0.4); }
      .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212,175,55,0.5); }
      .btn-secondary { background: var(--dark-green); color: var(--white); box-shadow: 0 4px 15px rgba(13,77,63,0.3); }
      .btn-secondary:hover { background: var(--medium-green); transform: translateY(-2px); }
      .btn-danger { background: #dc2626; color: white; }
      .btn-danger:hover { background: #b91c1c; }
      .big-icon-btn { font-size: 1.3rem; padding: 15px; margin: 6px 0; }
      .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-bottom: 12px; }
      .stat-card { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 3px 12px rgba(212,175,55,0.3); }
      .stat-card .icon { font-size: 1.4rem; margin-bottom: 3px; }
      .stat-card .number { font-size: 1.5rem; font-weight: 900; color: var(--dark-green); margin-bottom: 2px; }
      .stat-card .label { font-size: 0.75rem; color: var(--dark-green); font-weight: 600; }
      .record-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 12px 0; }
      .type-card { background: white; border: 2px solid var(--border-light); border-radius: 12px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
      .type-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); }
      .type-card.selected { border-color: var(--primary-gold); background: linear-gradient(to bottom, #fff9e6, white); }
      .type-card .icon { font-size: 2.5rem; margin-bottom: 6px; }
      .type-card h3 { font-size: 1rem; color: var(--dark-green); }
      .recording-controls { margin-top: 12px; }
      .timer { text-align: center; font-size: 1.8rem; font-weight: 700; color: var(--dark-green); margin: 12px 0; font-family: "Courier New", monospace; }
      .live-preview { margin: 12px 0; padding: 10px; background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .live-preview.recording { background: linear-gradient(135deg, #fef3c7, #fde68a); border-color: #dc2626; }
      .live-preview video { width: 100%; border-radius: 8px; background: #000; }
      .recording-preview { margin: 12px 0; padding: 12px; background: linear-gradient(to bottom, #fff9e6, white); border-radius: 10px; border: 2px solid var(--primary-gold); }
      .recording-preview video, .recording-preview audio { width: 100%; border-radius: 8px; margin-top: 10px; }
      .recording-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .recording-item video, .recording-item audio { width: 100%; margin-top: 8px; border-radius: 8px; }
      .recording-date { color: #666; font-size: 0.8rem; margin-bottom: 8px; }
      .three-dots { position: absolute; top: 10px; left: 10px; font-size: 1.5rem; cursor: pointer; color: #666; padding: 5px; }
      .three-dots:hover { color: var(--dark-green); }
      .menu-popup { position: absolute; top: 40px; left: 10px; background: white; border: 2px solid var(--primary-gold); border-radius: 8px; box-shadow: 0 3px 15px rgba(0,0,0,0.2); z-index: 100; min-width: 160px; }
      .menu-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; font-size: 0.9rem; transition: all 0.3s ease; }
      .menu-item:last-child { border-bottom: none; }
      .menu-item:hover { background: var(--cream); }
      .menu-item.danger { color: #dc2626; }
      .logout-btn { position: fixed; top: 10px; left: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
      .logout-btn:hover { background: var(--primary-gold); color: var(--white); }
      .back-btn { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.95); color: var(--dark-green); padding: 8px 14px; border: 2px solid var(--primary-gold); border-radius: 15px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; z-index: 1000; box-shadow: 0 3px 12px rgba(0,0,0,0.15); }
      .back-btn:hover { background: var(--primary-gold); color: var(--white); }
      .hidden { display: none !important; }
      .error-message { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 0.9rem; font-weight: 600; }
      .participants-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 8px; margin-top: 12px; }
      .participant-card { background: white; padding: 12px 8px; border-radius: 10px; border: 2px solid var(--border-light); cursor: pointer; transition: all 0.3s ease; text-align: center; position: relative; }
      .participant-card:hover { border-color: var(--primary-gold); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
      .participant-card .icon { font-size: 2.2rem; margin-bottom: 6px; }
      .participant-card h3 { color: var(--dark-green); font-size: 0.95rem; margin-bottom: 5px; word-break: break-word; }
      .participant-card .count { color: #666; font-size: 0.8rem; }
      .new-recordings-badge { position: absolute; top: -6px; right: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4); border: 2px solid white; }
      .empty-state { text-align: center; padding: 25px 15px; color: #999; }
      .empty-state .icon { font-size: 3rem; margin-bottom: 10px; opacity: 0.5; }
      .empty-state p { font-size: 0.95rem; }
      .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 3000; }
      .spinner { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid var(--primary-gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .loading-spinner { text-align: center; color: white; }
      .loading-spinner p { font-size: 0.95rem; font-weight: 600; }
      .message-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
      .message-modal-content { background: white; padding: 20px; border-radius: 12px; max-width: 450px; width: 100%; max-height: 80vh; overflow-y: auto; }
      .message-modal h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .message-type-btns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
      .message-type-btn { padding: 10px; border: 2px solid var(--border-light); border-radius: 8px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; }
      .message-type-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); color: var(--dark-green); }
      .message-modal textarea { width: 100%; padding: 12px; border: 2px solid var(--border-light); border-radius: 8px; font-family: "Cairo", sans-serif; font-size: 0.95rem; min-height: 100px; resize: vertical; }
      .voice-recorder { background: linear-gradient(to bottom, #f0f9ff, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); }
      .voice-recorder audio { width: 100%; margin-top: 10px; }
      .modal-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
      .unread-badge { position: absolute; top: -6px; left: -6px; background: #dc2626; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; box-shadow: 0 2px 6px rgba(220,38,38,0.4); }
      .message-item { background: linear-gradient(135deg, #fff9e6, white); padding: 12px; border-radius: 10px; margin-bottom: 10px; border-right: 3px solid var(--primary-gold); }
      .message-item.unread { background: linear-gradient(135deg, #fff4d6, #fff9e6); box-shadow: 0 3px 15px rgba(212,175,55,0.2); }
      .message-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 2px solid var(--border-light); }
      .message-content { font-size: 0.95rem; line-height: 1.6; margin-bottom: 8px; }
      .message-recording { background: white; padding: 10px; border-radius: 8px; margin-top: 8px; border: 1px solid var(--border-light); }
      .message-recording audio { width: 100%; margin-top: 6px; }
      .linked-recording { background: linear-gradient(135deg, #e8f5e9, #f0fff4); padding: 12px; border-radius: 8px; margin-top: 10px; border: 2px solid #4caf50; }
      .linked-recording p { color: var(--dark-green); font-weight: 700; margin-bottom: 8px; font-size: 0.9rem; }
      .linked-recording audio, .linked-recording video { width: 100%; border-radius: 6px; }
      .rating-container { background: linear-gradient(to bottom, #fff9e6, white); padding: 15px; border-radius: 8px; border: 2px solid var(--primary-gold); text-align: center; }
      .stars-display { display: flex; justify-content: center; align-items: center; gap: 8px; margin: 15px 0; font-size: 2.5rem; }
      .star { cursor: pointer; transition: all 0.2s ease; color: #d1d5db; }
      .star:hover { transform: scale(1.2); }
      .star.filled { color: #fbbf24; }
      .rating-value { font-size: 1.5rem; font-weight: 700; color: var(--dark-green); margin-top: 10px; }
      .rating-buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 12px; }
      .rating-btn { padding: 8px; border: 2px solid var(--border-light); border-radius: 6px; background: white; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; }
      .rating-btn:hover { background: var(--cream); border-color: var(--primary-gold); }
      .rating-btn.active { background: linear-gradient(135deg, var(--primary-gold), var(--accent-gold)); border-color: var(--primary-gold); color: var(--dark-green); }
      .message-rating { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 12px; border-radius: 8px; margin-top: 8px; text-align: center; border: 2px solid #fbbf24; }
      .message-stars { font-size: 2rem; margin: 8px 0; }
      .message-stars .star { cursor: default; }
      .contact-info-section { background: linear-gradient(135deg, #dbeafe, #e0f2fe); padding: 12px; border-radius: 10px; margin-bottom: 15px; border: 2px solid var(--primary-gold); }
      .contact-info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
      .contact-info-title { color: var(--dark-green); font-weight: 700; font-size: 1rem; }
      .toggle-contact-btn { background: var(--primary-gold); color: var(--dark-green); padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; }
      .toggle-contact-btn:hover { background: var(--accent-gold); transform: scale(1.05); }
      .contact-info-content { margin-top: 10px; }
      .info-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-light); }
      .info-label { color: #666; font-size: 0.85rem; margin-bottom: 4px; }
      .info-value { color: var(--dark-green); font-size: 1rem; font-weight: 700; word-break: break-all; }
      .copy-btn { background: var(--dark-green); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; }
      .copy-btn:hover { background: var(--medium-green); transform: scale(1.05); }
      .copy-btn.copied { background: #10b981; }
      .total-rating-badge { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 8px 12px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 12px; border: 2px solid #fbbf24; box-shadow: 0 2px 8px rgba(251,191,36,0.3); }
      .total-rating-badge .icon { font-size: 1.2rem; }
      .total-rating-badge .text { color: var(--dark-green); font-weight: 700; font-size: 0.9rem; }
      .total-rating-badge .value { color: var(--dark-green); font-weight: 900; font-size: 1.1rem; }
      .broadcast-banner { background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 14px; border-radius: 12px; margin-bottom: 12px; border: 2px solid #fbbf24; position: relative; box-shadow: 0 3px 12px rgba(251,191,36,0.3); }
      .broadcast-banner .broadcast-icon { font-size: 1.5rem; margin-bottom: 6px; }
      .broadcast-banner .broadcast-title { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 6px; }
      .broadcast-banner .broadcast-text { color: var(--text-dark); font-size: 0.95rem; line-height: 1.6; }
      .broadcast-banner audio { width: 100%; margin-top: 8px; border-radius: 6px; }
      .broadcast-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
      .broadcast-delete-btn:hover { background: #b91c1c; transform: scale(1.1); }
      .admin-msg-item { background: white; padding: 12px; border-radius: 10px; border: 2px solid var(--border-light); margin-bottom: 10px; position: relative; }
      .admin-msg-item .msg-delete-btn { position: absolute; top: 8px; left: 8px; background: #dc2626; color: white; border: none; border-radius: 6px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s ease; }
      .admin-msg-item .msg-delete-btn:hover { background: #b91c1c; }
      .leaderboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.75); display: flex; align-items: flex-start; justify-content: center; z-index: 2000; padding: 15px; overflow-y: auto; }
      .leaderboard-content { background: var(--white); border-radius: 16px; width: 100%; max-width: 500px; margin: auto; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
      .leaderboard-header { background: linear-gradient(135deg, var(--dark-green), var(--medium-green)); padding: 20px 15px; text-align: center; position: relative; }
      .leaderboard-header h2 { color: var(--white); font-family: "Amiri", serif; font-size: 1.5rem; margin-bottom: 4px; }
      .leaderboard-header p { color: var(--primary-gold); font-size: 0.85rem; }
      .leaderboard-close { position: absolute; top: 12px; left: 12px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
      .leaderboard-close:hover { background: rgba(255,255,255,0.35); }
      .leaderboard-body { padding: 15px; }
      .leaderboard-row { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 12px; margin-bottom: 8px; transition: all 0.3s; border: 2px solid transparent; }
      .leaderboard-row:hover { transform: translateX(-3px); }
      .leaderboard-row.rank-1 { background: linear-gradient(135deg, #fffbeb, #fef3c7); border-color: #f59e0b; box-shadow: 0 4px 15px rgba(245,158,11,0.2); }
      .leaderboard-row.rank-2 { background: linear-gradient(135deg, #f8fafc, #e2e8f0); border-color: #94a3b8; }
      .leaderboard-row.rank-3 { background: linear-gradient(135deg, #fff7ed, #ffedd5); border-color: #f97316; }
      .leaderboard-row.rank-other { background: var(--cream); border-color: var(--border-light); }
      .leaderboard-row.rank-mine { border-color: var(--primary-gold) !important; box-shadow: 0 0 0 3px rgba(212,175,55,0.25); }
      .rank-badge { width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; font-weight: 900; flex-shrink: 0; }
      .rank-1 .rank-badge { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; }
      .rank-2 .rank-badge { background: linear-gradient(135deg, #94a3b8, #cbd5e1); color: white; }
      .rank-3 .rank-badge { background: linear-gradient(135deg, #f97316, #fb923c); color: white; }
      .rank-other .rank-badge { background: var(--light-green); color: var(--dark-green); font-size: 1rem; }
      .rank-info { flex: 1; }
      .rank-name { color: var(--dark-green); font-weight: 700; font-size: 1rem; margin-bottom: 3px; }
      .rank-name .you-tag { background: var(--primary-gold); color: var(--dark-green); border-radius: 8px; padding: 1px 7px; font-size: 0.72rem; font-weight: 700; margin-right: 6px; }
      .rank-details { color: #777; font-size: 0.8rem; }
      .rank-score { text-align: center; }
      .rank-score .score-num { font-size: 1.4rem; font-weight: 900; color: var(--dark-green); line-height: 1; }
      .rank-score .score-label { font-size: 0.7rem; color: #888; }
      .rank-stars { color: #fbbf24; font-size: 0.85rem; margin-top: 2px; }
      .leaderboard-empty { text-align: center; padding: 30px; color: #aaa; }
      .leaderboard-empty .icon { font-size: 3rem; margin-bottom: 10px; }
      .my-rank-banner { background: linear-gradient(135deg, #e8f5e9, #f0fff4); border: 2px solid #4caf50; border-radius: 10px; padding: 12px 15px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
      .my-rank-banner .icon { font-size: 1.5rem; }
      .my-rank-banner .text { color: var(--dark-green); font-size: 0.95rem; font-weight: 600; }
      .my-rank-banner .text strong { font-size: 1.1rem; }
      @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
      .leaderboard-row { animation: popIn 0.3s ease both; }
      .confirm-dialog { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2500; padding: 15px; }
      .confirm-content { background: white; padding: 20px; border-radius: 12px; max-width: 400px; width: 100%; text-align: center; }
      .confirm-content h3 { color: var(--dark-green); font-size: 1.2rem; margin-bottom: 12px; }
      .confirm-content p { font-size: 0.95rem; margin-bottom: 20px; line-height: 1.5; }
      .confirm-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
      @media (max-width: 768px) {
        h1 { font-size: 1.3rem; }
        .subtitle { font-size: 0.85rem; }
        .card { padding: 12px 10px; }
        .btn { font-size: 0.95rem; padding: 10px; }
        .type-card .icon { font-size: 2.2rem; }
        .timer { font-size: 1.5rem; }
        .record-type-grid { grid-template-columns: 1fr; }
        .participants-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .logout-btn, .back-btn { padding: 6px 12px; font-size: 0.75rem; }
        .stat-card .number { font-size: 1.3rem; }
        .message-type-btns { grid-template-columns: 1fr; }
        .stars-display { font-size: 2rem; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">
          <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="Ø´Ø¹Ø§Ø± Ø±Ù…Ø¶Ø§Ù†" onerror="this.style.display='none'" />
        </div>
        <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
        <p class="subtitle">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</p>
      </div>

      <div id="globalBroadcastsBar"></div>

      <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div id="homePage" class="card">
        <button class="btn btn-primary big-icon-btn" onclick="showRegisterPage()">ğŸ†• ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-secondary big-icon-btn" onclick="showLoginPage()">ğŸ”‘ Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-secondary" onclick="showAdminLogin()" style="margin-top: 20px;">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
      <div id="registerPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>
        <form id="registerForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="participantName" required placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" />
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="password" required placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('password')">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">ØªØ³Ø¬ÙŠÙ„ ğŸŒŸ</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
      <div id="loginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</h2>
        <div id="loginError" class="error-message hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù…</label>
            <input type="text" id="loginName" required placeholder="Ø§Ø³Ù…Ùƒ" />
          </div>
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="loginPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('loginPassword')">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© -->
      <div id="adminLoginPage" class="card hidden">
        <h2 style="color:var(--dark-green);margin-bottom:15px;text-align:center;font-size:1.3rem;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h2>
        <div id="adminError" class="error-message hidden"></div>
        <form id="adminLoginForm">
          <div class="form-group">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="password-input-wrapper">
              <input type="password" id="adminPassword" required placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
              <span class="password-toggle" onclick="togglePassword('adminPassword')">ğŸ‘ï¸</span>
            </div>
          </div>
          <button type="submit" class="btn btn-primary">Ø¯Ø®ÙˆÙ„</button>
        </form>
        <button class="btn btn-secondary" onclick="showHomePage()">Ø±Ø¬ÙˆØ¹</button>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ -->
      <div id="participantPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:8px;text-align:center;font-size:1.3rem;">
          Ø£Ù‡Ù„Ø§Ù‹ <span id="participantDisplayName"></span> ğŸŒ™
        </h2>
        <div style="display:flex;gap:8px;margin:12px 0;">
          <button class="btn btn-secondary" onclick="showRecordingSection()" style="flex:1;">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</button>
          <button class="btn btn-secondary" onclick="showMessagesSection()" style="flex:1;position:relative;">
            ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„
            <span id="unreadBadge" class="unread-badge hidden"></span>
          </button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <div id="recordingSection">
          <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;text-align:center;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h3>
          <div class="record-type-grid">
            <div class="type-card selected" onclick="selectType('audio')">
              <div class="icon">ğŸ¤</div><h3>ØµÙˆØª</h3>
            </div>
            <div class="type-card" onclick="selectType('video')">
              <div class="icon">ğŸ¥</div><h3>ÙÙŠØ¯ÙŠÙˆ</h3>
            </div>
          </div>
          <div id="livePreview" class="live-preview hidden">
            <video id="liveVideo" autoplay muted playsinline></video>
          </div>
          <div class="recording-controls">
            <button class="btn btn-primary big-icon-btn" id="recordBtn" onclick="startRecording()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            <div class="timer hidden" id="timer">00:00</div>
            <button class="btn btn-danger big-icon-btn hidden" id="stopBtn" onclick="stopRecording()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
          </div>
          <div id="recordingPreview" class="recording-preview hidden">
            <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</h3>
            <div id="previewMedia"></div>
            <button class="btn btn-primary" onclick="saveRecording()" style="margin-top:12px;">ğŸ’¾ Ø­ÙØ¸</button>
            <button class="btn btn-secondary" onclick="cancelRecording()">ğŸ”„ Ø¥Ù„ØºØ§Ø¡</button>
          </div>
          <div style="margin-top:20px;">
            <h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1.1rem;">ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ</h3>
            <div id="myRecordingsList"></div>
          </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="messagesSection" class="hidden">
          <h3 style="color:var(--dark-green);margin-bottom:12px;font-size:1.1rem;">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</h3>
          <div id="messagesList"></div>
        </div>
      </div>

      <!-- ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©) -->
      <div id="adminParticipantsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <h2 style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h2>

        <div class="stats-container">
          <div class="stat-card">
            <div class="icon">ğŸ‘¥</div>
            <div class="number" id="totalParticipants">0</div>
            <div class="label">Ù…Ø´Ø§Ø±Ùƒ</div>
          </div>
          <div class="stat-card">
            <div class="icon">ğŸ™ï¸</div>
            <div class="number" id="totalRecordings">0</div>
            <div class="label">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠ</div>
          </div>
          <div class="stat-card">
            <div class="icon">ğŸ†•</div>
            <div class="number" id="newRecordings">0</div>
            <div class="label">Ø¬Ø¯ÙŠØ¯</div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="showBroadcastModal()" style="margin-bottom:8px;">
          ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
        </button>
        <button class="btn btn-secondary" onclick="showLeaderboard('admin')" style="margin-bottom:10px;">
          ğŸ† Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
        </button>

        <div id="adminBroadcastsList" style="margin-bottom:12px;"></div>
        <div id="participantsList" class="participants-grid"></div>
      </div>

      <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù…Ø¹ÙŠÙ† (Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©) -->
      <div id="adminRecordingsPage" class="card hidden">
        <button class="logout-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        <button class="back-btn" onclick="backToParticipants()">â† Ø±Ø¬ÙˆØ¹</button>

        <h2 id="participantTitle" style="color:var(--dark-green);margin-bottom:12px;text-align:center;font-size:1.3rem;"></h2>

        <div style="text-align:center;margin-bottom:12px;">
          <div class="total-rating-badge" id="totalRatingBadge">
            <span class="icon">â­</span>
            <span class="text">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
            <span class="value" id="totalRatingValue">0</span>
            <span class="text">/</span>
            <span class="value" id="totalRatingMax">0</span>
          </div>
        </div>

        <div style="text-align:center;margin-bottom:12px;">
          <button class="btn btn-danger" onclick="confirmDeleteAccount()" style="width:auto;padding:10px 20px;font-size:0.9rem;">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
          </button>
        </div>

        <div class="contact-info-section">
          <div class="contact-info-header">
            <span class="contact-info-title">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
            <button class="toggle-contact-btn" onclick="toggleContactInfo()">
              <span id="contactToggleText">Ø¹Ø±Ø¶</span>
            </button>
          </div>
          <div id="contactInfoContent" class="contact-info-content hidden">
            <div class="info-row">
              <div>
                <div class="info-label">Ø§Ù„Ø§Ø³Ù…</div>
                <div class="info-value" id="contactName">-</div>
              </div>
              <button class="copy-btn" onclick="copyToClipboard('name')">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
            <div class="info-row">
              <div>
                <div class="info-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div>
                <div class="info-value" id="contactPassword">-</div>
              </div>
              <button class="copy-btn" onclick="copyToClipboard('password')">ğŸ“‹ Ù†Ø³Ø®</button>
            </div>
          </div>
        </div>

        <div id="adminSentMessages" style="margin-bottom:12px;"></div>
        <div id="adminRecordingsList"></div>
      </div>
    </div>

    <!-- Firebase -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
      import { getDatabase, ref, set, get, push, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';
      const firebaseConfig = {
        apiKey: "AIzaSyAfhQL5spF3KcrbngSzunLaHT_7cieHkUk",
        authDomain: "opject-e223d.firebaseapp.com",
        databaseURL: "https://opject-e223d-default-rtdb.firebaseio.com/",
        projectId: "opject-e223d",
        storageBucket: "opject-e223d.firebasestorage.app",
        messagingSenderId: "607939195786",
        appId: "1:607939195786:web:c264710387d50fc2990e73"
      };
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);
      window.db = database;
      window.dbRef = ref;
      window.dbSet = set;
      window.dbGet = get;
      window.dbPush = push;
      window.dbUpdate = update;
      window.dbRemove = remove;
      window.firebaseInitialized = true;
    </script>

    <script>
      let currentUser = null;
      let isAdmin = false;
      let mediaRecorder = null;
      let recordedChunks = [];
      let recordingType = "audio";
      let timerInterval = null;
      let recordingStartTime = null;
      let previewStream = null;
      let currentParticipant = null;
      let adminVoiceRecorder = null;
      let adminVoiceChunks = [];
      let adminVoiceTimer = null;
      let currentRecordingForMessage = null;
      let viewedRecordings = new Set();
      let selectedRating = 0;

      // ====== FIX 1: ØªØ­Ø³ÙŠÙ† ØªØ­ÙˆÙŠÙ„ base64 Ø¥Ù„Ù‰ Blob URL Ù…Ø¹ fallback ======
      // Ù†Ø®Ø²Ù† blob URLs Ù„Ù…Ù†Ø¹ memory leaks ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
      const blobUrlCache = new Map();

      function dataUriToObjectUrl(dataUri) {
        if (!dataUri) return '';
        // Ù„Ùˆ Ù…Ø´ data URIØŒ Ø§Ø±Ø¬Ø¹Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø©
        if (!dataUri.startsWith('data:')) return dataUri;
        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒØ§Ø´
        if (blobUrlCache.has(dataUri.substring(0, 50))) {
          const cached = blobUrlCache.get(dataUri.substring(0, 50));
          // ØªØ­Ù‚Ù‚ Ø£Ù† Ø§Ù„Ù€ URL Ù„Ø§ ÙŠØ²Ø§Ù„ ØµØ§Ù„Ø­
          try { return cached; } catch(e) {}
        }
        try {
          const [header, base64] = dataUri.split(',');
          if (!header || !base64) return dataUri;
          const mimeMatch = header.match(/:(.*?);/);
          const mimeType = mimeMatch ? mimeMatch[1] : 'audio/webm';
          const binary = atob(base64);
          const array = new Uint8Array(binary.length);
          for (let i = 0; i < binary.length; i++) {
            array[i] = binary.charCodeAt(i);
          }
          const blob = new Blob([array], { type: mimeType });
          const url = URL.createObjectURL(blob);
          blobUrlCache.set(dataUri.substring(0, 50), url);
          return url;
        } catch(e) {
          console.warn('dataUriToObjectUrl error:', e);
          // Fallback: Ø§Ø³ØªØ®Ø¯Ù… data URI Ù…Ø¨Ø§Ø´Ø±Ø©
          return dataUri;
        }
      }

      // ====== FIX 2: createMediaElement Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ multiple source types ======
      function createMediaElement(data, type, extra = '') {
        if (!data) return '<p style="color:#999;font-size:0.85rem;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
        const blobUrl = dataUriToObjectUrl(data);
        if (type === 'video') {
          return `<video controls src="${blobUrl}" ${extra} style="width:100%;border-radius:8px;background:#000;">
            <source src="${blobUrl}" type="video/webm">
            Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
          </video>`;
        } else {
          // Ù„Ù„ØµÙˆØª: Ù†Ø¬Ø±Ø¨ blob URL Ø£ÙˆÙ„Ø§Ù‹ØŒ Ø«Ù… data URI Ù…Ø¨Ø§Ø´Ø±Ø©
          return `<audio controls ${extra} style="width:100%;">
            <source src="${blobUrl}" type="audio/webm">
            <source src="${blobUrl}" type="audio/ogg">
            Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.
          </audio>`;
        }
      }

      window.onload = function() {
        const checkFirebase = setInterval(() => {
          if (window.firebaseInitialized && window.db) {
            clearInterval(checkFirebase);
            testFirebaseConnection();
            loadViewedRecordings();
          }
        }, 100);
        setTimeout(() => {
          clearInterval(checkFirebase);
          if (!window.db) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
            showHomePage();
          }
        }, 5000);
      };

      async function loadGlobalBroadcasts() {
        const bar = document.getElementById("globalBroadcastsBar");
        if (!bar) return;
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'broadcasts'));
          if (!snapshot.exists()) { bar.innerHTML = ''; return; }
          const broadcasts = [];
          snapshot.forEach(child => broadcasts.push({ id: child.key, ...child.val() }));
          if (broadcasts.length === 0) { bar.innerHTML = ''; return; }
          broadcasts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          bar.innerHTML = broadcasts.map(b => `
            <div class="broadcast-banner" style="margin-bottom:8px;border-radius:10px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <span style="font-size:1.3rem;">ğŸ“¢</span>
                <span style="color:var(--dark-green);font-weight:700;font-size:0.95rem;">Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
                <span style="color:#888;font-size:0.75rem;margin-right:auto;">${new Date(b.timestamp).toLocaleDateString("ar-SA")}</span>
              </div>
              <div style="color:var(--text-dark);font-size:0.95rem;line-height:1.7;">${b.message || ''}</div>
              ${b.type === 'voice' && b.voiceData ? createMediaElement(b.voiceData, 'audio', 'style="margin-top:8px;"') : ''}
            </div>`).join("");
        } catch(e) { bar.innerHTML = ''; }
      }

      async function testFirebaseConnection() {
        try {
          const testRef = window.dbRef(window.db, 'connectionTest');
          await window.dbSet(testRef, { t: Date.now() });
          await window.dbGet(testRef);
          await window.dbRemove(testRef);
          loadCurrentSession();
          loadGlobalBroadcasts();
        } catch(e) {
          showHomePage();
          const card = document.getElementById("homePage");
          const alertDiv = document.createElement("div");
          alertDiv.className = "error-message";
          alertDiv.style.cssText = "margin-bottom:12px;font-size:0.88rem;line-height:1.7;";
          alertDiv.innerHTML = `
            âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡: Firebase Rules Ù…ØºÙ„Ù‚Ø©!</strong><br>
            Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù† ØªÙØ­ÙØ¸ ÙˆÙ„Ù† ØªÙÙ‚Ø±Ø£.<br><br>
            <strong>Ø§Ù„Ø­Ù„:</strong> Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰<br>
            Firebase Console â†’ Realtime Database â†’ Rules<br>
            ÙˆØºÙŠÙ‘Ø± Ø¥Ù„Ù‰:<br>
            <code style="background:#fff;padding:6px 10px;display:block;margin-top:6px;border-radius:6px;direction:ltr;font-size:0.82rem;border:1px solid #ccc;">
{ "rules": { ".read": true, ".write": true } }
            </code>
            Ø«Ù… Ø§Ø¶ØºØ· <strong>Publish</strong>
          `;
          card.insertBefore(alertDiv, card.firstChild);
        }
      }

      function loadViewedRecordings() {
        try {
          const stored = localStorage.getItem('viewedRecordings');
          if (stored) viewedRecordings = new Set(JSON.parse(stored));
        } catch(e) { viewedRecordings = new Set(); }
      }
      function saveViewedRecordings() {
        try {
          localStorage.setItem('viewedRecordings', JSON.stringify([...viewedRecordings]));
        } catch(e) {}
      }
      function markRecordingAsViewed(participantId, recordingId) {
        viewedRecordings.add(`${participantId}_${recordingId}`);
        saveViewedRecordings();
      }
      function isRecordingViewed(participantId, recordingId) {
        return viewedRecordings.has(`${participantId}_${recordingId}`);
      }

      function showLoading() {
        if (document.getElementById('loadingOverlay')) return;
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.id = 'loadingOverlay';
        overlay.innerHTML = `<div class="loading-spinner"><div class="spinner"></div><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>`;
        document.body.appendChild(overlay);
      }
      function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) overlay.remove();
      }

      async function loadCurrentSession() {
        try {
          const session = localStorage.getItem("currentSession");
          if (session) {
            const data = JSON.parse(session);
            if (data.isAdmin) {
              isAdmin = true;
              showAdminParticipantsPage();
            } else {
              showLoading();
              try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'participants/' + data.userId));
                hideLoading();
                if (snapshot.exists()) {
                  const val = snapshot.val();
                  // FIX 3: Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø§Ø³ØªØ®Ø¯Ù… toRecordingsArray Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                  val.recordings = toRecordingsArray(val.recordings);
                  currentUser = { id: data.userId, ...val };
                  showParticipantPage();
                } else {
                  localStorage.removeItem("currentSession");
                  showHomePage();
                }
              } catch (error) {
                hideLoading();
                localStorage.removeItem("currentSession");
                showHomePage();
              }
            }
          } else {
            showHomePage();
          }
        } catch(e) {
          localStorage.removeItem("currentSession");
          showHomePage();
        }
      }

      function saveSession() {
        const session = isAdmin ? { isAdmin: true } : { isAdmin: false, userId: currentUser.id };
        localStorage.setItem("currentSession", JSON.stringify(session));
      }

      function showHomePage() { hideAllPages(); document.getElementById("homePage").classList.remove("hidden"); }
      function showRegisterPage() { hideAllPages(); document.getElementById("registerPage").classList.remove("hidden"); }
      function showLoginPage() { hideAllPages(); document.getElementById("loginPage").classList.remove("hidden"); }
      function showAdminLogin() { hideAllPages(); document.getElementById("adminLoginPage").classList.remove("hidden"); }

      function showParticipantPage() {
        hideAllPages();
        document.getElementById("participantPage").classList.remove("hidden");
        document.getElementById("participantDisplayName").textContent = currentUser.name;
        showRecordingSection();
        loadMyRecordings();
        updateUnreadBadge();
      }

      async function showAdminParticipantsPage() {
        hideAllPages();
        document.getElementById("adminParticipantsPage").classList.remove("hidden");
        await loadParticipants();
        await loadAdminBroadcasts();
      }

      async function showAdminRecordingsPage(participant) {
        hideAllPages();
        currentParticipant = participant;
        document.getElementById("adminRecordingsPage").classList.remove("hidden");
        document.getElementById("participantTitle").textContent = "ØªØ³Ø¬ÙŠÙ„Ø§Øª: " + participant.name;
        document.getElementById("contactName").textContent = participant.name;
        document.getElementById("contactPassword").textContent = participant.password;
        await calculateAndDisplayTotalRating();
        await loadParticipantRecordings();
        await loadAdminSentMessages();
      }

      async function calculateAndDisplayTotalRating() {
        try {
          const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          let totalRating = 0;
          let ratedRecordingsCount = 0;
          const ratedRecordingsSet = new Set();
          if (messagesSnapshot.exists()) {
            messagesSnapshot.forEach(child => {
              const msg = child.val();
              if (msg.participantId === currentParticipant.id && msg.messageType === 'rating' && msg.rating && !ratedRecordingsSet.has(msg.recordingId)) {
                totalRating += msg.rating;
                ratedRecordingsSet.add(msg.recordingId);
                ratedRecordingsCount++;
              }
            });
          }
          const maxPossibleRating = ratedRecordingsCount * 5;
          document.getElementById("totalRatingValue").textContent = totalRating.toFixed(1);
          document.getElementById("totalRatingMax").textContent = maxPossibleRating;
          const badge = document.getElementById("totalRatingBadge");
          badge.style.display = ratedRecordingsCount === 0 ? 'none' : 'inline-flex';
        } catch(e) {
          console.error('calculateAndDisplayTotalRating error:', e);
        }
      }

      async function loadAdminSentMessages() {
        const div = document.getElementById("adminSentMessages");
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (!snapshot.exists()) { div.innerHTML = ''; return; }

          const messages = [];
          snapshot.forEach(child => {
            const msg = child.val();
            if (msg.participantId === currentParticipant.id) {
              messages.push({ id: child.key, ...msg });
            }
          });

          if (messages.length === 0) { div.innerHTML = ''; return; }
          messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

          let html = `<h3 style="color:var(--dark-green);margin-bottom:10px;font-size:1rem;">ğŸ“¨ Ø±Ø³Ø§Ø¦Ù„Ùƒ Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>`;
          for (const msg of messages) {
            let typeIcon = 'âœ‰ï¸';
            if (msg.messageType === 'voice') typeIcon = 'ğŸ¤';
            if (msg.messageType === 'rating') typeIcon = 'â­';
            html += `
              <div class="admin-msg-item">
                <button class="msg-delete-btn" onclick="deleteMessage('${msg.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                <p style="color:var(--dark-green);font-weight:700;font-size:0.9rem;margin-bottom:4px;margin-left:55px;">${typeIcon} ${msg.message || ''}</p>
                <p style="color:#888;font-size:0.78rem;">${new Date(msg.timestamp).toLocaleString("ar-SA")}</p>
                ${msg.messageType === 'voice' && msg.voiceData ? `
                  <div style="margin-top:8px;">
                    ${createMediaElement(msg.voiceData, 'audio')}
                  </div>` : ''}
                ${msg.messageType === 'rating' && msg.rating ? `
                  <div style="margin-top:6px;color:var(--dark-green);font-weight:700;">
                    Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${msg.rating} / 5 â­
                  </div>` : ''}
              </div>`;
          }
          div.innerHTML = html;
        } catch(e) {
          div.innerHTML = '';
          console.error('loadAdminSentMessages error:', e);
        }
      }

      async function deleteMessage(msgId) {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) return;
        showLoading();
        try {
          await window.dbRemove(window.dbRef(window.db, 'messages/' + msgId));
          hideLoading();
          await loadAdminSentMessages();
          await calculateAndDisplayTotalRating();
          alert("ØªÙ… Ø§Ù„Ø­Ø°Ù âœ…");
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      function confirmDeleteAccount() {
        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.id = "deleteAccountDialog";
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>âš ï¸ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</h3>
            <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ <strong>${currentParticipant.name}</strong>ØŸ<br>
            Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡ ÙˆØ±Ø³Ø§Ø¦Ù„Ù‡ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹<br>ÙˆÙ„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡Ø§.</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" onclick="deleteParticipantAccount()">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(dialog);
      }

      async function deleteParticipantAccount() {
        showLoading();
        try {
          await window.dbRemove(window.dbRef(window.db, 'participants/' + currentParticipant.id));
          const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (messagesSnapshot.exists()) {
            const updates = {};
            messagesSnapshot.forEach(child => {
              if (child.val().participantId === currentParticipant.id) {
                updates[`messages/${child.key}`] = null;
              }
            });
            if (Object.keys(updates).length > 0) {
              await window.dbUpdate(window.dbRef(window.db), updates);
            }
          }
          hideLoading();
          closeConfirmDialog();
          alert(`ØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${currentParticipant.name} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ âœ…`);
          currentParticipant = null;
          showAdminParticipantsPage();
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      function showBroadcastModal() {
        const modal = document.createElement("div");
        modal.className = "message-modal";
        modal.id = "broadcastModal";
        modal.innerHTML = `
          <div class="message-modal-content">
            <h3>ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</h3>
            <div class="message-type-btns" style="grid-template-columns:1fr 1fr;">
              <button class="message-type-btn active" onclick="switchBroadcastType('text', this)">âœï¸ Ù†ØµÙŠ</button>
              <button class="message-type-btn" onclick="switchBroadcastType('voice', this)">ğŸ¤ ØµÙˆØªÙŠ</button>
            </div>
            <div id="broadcastTextDiv">
              <textarea id="broadcastText" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‡Ù†Ø§..."></textarea>
            </div>
            <div id="broadcastVoiceDiv" class="voice-recorder hidden">
              <button class="btn btn-primary" id="bVoiceRecordBtn" onclick="startBroadcastVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <div class="timer hidden" id="bVoiceTimer">00:00</div>
              <button class="btn btn-danger hidden" id="bVoiceStopBtn" onclick="stopBroadcastVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
              <div id="bVoicePreviewDiv" class="hidden">
                <audio id="bVoicePreview" controls style="width:100%;margin-top:8px;"></audio>
              </div>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-primary" onclick="sendBroadcast()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
              <button class="btn btn-secondary" onclick="closeBroadcastModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }

      let broadcastVoiceRecorder = null;
      let broadcastVoiceChunks = [];
      let broadcastVoiceTimerInterval = null;
      let broadcastVoiceBlob = null;

      function switchBroadcastType(type, btn) {
        document.querySelectorAll("#broadcastModal .message-type-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById("broadcastTextDiv").classList.toggle("hidden", type !== 'text');
        document.getElementById("broadcastVoiceDiv").classList.toggle("hidden", type !== 'voice');
      }

      async function startBroadcastVoice() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          broadcastVoiceChunks = [];
          broadcastVoiceBlob = null;
          // FIX 4: Ø§Ø³ØªØ®Ø¯Ø§Ù… mimeType Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…ØªØµÙØ­
          const mimeType = getSupportedMimeType();
          broadcastVoiceRecorder = new MediaRecorder(stream, mimeType ? { mimeType } : {});
          broadcastVoiceRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) broadcastVoiceChunks.push(e.data); };
          broadcastVoiceRecorder.onstop = () => {
            stream.getTracks().forEach(t => t.stop());
            if (broadcastVoiceChunks.length > 0) {
              broadcastVoiceBlob = new Blob(broadcastVoiceChunks, { type: mimeType || 'audio/webm' });
              const url = URL.createObjectURL(broadcastVoiceBlob);
              const preview = document.getElementById("bVoicePreview");
              preview.src = url;
              document.getElementById("bVoicePreviewDiv").classList.remove("hidden");
            }
          };
          broadcastVoiceRecorder.start(100);
          document.getElementById("bVoiceRecordBtn").classList.add("hidden");
          document.getElementById("bVoiceStopBtn").classList.remove("hidden");
          document.getElementById("bVoiceTimer").classList.remove("hidden");
          const startTime = Date.now();
          broadcastVoiceTimerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(elapsed/60).toString().padStart(2,"0");
            const s = (elapsed%60).toString().padStart(2,"0");
            const timerEl = document.getElementById("bVoiceTimer");
            if (timerEl) timerEl.textContent = `${m}:${s}`;
          }, 1000);
        } catch(err) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + err.message); }
      }

      function stopBroadcastVoice() {
        if (broadcastVoiceRecorder && broadcastVoiceRecorder.state !== "inactive") {
          broadcastVoiceRecorder.stop();
          clearInterval(broadcastVoiceTimerInterval);
          const btn = document.getElementById("bVoiceRecordBtn");
          const stopBtn = document.getElementById("bVoiceStopBtn");
          const timer = document.getElementById("bVoiceTimer");
          if (btn) btn.classList.remove("hidden");
          if (stopBtn) stopBtn.classList.add("hidden");
          if (timer) timer.classList.add("hidden");
        }
      }

      async function sendBroadcast() {
        const activeBtn = document.querySelector("#broadcastModal .message-type-btn.active");
        const isVoice = activeBtn && activeBtn.textContent.includes("ØµÙˆØªÙŠ");
        showLoading();
        try {
          const broadcastData = { timestamp: new Date().toISOString(), type: isVoice ? 'voice' : 'text' };
          if (isVoice) {
            if (!broadcastVoiceBlob) {
              hideLoading();
              alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©!");
              return;
            }
            broadcastData.message = "Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ“¢";
            broadcastData.voiceData = await blobToBase64(broadcastVoiceBlob);
          } else {
            const text = document.getElementById("broadcastText").value.trim();
            if (!text) { hideLoading(); alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†!"); return; }
            broadcastData.message = text;
          }
          const broadcastRef = window.dbPush(window.dbRef(window.db, 'broadcasts'));
          await window.dbSet(broadcastRef, broadcastData);
          hideLoading();
          closeBroadcastModal();
          await loadAdminBroadcasts();
          await loadGlobalBroadcasts();
          alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† âœ…");
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      async function loadAdminBroadcasts() {
        const div = document.getElementById("adminBroadcastsList");
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'broadcasts'));
          if (!snapshot.exists()) { div.innerHTML = ''; return; }
          const broadcasts = [];
          snapshot.forEach(child => broadcasts.push({ id: child.key, ...child.val() }));
          if (broadcasts.length === 0) { div.innerHTML = ''; return; }
          broadcasts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          let html = `<h3 style="color:var(--dark-green);margin-bottom:8px;font-size:1rem;">ğŸ“¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>`;
          for (const b of broadcasts) {
            html += `
              <div class="broadcast-banner" style="position:relative;">
                <button class="broadcast-delete-btn" onclick="deleteBroadcast('${b.id}')" title="Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">ğŸ—‘ï¸</button>
                <div class="broadcast-icon">ğŸ“¢</div>
                <div class="broadcast-title">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</div>
                <div class="broadcast-text">${b.message || ''}</div>
                ${b.type === 'voice' && b.voiceData ? createMediaElement(b.voiceData, 'audio') : ''}
                <div style="color:#888;font-size:0.78rem;margin-top:6px;">${new Date(b.timestamp).toLocaleString("ar-SA")}</div>
              </div>`;
          }
          div.innerHTML = html;
        } catch(e) {
          div.innerHTML = '';
        }
      }

      async function deleteBroadcast(broadcastId) {
        if (!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†ØŸ")) return;
        showLoading();
        try {
          await window.dbRemove(window.dbRef(window.db, 'broadcasts/' + broadcastId));
          hideLoading();
          await loadAdminBroadcasts();
          await loadGlobalBroadcasts();
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£: " + e.message);
        }
      }

      function closeBroadcastModal() {
        const modal = document.getElementById("broadcastModal");
        if (modal) modal.remove();
        broadcastVoiceChunks = [];
        broadcastVoiceBlob = null;
        if (broadcastVoiceRecorder && broadcastVoiceRecorder.state !== "inactive") {
          try { broadcastVoiceRecorder.stop(); } catch(e) {}
        }
        clearInterval(broadcastVoiceTimerInterval);
      }

      function backToParticipants() {
        currentParticipant = null;
        const contactContent = document.getElementById("contactInfoContent");
        if (contactContent && !contactContent.classList.contains("hidden")) toggleContactInfo();
        showAdminParticipantsPage();
      }

      function hideAllPages() {
        ["homePage","registerPage","loginPage","adminLoginPage","participantPage","adminParticipantsPage","adminRecordingsPage"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.add("hidden");
        });
      }

      function showRecordingSection() {
        document.getElementById("recordingSection").classList.remove("hidden");
        document.getElementById("messagesSection").classList.add("hidden");
        if (recordingType === "video" && !previewStream) startVideoPreview();
      }

      async function showMessagesSection() {
        document.getElementById("recordingSection").classList.add("hidden");
        document.getElementById("messagesSection").classList.remove("hidden");
        stopVideoPreview();
        await loadMessages();
        await markMessagesAsRead();
      }

      async function updateUnreadBadge() {
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          let unreadCount = 0;
          if (snapshot.exists()) {
            snapshot.forEach(child => {
              const msg = child.val();
              if (msg.participantId === currentUser.id && !msg.read) unreadCount++;
            });
          }
          const badge = document.getElementById("unreadBadge");
          if (badge) {
            if (unreadCount > 0) { badge.textContent = unreadCount; badge.classList.remove("hidden"); }
            else { badge.classList.add("hidden"); }
          }
        } catch(e) {
          console.error('updateUnreadBadge error:', e);
        }
      }

      async function markMessagesAsRead() {
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (snapshot.exists()) {
            const updates = {};
            snapshot.forEach(child => {
              const msg = child.val();
              if (msg.participantId === currentUser.id && !msg.read) {
                updates[`messages/${child.key}/read`] = true;
              }
            });
            if (Object.keys(updates).length > 0) {
              await window.dbUpdate(window.dbRef(window.db), updates);
            }
          }
          updateUnreadBadge();
        } catch(e) {
          console.error('markMessagesAsRead error:', e);
        }
      }

      // ====== FIX 5: Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - loadMessages ÙŠØªØ¹Ø·Ù„ Ø¨Ø³Ø¨Ø¨ myRecordings ======
      async function loadMessages() {
        const listDiv = document.getElementById("messagesList");
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (!snapshot.exists()) {
            listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';
            return;
          }
          const messages = [];
          snapshot.forEach(child => {
            const msg = child.val();
            // FIX: ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù‚Ø§Ø±Ù†Ø© String Ù…Ø¹ String
            if (String(msg.participantId) === String(currentUser.id)) {
              messages.push({ id: child.key, ...msg });
            }
          });

          if (messages.length === 0) {
            listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';
            return;
          }
          messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

          // FIX Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ: Ø¬Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ array ØµØ­ÙŠØ­
          let myRecordings = [];
          try {
            const participantSnapshot = await window.dbGet(window.dbRef(window.db, 'participants/' + currentUser.id));
            if (participantSnapshot.exists()) {
              // toRecordingsArray ÙŠØ­ÙˆÙ„ object Ø£Ùˆ array Ø¥Ù„Ù‰ array ØµØ­ÙŠØ­
              myRecordings = toRecordingsArray(participantSnapshot.val().recordings);
            }
          } catch(recErr) {
            console.warn('Could not load recordings for messages:', recErr);
            myRecordings = [];
          }

          let html = '';
          for (const msg of messages) {
            let typeIcon = 'âœ‰ï¸';
            if (msg.messageType === 'voice') typeIcon = 'ğŸ¤';
            if (msg.messageType === 'rating') typeIcon = 'â­';

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ØªØ¨Ø· - myRecordings Ø§Ù„Ø¢Ù† array ØµØ­ÙŠØ­
            let linkedHtml = '';
            try {
              const linkedRec = myRecordings.find(r => r && String(r.id) === String(msg.recordingId));
              if (linkedRec && linkedRec.data) {
                linkedHtml = `
                  <div class="linked-recording">
                    <p>ğŸ”— Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°ÙŠ Ø±Ø¯Ù‘Øª Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©:</p>
                    ${createMediaElement(linkedRec.data, linkedRec.type)}
                  </div>`;
              }
            } catch(e) { linkedHtml = ''; }

            html += `
              <div class="message-item ${!msg.read ? "unread" : ""}">
                <div class="message-header">
                  <span style="color:var(--primary-gold);font-weight:700;font-size:1rem;">${typeIcon} Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
                  <span style="color:#666;font-size:0.75rem;">${new Date(msg.timestamp).toLocaleDateString("ar-SA")}</span>
                </div>
                <div class="message-content">${msg.message || ''}</div>
                ${msg.messageType === 'voice' && msg.voiceData ? `
                  <div class="message-recording">
                    <p style="color:var(--dark-green);font-weight:600;margin-bottom:6px;font-size:0.9rem;">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</p>
                    ${createMediaElement(msg.voiceData, 'audio')}
                  </div>` : ''}
                ${msg.messageType === 'rating' && msg.rating ? `
                  <div class="message-rating">
                    <p style="color:var(--dark-green);font-weight:700;margin-bottom:6px;font-size:1rem;">ØªÙ‚ÙŠÙŠÙ…Ùƒ</p>
                    <div class="message-stars">${generateStarsDisplay(msg.rating)}</div>
                    <p style="color:var(--dark-green);font-weight:700;font-size:1.3rem;margin-top:6px;">${msg.rating} / 5</p>
                  </div>` : ''}
                ${linkedHtml}
              </div>`;
          }
          listDiv.innerHTML = html;
        } catch(err) {
          console.error('loadMessages error:', err);
          listDiv.innerHTML = `<div class="empty-state"><div class="icon">âš ï¸</div><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</p></div>`;
        }
      }

      function generateStarsDisplay(rating) {
        let html = '';
        for (let i = 1; i <= 5; i++) {
          if (rating >= i) html += '<span class="star filled">â­</span>';
          else html += '<span class="star" style="color:#ddd;">â­</span>';
        }
        return html;
      }

      document.getElementById("registerForm").onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById("participantName").value.trim();
        const password = document.getElementById("password").value;
        if (!name || !password) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!"); return; }
        showLoading();
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
          if (snapshot.exists()) {
            const exists = Object.values(snapshot.val()).some(p => p && p.name === name);
            if (exists) { hideLoading(); alert("Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!"); return; }
          }
          const participantId = Date.now().toString();
          // FIX 6: Ù„Ø§ Ù†Ø­ÙØ¸ recordings ÙƒÙ€ array ÙØ§Ø±Øº (Firebase ÙŠØ­Ø°ÙÙ‡) - Ù†Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ†Ù‡
          const participant = { name, password, registeredAt: new Date().toISOString() };
          await window.dbSet(window.dbRef(window.db, 'participants/' + participantId), participant);
          currentUser = { id: participantId, ...participant, recordings: [] };
          saveSession();
          hideLoading();
          showParticipantPage();
        } catch (error) {
          hideLoading();
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
        }
      };

      document.getElementById("loginForm").onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById("loginName").value.trim();
        const password = document.getElementById("loginPassword").value;
        if (!name || !password) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!"); return; }
        showLoading();
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
          hideLoading();
          if (snapshot.exists()) {
            let foundUser = null, foundId = null;
            Object.entries(snapshot.val()).forEach(([id, p]) => {
              if (p && p.name === name && p.password === password) { foundUser = p; foundId = id; }
            });
            if (foundUser) {
              // FIX: ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­ÙˆÙŠÙ„ recordings Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
              foundUser.recordings = toRecordingsArray(foundUser.recordings);
              currentUser = { id: foundId, ...foundUser };
              saveSession();
              showParticipantPage();
              return;
            }
          }
        } catch(err) {
          hideLoading();
        }
        const err = document.getElementById("loginError");
        err.textContent = "Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!";
        err.classList.remove("hidden");
        setTimeout(() => err.classList.add("hidden"), 3000);
      };

      document.getElementById("adminLoginForm").onsubmit = function(e) {
        e.preventDefault();
        const password = document.getElementById("adminPassword").value;
        if (password === "Qur@n2025#Admin$Ramadan") {
          isAdmin = true;
          saveSession();
          showAdminParticipantsPage();
        } else {
          const err = document.getElementById("adminError");
          err.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!";
          err.classList.remove("hidden");
          setTimeout(() => err.classList.add("hidden"), 3000);
        }
      };

      function logout() {
        stopVideoPreview();
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          try { mediaRecorder.stop(); } catch(e) {}
        }
        clearInterval(timerInterval);
        localStorage.removeItem("currentSession");
        currentUser = null;
        isAdmin = false;
        currentParticipant = null;
        recordedChunks = [];
        showHomePage();
      }

      function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const icon = event.target;
        if (input.type === "password") { input.type = "text"; icon.textContent = "ğŸ™ˆ"; }
        else { input.type = "password"; icon.textContent = "ğŸ‘ï¸"; }
      }

      function selectType(type) {
        recordingType = type;
        document.querySelectorAll(".type-card").forEach(el => el.classList.remove("selected"));
        event.target.closest(".type-card").classList.add("selected");
        if (type === "video") startVideoPreview();
        else stopVideoPreview();
      }

      async function startVideoPreview() {
        try {
          if (previewStream) return;
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          previewStream = stream;
          const liveVideo = document.getElementById("liveVideo");
          liveVideo.srcObject = stream;
          document.getElementById("livePreview").classList.remove("hidden");
        } catch(err) {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + err.message);
          // Ø±Ø¬ÙˆØ¹ Ù„Ù„ØµÙˆØª Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
          recordingType = "audio";
          document.querySelectorAll(".type-card").forEach((el, i) => {
            el.classList.toggle("selected", i === 0);
          });
        }
      }

      function stopVideoPreview() {
        if (previewStream) {
          previewStream.getTracks().forEach(track => { try { track.stop(); } catch(e) {} });
          previewStream = null;
          const liveVideo = document.getElementById("liveVideo");
          if (liveVideo && liveVideo.srcObject) liveVideo.srcObject = null;
          const livePreview = document.getElementById("livePreview");
          if (livePreview) livePreview.classList.add("hidden");
        }
      }

      // FIX 7: Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ mimeType Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ… Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­
      function getSupportedMimeType() {
        const types = [
          'audio/webm;codecs=opus',
          'audio/webm',
          'audio/ogg;codecs=opus',
          'audio/ogg',
          'audio/mp4',
          ''
        ];
        for (const type of types) {
          if (!type || MediaRecorder.isTypeSupported(type)) return type;
        }
        return '';
      }

      function getSupportedVideoMimeType() {
        const types = [
          'video/webm;codecs=vp9,opus',
          'video/webm;codecs=vp8,opus',
          'video/webm',
          'video/mp4',
          ''
        ];
        for (const type of types) {
          if (!type || MediaRecorder.isTypeSupported(type)) return type;
        }
        return '';
      }

      // FIX 8: startRecording Ù…Ø­Ø³Ù‘Ù† Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡ Ø£ÙØ¶Ù„
      async function startRecording() {
        try {
          let stream;
          if (recordingType === "video") {
            if (previewStream) {
              try {
                const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream = new MediaStream([...previewStream.getVideoTracks(), ...audioStream.getAudioTracks()]);
              } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + e.message);
                return;
              }
            } else {
              try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                previewStream = new MediaStream(stream.getVideoTracks());
                const liveVideo = document.getElementById("liveVideo");
                liveVideo.srcObject = previewStream;
                document.getElementById("livePreview").classList.remove("hidden");
              } catch(e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e.message);
                return;
              }
            }
          } else {
            try {
              stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch(e) {
              alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.\n" + e.message);
              return;
            }
          }

          recordedChunks = [];
          const mimeType = recordingType === "video" ? getSupportedVideoMimeType() : getSupportedMimeType();
          try {
            mediaRecorder = mimeType
              ? new MediaRecorder(stream, { mimeType })
              : new MediaRecorder(stream);
          } catch(e) {
            mediaRecorder = new MediaRecorder(stream);
          }

          mediaRecorder.ondataavailable = e => {
            if (e.data && e.data.size > 0) recordedChunks.push(e.data);
          };
          mediaRecorder.onstop = () => {
            if (recordingType === "audio") {
              stream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            }
            showPreview();
          };
          mediaRecorder.onerror = (e) => {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + (e.error ? e.error.message : 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
            cancelRecording();
          };

          mediaRecorder.start(100); // Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 100ms Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙÙ‚Ø¯Ø§Ù†Ù‡Ø§
          document.getElementById("recordBtn").classList.add("hidden");
          document.getElementById("stopBtn").classList.remove("hidden");
          document.getElementById("timer").classList.remove("hidden");
          if (recordingType === "video") document.getElementById("livePreview").classList.add("recording");
          recordingStartTime = Date.now();
          timerInterval = setInterval(updateTimer, 1000);
        } catch(err) {
          alert("Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: " + err.message);
        }
      }

      function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const m = Math.floor(elapsed/60).toString().padStart(2,"0");
        const s = (elapsed%60).toString().padStart(2,"0");
        const timerEl = document.getElementById("timer");
        if (timerEl) timerEl.textContent = `${m}:${s}`;
      }

      function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          try {
            mediaRecorder.stop();
          } catch(e) {}
          clearInterval(timerInterval);
        }
      }

      function cancelRecording() {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          try { mediaRecorder.stop(); } catch(e) {}
        }
        const livePreview = document.getElementById("livePreview");
        if (livePreview) livePreview.classList.remove("recording");
        clearInterval(timerInterval);
        recordedChunks = [];
        document.getElementById("recordBtn").classList.remove("hidden");
        document.getElementById("stopBtn").classList.add("hidden");
        document.getElementById("timer").classList.add("hidden");
        document.getElementById("timer").textContent = "00:00";
        document.getElementById("recordingPreview").classList.add("hidden");
      }

      function showPreview() {
        if (recordedChunks.length === 0) {
          alert("Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
          cancelRecording();
          return;
        }
        const mimeType = recordingType === "video"
          ? (mediaRecorder && mediaRecorder.mimeType ? mediaRecorder.mimeType : "video/webm")
          : (mediaRecorder && mediaRecorder.mimeType ? mediaRecorder.mimeType : "audio/webm");
        const blob = new Blob(recordedChunks, { type: mimeType });
        const url = URL.createObjectURL(blob);
        const previewDiv = document.getElementById("previewMedia");
        previewDiv.innerHTML = recordingType === "video"
          ? `<video controls src="${url}" style="width:100%;border-radius:8px;"></video>`
          : `<audio controls src="${url}" style="width:100%;"></audio>`;
        document.getElementById("recordingPreview").classList.remove("hidden");
        document.getElementById("livePreview").classList.remove("recording");
        document.getElementById("recordBtn").classList.remove("hidden");
        document.getElementById("stopBtn").classList.add("hidden");
        document.getElementById("timer").classList.add("hidden");
      }

      function blobToBase64(blob) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      }

      // FIX 9: saveRecording Ù…Ø¹ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù…
      async function saveRecording() {
        if (recordedChunks.length === 0) {
          alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø­ÙØ¸. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
          return;
        }
        showLoading();
        try {
          const mimeType = mediaRecorder && mediaRecorder.mimeType
            ? mediaRecorder.mimeType
            : (recordingType === "video" ? "video/webm" : "audio/webm");
          const blob = new Blob(recordedChunks, { type: mimeType });

          // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¬Ù… (Firebase ÙŠØ¯Ø¹Ù… Ø­ØªÙ‰ 10MB per request)
          if (blob.size > 8 * 1024 * 1024) {
            hideLoading();
            alert("Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 8MB). ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ù…Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
            return;
          }

          const base64Data = await blobToBase64(blob);
          const recordingId = Date.now().toString();
          const recording = {
            id: recordingId,
            type: recordingType,
            data: base64Data,
            timestamp: new Date().toISOString()
          };

          await window.dbSet(
            window.dbRef(window.db, `participants/${currentUser.id}/recordings/${recordingId}`),
            recording
          );

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
          if (!Array.isArray(currentUser.recordings)) currentUser.recordings = [];
          currentUser.recordings.push(recording);

          hideLoading();
          alert("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…");
          recordedChunks = [];
          document.getElementById("recordingPreview").classList.add("hidden");
          document.getElementById("timer").textContent = "00:00";
          loadMyRecordings();
        } catch(error) {
          hideLoading();
          if (error.message && error.message.includes('quota')) {
            alert("Ø§Ù†ØªÙ‡Øª Ù…Ø³Ø§Ø­Ø© Firebase. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø´Ø±Ù.");
          } else {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message + "\n\nÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ­Ø¬Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„.");
          }
        }
      }

      async function loadMyRecordings() {
        try {
          const snap = await window.dbGet(window.dbRef(window.db, `participants/${currentUser.id}/recordings`));
          if (snap.exists()) {
            currentUser.recordings = toRecordingsArray(snap.val());
          } else {
            currentUser.recordings = [];
          }
        } catch(e) {
          console.error('loadMyRecordings fetch error:', e);
          if (!Array.isArray(currentUser.recordings)) currentUser.recordings = [];
        }

        const listDiv = document.getElementById("myRecordingsList");
        const recordings = toRecordingsArray(currentUser.recordings);
        if (recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
          return;
        }
        listDiv.innerHTML = recordings.map((rec, index) => `
          <div class="recording-item">
            <div class="three-dots" onclick="showRecordingMenu(event, '${rec.id}')">â‹®</div>
            <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index+1} - ${rec.type === "video" ? "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ" : "ğŸ¤ ØµÙˆØª"}
            </p>
            <p class="recording-date">${new Date(rec.timestamp).toLocaleDateString("ar-SA")}</p>
            ${createMediaElement(rec.data, rec.type)}
          </div>`).join("");
      }

      function showRecordingMenu(e, recordingId) {
        e.stopPropagation();
        const existingMenu = document.querySelector(".menu-popup");
        if (existingMenu) existingMenu.remove();
        const menu = document.createElement("div");
        menu.className = "menu-popup";
        menu.innerHTML = `<div class="menu-item danger" onclick="confirmDeleteRecording('${recordingId}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        e.target.parentElement.appendChild(menu);
        setTimeout(() => {
          document.addEventListener("click", function closeMenu(e) {
            if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener("click", closeMenu); }
          });
        }, 10);
      }

      function confirmDeleteRecording(recordingId) {
        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" onclick="deleteRecording('${recordingId}')">Ø­Ø°Ù</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(dialog);
      }

      function closeConfirmDialog() {
        document.querySelectorAll(".confirm-dialog").forEach(d => d.remove());
      }

      async function deleteRecording(recordingId) {
        showLoading();
        try {
          await window.dbRemove(window.dbRef(window.db, `participants/${currentUser.id}/recordings/${recordingId}`));
          const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (messagesSnapshot.exists()) {
            const updates = {};
            messagesSnapshot.forEach(child => {
              if (child.val().recordingId === recordingId) updates[`messages/${child.key}`] = null;
            });
            if (Object.keys(updates).length > 0) await window.dbUpdate(window.dbRef(window.db), updates);
          }
          currentUser.recordings = toRecordingsArray(currentUser.recordings).filter(r => r.id !== recordingId);
          hideLoading();
          closeConfirmDialog();
          loadMyRecordings();
          updateUnreadBadge();
          alert("ØªÙ… Ø§Ù„Ø­Ø°Ù! âœ…");
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + e.message);
        }
      }

      // ====== FIX 10: toRecordingsArray Ù…Ø­Ø³Ù‘Ù† ======
      function toRecordingsArray(recordings) {
        if (!recordings) return [];
        if (Array.isArray(recordings)) {
          // ÙÙ„ØªØ± null Ùˆundefined Ùˆrecordings Ø¨Ø¯ÙˆÙ† id
          return recordings.filter(r => r && r.id && r.data);
        }
        if (typeof recordings === 'object') {
          return Object.values(recordings).filter(r => r && r.id && r.data);
        }
        return [];
      }

      // ====== FIX 11: loadParticipants Ù…Ø¹ data attributes Ø¨Ø¯Ù„ onclick Ù…Ø¶Ù…Ù† ======
      async function loadParticipants() {
        showLoading();
        try {
          const snapshot = await window.dbGet(window.dbRef(window.db, 'participants'));
          hideLoading();
          const listDiv = document.getElementById("participantsList");
          if (!snapshot.exists()) {
            listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>';
            updateAdminStats(0, 0, 0);
            return;
          }
          let participants = [];
          snapshot.forEach(child => {
            const val = child.val();
            const recs = toRecordingsArray(val.recordings);
            participants.push({ id: child.key, ...val, recordings: recs });
          });
          if (participants.length === 0) {
            listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>';
            updateAdminStats(0, 0, 0);
            return;
          }
          let totalRecordings = 0, newRecordings = 0;
          participants.forEach(p => {
            totalRecordings += p.recordings.length;
            p.recordings.forEach(rec => { if (!isRecordingViewed(p.id, rec.id)) newRecordings++; });
          });
          updateAdminStats(participants.length, totalRecordings, newRecordings);

          // Ø­ÙØ¸ Ø§Ù„ÙƒØ§Ø´ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… String ID
          window._participantsCache = {};
          participants.forEach(p => { window._participantsCache[String(p.id)] = p; });

          listDiv.innerHTML = participants.map(p => {
            const newCount = p.recordings.filter(rec => !isRecordingViewed(p.id, rec.id)).length;
            // FIX: Ø§Ø³ØªØ®Ø¯Ø§Ù… data-id attribute Ø¨Ø¯Ù„ inline onclick Ù…Ø¹ ID Ù…Ø¹Ø§Ù„Ø¬
            return `
              <div class="participant-card" data-pid="${p.id}">
                ${newCount > 0 ? `<div class="new-recordings-badge">${newCount}</div>` : ''}
                <div class="icon">ğŸ‘¤</div>
                <h3>${p.name}</h3>
                <p class="count">${p.recordings.length} ØªØ³Ø¬ÙŠÙ„</p>
              </div>`;
          }).join("");

          // Ø¥Ø¶Ø§ÙØ© event listeners Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ±
          listDiv.querySelectorAll('.participant-card').forEach(card => {
            card.addEventListener('click', function() {
              const pid = this.getAttribute('data-pid');
              openParticipant(pid);
            });
          });

        } catch (error) {
          hideLoading();
          const listDiv = document.getElementById("participantsList");
          if (error.message && error.message.includes('permission')) {
            listDiv.innerHTML = `
              <div class="error-message" style="grid-column:1/-1;">
                ğŸ”’ <strong>Ø®Ø·Ø£ ÙÙŠ ØµÙ„Ø§Ø­ÙŠØ§Øª Firebase!</strong><br><br>
                Ø§Ù„Ø­Ù„: Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Firebase Console â†’ Realtime Database â†’ Rules ÙˆØºÙŠÙ‘Ø± Ø§Ù„Ù€ Rules Ø¥Ù„Ù‰:<br>
                <code style="background:#f1f1f1;padding:8px;display:block;margin-top:8px;border-radius:6px;direction:ltr;font-size:0.85rem;">
                { "rules": { ".read": true, ".write": true } }
                </code>
                Ø«Ù… Ø§Ø¶ØºØ· "Publish"
              </div>`;
          } else {
            listDiv.innerHTML = `<div class="error-message" style="grid-column:1/-1;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}</div>`;
          }
          updateAdminStats(0, 0, 0);
        }
      }

      function openParticipant(pid) {
        // FIX: Ø§Ø³ØªØ®Ø¯Ù… String Ù„Ù„Ø¨Ø­Ø«
        const p = window._participantsCache && window._participantsCache[String(pid)];
        if (p) {
          showAdminRecordingsPage(p);
        } else {
          alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.");
        }
      }

      function updateAdminStats(participants, recordings, newRecs) {
        document.getElementById("totalParticipants").textContent = participants;
        document.getElementById("totalRecordings").textContent = recordings;
        document.getElementById("newRecordings").textContent = newRecs;
      }

      async function loadParticipantRecordings() {
        const listDiv = document.getElementById("adminRecordingsList");
        try {
          const snap = await window.dbGet(window.dbRef(window.db, `participants/${currentParticipant.id}/recordings`));
          if (snap.exists()) {
            currentParticipant.recordings = toRecordingsArray(snap.val());
            if (window._participantsCache && window._participantsCache[String(currentParticipant.id)]) {
              window._participantsCache[String(currentParticipant.id)].recordings = currentParticipant.recordings;
            }
          } else {
            currentParticipant.recordings = [];
          }
        } catch(e) {
          console.error('loadParticipantRecordings error:', e);
          currentParticipant.recordings = toRecordingsArray(currentParticipant.recordings);
        }

        const recordings = currentParticipant.recordings;
        if (!recordings || recordings.length === 0) {
          listDiv.innerHTML = '<div class="empty-state"><div class="icon">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';
          return;
        }
        recordings.forEach(rec => markRecordingAsViewed(currentParticipant.id, rec.id));

        listDiv.innerHTML = recordings.map((rec, index) => `
          <div class="recording-item">
            <div class="three-dots" onclick="showAdminRecordingMenu(event, '${rec.id}')">â‹®</div>
            <p style="color:var(--dark-green);font-weight:700;font-size:1rem;margin-bottom:4px;">
              Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${index+1} - ${rec.type === "video" ? "ğŸ¥ ÙÙŠØ¯ÙŠÙˆ" : "ğŸ¤ ØµÙˆØª"}
            </p>
            <p class="recording-date">${new Date(rec.timestamp).toLocaleDateString("ar-SA")}</p>
            ${createMediaElement(rec.data, rec.type)}
          </div>`).join("");
      }

      function showAdminRecordingMenu(e, recordingId) {
        e.stopPropagation();
        const existingMenu = document.querySelector(".menu-popup");
        if (existingMenu) existingMenu.remove();
        const menu = document.createElement("div");
        menu.className = "menu-popup";
        menu.innerHTML = `
          <div class="menu-item" onclick="openMessageModal('${recordingId}', 'text')">âœï¸ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal('${recordingId}', 'voice')">ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©</div>
          <div class="menu-item" onclick="openMessageModal('${recordingId}', 'rating')">â­ ØªÙ‚ÙŠÙŠÙ…</div>
          <div class="menu-item danger" onclick="confirmDeleteRecordingAdmin('${recordingId}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>`;
        e.target.parentElement.appendChild(menu);
        setTimeout(() => {
          document.addEventListener("click", function closeMenu(e) {
            if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener("click", closeMenu); }
          });
        }, 10);
      }

      function openMessageModal(recordingId, type) {
        currentRecordingForMessage = recordingId;
        selectedRating = 0;
        adminVoiceChunks = [];
        adminVoiceBlob = null;
        const modal = document.createElement("div");
        modal.className = "message-modal";
        modal.id = "messageModal";
        modal.innerHTML = `
          <div class="message-modal-content">
            <h3>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø´Ø§Ø±Ùƒ</h3>
            <div class="message-type-btns">
              <button class="message-type-btn ${type==='text'?'active':''}" onclick="switchMessageType('text')">âœï¸ Ù†ØµÙŠØ©</button>
              <button class="message-type-btn ${type==='voice'?'active':''}" onclick="switchMessageType('voice')">ğŸ¤ ØµÙˆØªÙŠØ©</button>
              <button class="message-type-btn ${type==='rating'?'active':''}" onclick="switchMessageType('rating')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
            </div>
            <div id="textMessageDiv" class="${type!=='text'?'hidden':''}">
              <textarea id="messageText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
            </div>
            <div id="voiceMessageDiv" class="voice-recorder ${type!=='voice'?'hidden':''}">
              <button class="btn btn-primary" id="voiceRecordBtn" onclick="startAdminVoice()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
              <div class="timer hidden" id="voiceTimer">00:00</div>
              <button class="btn btn-danger hidden" id="voiceStopBtn" onclick="stopAdminVoice()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
              <div id="voicePreviewDiv" class="hidden">
                <audio id="voicePreview" controls style="width:100%;margin-top:8px;"></audio>
              </div>
            </div>
            <div id="ratingMessageDiv" class="rating-container ${type!=='rating'?'hidden':''}">
              <p style="color:var(--dark-green);font-weight:700;font-size:1.1rem;margin-bottom:10px;">Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
              <div class="stars-display" id="starsDisplay">
                ${[1,2,3,4,5].map(i => `<span class="star" onclick="setRating(${i})" data-value="${i}">â­</span>`).join('')}
              </div>
              <div class="rating-value" id="ratingValue">0 / 5</div>
              <div class="rating-buttons">
                ${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(val => `<button class="rating-btn" onclick="setRating(${val})">${val}</button>`).join('')}
              </div>
            </div>
            <div class="modal-buttons">
              <button class="btn btn-primary" onclick="sendMessageToParticipant()">Ø¥Ø±Ø³Ø§Ù„</button>
              <button class="btn btn-secondary" onclick="closeMessageModal()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
      }

      function switchMessageType(type) {
        document.querySelectorAll("#messageModal .message-type-btn").forEach(btn => btn.classList.remove("active"));
        event.target.classList.add("active");
        document.getElementById("textMessageDiv").classList.add("hidden");
        document.getElementById("voiceMessageDiv").classList.add("hidden");
        document.getElementById("ratingMessageDiv").classList.add("hidden");
        if (type === 'text') document.getElementById("textMessageDiv").classList.remove("hidden");
        else if (type === 'voice') document.getElementById("voiceMessageDiv").classList.remove("hidden");
        else if (type === 'rating') document.getElementById("ratingMessageDiv").classList.remove("hidden");
      }

      function setRating(value) {
        selectedRating = value;
        document.getElementById("ratingValue").textContent = `${value} / 5`;
        document.querySelectorAll("#starsDisplay .star").forEach((star, index) => {
          const starValue = index + 1;
          star.classList.remove("filled");
          if (value >= starValue) star.classList.add("filled");
        });
        document.querySelectorAll(".rating-btn").forEach(btn => {
          btn.classList.remove("active");
          if (parseFloat(btn.textContent) === value) btn.classList.add("active");
        });
      }

      let adminVoiceBlob = null;

      async function startAdminVoice() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          adminVoiceChunks = [];
          adminVoiceBlob = null;
          const mimeType = getSupportedMimeType();
          try {
            adminVoiceRecorder = mimeType
              ? new MediaRecorder(stream, { mimeType })
              : new MediaRecorder(stream);
          } catch(e) {
            adminVoiceRecorder = new MediaRecorder(stream);
          }
          adminVoiceRecorder.ondataavailable = e => {
            if (e.data && e.data.size > 0) adminVoiceChunks.push(e.data);
          };
          adminVoiceRecorder.onstop = () => {
            stream.getTracks().forEach(t => { try { t.stop(); } catch(e) {} });
            if (adminVoiceChunks.length > 0) {
              const usedMime = adminVoiceRecorder.mimeType || 'audio/webm';
              adminVoiceBlob = new Blob(adminVoiceChunks, { type: usedMime });
              const url = URL.createObjectURL(adminVoiceBlob);
              const preview = document.getElementById("voicePreview");
              if (preview) { preview.src = url; }
              const previewDiv = document.getElementById("voicePreviewDiv");
              if (previewDiv) previewDiv.classList.remove("hidden");
            }
          };
          adminVoiceRecorder.start(100);
          document.getElementById("voiceRecordBtn").classList.add("hidden");
          document.getElementById("voiceStopBtn").classList.remove("hidden");
          document.getElementById("voiceTimer").classList.remove("hidden");
          const startTime = Date.now();
          adminVoiceTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(elapsed/60).toString().padStart(2,"0");
            const s = (elapsed%60).toString().padStart(2,"0");
            const timerEl = document.getElementById("voiceTimer");
            if (timerEl) timerEl.textContent = `${m}:${s}`;
          }, 1000);
        } catch(err) {
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø§ÙŠÙƒØ±ÙˆÙÙˆÙ†: " + err.message);
        }
      }

      function stopAdminVoice() {
        if (adminVoiceRecorder && adminVoiceRecorder.state !== "inactive") {
          try { adminVoiceRecorder.stop(); } catch(e) {}
          clearInterval(adminVoiceTimer);
          const btn = document.getElementById("voiceRecordBtn");
          const stopBtn = document.getElementById("voiceStopBtn");
          const timer = document.getElementById("voiceTimer");
          if (btn) btn.classList.remove("hidden");
          if (stopBtn) stopBtn.classList.add("hidden");
          if (timer) { timer.classList.add("hidden"); timer.textContent = "00:00"; }
        }
      }

      async function sendMessageToParticipant() {
        const activeBtn = document.querySelector("#messageModal .message-type-btn.active");
        if (!activeBtn) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ø§Ù‹."); return; }

        let messageType = 'text';
        if (activeBtn.textContent.includes("Ù†ØµÙŠØ©")) messageType = 'text';
        else if (activeBtn.textContent.includes("ØµÙˆØªÙŠØ©")) messageType = 'voice';
        else if (activeBtn.textContent.includes("ØªÙ‚ÙŠÙŠÙ…")) messageType = 'rating';

        showLoading();
        try {
          if (messageType === 'text') {
            const messageText = document.getElementById("messageText").value.trim();
            if (!messageText) { hideLoading(); alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©!"); return; }
            await sendMessage(currentParticipant.id, currentRecordingForMessage, messageText, 'text', null, null);

          } else if (messageType === 'voice') {
            // FIX 12: Ø§Ø³ØªØ®Ø¯Ø§Ù… adminVoiceBlob Ø¨Ø¯Ù„ adminVoiceChunks Ù…Ø¨Ø§Ø´Ø±Ø©
            if (!adminVoiceBlob) {
              hideLoading();
              alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù!");
              return;
            }
            if (adminVoiceBlob.size > 5 * 1024 * 1024) {
              hideLoading();
              alert("Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØµÙˆØªÙŠØ© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹. ÙŠØ±Ø¬Ù‰ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¯Ø©.");
              return;
            }
            const base64Data = await blobToBase64(adminVoiceBlob);
            await sendMessage(currentParticipant.id, currentRecordingForMessage, "Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© ğŸ¤", 'voice', base64Data, null);

          } else if (messageType === 'rating') {
            if (selectedRating === 0) { hideLoading(); alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ…!"); return; }
            // Ø­Ø°Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù†ÙØ³ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
            if (messagesSnapshot.exists()) {
              const updates = {};
              messagesSnapshot.forEach(child => {
                const msg = child.val();
                if (msg.recordingId === currentRecordingForMessage &&
                    String(msg.participantId) === String(currentParticipant.id) &&
                    msg.messageType === 'rating') {
                  updates[`messages/${child.key}`] = null;
                }
              });
              if (Object.keys(updates).length > 0) {
                await window.dbUpdate(window.dbRef(window.db), updates);
              }
            }
            await sendMessage(currentParticipant.id, currentRecordingForMessage,
              `ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selectedRating} / 5 Ù†Ø¬ÙˆÙ…`, 'rating', null, selectedRating);
          }

          hideLoading();
          closeMessageModal();
          if (messageType === 'rating') await calculateAndDisplayTotalRating();
          await loadAdminSentMessages();
          alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! âœ…");
        } catch(error) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + error.message);
        }
      }

      async function sendMessage(participantId, recordingId, message, messageType, voiceData, rating) {
        const newMessageRef = window.dbPush(window.dbRef(window.db, 'messages'));
        const newMessage = {
          participantId: String(participantId),
          recordingId: String(recordingId),
          message,
          messageType,
          timestamp: new Date().toISOString(),
          read: false
        };
        if (messageType === 'voice' && voiceData) newMessage.voiceData = voiceData;
        if (messageType === 'rating' && rating) newMessage.rating = rating;
        await window.dbSet(newMessageRef, newMessage);
        return newMessage;
      }

      function closeMessageModal() {
        const modal = document.getElementById("messageModal");
        if (modal) modal.remove();
        adminVoiceChunks = [];
        adminVoiceBlob = null;
        if (adminVoiceRecorder && adminVoiceRecorder.state !== "inactive") {
          try { adminVoiceRecorder.stop(); } catch(e) {}
        }
        clearInterval(adminVoiceTimer);
        selectedRating = 0;
      }

      function confirmDeleteRecordingAdmin(recordingId) {
        const dialog = document.createElement("div");
        dialog.className = "confirm-dialog";
        dialog.innerHTML = `
          <div class="confirm-content">
            <h3>âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h3>
            <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ØŸ<br>Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹Ù‡.</p>
            <div class="confirm-buttons">
              <button class="btn btn-danger" onclick="deleteRecordingAdmin('${recordingId}')">Ø­Ø°Ù</button>
              <button class="btn btn-secondary" onclick="closeConfirmDialog()">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
          </div>`;
        document.body.appendChild(dialog);
      }

      async function deleteRecordingAdmin(recordingId) {
        showLoading();
        try {
          await window.dbRemove(window.dbRef(window.db, `participants/${currentParticipant.id}/recordings/${recordingId}`));
          const messagesSnapshot = await window.dbGet(window.dbRef(window.db, 'messages'));
          if (messagesSnapshot.exists()) {
            const updates = {};
            messagesSnapshot.forEach(child => {
              if (child.val().recordingId === recordingId) updates[`messages/${child.key}`] = null;
            });
            if (Object.keys(updates).length > 0) await window.dbUpdate(window.dbRef(window.db), updates);
          }
          hideLoading();
          closeConfirmDialog();
          await calculateAndDisplayTotalRating();
          await loadAdminSentMessages();
          await loadParticipantRecordings();
          alert("ØªÙ… Ø§Ù„Ø­Ø°Ù! âœ…");
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: " + e.message);
        }
      }

      function toggleContactInfo() {
        const content = document.getElementById("contactInfoContent");
        const toggleText = document.getElementById("contactToggleText");
        if (content.classList.contains("hidden")) { content.classList.remove("hidden"); toggleText.textContent = "Ø¥Ø®ÙØ§Ø¡"; }
        else { content.classList.add("hidden"); toggleText.textContent = "Ø¹Ø±Ø¶"; }
      }

      async function copyToClipboard(type) {
        let textToCopy = type === 'name' ? currentParticipant.name : currentParticipant.password;
        let buttonElement = event.target.closest('.copy-btn');
        try {
          await navigator.clipboard.writeText(textToCopy);
          const originalHTML = buttonElement.innerHTML;
          buttonElement.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®';
          buttonElement.classList.add('copied');
          setTimeout(() => { buttonElement.innerHTML = originalHTML; buttonElement.classList.remove('copied'); }, 2000);
        } catch(err) {
          // Fallback Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… clipboard API
          const textArea = document.createElement("textarea");
          textArea.value = textToCopy;
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try { document.execCommand('copy'); alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® âœ…'); } catch(e) { alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®'); }
          document.body.removeChild(textArea);
        }
      }

      async function showLeaderboard(caller) {
        if (!isAdmin) return;
        showLoading();
        try {
          const participantsSnap = await window.dbGet(window.dbRef(window.db, 'participants'));
          const messagesSnap = await window.dbGet(window.dbRef(window.db, 'messages'));
          let participants = [];
          if (participantsSnap.exists()) {
            participantsSnap.forEach(child => {
              const val = child.val();
              participants.push({ id: child.key, name: val.name, recordings: toRecordingsArray(val.recordings) });
            });
          }
          const ratings = {};
          participants.forEach(p => { ratings[p.id] = { total: 0, ratedSet: new Set() }; });
          if (messagesSnap.exists()) {
            messagesSnap.forEach(child => {
              const msg = child.val();
              if (msg.messageType === 'rating' && msg.rating && ratings[String(msg.participantId)]) {
                const r = ratings[String(msg.participantId)];
                if (!r.ratedSet.has(msg.recordingId)) {
                  r.total += msg.rating;
                  r.ratedSet.add(msg.recordingId);
                }
              }
            });
          }
          const ranked = participants.map(p => ({
            ...p,
            totalRating: ratings[p.id] ? ratings[p.id].total : 0,
            ratedCount: ratings[p.id] ? ratings[p.id].ratedSet.size : 0,
            maxRating: ratings[p.id] ? ratings[p.id].ratedSet.size * 5 : 0,
          })).sort((a, b) => b.totalRating - a.totalRating || b.ratedCount - a.ratedCount);
          hideLoading();
          renderLeaderboard(ranked, caller);
        } catch(e) {
          hideLoading();
          alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨: " + e.message);
        }
      }

      function renderLeaderboard(ranked, caller) {
        const old = document.getElementById('leaderboardModal');
        if (old) old.remove();
        const myId = currentUser && !isAdmin ? currentUser.id : null;
        const myRank = myId ? ranked.findIndex(p => p.id === myId) + 1 : 0;
        const rankEmoji = (i) => i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : (i + 1);
        const rankClass = (i) => i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : 'rank-other';
        const starsHtml = (rating, max) => {
          if (!max) return '<span style="color:#bbb;font-size:0.8rem;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¹Ø¯</span>';
          const full = Math.floor(rating);
          return 'â­'.repeat(full) + 'â˜†'.repeat(Math.max(0, 5 - full));
        };
        let rowsHtml = '';
        if (ranked.length === 0) {
          rowsHtml = `<div class="leaderboard-empty"><div class="icon">ğŸ†</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø¨Ø¹Ø¯</p></div>`;
        } else {
          ranked.forEach((p, i) => {
            const isMine = p.id === myId;
            rowsHtml += `
              <div class="leaderboard-row ${rankClass(i)} ${isMine ? 'rank-mine' : ''}" style="animation-delay:${i * 0.06}s">
                <div class="rank-badge">${rankEmoji(i)}</div>
                <div class="rank-info">
                  <div class="rank-name">${p.name}${isMine ? '<span class="you-tag">Ø£Ù†ØªÙ</span>' : ''}</div>
                  <div class="rank-details">${p.recordings.length} ØªØ³Ø¬ÙŠÙ„ â€¢ ${p.ratedCount} ØªÙ‚ÙŠÙŠÙ…</div>
                  <div class="rank-stars">${starsHtml(p.totalRating, p.maxRating)}</div>
                </div>
                <div class="rank-score">
                  <div class="score-num">${p.totalRating > 0 ? p.totalRating.toFixed(1) : '-'}</div>
                  ${p.maxRating > 0 ? `<div class="score-label">Ù…Ù† ${p.maxRating}</div>` : '<div class="score-label">Ù†Ù‚Ø·Ø©</div>'}
                </div>
              </div>`;
          });
        }
        let myBanner = '';
        if (myId && myRank > 0 && ranked.length > 0) {
          const me = ranked[myRank - 1];
          myBanner = `
            <div class="my-rank-banner">
              <span class="icon">ğŸ“</span>
              <div class="text">Ù…Ø±ØªØ¨ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <strong>${myRank} Ù…Ù† ${ranked.length}</strong> â€¢ Ù…Ø¬Ù…ÙˆØ¹Ùƒ: <strong>${me.totalRating > 0 ? me.totalRating.toFixed(1) : '0'} Ù†Ù‚Ø·Ø©</strong></div>
            </div>`;
        }
        const modal = document.createElement('div');
        modal.className = 'leaderboard-modal';
        modal.id = 'leaderboardModal';
        modal.innerHTML = `
          <div class="leaderboard-content">
            <div class="leaderboard-header">
              <button class="leaderboard-close" onclick="closeLeaderboard()">âœ•</button>
              <h2>ğŸ† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ±ØªÙŠØ¨</h2>
              <p>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù… - Ø±Ù…Ø¶Ø§Ù† 1446</p>
            </div>
            <div class="leaderboard-body">
              ${myBanner}
              ${rowsHtml}
            </div>
          </div>`;
        document.body.appendChild(modal);
        modal.addEventListener('click', function(e) {
          if (e.target === modal) closeLeaderboard();
        });
      }

      function closeLeaderboard() {
        const modal = document.getElementById('leaderboardModal');
        if (modal) modal.remove();
      }
    </script>
  </body>
</html>
