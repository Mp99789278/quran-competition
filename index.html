<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Firebase â†’ Supabase</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0d4d3f; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .box { background: white; border-radius: 16px; padding: 30px; max-width: 600px; width: 100%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    h1 { color: #0d4d3f; text-align: center; margin-bottom: 8px; font-size: 1.5rem; }
    .subtitle { text-align: center; color: #888; margin-bottom: 25px; font-size: 0.9rem; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, #d4af37, #f0c850); color: #0d4d3f; margin-top: 15px; }
    .btn:hover { opacity: 0.9; transform: translateY(-2px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .log { background: #1a1a2e; color: #00ff88; padding: 15px; border-radius: 10px; margin-top: 20px; min-height: 200px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; line-height: 1.8; }
    .log .error { color: #ff4444; }
    .log .success { color: #00ff88; }
    .log .info { color: #88ccff; }
    .log .warn { color: #ffaa00; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
    .stat { background: #f0fff4; border: 2px solid #4caf50; border-radius: 10px; padding: 12px; text-align: center; }
    .stat .num { font-size: 1.8rem; font-weight: 900; color: #0d4d3f; }
    .stat .lbl { font-size: 0.75rem; color: #666; }
    .progress-bar { background: #e0e0e0; border-radius: 10px; height: 12px; margin-top: 15px; overflow: hidden; }
    .progress-fill { background: linear-gradient(90deg, #d4af37, #4caf50); height: 100%; border-radius: 10px; transition: width 0.3s; width: 0%; }
    .done-banner { background: linear-gradient(135deg, #e8f5e9, #f0fff4); border: 2px solid #4caf50; border-radius: 12px; padding: 20px; text-align: center; margin-top: 20px; display: none; }
    .done-banner h2 { color: #0d4d3f; font-size: 1.3rem; margin-bottom: 8px; }
    .done-banner p { color: #555; font-size: 0.95rem; }
  </style>
</head>
<body>
<div class="box">
  <h1>ğŸ”„ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
  <p class="subtitle">Ù…Ù† Firebase Ø¥Ù„Ù‰ Supabase ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>

  <div class="stats">
    <div class="stat"><div class="num" id="sParticipants">0</div><div class="lbl">Ù…Ø´Ø§Ø±Ùƒ</div></div>
    <div class="stat"><div class="num" id="sRecordings">0</div><div class="lbl">ØªØ³Ø¬ÙŠÙ„</div></div>
    <div class="stat"><div class="num" id="sMessages">0</div><div class="lbl">Ø±Ø³Ø§Ù„Ø©</div></div>
    <div class="stat"><div class="num" id="sBroadcasts">0</div><div class="lbl">Ø¥Ø¹Ù„Ø§Ù†</div></div>
  </div>

  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

  <button class="btn" id="startBtn" onclick="startMigration()">ğŸš€ Ø§Ø¨Ø¯Ø£ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>

  <div class="log" id="log"><span class="info">â³ Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„Ø¨Ø¯Ø¡ Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase Ø¥Ù„Ù‰ Supabase...</span></div>

  <div class="done-banner" id="doneBanner">
    <h2>âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!</h2>
    <p>Ø§Ù„Ø¢Ù† ÙŠÙ…ÙƒÙ†Ùƒ ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Supabase) ÙˆØ³ØªØ¬Ø¯ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

  const firebaseConfig = {
    apiKey: "AIzaSyAfhQL5spF3KcrbngSzunLaHT_7cieHkUk",
    authDomain: "opject-e223d.firebaseapp.com",
    databaseURL: "https://opject-e223d-default-rtdb.firebaseio.com/",
    projectId: "opject-e223d",
    storageBucket: "opject-e223d.firebasestorage.app",
    messagingSenderId: "607939195786",
    appId: "1:607939195786:web:c264710387d50fc2990e73"
  };

  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);
  window.fbDb = database;
  window.fbRef = ref;
  window.fbGet = get;
  window.firebaseReady = true;
</script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = 'https://jimrkqewuafaoxmpmhbp.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImppbXJrcWV3dWFmYW94bXBtaGJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODM1NzUsImV4cCI6MjA4NzI1OTU3NX0.Qihj4BnB0FErseE0j8Gq8ydbOf8Bu7lW2sRTfTudZ7Q';
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let totalSteps = 0;
  let doneSteps = 0;

  function log(msg, type = 'info') {
    const el = document.getElementById('log');
    const span = document.createElement('div');
    span.className = type;
    span.innerHTML = msg;
    el.appendChild(span);
    el.scrollTop = el.scrollHeight;
  }

  function updateProgress() {
    doneSteps++;
    const pct = totalSteps > 0 ? Math.round((doneSteps / totalSteps) * 100) : 0;
    document.getElementById('progressFill').style.width = pct + '%';
  }

  function updateStat(id, val) {
    document.getElementById(id).textContent = val;
  }

  async function waitForFirebase() {
    return new Promise((resolve) => {
      if (window.firebaseReady) { resolve(); return; }
      const check = setInterval(() => {
        if (window.firebaseReady) { clearInterval(check); resolve(); }
      }, 100);
      setTimeout(() => { clearInterval(check); resolve(); }, 5000);
    });
  }

  async function startMigration() {
    document.getElementById('startBtn').disabled = true;
    document.getElementById('log').innerHTML = '';
    doneSteps = 0;

    log('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...', 'info');
    await waitForFirebase();

    if (!window.fbDb) {
      log('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase!', 'error');
      document.getElementById('startBtn').disabled = false;
      return;
    }

    log('âœ… ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase', 'success');
    log('â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');

    try {
      // Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
      const [participantsSnap, messagesSnap, broadcastsSnap] = await Promise.all([
        window.fbGet(window.fbRef(window.fbDb, 'participants')),
        window.fbGet(window.fbRef(window.fbDb, 'messages')),
        window.fbGet(window.fbRef(window.fbDb, 'broadcasts'))
      ]);

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const participants = [];
      const allRecordings = [];
      const messages = [];
      const broadcasts = [];

      // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª
      if (participantsSnap.exists()) {
        participantsSnap.forEach(child => {
          const p = child.val();
          const fbId = child.key;
          participants.push({ fbId, name: p.name, password: p.password, registeredAt: p.registeredAt });
          
          // Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ
          if (p.recordings) {
            const recs = typeof p.recordings === 'object' && !Array.isArray(p.recordings)
              ? Object.values(p.recordings)
              : (Array.isArray(p.recordings) ? p.recordings : []);
            recs.forEach(rec => {
              if (rec && rec.id && rec.data) {
                allRecordings.push({ fbId: rec.id, participantFbId: fbId, type: rec.type || 'audio', data: rec.data, timestamp: rec.timestamp });
              }
            });
          }
        });
      }

      // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
      if (messagesSnap.exists()) {
        messagesSnap.forEach(child => {
          const m = child.val();
          messages.push({ fbId: child.key, ...m });
        });
      }

      // Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
      if (broadcastsSnap.exists()) {
        broadcastsSnap.forEach(child => {
          const b = child.val();
          broadcasts.push({ fbId: child.key, ...b });
        });
      }

      log(`ğŸ“Š ÙˆØ¬Ø¯Øª: ${participants.length} Ù…Ø´Ø§Ø±ÙƒØŒ ${allRecordings.length} ØªØ³Ø¬ÙŠÙ„ØŒ ${messages.length} Ø±Ø³Ø§Ù„Ø©ØŒ ${broadcasts.length} Ø¥Ø¹Ù„Ø§Ù†`, 'info');

      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©
      totalSteps = participants.length + allRecordings.length + messages.length + broadcasts.length;
      if (totalSteps === 0) {
        log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase Ù„Ù„Ù†Ù‚Ù„!', 'warn');
        document.getElementById('startBtn').disabled = false;
        return;
      }

      // ===== Ø®Ø·ÙˆØ© 1: Ù†Ù‚Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† =====
      log('', 'info');
      log('ğŸ‘¥ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†...', 'info');

      // Ø®Ø±ÙŠØ·Ø© fbId â†’ supabase id
      const participantIdMap = {};

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
      const { data: existingParticipants } = await sb.from('participants').select('id, name');
      const existingNames = new Map((existingParticipants || []).map(p => [p.name, p.id]));

      let pCount = 0;
      for (const p of participants) {
        if (existingNames.has(p.name)) {
          // Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ - Ø§Ø³ØªØ®Ø¯Ù… ID Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
          participantIdMap[p.fbId] = existingNames.get(p.name);
          log(`â­ï¸ Ù…Ø´Ø§Ø±Ùƒ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: ${p.name}`, 'warn');
        } else {
          // Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ø±Ùƒ Ø¬Ø¯ÙŠØ¯
          const { data: newP, error } = await sb.from('participants').insert({
            name: p.name,
            password: p.password
          }).select().single();

          if (error) {
            log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ù‚Ù„ Ù…Ø´Ø§Ø±Ùƒ "${p.name}": ${error.message}`, 'error');
          } else {
            participantIdMap[p.fbId] = newP.id;
            pCount++;
            log(`âœ… Ù†ÙÙ‚Ù„ Ù…Ø´Ø§Ø±Ùƒ: ${p.name}`, 'success');
          }
        }
        updateProgress();
        updateStat('sParticipants', ++pCount > participants.length ? participants.length : pCount);
      }
      updateStat('sParticipants', participants.length);

      // ===== Ø®Ø·ÙˆØ© 2: Ù†Ù‚Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª =====
      log('', 'info');
      log('ğŸ¤ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª...', 'info');

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
      const { data: existingRecs } = await sb.from('recordings').select('id, participant_id, created_at');
      
      const recordingIdMap = {};
      let rCount = 0;

      for (const rec of allRecordings) {
        const supParticipantId = participantIdMap[rec.participantFbId];
        if (!supParticipantId) {
          log(`âš ï¸ ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±Ùƒ Ù…Ø¹Ø±ÙˆÙ - ØªØ®Ø·ÙŠ`, 'warn');
          updateProgress();
          continue;
        }

        const { data: newRec, error } = await sb.from('recordings').insert({
          participant_id: supParticipantId,
          type: rec.type,
          data: rec.data
        }).select().single();

        if (error) {
          log(`âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„: ${error.message}`, 'error');
        } else {
          recordingIdMap[rec.fbId] = newRec.id;
          rCount++;
          log(`âœ… Ù†ÙÙ‚Ù„ ØªØ³Ø¬ÙŠÙ„ ${rCount}/${allRecordings.length}`, 'success');
          updateStat('sRecordings', rCount);
        }
        updateProgress();
      }

      // ===== Ø®Ø·ÙˆØ© 3: Ù†Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ =====
      log('', 'info');
      log('ğŸ“¬ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...', 'info');

      let mCount = 0;
      for (const msg of messages) {
        const supParticipantId = participantIdMap[msg.participantId];
        const supRecordingId = recordingIdMap[msg.recordingId];

        if (!supParticipantId) {
          log(`âš ï¸ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§Ø±Ùƒ - ØªØ®Ø·ÙŠ`, 'warn');
          updateProgress();
          continue;
        }

        const msgData = {
          participant_id: supParticipantId,
          recording_id: supRecordingId || null,
          message: msg.message || '',
          message_type: msg.messageType || 'text',
          read: msg.read || false
        };
        if (msg.voiceData) msgData.voice_data = msg.voiceData;
        if (msg.rating) msgData.rating = msg.rating;

        const { error } = await sb.from('messages').insert(msgData);
        if (error) {
          log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ø§Ù„Ø©: ${error.message}`, 'error');
        } else {
          mCount++;
          log(`âœ… Ù†ÙÙ‚Ù„Øª Ø±Ø³Ø§Ù„Ø© ${mCount}/${messages.length}`, 'success');
          updateStat('sMessages', mCount);
        }
        updateProgress();
      }

      // ===== Ø®Ø·ÙˆØ© 4: Ù†Ù‚Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª =====
      log('', 'info');
      log('ğŸ“¢ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª...', 'info');

      let bCount = 0;
      for (const b of broadcasts) {
        const bData = {
          message: b.message || '',
          type: b.type || 'text'
        };
        if (b.voiceData) bData.voice_data = b.voiceData;

        const { error } = await sb.from('broadcasts').insert(bData);
        if (error) {
          log(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ù„Ø§Ù†: ${error.message}`, 'error');
        } else {
          bCount++;
          log(`âœ… Ù†ÙÙ‚Ù„ Ø¥Ø¹Ù„Ø§Ù† ${bCount}/${broadcasts.length}`, 'success');
          updateStat('sBroadcasts', bCount);
        }
        updateProgress();
      }

      // ===== Ø§Ù„Ù†ØªÙŠØ¬Ø© =====
      document.getElementById('progressFill').style.width = '100%';
      log('', 'info');
      log('ğŸ‰ğŸ‰ğŸ‰ ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰ğŸ‰ğŸ‰', 'success');
      log(`ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:`, 'info');
      log(`  ğŸ‘¥ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†: ${participants.length}`, 'info');
      log(`  ğŸ¤ ØªØ³Ø¬ÙŠÙ„Ø§Øª: ${rCount}`, 'info');
      log(`  ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„: ${mCount}`, 'info');
      log(`  ğŸ“¢ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª: ${bCount}`, 'info');

      document.getElementById('doneBanner').style.display = 'block';

    } catch(err) {
      log(`âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${err.message}`, 'error');
      console.error(err);
    }

    document.getElementById('startBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'ğŸ”„ ØªØ´ØºÙŠÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
  }
</script>
</body>
</html>
