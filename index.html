<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Scheherazade+New:wght@400;700&family=Tajawal:wght@300;400;500;700;900&display=swap" rel="stylesheet"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --ink:#0f1923;
  --gold:#c8982a;
  --gold2:#e8b84b;
  --gold3:#f5d27a;
  --emerald:#0e4d3a;
  --emerald2:#176049;
  --emerald3:#1e7a5c;
  --cream:#fdf8ee;
  --cream2:#f7f0dc;
  --white:#ffffff;
  --muted:#7a8a8f;
  --border:#e2d9c8;
  --red:#c0392b;
  --red2:#e74c3c;
  --shadow:0 4px 24px rgba(15,25,35,0.12);
  --shadow-lg:0 12px 48px rgba(15,25,35,0.18);
}

body{
  font-family:'Tajawal',sans-serif;
  background:var(--cream);
  min-height:100vh;
  color:var(--ink);
  overflow-x:hidden;
}

/* â”€â”€â”€ BACKGROUND PATTERN â”€â”€â”€ */
body::before{
  content:'';
  position:fixed;top:0;left:0;right:0;bottom:0;
  background-image:
    radial-gradient(circle at 20% 20%, rgba(200,152,42,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(14,77,58,0.08) 0%, transparent 50%);
  pointer-events:none;z-index:0;
}

.app-wrapper{position:relative;z-index:1;min-height:100vh;}

/* â”€â”€â”€ TOPBAR â”€â”€â”€ */
.topbar{
  background:linear-gradient(135deg, var(--emerald) 0%, var(--emerald2) 100%);
  padding:0 16px;
  height:56px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 2px 16px rgba(14,77,58,0.35);
  position:sticky;top:0;z-index:100;
}
.topbar-brand{
  display:flex;align-items:center;gap:10px;
}
.topbar-logo{
  width:36px;height:36px;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:1.2rem;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  overflow:hidden;
}
.topbar-logo img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.topbar-title{
  font-family:'Scheherazade New',serif;
  color:var(--white);font-size:1.05rem;font-weight:700;
  line-height:1.2;
}
.topbar-sub{color:var(--gold3);font-size:0.72rem;font-weight:400;}
.topbar-actions{display:flex;gap:8px;align-items:center;}
.topbar-btn{
  background:rgba(255,255,255,0.12);
  color:white;border:1.5px solid rgba(255,255,255,0.25);
  padding:6px 12px;border-radius:20px;
  font-size:0.8rem;font-weight:700;cursor:pointer;
  font-family:'Tajawal',sans-serif;
  transition:all .2s;
}
.topbar-btn:hover{background:rgba(255,255,255,0.22);}
.topbar-btn.gold-btn{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:var(--emerald);border-color:transparent;
}

/* â”€â”€â”€ MAIN CONTAINER â”€â”€â”€ */
.main{max-width:520px;margin:0 auto;padding:20px 14px 40px;}

/* â”€â”€â”€ PAGES â”€â”€â”€ */
.page{display:none;}
.page.active{display:block;}

/* â”€â”€â”€ HOME PAGE â”€â”€â”€ */
.hero{
  text-align:center;padding:30px 10px 24px;
}
.hero-moon{
  font-size:3.5rem;margin-bottom:10px;
  animation:float 4s ease-in-out infinite;
  display:block;
}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
.hero h1{
  font-family:'Scheherazade New',serif;
  font-size:2rem;color:var(--emerald);
  margin-bottom:6px;line-height:1.3;
}
.hero p{color:var(--muted);font-size:0.95rem;}
.hero-badge{
  display:inline-flex;align-items:center;gap:6px;
  background:linear-gradient(135deg,#fef9ec,#fdf3d0);
  border:1.5px solid var(--gold);border-radius:20px;
  padding:5px 14px;margin:12px auto 24px;
  color:var(--gold);font-weight:700;font-size:0.85rem;
}

.home-cards{display:flex;flex-direction:column;gap:12px;}
.home-card{
  background:var(--white);border-radius:16px;
  border:2px solid var(--border);
  padding:18px 20px;
  display:flex;align-items:center;gap:14px;
  cursor:pointer;
  transition:all .25s;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
  position:relative;overflow:hidden;
}
.home-card::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,var(--emerald),var(--emerald2));
  opacity:0;transition:opacity .25s;
}
.home-card:hover{transform:translateY(-2px);box-shadow:var(--shadow);border-color:var(--emerald);}
.home-card:hover::before{opacity:1;}
.home-card:hover .hc-title,.home-card:hover .hc-desc{color:white;}
.home-card:hover .hc-icon-wrap{background:rgba(255,255,255,0.2);}
.home-card .hc-icon-wrap{
  width:48px;height:48px;border-radius:12px;
  background:linear-gradient(135deg,var(--cream),var(--cream2));
  display:flex;align-items:center;justify-content:center;
  font-size:1.5rem;flex-shrink:0;position:relative;z-index:1;
  transition:all .25s;
}
.home-card .hc-text{position:relative;z-index:1;}
.home-card .hc-title{font-weight:700;font-size:1rem;color:var(--emerald);transition:color .25s;}
.home-card .hc-desc{font-size:0.8rem;color:var(--muted);margin-top:2px;transition:color .25s;}
.home-card .hc-arrow{
  margin-right:auto;position:relative;z-index:1;
  color:var(--muted);font-size:1.1rem;transition:color .25s;
}
.home-card:hover .hc-arrow{color:rgba(255,255,255,0.7);}
.home-card.admin-card{border-style:dashed;}

/* â”€â”€â”€ FORMS â”€â”€â”€ */
.form-card{
  background:var(--white);border-radius:20px;
  border:2px solid var(--border);
  padding:24px 20px;
  box-shadow:var(--shadow);
}
.form-title{
  font-size:1.2rem;font-weight:700;color:var(--emerald);
  margin-bottom:20px;display:flex;align-items:center;gap:8px;
}
.form-group{margin-bottom:16px;}
.form-label{
  display:block;font-weight:700;font-size:0.9rem;
  color:var(--emerald);margin-bottom:7px;
}
.input-wrap{position:relative;}
.form-input{
  width:100%;padding:12px 14px;
  border:2px solid var(--border);border-radius:12px;
  font-size:0.95rem;font-family:'Tajawal',sans-serif;
  background:var(--cream);color:var(--ink);
  transition:all .2s;
}
.form-input:focus{
  outline:none;border-color:var(--gold);
  background:white;
  box-shadow:0 0 0 4px rgba(200,152,42,0.12);
}
.pass-toggle{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  cursor:pointer;font-size:1rem;color:var(--muted);
  transition:color .2s;
}
.pass-toggle:hover{color:var(--emerald);}
.error-box{
  background:#fef2f2;color:#991b1b;
  padding:10px 14px;border-radius:10px;
  margin-bottom:14px;font-size:0.88rem;font-weight:600;
  border:1.5px solid #fecaca;display:none;
}
.error-box.show{display:block;}
.back-link{
  display:inline-flex;align-items:center;gap:6px;
  color:var(--muted);font-size:0.88rem;cursor:pointer;
  margin-top:14px;transition:color .2s;
  background:none;border:none;font-family:'Tajawal',sans-serif;
  font-weight:600;
}
.back-link:hover{color:var(--emerald);}

/* â”€â”€â”€ BUTTON â”€â”€â”€ */
.btn{
  width:100%;padding:13px;border:none;border-radius:12px;
  font-size:0.97rem;font-weight:700;font-family:'Tajawal',sans-serif;
  cursor:pointer;transition:all .25s;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.btn-gold{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:var(--emerald);
  box-shadow:0 4px 16px rgba(200,152,42,0.35);
}
.btn-gold:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(200,152,42,0.45);}
.btn-dark{
  background:linear-gradient(135deg,var(--emerald),var(--emerald2));
  color:white;
  box-shadow:0 4px 16px rgba(14,77,58,0.3);
}
.btn-dark:hover{transform:translateY(-2px);}
.btn-ghost{background:var(--cream2);color:var(--emerald);border:2px solid var(--border);}
.btn-ghost:hover{background:var(--border);}
.btn-red{background:linear-gradient(135deg,var(--red),var(--red2));color:white;}
.btn-sm{padding:9px 14px;font-size:0.85rem;width:auto;}
.btn-mb{margin-bottom:10px;}

/* â”€â”€â”€ PARTICIPANT PAGE â”€â”€â”€ */
.welcome-banner{
  background:linear-gradient(135deg,var(--emerald),var(--emerald2));
  border-radius:16px;padding:16px 18px;
  display:flex;align-items:center;gap:12px;margin-bottom:18px;
  box-shadow:var(--shadow);
}
.welcome-avatar{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;flex-shrink:0;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
.welcome-text .wt-name{color:white;font-weight:700;font-size:1rem;}
.welcome-text .wt-sub{color:rgba(255,255,255,0.65);font-size:0.78rem;}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{display:flex;gap:6px;margin-bottom:18px;background:var(--cream2);padding:5px;border-radius:14px;}
.tab{
  flex:1;padding:9px;text-align:center;border-radius:10px;
  font-weight:700;font-size:0.88rem;cursor:pointer;
  transition:all .25s;color:var(--muted);position:relative;
  border:none;background:none;font-family:'Tajawal',sans-serif;
}
.tab.active{background:white;color:var(--emerald);box-shadow:0 2px 8px rgba(0,0,0,0.08);}
.tab-badge{
  position:absolute;top:-4px;right:-4px;
  background:var(--red2);color:white;
  border-radius:50%;width:18px;height:18px;
  font-size:0.65rem;font-weight:900;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--cream2);
}

/* â”€â”€â”€ SECTION HEADER â”€â”€â”€ */
.sec-header{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:14px;
}
.sec-title{font-weight:700;font-size:1rem;color:var(--emerald);}

/* â”€â”€â”€ RECORD TYPE CARDS â”€â”€â”€ */
.type-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.type-card{
  background:var(--white);border:2px solid var(--border);
  border-radius:14px;padding:16px 12px;text-align:center;
  cursor:pointer;transition:all .25s;
}
.type-card.sel{
  border-color:var(--gold);
  background:linear-gradient(to bottom,#fdf8ee,white);
  box-shadow:0 2px 12px rgba(200,152,42,0.2);
}
.type-card .tc-icon{font-size:2rem;margin-bottom:6px;display:block;}
.type-card .tc-label{font-weight:700;font-size:0.9rem;color:var(--emerald);}

/* â”€â”€â”€ LIVE PREVIEW â”€â”€â”€ */
.live-box{
  border-radius:12px;overflow:hidden;border:2.5px solid var(--gold);
  background:#000;margin-bottom:12px;position:relative;display:none;
}
.live-box.show{display:block;}
.live-box.rec-active{border-color:var(--red2);animation:pulse-border 1s infinite;}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(231,76,60,0.4)}50%{box-shadow:0 0 0 6px rgba(231,76,60,0)}}
.live-box video{width:100%;display:block;}
.rec-dot{
  position:absolute;top:8px;right:8px;
  background:var(--red2);color:white;
  border-radius:20px;padding:3px 10px;font-size:0.75rem;font-weight:700;
  display:none;align-items:center;gap:5px;
}
.rec-dot.show{display:flex;}
.rec-dot::before{content:'';width:7px;height:7px;background:white;border-radius:50%;animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

/* â”€â”€â”€ TIMER â”€â”€â”€ */
.big-timer{
  text-align:center;font-size:2.2rem;font-weight:900;
  color:var(--emerald);letter-spacing:2px;
  font-variant-numeric:tabular-nums;
  display:none;margin:8px 0;
}
.big-timer.show{display:block;}

/* â”€â”€â”€ PREVIEW BOX â”€â”€â”€ */
.preview-box{
  background:linear-gradient(135deg,#fdf8ee,#fff);
  border:2px solid var(--gold);border-radius:14px;
  padding:16px;margin-bottom:14px;display:none;
}
.preview-box.show{display:block;}
.preview-box .pb-title{font-weight:700;color:var(--emerald);margin-bottom:10px;font-size:0.95rem;}
.preview-box audio,.preview-box video{width:100%;border-radius:8px;}
.preview-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}

/* â”€â”€â”€ RECORDINGS LIST â”€â”€â”€ */
.rec-card{
  background:white;border-radius:14px;
  border:2px solid var(--border);
  margin-bottom:12px;overflow:hidden;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
  transition:box-shadow .2s;
}
.rec-card:hover{box-shadow:var(--shadow);}
.rec-card-head{
  padding:12px 14px 8px;
  display:flex;align-items:center;justify-content:space-between;
}
.rec-num-badge{
  background:linear-gradient(135deg,var(--emerald),var(--emerald2));
  color:white;border-radius:8px;padding:3px 10px;
  font-size:0.78rem;font-weight:700;
}
.rec-type-badge{
  background:var(--cream2);color:var(--emerald);
  border-radius:8px;padding:3px 10px;font-size:0.78rem;font-weight:700;
  border:1px solid var(--border);
}
.rec-date{color:var(--muted);font-size:0.75rem;padding:0 14px 8px;}
.rec-media{padding:0 14px 12px;}
.rec-media audio,.rec-media video{width:100%;border-radius:8px;}
.rec-actions{display:flex;gap:0;border-top:1px solid var(--border);}
.rec-action-btn{
  flex:1;padding:10px;text-align:center;
  font-size:0.8rem;font-weight:700;cursor:pointer;
  color:var(--muted);transition:all .2s;
  background:none;border:none;font-family:'Tajawal',sans-serif;
}
.rec-action-btn:not(:last-child){border-left:1px solid var(--border);}
.rec-action-btn:hover{background:var(--cream);color:var(--emerald);}
.rec-action-btn.danger:hover{background:#fef2f2;color:var(--red);}

/* â”€â”€â”€ MESSAGES ATTACHED â”€â”€â”€ */
.msgs-section{
  background:linear-gradient(135deg,#fdf8ee,#fff);
  border-top:2px dashed var(--border);
  padding:12px 14px;
}
.msgs-section-title{
  font-size:0.8rem;font-weight:700;color:var(--gold);
  margin-bottom:8px;display:flex;align-items:center;gap:5px;
}
.msg-pill{
  background:white;border:1.5px solid var(--border);
  border-radius:10px;padding:10px 12px;margin-bottom:6px;
  border-right:3px solid var(--gold);
}
.msg-pill:last-child{margin-bottom:0;}
.mp-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;}
.mp-type{font-size:0.75rem;font-weight:700;color:var(--gold);}
.mp-date{font-size:0.7rem;color:var(--muted);}
.mp-body{font-size:0.88rem;color:var(--ink);line-height:1.5;}
.mp-audio audio{width:100%;margin-top:6px;border-radius:6px;}
.mp-rating{
  background:linear-gradient(135deg,#fef9ec,#fdf3d0);
  border:1.5px solid var(--gold);border-radius:8px;
  padding:8px;text-align:center;margin-top:6px;
}
.mp-stars{font-size:1.1rem;margin-bottom:2px;}
.mp-rat-num{font-weight:900;font-size:1rem;color:var(--emerald);}
.new-msg-indicator{
  background:var(--red2);color:white;
  border-radius:50%;width:10px;height:10px;
  display:inline-block;margin-right:4px;
  flex-shrink:0;
}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€ */
.empty{text-align:center;padding:32px 16px;color:var(--muted);}
.empty .ei{font-size:3rem;opacity:.4;margin-bottom:8px;}
.empty p{font-size:0.9rem;}

/* â”€â”€â”€ ADMIN PAGE â”€â”€â”€ */
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;}
.stat-box{
  background:linear-gradient(135deg,var(--emerald),var(--emerald2));
  border-radius:14px;padding:12px 8px;text-align:center;
  box-shadow:0 4px 14px rgba(14,77,58,0.25);
}
.stat-box .sn{font-size:1.6rem;font-weight:900;color:var(--gold3);}
.stat-box .sl{font-size:0.7rem;color:rgba(255,255,255,0.7);font-weight:600;}
.stat-box .si{font-size:1.1rem;margin-bottom:2px;}

.part-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;}
.part-card{
  background:white;border:2px solid var(--border);
  border-radius:14px;padding:14px 8px;text-align:center;
  cursor:pointer;transition:all .25s;position:relative;
  box-shadow:0 2px 8px rgba(0,0,0,0.04);
}
.part-card:hover{border-color:var(--gold);transform:translateY(-3px);box-shadow:var(--shadow);}
.part-icon{font-size:2rem;margin-bottom:6px;}
.part-name{color:var(--emerald);font-size:0.88rem;font-weight:700;word-break:break-word;margin-bottom:3px;}
.part-count{color:var(--muted);font-size:0.75rem;}
.new-bubble{
  position:absolute;top:-6px;right:-6px;
  background:var(--red2);color:white;border-radius:50%;
  width:22px;height:22px;display:flex;align-items:center;
  justify-content:center;font-size:0.7rem;font-weight:900;
  border:2px solid white;box-shadow:0 2px 6px rgba(231,76,60,0.4);
}

/* â”€â”€â”€ ADMIN RECORDING PAGE â”€â”€â”€ */
.total-badge{
  background:linear-gradient(135deg,#fef9ec,#fdf0c0);
  border:2px solid var(--gold);border-radius:12px;
  padding:10px 16px;
  display:inline-flex;align-items:center;gap:8px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(200,152,42,0.2);
}
.total-badge span{color:var(--emerald);font-weight:700;font-size:0.9rem;}
.total-badge .tv{font-size:1.1rem;font-weight:900;color:var(--emerald);}

.contact-card{
  background:linear-gradient(135deg,#e8f5f0,#d4edea);
  border:2px solid rgba(14,77,58,0.2);border-radius:14px;
  padding:14px;margin-bottom:14px;
}
.contact-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:0;}
.contact-head span{font-weight:700;color:var(--emerald);font-size:0.9rem;}
.contact-body{margin-top:12px;}
.info-row{
  background:white;border-radius:10px;padding:10px 12px;
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:8px;border:1px solid var(--border);
}
.info-row:last-child{margin-bottom:0;}
.ir-label{font-size:0.75rem;color:var(--muted);margin-bottom:2px;}
.ir-val{font-weight:700;color:var(--emerald);font-size:0.95rem;word-break:break-all;}
.copy-btn{
  background:var(--emerald);color:white;border:none;
  padding:7px 12px;border-radius:8px;cursor:pointer;
  font-size:0.78rem;font-weight:700;font-family:'Tajawal',sans-serif;
  transition:all .2s;flex-shrink:0;
}
.copy-btn:hover{background:var(--emerald2);}
.copy-btn.ok{background:#10b981;}

/* â”€â”€â”€ SEND MESSAGE MODAL â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;background:rgba(15,25,35,0.7);
  z-index:500;display:flex;align-items:flex-end;justify-content:center;
  padding:0;backdrop-filter:blur(4px);
}
.bottom-sheet{
  background:white;border-radius:22px 22px 0 0;
  width:100%;max-width:520px;padding:20px 18px 32px;
  max-height:85vh;overflow-y:auto;
  animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);
}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.sheet-handle{width:40px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 16px;}
.sheet-title{font-weight:700;font-size:1.1rem;color:var(--emerald);margin-bottom:14px;}
.msg-tabs{display:flex;gap:6px;margin-bottom:14px;}
.msg-tab{
  flex:1;padding:9px;border-radius:10px;text-align:center;
  font-size:0.82rem;font-weight:700;cursor:pointer;
  border:2px solid var(--border);background:white;color:var(--muted);
  font-family:'Tajawal',sans-serif;transition:all .2s;
}
.msg-tab.active{background:linear-gradient(135deg,var(--gold),var(--gold2));color:var(--emerald);border-color:transparent;}
.msg-textarea{
  width:100%;padding:12px;border:2px solid var(--border);border-radius:12px;
  font-family:'Tajawal',sans-serif;font-size:0.95rem;
  min-height:100px;resize:vertical;background:var(--cream);
}
.msg-textarea:focus{outline:none;border-color:var(--gold);}
.voice-rec-box{
  background:var(--cream);border:2px solid var(--gold);
  border-radius:12px;padding:14px;
}
.voice-rec-box audio{width:100%;margin-top:10px;border-radius:8px;}
.rating-box{background:var(--cream);border:2px solid var(--gold);border-radius:12px;padding:16px;text-align:center;}
.stars-row{display:flex;justify-content:center;gap:6px;margin:10px 0;font-size:2.2rem;}
.star{cursor:pointer;transition:transform .15s;user-select:none;}
.star:hover{transform:scale(1.2);}
.star.on{filter:drop-shadow(0 0 4px rgba(200,152,42,0.6));}
.rat-val{font-size:1.4rem;font-weight:900;color:var(--emerald);}
.rat-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-top:10px;}
.rat-btn{
  padding:7px;border:2px solid var(--border);border-radius:7px;
  background:white;cursor:pointer;font-size:0.8rem;font-weight:700;
  font-family:'Tajawal',sans-serif;transition:all .2s;
}
.rat-btn:hover,.rat-btn.active{background:linear-gradient(135deg,var(--gold),var(--gold2));border-color:transparent;color:var(--emerald);}
.sheet-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:14px;}

/* â”€â”€â”€ CONFIRM DIALOG â”€â”€â”€ */
.confirm-box{
  background:white;border-radius:20px;padding:24px 20px;
  max-width:360px;width:100%;text-align:center;
  animation:popIn .25s cubic-bezier(.34,1.56,.64,1);
  margin:auto;
}
@keyframes popIn{from{transform:scale(0.8);opacity:0}to{transform:scale(1);opacity:1}}
.confirm-icon{font-size:3rem;margin-bottom:10px;}
.confirm-title{font-size:1.1rem;font-weight:700;color:var(--ink);margin-bottom:6px;}
.confirm-desc{font-size:0.88rem;color:var(--muted);margin-bottom:18px;line-height:1.5;}
.confirm-btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;}

/* â”€â”€â”€ LOADING â”€â”€â”€ */
.loader-overlay{
  position:fixed;inset:0;background:rgba(15,25,35,0.65);
  z-index:9000;display:flex;align-items:center;justify-content:center;
  backdrop-filter:blur(3px);
}
.loader-box{
  background:white;border-radius:18px;padding:28px 32px;text-align:center;
  box-shadow:var(--shadow-lg);min-width:160px;
}
.loader-spinner{
  width:44px;height:44px;
  border:4px solid var(--cream2);
  border-top-color:var(--gold);
  border-radius:50%;animation:spin 0.8s linear infinite;
  margin:0 auto 12px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-txt{font-weight:700;color:var(--emerald);font-size:0.9rem;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPOTLIGHT TUTORIAL SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tut-overlay{
  position:fixed;inset:0;z-index:8000;
  pointer-events:none;
  display:none;
}
.tut-overlay.active{pointer-events:all;display:block;}

/* Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹ØªÙ…Ø© Ù…Ø¹ Ø«Ù‚Ø¨ */
.tut-mask{
  position:absolute;inset:0;
  transition:all .4s cubic-bezier(.4,0,.2,1);
}

/* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
.tut-card{
  position:absolute;
  background:var(--emerald);
  border-radius:18px;padding:18px 18px 14px;
  max-width:300px;min-width:240px;
  box-shadow:0 16px 48px rgba(15,25,35,0.4),0 0 0 1.5px rgba(200,152,42,0.5);
  color:white;
  transition:all .4s cubic-bezier(.4,0,.2,1);
  z-index:8001;
  opacity:0;
  animation:cardIn .4s .1s cubic-bezier(.34,1.56,.64,1) forwards;
}
@keyframes cardIn{
  from{opacity:0;transform:scale(0.85) translateY(10px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}
/* Ø§Ù„Ø³Ù‡Ù… */
.tut-card::before{
  content:'';position:absolute;
  width:14px;height:14px;
  background:var(--emerald);
  transform:rotate(45deg);
  box-shadow:-2px -2px 0 rgba(200,152,42,0.3);
}
.tut-card.arrow-bottom::before{bottom:-7px;right:28px;}
.tut-card.arrow-top::before{top:-7px;right:28px;box-shadow:2px 2px 0 rgba(200,152,42,0.3);}
.tut-card.arrow-top-left::before{top:-7px;left:28px;box-shadow:2px 2px 0 rgba(200,152,42,0.3);}
.tut-card.arrow-bottom-left::before{bottom:-7px;left:28px;}
.tut-card.no-arrow::before{display:none;}

.tut-step-num{
  font-size:0.7rem;font-weight:700;
  color:var(--gold3);margin-bottom:4px;letter-spacing:1px;
}
.tut-card-title{font-size:1rem;font-weight:700;margin-bottom:6px;color:white;}
.tut-card-desc{font-size:0.83rem;line-height:1.6;color:rgba(255,255,255,0.82);}
.tut-highlight-box{
  background:rgba(200,152,42,0.2);border:1px solid rgba(200,152,42,0.4);
  border-radius:8px;padding:8px 10px;margin-top:8px;
  font-size:0.8rem;color:var(--gold3);font-weight:600;line-height:1.4;
}
.tut-footer{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:14px;padding-top:10px;
  border-top:1px solid rgba(255,255,255,0.15);
}
.tut-dots{display:flex;gap:5px;align-items:center;}
.tut-dot{width:6px;height:6px;border-radius:3px;background:rgba(255,255,255,0.25);transition:all .3s;}
.tut-dot.on{width:18px;background:var(--gold2);}
.tut-btns{display:flex;gap:6px;}
.tut-skip{
  background:none;border:none;color:rgba(255,255,255,0.5);
  font-size:0.78rem;cursor:pointer;font-family:'Tajawal',sans-serif;
  padding:0;transition:color .2s;
}
.tut-skip:hover{color:rgba(255,255,255,0.8);}
.tut-next{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:var(--emerald);border:none;border-radius:8px;
  padding:7px 14px;font-size:0.82rem;font-weight:700;
  cursor:pointer;font-family:'Tajawal',sans-serif;
  transition:all .2s;
}
.tut-next:hover{transform:scale(1.05);}
.tut-prev{
  background:rgba(255,255,255,0.1);color:white;border:none;
  border-radius:8px;padding:7px 10px;font-size:0.82rem;font-weight:700;
  cursor:pointer;font-family:'Tajawal',sans-serif;transition:all .2s;
}
.tut-prev:hover{background:rgba(255,255,255,0.18);}

/* Ù†Ø¨Ø¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù…ÙØ´Ø§Ø± Ø¥Ù„ÙŠÙ‡ */
.tut-pulse{
  position:absolute;border-radius:inherit;
  box-shadow:0 0 0 0 rgba(200,152,42,0.7);
  animation:tutPulse 1.5s infinite;
  pointer-events:none;z-index:7999;
}
@keyframes tutPulse{
  0%{box-shadow:0 0 0 0 rgba(200,152,42,0.7)}
  70%{box-shadow:0 0 0 12px rgba(200,152,42,0)}
  100%{box-shadow:0 0 0 0 rgba(200,152,42,0)}
}

@media(max-width:480px){
  .tut-card{max-width:calc(100vw - 28px);}
  .stats-row .stat-box .sn{font-size:1.3rem;}
}
</style>
</head>
<body>
<div class="app-wrapper">

<!-- TOPBAR -->
<div class="topbar" id="topbar">
  <div class="topbar-brand">
    <div class="topbar-logo" id="topbarLogo">
      <img src="360_F_498618110_CmzpqAOH4xxhBFqXKEx5cOwYhvHpnmDH.jpg" alt="" onerror="this.style.display='none';this.parentElement.textContent='ğŸŒ™'"/>
    </div>
    <div>
      <div class="topbar-title">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø²Ø¡ Ø¹Ù…</div>
      <div class="topbar-sub">Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446</div>
    </div>
  </div>
  <div class="topbar-actions" id="topbarActions"></div>
</div>

<!-- MAIN -->
<div class="main">

<!-- â•â• Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© â•â• -->
<div class="page active" id="pg-home">
  <div class="hero">
    <span class="hero-moon">ğŸŒ™</span>
    <h1>Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ÙØ¸ Ø¬Ø²Ø¡ Ø¹Ù…</h1>
    <p>Ø³Ø¬Ù‘Ù„ Ø­ÙØ¸Ùƒ ÙˆØ£Ø±Ø³Ù„Ù‡ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø§Ø³ØªØ§Ø°Ø©</p>
    <div class="hero-badge">â­ Ø±Ù…Ø¶Ø§Ù† Ø§Ù„Ù…Ø¨Ø§Ø±Ùƒ 1446 â­</div>
  </div>
  <div class="home-cards">
    <div class="home-card" id="btn-register" onclick="goPage('pg-register')">
      <div class="hc-icon-wrap">ğŸ†•</div>
      <div class="hc-text">
        <div class="hc-title">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
        <div class="hc-desc">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
      </div>
      <div class="hc-arrow">â—€</div>
    </div>
    <div class="home-card" id="btn-login" onclick="goPage('pg-login')">
      <div class="hc-icon-wrap">ğŸ”‘</div>
      <div class="hc-text">
        <div class="hc-title">Ø¯Ø®ÙˆÙ„</div>
        <div class="hc-desc">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯</div>
      </div>
      <div class="hc-arrow">â—€</div>
    </div>
    <div class="home-card admin-card" id="btn-admin" onclick="goPage('pg-admin-login')">
      <div class="hc-icon-wrap">ğŸ‘©â€ğŸ«</div>
      <div class="hc-text">
        <div class="hc-title">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</div>
        <div class="hc-desc">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</div>
      </div>
      <div class="hc-arrow">â—€</div>
    </div>
  </div>
</div>

<!-- â•â• Ø§Ù„ØªØ³Ø¬ÙŠÙ„ â•â• -->
<div class="page" id="pg-register">
  <div class="form-card">
    <div class="form-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
    <!-- ØªÙˆØªÙˆØ±ÙŠØ§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
    <div id="regTutBanner" style="background:linear-gradient(135deg,#e8f5f0,#d4edea);border:2px solid var(--gold);border-radius:12px;padding:12px 14px;margin-bottom:16px;display:none;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="font-size:1.2rem;">ğŸ’¡</span>
        <span style="font-weight:700;color:var(--emerald);font-size:0.9rem;" id="regTutTitle">Ø®Ø·ÙˆØ© 1</span>
        <span style="margin-right:auto;font-size:0.75rem;color:var(--muted);" id="regTutCounter">1/3</span>
      </div>
      <p style="font-size:0.85rem;color:var(--emerald);line-height:1.5;" id="regTutDesc"></p>
      <div style="display:flex;gap:6px;margin-top:8px;">
        <button onclick="regTutPrev()" id="regTutPrevBtn" style="display:none;background:rgba(14,77,58,0.1);border:none;color:var(--emerald);padding:5px 10px;border-radius:7px;cursor:pointer;font-family:'Tajawal',sans-serif;font-weight:700;font-size:0.8rem;">â—€ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <button onclick="regTutNext()" id="regTutNextBtn" style="background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:var(--emerald);padding:5px 12px;border-radius:7px;cursor:pointer;font-family:'Tajawal',sans-serif;font-weight:700;font-size:0.8rem;margin-right:auto;">ÙÙ‡Ù…Øª â–¶</button>
      </div>
    </div>
    <form id="regForm">
      <div class="form-group" id="regNameGroup">
        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input class="form-input" type="text" id="regName" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" required/>
      </div>
      <div class="form-group" id="regPassGroup">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="input-wrap">
          <input class="form-input" type="password" id="regPass" placeholder="Ø§Ø®ØªØ§Ø±ÙŠ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø³Ù‡Ù„Ø©" style="padding-left:40px" required/>
          <span class="pass-toggle" onclick="togglePass('regPass',this)">ğŸ‘ï¸</span>
        </div>
        <p style="font-size:0.78rem;color:var(--muted);margin-top:5px;">ğŸ’¡ Ù…Ø«Ø§Ù„: Ø§Ø³Ù…Ùƒ + Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø§Ù„Ø£Ø®ÙŠØ±</p>
      </div>
      <button type="submit" class="btn btn-gold">ØªØ³Ø¬ÙŠÙ„ âœ¨</button>
    </form>
    <button class="back-link" onclick="goPage('pg-home')">â—€ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  </div>
</div>

<!-- â•â• Ø§Ù„Ø¯Ø®ÙˆÙ„ â•â• -->
<div class="page" id="pg-login">
  <div class="form-card">
    <div class="form-title">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</div>
    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© -->
    <div id="savedCredsBanner" style="display:none;background:linear-gradient(135deg,#e8f5f0,#d4edea);border:2px solid var(--emerald);border-radius:12px;padding:12px 14px;margin-bottom:14px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <span>âœ…</span>
        <span style="font-weight:700;color:var(--emerald);font-size:0.9rem;">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø©!</span>
      </div>
      <p style="font-size:0.82rem;color:var(--emerald);margin-bottom:10px;" id="savedCredsName">Ù…Ø±Ø­Ø¨Ø§Ù‹ ...</p>
      <button onclick="autoLogin()" class="btn btn-dark" style="margin-bottom:6px;">ğŸš€ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
      <button onclick="clearSavedCreds()" style="background:none;border:none;color:var(--muted);font-size:0.78rem;cursor:pointer;font-family:'Tajawal',sans-serif;width:100%;text-align:center;padding:4px;">
        ğŸ”„ Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±
      </button>
    </div>
    <div class="error-box" id="loginErr"></div>
    <form id="loginForm">
      <div class="form-group">
        <label class="form-label">Ø§Ù„Ø§Ø³Ù…</label>
        <input class="form-input" type="text" id="loginName" placeholder="Ø§Ø³Ù…Ùƒ" required/>
      </div>
      <div class="form-group">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="input-wrap">
          <input class="form-input" type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="padding-left:40px" required/>
          <span class="pass-toggle" onclick="togglePass('loginPass',this)">ğŸ‘ï¸</span>
        </div>
      </div>
      <!-- Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ -->
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:14px;background:var(--cream2);padding:10px;border-radius:10px;">
        <input type="checkbox" id="rememberMe" style="width:18px;height:18px;cursor:pointer;accent-color:var(--emerald);" checked/>
        <label for="rememberMe" style="cursor:pointer;font-size:0.88rem;font-weight:600;color:var(--emerald);">
          ğŸ’¾ Ø§Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ (Ù„Ø§ ØªØ·Ù„Ø¨Ù‡Ø§ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©)
        </label>
      </div>
      <button type="submit" class="btn btn-gold">Ø¯Ø®ÙˆÙ„ ğŸ”“</button>
    </form>
    <button class="back-link" onclick="goPage('pg-home')">â—€ Ø±Ø¬ÙˆØ¹</button>
  </div>
</div>

<!-- â•â• Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© â•â• -->
<div class="page" id="pg-admin-login">
  <div class="form-card">
    <div class="form-title">ğŸ‘©â€ğŸ« Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</div>
    <div class="error-box" id="adminErr"></div>
    <form id="adminForm">
      <div class="form-group">
        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <div class="input-wrap">
          <input class="form-input" type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" style="padding-left:40px" required/>
          <span class="pass-toggle" onclick="togglePass('adminPass',this)">ğŸ‘ï¸</span>
        </div>
      </div>
      <button type="submit" class="btn btn-gold">Ø¯Ø®ÙˆÙ„</button>
    </form>
    <button class="back-link" onclick="goPage('pg-home')">â—€ Ø±Ø¬ÙˆØ¹</button>
  </div>
</div>

<!-- â•â• ØµÙØ­Ø© Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ â•â• -->
<div class="page" id="pg-participant">
  <div class="welcome-banner" id="welcomeBanner">
    <div class="welcome-avatar">ğŸŒ¸</div>
    <div class="welcome-text">
      <div class="wt-name" id="welcomeName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</div>
      <div class="wt-sub">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸŒ™</div>
    </div>
  </div>
  <div class="tabs" id="participantTabs">
    <button class="tab active" id="tab-rec" onclick="switchTab('rec')">ğŸ¤ ØªØ³Ø¬ÙŠÙ„</button>
    <button class="tab" id="tab-msgs" onclick="switchTab('msgs')" style="position:relative;">
      ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ÙŠ
      <span id="unreadBadge" class="tab-badge" style="display:none;"></span>
    </button>
  </div>
  <!-- ØªØ³Ø¬ÙŠÙ„ -->
  <div id="sec-rec">
    <div class="sec-header" id="recTypeSection">
      <div class="sec-title">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
    </div>
    <div class="type-grid" id="typeGrid">
      <div class="type-card sel" id="tc-audio" onclick="selType('audio')">
        <span class="tc-icon">ğŸ¤</span>
        <span class="tc-label">ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ</span>
      </div>
      <div class="type-card" id="tc-video" onclick="selType('video')">
        <span class="tc-icon">ğŸ¥</span>
        <span class="tc-label">ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ</span>
      </div>
    </div>
    <div class="live-box" id="liveBox">
      <video id="liveVid" autoplay muted playsinline></video>
      <div class="rec-dot" id="recDot">ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
    </div>
    <div class="big-timer" id="bigTimer">00:00</div>
    <button class="btn btn-gold btn-mb" id="startRecBtn" onclick="startRec()">ğŸ”´ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <button class="btn btn-red btn-mb" id="stopRecBtn" style="display:none;" onclick="stopRec()">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
    <div class="preview-box" id="previewBox">
      <div class="pb-title">ğŸ§ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</div>
      <div id="previewMedia"></div>
      <div class="preview-btns">
        <button class="btn btn-gold" onclick="saveRec()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
        <button class="btn btn-ghost" onclick="cancelRec()">ğŸ”„ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹</button>
      </div>
    </div>
    <div style="margin-top:20px;">
      <div class="sec-header"><div class="sec-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„Ø§ØªÙŠ</div></div>
      <div id="myRecsList"></div>
    </div>
  </div>
  <!-- Ø±Ø³Ø§Ø¦Ù„ -->
  <div id="sec-msgs" style="display:none;">
    <div class="sec-header"><div class="sec-title">ğŸ“¬ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</div></div>
    <div id="msgsList"></div>
  </div>
</div>

<!-- â•â• ØµÙØ­Ø© Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© - Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† â•â• -->
<div class="page" id="pg-admin">
  <div class="stats-row" id="statsRow">
    <div class="stat-box"><div class="si">ğŸ‘¥</div><div class="sn" id="stTotal">0</div><div class="sl">Ù…Ø´Ø§Ø±Ùƒ</div></div>
    <div class="stat-box"><div class="si">ğŸ™ï¸</div><div class="sn" id="stRecs">0</div><div class="sl">ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ÙŠ</div></div>
    <div class="stat-box"><div class="si">ğŸ†•</div><div class="sn" id="stNew">0</div><div class="sl">Ø¬Ø¯ÙŠØ¯</div></div>
  </div>
  <div class="part-grid" id="partGrid"></div>
</div>

<!-- â•â• ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù…Ø´Ø§Ø±Ùƒ Ù…Ø­Ø¯Ø¯ â•â• -->
<div class="page" id="pg-admin-recs">
  <div style="text-align:center;margin-bottom:14px;">
    <div class="total-badge" id="totalBadge" style="display:none;">
      <span>â­</span><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ:</span>
      <span class="tv" id="totalVal">0</span><span>/</span><span class="tv" id="totalMax">0</span>
    </div>
  </div>
  <div class="contact-card">
    <div class="contact-head">
      <span>ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</span>
      <button class="btn btn-sm btn-dark" onclick="toggleContact()" id="contactToggleBtn">Ø¹Ø±Ø¶</button>
    </div>
    <div class="contact-body" id="contactBody" style="display:none;">
      <div class="info-row">
        <div><div class="ir-label">Ø§Ù„Ø§Ø³Ù…</div><div class="ir-val" id="cName">-</div></div>
        <button class="copy-btn" onclick="copyInfo('name',this)">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
      <div class="info-row">
        <div><div class="ir-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</div><div class="ir-val" id="cPass">-</div></div>
        <button class="copy-btn" onclick="copyInfo('pass',this)">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
    </div>
  </div>
  <div id="adminRecsList"></div>
</div>

</div><!-- /main -->
</div><!-- /app-wrapper -->

<!-- â•â• SPOTLIGHT TUTORIAL â•â• -->
<div class="tut-overlay" id="tutOverlay">
  <svg id="tutMaskSvg" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;"></svg>
  <div class="tut-card" id="tutCard">
    <div class="tut-step-num" id="tutStepNum">Ø®Ø·ÙˆØ© 1 Ù…Ù† 4</div>
    <div class="tut-card-title" id="tutCardTitle"></div>
    <div class="tut-card-desc" id="tutCardDesc"></div>
    <div class="tut-highlight-box" id="tutHighlight" style="display:none;"></div>
    <div class="tut-footer">
      <div class="tut-dots" id="tutDots"></div>
      <div class="tut-btns">
        <button class="tut-prev" id="tutPrevBtn" onclick="tutPrev()">â—€</button>
        <button class="tut-skip" onclick="tutSkip()">ØªØ®Ø·ÙŠ</button>
        <button class="tut-next" id="tutNextBtn" onclick="tutNext()">Ø§Ù„ØªØ§Ù„ÙŠ â–¶</button>
      </div>
    </div>
  </div>
  <div class="tut-pulse" id="tutPulse"></div>
</div>

<!-- Firebase -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import{getDatabase,ref,set,get,push,update}from'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';
const cfg={apiKey:"AIzaSyAfhQL5spF3KcrbngSzunLaHT_7cieHkUk",authDomain:"opject-e223d.firebaseapp.com",databaseURL:"https://opject-e223d-default-rtdb.firebaseio.com/",projectId:"opject-e223d",storageBucket:"opject-e223d.firebasestorage.app",messagingSenderId:"607939195786",appId:"1:607939195786:web:c264710387d50fc2990e73"};
const app=initializeApp(cfg);const db=getDatabase(app);
window.db=db;window.dbRef=ref;window.dbSet=set;window.dbGet=get;window.dbPush=push;window.dbUpdate=update;window.fbReady=true;
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â•â•
let user=null,isAdmin=false,curPart=null;
let mr=null,mrChunks=[],mrType='audio',mrTimer=null,mrStart=null,previewStream=null;
let avr=null,avrChunks=[],avrTimer=null;
let curRecForMsg=null,selRating=0;
let viewedSet=new Set();

// â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•
window.onload=function(){
  const chk=setInterval(()=>{
    if(window.fbReady&&window.db){clearInterval(chk);loadViewed();loadSession();}
  },100);
  setTimeout(()=>{clearInterval(chk);if(!window.db){alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");goPage('pg-home');}},6000);
};

// â•â•â•â•â•â•â•â•â•â•â•â• SESSION â•â•â•â•â•â•â•â•â•â•â•â•
function loadSession(){
  const s=localStorage.getItem('sess');
  if(s){
    const d=JSON.parse(s);
    if(d.isAdmin){isAdmin=true;goAdminPage();}
    else{
      showLoader();
      window.dbGet(window.dbRef(window.db,'participants/'+d.uid)).then(snap=>{
        hideLoader();
        if(snap.exists()){user={id:d.uid,...snap.val()};goParticipantPage();}
        else{localStorage.removeItem('sess');tryAutoLoginFromCreds();}
      }).catch(()=>{hideLoader();localStorage.removeItem('sess');tryAutoLoginFromCreds();});
    }
  }else{
    tryAutoLoginFromCreds();
  }
}

async function tryAutoLoginFromCreds(){
  const creds=loadSavedCreds();
  if(!creds){goPage('pg-home');return;}
  // Ø­Ø§ÙˆÙ„ Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
  showLoader();
  try{
    const snap=await window.dbGet(window.dbRef(window.db,'participants'));
    hideLoader();
    if(snap.exists()){
      let found=null,fid=null;
      Object.entries(snap.val()).forEach(([id,p])=>{if(p.name===creds.name&&p.password===creds.pass){found=p;fid=id;}});
      if(found){user={id:fid,...found};saveSession();goParticipantPage();return;}
    }
  }catch(e){hideLoader();}
  goPage('pg-home');
}
function saveSession(){
  localStorage.setItem('sess',JSON.stringify(isAdmin?{isAdmin:true}:{isAdmin:false,uid:user.id}));
}

// â•â•â•â•â•â•â•â•â•â•â•â• NAVIGATION â•â•â•â•â•â•â•â•â•â•â•â•
function goPage(id){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  updateTopbar();
  window.scrollTo(0,0);
  // Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø®Ø§ØµØ© Ø¨ÙƒÙ„ ØµÙØ­Ø©
  if(id==='pg-login') checkSavedCreds();
  if(id==='pg-register'){
    regTutIdx=0;
    if(!localStorage.getItem('reg_tut_shown')){
      localStorage.setItem('reg_tut_shown','1');
      setTimeout(()=>showRegTut(),300);
    }
  }
  if(id==='pg-login'){
    checkSavedCreds();
  }
}

function updateTopbar(){
  const act=document.getElementById('topbarActions');
  act.innerHTML='';
  if(user||isAdmin){
    const btn=document.createElement('button');
    btn.className='topbar-btn';btn.textContent='Ø®Ø±ÙˆØ¬';
    btn.onclick=logout;act.appendChild(btn);
    if(isAdmin){
      const hBtn=document.createElement('button');
      hBtn.className='topbar-btn gold-btn';hBtn.textContent='â“ Ù…Ø³Ø§Ø¹Ø¯Ø©';
      hBtn.onclick=()=>startTutorial('admin');act.appendChild(hBtn);
    }
  }
  // Back button for admin recordings page
  const curActive=document.querySelector('.page.active');
  if(curActive&&curActive.id==='pg-admin-recs'){
    const bBtn=document.createElement('button');
    bBtn.className='topbar-btn';bBtn.textContent='â—€ Ø±Ø¬ÙˆØ¹';
    bBtn.onclick=backToAdmin;act.appendChild(bBtn);
  }
}

function goParticipantPage(){
  goPage('pg-participant');
  document.getElementById('welcomeName').textContent=user.name;
  switchTab('rec');
  loadMyRecs();
  loadUnreadBadge();
  if(!localStorage.getItem('tut_p_'+user.id)){
    localStorage.setItem('tut_p_'+user.id,'1');
    setTimeout(()=>startTutorial('participant'),600);
  }
}

async function goAdminPage(){
  goPage('pg-admin');
  await loadParticipants();
  if(!localStorage.getItem('tut_admin')){
    localStorage.setItem('tut_admin','1');
    setTimeout(()=>startTutorial('admin'),600);
  }
}

async function goAdminRecsPage(p){
  curPart=p;
  goPage('pg-admin-recs');
  document.querySelector('.page.active .sec-title');
  // update topbar title dynamically
  document.getElementById('cName').textContent=p.name;
  document.getElementById('cPass').textContent=p.password;
  document.getElementById('contactBody').style.display='none';
  document.getElementById('contactToggleBtn').textContent='Ø¹Ø±Ø¶';
  await calcTotal();
  await loadAdminRecs();
}

function backToAdmin(){curPart=null;goAdminPage();}
function logout(){
  stopPreview();localStorage.removeItem('sess');
  user=null;isAdmin=false;curPart=null;goPage('pg-home');
}

// â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(t){
  document.getElementById('tab-rec').classList.toggle('active',t==='rec');
  document.getElementById('tab-msgs').classList.toggle('active',t==='msgs');
  document.getElementById('sec-rec').style.display=t==='rec'?'block':'none';
  document.getElementById('sec-msgs').style.display=t==='msgs'?'block':'none';
  if(t==='rec'&&mrType==='video'&&!previewStream)startPreview();
  if(t==='msgs'){stopPreview();loadParticipantMsgs();markRead();}
}

// â•â•â•â•â•â•â•â•â•â•â•â• FORMS â•â•â•â•â•â•â•â•â•â•â•â•
function togglePass(id,el){
  const i=document.getElementById(id);
  i.type=i.type==='password'?'text':'password';
  el.textContent=i.type==='password'?'ğŸ‘ï¸':'ğŸ™ˆ';
}
function showErr(id,msg){
  const el=document.getElementById(id);
  el.textContent=msg;el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),3000);
}

document.getElementById('regForm').onsubmit=async function(e){
  e.preventDefault();
  const name=document.getElementById('regName').value.trim();
  const pass=document.getElementById('regPass').value;
  if(!name||!pass)return;
  showLoader();
  try{
    const snap=await window.dbGet(window.dbRef(window.db,'participants'));
    if(snap.exists()&&Object.values(snap.val()).some(p=>p.name===name)){
      hideLoader();alert('Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!');return;
    }
    const id=Date.now().toString();
    const p={name,password:pass,registeredAt:new Date().toISOString(),recordings:[]};
    await window.dbSet(window.dbRef(window.db,'participants/'+id),p);
    user={id,...p};
    saveCreds(name,pass); // Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    saveSession();hideLoader();goParticipantPage();
  }catch(err){hideLoader();alert("Ø®Ø·Ø£: "+err.message);}
};

document.getElementById('loginForm').onsubmit=async function(e){
  e.preventDefault();
  const name=document.getElementById('loginName').value;
  const pass=document.getElementById('loginPass').value;
  const remember=document.getElementById('rememberMe').checked;
  showLoader();
  const snap=await window.dbGet(window.dbRef(window.db,'participants'));
  hideLoader();
  if(snap.exists()){
    let found=null,fid=null;
    Object.entries(snap.val()).forEach(([id,p])=>{if(p.name===name&&p.password===pass){found=p;fid=id;}});
    if(found){
      user={id:fid,...found};
      // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø°Ù„Ùƒ
      if(remember) saveCreds(name,pass);
      saveSession();goParticipantPage();return;
    }
  }
  showErr('loginErr','Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
};

document.getElementById('adminForm').onsubmit=function(e){
  e.preventDefault();
  if(document.getElementById('adminPass').value==='Qur@n2025#Admin$Ramadan'){
    isAdmin=true;saveSession();goAdminPage();
  }else showErr('adminErr','ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!');
};

// â•â•â•â•â•â•â•â•â•â•â•â• RECORDING â•â•â•â•â•â•â•â•â•â•â•â•
function selType(t){
  mrType=t;
  document.getElementById('tc-audio').classList.toggle('sel',t==='audio');
  document.getElementById('tc-video').classList.toggle('sel',t==='video');
  if(t==='video')startPreview();else stopPreview();
}

async function startPreview(){
  try{
    if(previewStream)return;
    const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
    previewStream=s;
    document.getElementById('liveVid').srcObject=s;
    document.getElementById('liveBox').classList.add('show');
  }catch(e){alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: "+e.message);}
}
function stopPreview(){
  if(previewStream){previewStream.getTracks().forEach(t=>t.stop());previewStream=null;}
  const v=document.getElementById('liveVid');
  if(v.srcObject)v.srcObject=null;
  document.getElementById('liveBox').classList.remove('show','rec-active');
  document.getElementById('recDot').classList.remove('show');
}

async function startRec(){
  try{
    let stream;
    if(mrType==='video'){
      if(previewStream){
        const a=await navigator.mediaDevices.getUserMedia({audio:true});
        stream=new MediaStream([...previewStream.getVideoTracks(),...a.getAudioTracks()]);
      }else{
        stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
        previewStream=stream;document.getElementById('liveVid').srcObject=stream;
        document.getElementById('liveBox').classList.add('show');
      }
    }else stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mrChunks=[];mr=new MediaRecorder(stream);
    mr.ondataavailable=e=>{if(e.data.size>0)mrChunks.push(e.data);};
    mr.onstop=()=>{if(mrType==='audio')stream.getTracks().forEach(t=>t.stop());showPreviewBox();};
    mr.start();
    document.getElementById('startRecBtn').style.display='none';
    document.getElementById('stopRecBtn').style.display='flex';
    document.getElementById('bigTimer').classList.add('show');
    if(mrType==='video'){document.getElementById('liveBox').classList.add('rec-active');document.getElementById('recDot').classList.add('show');}
    mrStart=Date.now();
    mrTimer=setInterval(()=>{
      const e=Math.floor((Date.now()-mrStart)/1000);
      document.getElementById('bigTimer').textContent=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
    },1000);
  }catch(e){alert("Ø®Ø·Ø£: "+e.message);}
}

function stopRec(){
  if(mr&&mr.state!=='inactive'){mr.stop();clearInterval(mrTimer);}
  document.getElementById('liveBox').classList.remove('rec-active');
  document.getElementById('recDot').classList.remove('show');
  document.getElementById('stopRecBtn').style.display='none';
  document.getElementById('bigTimer').classList.remove('show');
}

function cancelRec(){
  mrChunks=[];
  document.getElementById('previewBox').classList.remove('show');
  document.getElementById('startRecBtn').style.display='flex';
  document.getElementById('bigTimer').textContent='00:00';
}

function showPreviewBox(){
  const blob=new Blob(mrChunks,{type:mrType==='video'?'video/webm':'audio/webm'});
  const url=URL.createObjectURL(blob);
  document.getElementById('previewMedia').innerHTML=mrType==='video'
    ?`<video controls src="${url}" style="width:100%;border-radius:8px;"></video>`
    :`<audio controls src="${url}" style="width:100%;"></audio>`;
  document.getElementById('previewBox').classList.add('show');
  document.getElementById('startRecBtn').style.display='flex';
}

async function saveRec(){
  showLoader();
  try{
    const blob=new Blob(mrChunks,{type:mrType==='video'?'video/webm':'audio/webm'});
    const b64=await b64(blob);
    const id=Date.now().toString();
    const rec={id,type:mrType,data:b64,timestamp:new Date().toISOString()};
    const recs=[...(user.recordings||[]),rec];
    await window.dbUpdate(window.dbRef(window.db),{[`participants/${user.id}/recordings`]:recs});
    user.recordings=recs;hideLoader();
    document.getElementById('previewBox').classList.remove('show');
    mrChunks=[];document.getElementById('bigTimer').textContent='00:00';
    loadMyRecs();
    showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­! âœ…');
  }catch(e){hideLoader();alert("Ø®Ø·Ø£: "+e.message);}
}

// â•â•â•â•â•â•â•â•â•â•â•â• MY RECS (with attached messages) â•â•â•â•â•â•â•â•â•â•â•â•
async function loadMyRecs(){
  const div=document.getElementById('myRecsList');
  if(!user.recordings||!user.recordings.length){
    div.innerHTML='<div class="empty"><div class="ei">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯<br>Ø§Ø¨Ø¯Ø£ Ø£ÙˆÙ„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†!</p></div>';
    return;
  }
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  const msgs={};
  if(snap.exists()){snap.forEach(c=>{const m=c.val();if(m.participantId===user.id){if(!msgs[m.recordingId])msgs[m.recordingId]=[];msgs[m.recordingId].push({id:c.key,...m});}});}
  let html='';
  user.recordings.forEach((r,i)=>{
    const rm=msgs[r.id]||[];
    const hasNew=rm.some(m=>!m.read);
    html+=`
    <div class="rec-card" id="rcard_${r.id}">
      <div class="rec-card-head">
        <span class="rec-num-badge">${hasNew?'ğŸ”” ':''}ØªØ³Ø¬ÙŠÙ„ ${i+1}</span>
        <span class="rec-type-badge">${r.type==='video'?'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ':'ğŸ¤ ØµÙˆØª'}</span>
      </div>
      <div class="rec-date">ğŸ“… ${new Date(r.timestamp).toLocaleDateString('ar-SA')}</div>
      <div class="rec-media">
        ${r.type==='video'?`<video controls src="${r.data}"></video>`:`<audio controls src="${r.data}"></audio>`}
      </div>
      ${rm.length?buildMsgPills(rm):''}
      <div class="rec-actions">
        <button class="rec-action-btn danger" onclick="confirmDel('${r.id}',false)">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    </div>`;
  });
  div.innerHTML=html;
}

function buildMsgPills(msgs){
  msgs.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  let html=`<div class="msgs-section"><div class="msgs-section-title">ğŸ’¬ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</div>`;
  msgs.forEach(m=>{
    html+=`<div class="msg-pill">
      <div class="mp-meta">
        <span class="mp-type">${m.messageType==='voice'?'ğŸ¤ ØµÙˆØªÙŠØ©':m.messageType==='rating'?'â­ ØªÙ‚ÙŠÙŠÙ…':'âœ‰ï¸ Ø±Ø³Ø§Ù„Ø©'}</span>
        <span class="mp-date">${new Date(m.timestamp).toLocaleDateString('ar-SA')}</span>
      </div>
      <div class="mp-body">${m.message}</div>
      ${m.messageType==='voice'&&m.voiceData?`<div class="mp-audio"><audio controls src="${m.voiceData}"></audio></div>`:''}
      ${m.messageType==='rating'&&m.rating?`<div class="mp-rating"><div class="mp-stars">${stars(m.rating)}</div><div class="mp-rat-num">${m.rating} / 5 â­</div></div>`:''}
    </div>`;
  });
  return html+'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â• MESSAGES PAGE â•â•â•â•â•â•â•â•â•â•â•â•
async function loadParticipantMsgs(){
  const div=document.getElementById('msgsList');
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  if(!snap.exists()){div.innerHTML='<div class="empty"><div class="ei">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';return;}
  const msgs=[];
  snap.forEach(c=>{const m=c.val();if(m.participantId===user.id)msgs.push({id:c.key,...m});});
  if(!msgs.length){div.innerHTML='<div class="empty"><div class="ei">ğŸ“­</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</p></div>';return;}
  msgs.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
  div.innerHTML=msgs.map(m=>`
    <div class="msg-pill" style="margin-bottom:10px;${!m.read?'border-right-color:'+'"var(--red2)"':''}">
      <div class="mp-meta">
        <span class="mp-type">${m.messageType==='voice'?'ğŸ¤':m.messageType==='rating'?'â­':'âœ‰ï¸'} Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©</span>
        <span class="mp-date">${new Date(m.timestamp).toLocaleDateString('ar-SA')}</span>
      </div>
      <div class="mp-body">${m.message}</div>
      ${m.messageType==='voice'&&m.voiceData?`<div class="mp-audio"><audio controls src="${m.voiceData}"></audio></div>`:''}
      ${m.messageType==='rating'&&m.rating?`<div class="mp-rating"><div class="mp-stars">${stars(m.rating)}</div><div class="mp-rat-num">${m.rating} / 5</div></div>`:''}
    </div>`).join('');
}

async function loadUnreadBadge(){
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  let c=0;
  if(snap.exists())snap.forEach(ch=>{const m=ch.val();if(m.participantId===user.id&&!m.read)c++;});
  const b=document.getElementById('unreadBadge');
  if(c>0){b.textContent=c;b.style.display='flex';}else b.style.display='none';
}

async function markRead(){
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  if(!snap.exists())return;
  const upd={};
  snap.forEach(c=>{const m=c.val();if(m.participantId===user.id&&!m.read)upd[`messages/${c.key}/read`]=true;});
  if(Object.keys(upd).length)await window.dbUpdate(window.dbRef(window.db),upd);
  loadUnreadBadge();loadMyRecs();
}

// â•â•â•â•â•â•â•â•â•â•â•â• ADMIN PARTICIPANTS â•â•â•â•â•â•â•â•â•â•â•â•
async function loadParticipants(){
  showLoader();
  const snap=await window.dbGet(window.dbRef(window.db,'participants'));
  hideLoader();
  const grid=document.getElementById('partGrid');
  if(!snap.exists()){grid.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="ei">ğŸ‘¥</div><p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙˆÙ†</p></div>';setStats(0,0,0);return;}
  let parts=[],totR=0,newR=0;
  snap.forEach(c=>parts.push({id:c.key,...c.val()}));
  parts.forEach(p=>{const r=p.recordings||[];totR+=r.length;r.forEach(rc=>{if(!isViewed(p.id,rc.id))newR++;});});
  setStats(parts.length,totR,newR);
  grid.innerHTML=parts.map(p=>{
    const nc=(p.recordings||[]).filter(r=>!isViewed(p.id,r.id)).length;
    return `<div class="part-card" onclick='goAdminRecsPage(${JSON.stringify(p)})'>
      ${nc?`<div class="new-bubble">${nc}</div>`:''}
      <div class="part-icon">ğŸ‘¤</div>
      <div class="part-name">${p.name}</div>
      <div class="part-count">${(p.recordings||[]).length} ØªØ³Ø¬ÙŠÙ„</div>
    </div>`;
  }).join('');
}

function setStats(p,r,n){
  document.getElementById('stTotal').textContent=p;
  document.getElementById('stRecs').textContent=r;
  document.getElementById('stNew').textContent=n;
}

// â•â•â•â•â•â•â•â•â•â•â•â• ADMIN RECORDINGS â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminRecs(){
  const div=document.getElementById('adminRecsList');
  if(!curPart.recordings||!curPart.recordings.length){div.innerHTML='<div class="empty"><div class="ei">ğŸ™ï¸</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª</p></div>';return;}
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  const msgs={};
  if(snap.exists()){snap.forEach(c=>{const m=c.val();if(m.participantId===curPart.id){if(!msgs[m.recordingId])msgs[m.recordingId]=[];msgs[m.recordingId].push({id:c.key,...m});}});}
  curPart.recordings.forEach(r=>markViewed(curPart.id,r.id));
  div.innerHTML=curPart.recordings.map((r,i)=>{
    const rm=msgs[r.id]||[];
    return `<div class="rec-card">
      <div class="rec-card-head">
        <span class="rec-num-badge">ØªØ³Ø¬ÙŠÙ„ ${i+1}</span>
        <span class="rec-type-badge">${r.type==='video'?'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ':'ğŸ¤ ØµÙˆØª'}</span>
      </div>
      <div class="rec-date">ğŸ“… ${new Date(r.timestamp).toLocaleDateString('ar-SA')}</div>
      <div class="rec-media">
        ${r.type==='video'?`<video controls src="${r.data}"></video>`:`<audio controls src="${r.data}"></audio>`}
      </div>
      ${rm.length?buildAdminPills(rm):''}
      <div class="rec-actions">
        <button class="rec-action-btn" onclick="openMsgSheet('${r.id}','text')">âœï¸ Ù†ØµÙŠØ©</button>
        <button class="rec-action-btn" onclick="openMsgSheet('${r.id}','voice')">ğŸ¤ ØµÙˆØªÙŠØ©</button>
        <button class="rec-action-btn" onclick="openMsgSheet('${r.id}','rating')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
        <button class="rec-action-btn danger" onclick="confirmDel('${r.id}',true)">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function buildAdminPills(msgs){
  msgs.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  let html=`<div class="msgs-section"><div class="msgs-section-title">ğŸ’¬ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø±Ø³Ù„Ø©</div>`;
  msgs.forEach(m=>{
    html+=`<div class="msg-pill">
      <div class="mp-meta">
        <span class="mp-type">${m.messageType==='voice'?'ğŸ¤':m.messageType==='rating'?'â­':'âœ‰ï¸'}</span>
        <span class="mp-date">${new Date(m.timestamp).toLocaleDateString('ar-SA')}</span>
      </div>
      <div class="mp-body">${m.message}</div>
      ${m.messageType==='voice'&&m.voiceData?`<div class="mp-audio"><audio controls src="${m.voiceData}"></audio></div>`:''}
      ${m.messageType==='rating'&&m.rating?`<div class="mp-rating"><div class="mp-stars">${stars(m.rating)}</div><div class="mp-rat-num">${m.rating}/5</div></div>`:''}
    </div>`;
  });
  return html+'</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â• SEND MESSAGE SHEET â•â•â•â•â•â•â•â•â•â•â•â•
function openMsgSheet(recId,type){
  curRecForMsg=recId;selRating=0;
  const sheet=document.createElement('div');
  sheet.className='overlay';sheet.id='msgSheet';
  sheet.innerHTML=`<div class="bottom-sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©</div>
    <div class="msg-tabs">
      <button class="msg-tab ${type==='text'?'active':''}" onclick="switchMsgTab('text',this)">âœï¸ Ù†ØµÙŠØ©</button>
      <button class="msg-tab ${type==='voice'?'active':''}" onclick="switchMsgTab('voice',this)">ğŸ¤ ØµÙˆØªÙŠØ©</button>
      <button class="msg-tab ${type==='rating'?'active':''}" onclick="switchMsgTab('rating',this)">â­ ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
    <div id="sd-text" class="${type!=='text'?'hidden':''}">
      <textarea class="msg-textarea" id="msgTxt" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
    </div>
    <div id="sd-voice" class="voice-rec-box ${type!=='voice'?'hidden':''}">
      <button class="btn btn-gold btn-mb" id="vr-start" onclick="startAVR()">ğŸ¤ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      <div class="big-timer" id="vr-timer" style="font-size:1.5rem;">00:00</div>
      <button class="btn btn-red btn-mb hidden" id="vr-stop" onclick="stopAVR()">â¹ Ø¥ÙŠÙ‚Ø§Ù</button>
      <div id="vr-prev" class="hidden"><audio id="vr-audio" controls style="width:100%;"></audio></div>
    </div>
    <div id="sd-rating" class="rating-box ${type!=='rating'?'hidden':''}">
      <p style="font-weight:700;color:var(--emerald);margin-bottom:4px;">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p>
      <div class="stars-row" id="starsRow">${[1,2,3,4,5].map(i=>`<span class="star" onclick="setRat(${i})" data-v="${i}">â­</span>`).join('')}</div>
      <div class="rat-val" id="ratVal">0 / 5</div>
      <div class="rat-grid">${[0.5,1,1.5,2,2.5,3,3.5,4,4.5,5].map(v=>`<button class="rat-btn" onclick="setRat(${v})">${v}</button>`).join('')}</div>
    </div>
    <div class="sheet-btns">
      <button class="btn btn-gold" onclick="sendMsg()">Ø¥Ø±Ø³Ø§Ù„ âœ…</button>
      <button class="btn btn-ghost" onclick="closeSheet()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>`;
  document.body.appendChild(sheet);
  sheet.addEventListener('click',e=>{if(e.target===sheet)closeSheet();});
}

function switchMsgTab(t,btn){
  document.querySelectorAll('.msg-tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['sd-text','sd-voice','sd-rating'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  document.getElementById('sd-'+t).classList.remove('hidden');
}

function setRat(v){
  selRating=v;
  document.getElementById('ratVal').textContent=`${v} / 5`;
  document.querySelectorAll('#starsRow .star').forEach((s,i)=>{
    if(v>=i+1){s.textContent='â­';s.classList.add('on');}
    else{s.textContent='â˜†';s.classList.remove('on');}
  });
  document.querySelectorAll('.rat-btn').forEach(b=>{b.classList.toggle('active',parseFloat(b.textContent)===v);});
}

async function startAVR(){
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    avrChunks=[];avr=new MediaRecorder(stream);
    avr.ondataavailable=e=>{if(e.data.size>0)avrChunks.push(e.data);};
    avr.onstop=()=>{
      stream.getTracks().forEach(t=>t.stop());
      const blob=new Blob(avrChunks,{type:'audio/webm'});
      document.getElementById('vr-audio').src=URL.createObjectURL(blob);
      document.getElementById('vr-prev').classList.remove('hidden');
    };
    avr.start();
    document.getElementById('vr-start').classList.add('hidden');
    document.getElementById('vr-stop').classList.remove('hidden');
    document.getElementById('vr-timer').classList.add('show');
    const t0=Date.now();
    avrTimer=setInterval(()=>{
      const e=Math.floor((Date.now()-t0)/1000);
      document.getElementById('vr-timer').textContent=`${String(Math.floor(e/60)).padStart(2,'0')}:${String(e%60).padStart(2,'0')}`;
    },1000);
  }catch(e){alert("Ø®Ø·Ø£: "+e.message);}
}
function stopAVR(){
  if(avr&&avr.state!=='inactive'){avr.stop();clearInterval(avrTimer);}
  document.getElementById('vr-start').classList.remove('hidden');
  document.getElementById('vr-stop').classList.add('hidden');
  document.getElementById('vr-timer').classList.remove('show');
}
function closeSheet(){
  document.getElementById('msgSheet')?.remove();
  avrChunks=[];if(avr&&avr.state!=='inactive')avr.stop();clearInterval(avrTimer);selRating=0;
}

async function sendMsg(){
  const activeTab=document.querySelector('.msg-tab.active');
  let type='text';
  if(activeTab.textContent.includes('ØµÙˆØªÙŠØ©'))type='voice';
  else if(activeTab.textContent.includes('ØªÙ‚ÙŠÙŠÙ…'))type='rating';
  showLoader();
  try{
    if(type==='text'){
      const txt=document.getElementById('msgTxt').value.trim();
      if(!txt){hideLoader();alert('Ø§ÙƒØªØ¨ÙŠ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹!');return;}
      await doSendMsg(curPart.id,curRecForMsg,txt,'text',null,null);
    }else if(type==='voice'){
      if(!avrChunks.length){hideLoader();alert('Ø³Ø¬Ù‘Ù„ÙŠ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø£ÙˆÙ„Ø§Ù‹!');return;}
      const data=await b64(new Blob(avrChunks,{type:'audio/webm'}));
      await doSendMsg(curPart.id,curRecForMsg,'ğŸ¤ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©','voice',data,null);
    }else{
      if(!selRating){hideLoader();alert('Ø§Ø®ØªØ§Ø±ÙŠ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹!');return;}
      const snap=await window.dbGet(window.dbRef(window.db,'messages'));
      if(snap.exists()){
        const upd={};
        snap.forEach(c=>{const m=c.val();if(m.recordingId===curRecForMsg&&m.participantId===curPart.id&&m.messageType==='rating')upd[`messages/${c.key}`]=null;});
        if(Object.keys(upd).length)await window.dbUpdate(window.dbRef(window.db),upd);
      }
      await doSendMsg(curPart.id,curRecForMsg,`â­ ØªÙ‚ÙŠÙŠÙ…Ùƒ: ${selRating} / 5 Ù†Ø¬ÙˆÙ…`,'rating',null,selRating);
    }
    hideLoader();closeSheet();await calcTotal();await loadAdminRecs();showToast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„! âœ…');
  }catch(e){hideLoader();alert("Ø®Ø·Ø£: "+e.message);}
}

async function doSendMsg(pid,rid,msg,type,voice,rating){
  const r=window.dbPush(window.dbRef(window.db,'messages'));
  const obj={participantId:pid,recordingId:rid,message:msg,messageType:type,timestamp:new Date().toISOString(),read:false};
  if(voice)obj.voiceData=voice;
  if(rating)obj.rating=rating;
  await window.dbSet(r,obj);
}

// â•â•â•â•â•â•â•â•â•â•â•â• TOTAL RATING â•â•â•â•â•â•â•â•â•â•â•â•
async function calcTotal(){
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  let tot=0,cnt=0;const rs=new Set();
  if(snap.exists()){snap.forEach(c=>{const m=c.val();if(m.participantId===curPart.id&&m.messageType==='rating'&&m.rating&&!rs.has(m.recordingId)){tot+=m.rating;rs.add(m.recordingId);cnt++;}});}
  const b=document.getElementById('totalBadge');
  if(!cnt){b.style.display='none';return;}
  b.style.display='inline-flex';
  document.getElementById('totalVal').textContent=tot.toFixed(1);
  document.getElementById('totalMax').textContent=cnt*5;
}

// â•â•â•â•â•â•â•â•â•â•â•â• DELETE â•â•â•â•â•â•â•â•â•â•â•â•
function confirmDel(recId,adminMode){
  const ov=document.createElement('div');
  ov.className='overlay';
  ov.innerHTML=`<div class="confirm-box">
    <div class="confirm-icon">ğŸ—‘ï¸</div>
    <div class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</div>
    <div class="confirm-desc">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ù„Ù† ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</div>
    <div class="confirm-btns">
      <button class="btn btn-red" onclick="doDel('${recId}',${adminMode})">Ø­Ø°Ù</button>
      <button class="btn btn-ghost" onclick="this.closest('.overlay').remove()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click',e=>{if(e.target===ov)ov.remove();});
}

async function doDel(recId,adminMode){
  showLoader();
  const src=adminMode?curPart:user;
  const pid=adminMode?curPart.id:user.id;
  const recs=(src.recordings||[]).filter(r=>r.id!==recId);
  await window.dbUpdate(window.dbRef(window.db),{[`participants/${pid}/recordings`]:recs});
  const snap=await window.dbGet(window.dbRef(window.db,'messages'));
  if(snap.exists()){const upd={};snap.forEach(c=>{if(c.val().recordingId===recId)upd[`messages/${c.key}`]=null;});if(Object.keys(upd).length)await window.dbUpdate(window.dbRef(window.db),upd);}
  if(adminMode){curPart.recordings=recs;await calcTotal();await loadAdminRecs();}
  else{user.recordings=recs;loadMyRecs();loadUnreadBadge();}
  hideLoader();document.querySelector('.overlay')?.remove();showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù');
}

// â•â•â•â•â•â•â•â•â•â•â•â• CONTACT â•â•â•â•â•â•â•â•â•â•â•â•
function toggleContact(){
  const b=document.getElementById('contactBody');
  const t=document.getElementById('contactToggleBtn');
  if(b.style.display==='none'){b.style.display='block';t.textContent='Ø¥Ø®ÙØ§Ø¡';}
  else{b.style.display='none';t.textContent='Ø¹Ø±Ø¶';}
}
async function copyInfo(type,btn){
  const txt=type==='name'?curPart.name:curPart.password;
  try{
    await navigator.clipboard.writeText(txt);
    const orig=btn.innerHTML;btn.innerHTML='âœ… ØªÙ…';btn.classList.add('ok');
    setTimeout(()=>{btn.innerHTML=orig;btn.classList.remove('ok');},2000);
  }catch(e){alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®');}
}

// â•â•â•â•â•â•â•â•â•â•â•â• REGISTER TUTORIAL â•â•â•â•â•â•â•â•â•â•â•â•
const REG_TUT=[
  {
    title:'ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹! Ø³Ù†Ø³Ø§Ø¹Ø¯Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©',
    desc:'Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹ â€” Ø®Ø·ÙˆØªÙŠÙ† Ø¨Ø³ ÙˆØªØ®Ù„Øµ! Ø§Ù‚Ø±Ø¦ÙŠ Ø§Ù„Ø´Ø±Ø­ Ø£Ø¯Ù†Ø§Ù‡ Ù‚Ø¨Ù„ Ù…Ø§ ØªØ¨Ø¯Ø¦ÙŠ.',
    highlight:null
  },
  {
    title:'ğŸ“ Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„',
    desc:'Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ ÙƒÙ…Ø§ ØªØ¹Ø±ÙÙŠÙ†Ù‡ â€” Ù…Ø«Ù„Ø§Ù‹: "ÙØ§Ø·Ù…Ø© Ø£Ø­Ù…Ø¯". Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ø³ØªØ³ØªØ®Ø¯Ù…ÙŠÙ†Ù‡ Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ„ Ù…Ø±Ø©.',
    target:'#regNameGroup'
  },
  {
    title:'ğŸ” Ø§Ø®ØªØ§Ø±ÙŠ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø³Ù‡Ù„Ø©',
    desc:'Ø§Ø®ØªØ§Ø±ÙŠ Ø±Ù‚Ù… ØªØ­ÙØ¸ÙŠÙ†Ù‡ Ù…Ø«Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ù…ÙŠÙ„Ø§Ø¯Ùƒ. Ø§ÙƒØªØ¨ÙŠÙ‡ ÙÙŠ Ù…ÙƒØ§Ù† Ø¢Ù…Ù†.',
    target:'#regPassGroup'
  }
];
let regTutIdx=0;

function showRegTut(){
  document.getElementById('regTutBanner').style.display='block';
  renderRegTut();
}
function renderRegTut(){
  const s=REG_TUT[regTutIdx];
  document.getElementById('regTutTitle').textContent=s.title;
  document.getElementById('regTutDesc').textContent=s.desc;
  document.getElementById('regTutCounter').textContent=`${regTutIdx+1}/${REG_TUT.length}`;
  document.getElementById('regTutPrevBtn').style.display=regTutIdx>0?'block':'none';
  const nextBtn=document.getElementById('regTutNextBtn');
  nextBtn.textContent=regTutIdx===REG_TUT.length-1?'âœ… Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ³Ø¬ÙŠÙ„!':'ÙÙ‡Ù…Øª â–¶';
  // highlight target field
  document.querySelectorAll('.form-group').forEach(g=>{
    g.style.boxShadow='none';g.style.borderRadius='';g.style.transition='';
  });
  if(s.target){
    const el=document.querySelector(s.target);
    if(el){el.style.boxShadow='0 0 0 3px rgba(200,152,42,0.5)';el.style.borderRadius='12px';el.style.transition='box-shadow .3s';}
  }
}
function regTutNext(){
  if(regTutIdx<REG_TUT.length-1){regTutIdx++;renderRegTut();}
  else{document.getElementById('regTutBanner').style.display='none';document.querySelectorAll('.form-group').forEach(g=>g.style.boxShadow='none');document.getElementById('regName').focus();}
}
function regTutPrev(){if(regTutIdx>0){regTutIdx--;renderRegTut();}}

// â•â•â•â•â•â•â•â•â•â•â•â• SAVED CREDENTIALS â•â•â•â•â•â•â•â•â•â•â•â•
function saveCreds(name,pass){
  localStorage.setItem('savedCreds',JSON.stringify({name,pass,savedAt:new Date().toISOString()}));
}
function loadSavedCreds(){
  const s=localStorage.getItem('savedCreds');
  return s?JSON.parse(s):null;
}
function clearSavedCreds(){
  localStorage.removeItem('savedCreds');
  document.getElementById('savedCredsBanner').style.display='none';
  document.getElementById('loginName').value='';
  document.getElementById('loginPass').value='';
}
async function autoLogin(){
  const creds=loadSavedCreds();
  if(!creds)return;
  showLoader();
  const snap=await window.dbGet(window.dbRef(window.db,'participants'));
  hideLoader();
  if(snap.exists()){
    let found=null,fid=null;
    Object.entries(snap.val()).forEach(([id,p])=>{if(p.name===creds.name&&p.password===creds.pass){found=p;fid=id;}});
    if(found){user={id:fid,...found};saveSession();goParticipantPage();return;}
  }
  showErr('loginErr','Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù… ØªØ¹Ø¯ ØªØ¹Ù…Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹.');
  clearSavedCreds();
}
function checkSavedCreds(){
  const creds=loadSavedCreds();
  const banner=document.getElementById('savedCredsBanner');
  if(creds){
    banner.style.display='block';
    document.getElementById('savedCredsName').textContent=`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${creds.name}! ğŸ‘‹`;
    document.getElementById('loginName').value=creds.name;
    document.getElementById('loginPass').value=creds.pass;
  }else{
    banner.style.display='none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â• VIEWED â•â•â•â•â•â•â•â•â•â•â•â•
function loadViewed(){const s=localStorage.getItem('vr');if(s)viewedSet=new Set(JSON.parse(s));}
function saveViewed(){localStorage.setItem('vr',JSON.stringify([...viewedSet]));}
function markViewed(p,r){viewedSet.add(`${p}_${r}`);saveViewed();}
function isViewed(p,r){return viewedSet.has(`${p}_${r}`);}

// â•â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â•â•
function b64(blob){return new Promise((res,rej)=>{const fr=new FileReader();fr.onloadend=()=>res(fr.result);fr.onerror=rej;fr.readAsDataURL(blob);});}
function stars(r){let h='';for(let i=1;i<=5;i++){h+=r>=i?'â­':(r>i-1?'âœ¨':'â˜†');}return h;}

function showLoader(){
  if(document.getElementById('ldr'))return;
  const d=document.createElement('div');d.className='loader-overlay';d.id='ldr';
  d.innerHTML='<div class="loader-box"><div class="loader-spinner"></div><div class="loader-txt">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>';
  document.body.appendChild(d);
}
function hideLoader(){document.getElementById('ldr')?.remove();}

function showToast(msg){
  const t=document.createElement('div');
  t.style.cssText='position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--emerald);color:white;padding:10px 20px;border-radius:30px;font-weight:700;font-size:0.9rem;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.2);animation:slideUp .3s;';
  t.textContent=msg;document.body.appendChild(t);
  setTimeout(()=>t.remove(),2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â• SPOTLIGHT TUTORIAL SYSTEM â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let tutSteps=[],tutIdx=0,tutMode='';

const STEPS_PARTICIPANT=[
  {
    target:'#welcomeBanner',
    title:'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©! ğŸŒ™',
    desc:'Ù‡Ø°Ø§ Ø¨Ø§Ù†Ø± Ø§Ù„ØªØ±Ø­ÙŠØ¨. Ø§Ø³Ù…Ùƒ ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ØªØ¯Ø®Ù„ÙŠÙ†.',
    highlight:null,
    arrow:'arrow-bottom',pos:'below'
  },
  {
    target:'#participantTabs',
    title:'Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ğŸ“‚',
    desc:'ØªØ¨ÙˆÙŠØ¨ "ØªØ³Ø¬ÙŠÙ„" Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­ÙØ¸ÙƒØŒ ÙˆØªØ¨ÙˆÙŠØ¨ "Ø±Ø³Ø§Ø¦Ù„ÙŠ" Ù„Ø±Ø¤ÙŠØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ§Ø°Ø©.',
    highlight:'ğŸ”´ Ù†Ù‚Ø·Ø© Ø­Ù…Ø±Ø§Ø¡ ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ ÙˆØµÙˆÙ„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©',
    arrow:'arrow-bottom',pos:'below'
  },
  {
    target:'#typeGrid',
    title:'Ø§Ø®ØªØ§Ø±ÙŠ Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ¤',
    desc:'Ø§Ø®ØªØ§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ ÙÙ‚Ø·ØŒ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ Ù„ØªØ±Ù‰ Ù†ÙØ³Ùƒ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ„Ø§ÙˆØ©.',
    highlight:null,
    arrow:'arrow-top',pos:'below'
  },
  {
    target:'#startRecBtn',
    title:'Ø§Ø¨Ø¯Ø£ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„! ğŸ”´',
    desc:'Ø§Ø¶ØºØ·ÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„. Ø§Ø¶ØºØ·ÙŠ "Ø¥ÙŠÙ‚Ø§Ù" Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ØŒ Ø«Ù… "Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„".',
    highlight:'ğŸ’¡ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„Ù‡',
    arrow:'arrow-top',pos:'below'
  }
];

const STEPS_ADMIN=[
  {
    target:'#statsRow',
    title:'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ“Š',
    desc:'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†ØŒ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§ØªØŒ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ØªÙŠ Ù„Ù… ØªØ´Ø§Ù‡Ø¯ÙŠÙ‡Ø§.',
    highlight:null,
    arrow:'arrow-bottom',pos:'below'
  },
  {
    target:'#partGrid',
    title:'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ğŸ‘¥',
    desc:'ÙƒÙ„ Ù…Ø´Ø§Ø±Ùƒ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ù…Ø³ØªÙ‚Ù„Ø©. Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø£Ø­Ù…Ø± ÙŠØ¹Ù†ÙŠ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©.',
    highlight:'ğŸ”´ Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø£ÙŠ Ù…Ø´Ø§Ø±Ùƒ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ØªØ³Ø¬ÙŠÙ„Ø§ØªÙ‡',
    arrow:'arrow-top',pos:'below'
  }
];

const STEPS_ADMIN_REC=[
  {
    target:'#adminRecsList .rec-card:first-child .rec-media',
    title:'Ø§Ø³ØªÙ…Ø¹ÙŠ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ ğŸ§',
    desc:'Ø§Ø¶ØºØ·ÙŠ play Ù„ØªØ³Ù…Ø¹ÙŠ Ø£Ùˆ ØªØ´Ø§Ù‡Ø¯ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.',
    highlight:null,
    arrow:'arrow-bottom',pos:'below'
  },
  {
    target:'#adminRecsList .rec-card:first-child .rec-actions',
    title:'Ø£Ø±Ø³Ù„ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ ğŸ’¬',
    desc:'Ø§Ø®ØªØ§Ø±ÙŠ: Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©ØŒ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ©ØŒ Ø£Ùˆ ØªÙ‚ÙŠÙŠÙ… Ø¨Ø§Ù„Ù†Ø¬ÙˆÙ…. ØªØ¸Ù‡Ø± Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ø·Ø§Ù„Ø¨Ø© ØªØ­Øª ØªØ³Ø¬ÙŠÙ„Ù‡Ø§.',
    highlight:'â­ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙŠÙØ­ÙØ¸ ÙˆÙŠØ¬Ù…Ø¹ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ',
    arrow:'arrow-top',pos:'below'
  },
  {
    target:'#totalBadge',
    title:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª â­',
    desc:'ÙŠÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„ØªÙŠ Ù…Ù†Ø­ØªÙÙ‡Ø§ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§Ù„Ø¨Ø©.',
    highlight:null,
    arrow:'arrow-bottom',pos:'below'
  }
];

function startTutorial(mode){
  tutMode=mode;tutIdx=0;
  if(mode==='participant')tutSteps=STEPS_PARTICIPANT;
  else if(mode==='admin')tutSteps=STEPS_ADMIN;
  else if(mode==='admin-rec'){
    const fc=document.querySelector('#adminRecsList .rec-card');
    if(!fc){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±Ø­');return;}
    tutSteps=STEPS_ADMIN_REC;
  }
  const ov=document.getElementById('tutOverlay');
  ov.style.display='block';
  ov.classList.add('active');
  renderTutStep();
}

function renderTutStep(){
  const step=tutSteps[tutIdx];
  const total=tutSteps.length;

  // step info
  document.getElementById('tutStepNum').textContent=`Ø®Ø·ÙˆØ© ${tutIdx+1} Ù…Ù† ${total}`;
  document.getElementById('tutCardTitle').textContent=step.title;
  document.getElementById('tutCardDesc').textContent=step.desc;
  const hl=document.getElementById('tutHighlight');
  if(step.highlight){hl.style.display='block';hl.textContent=step.highlight;}
  else hl.style.display='none';

  // dots
  const dotsEl=document.getElementById('tutDots');
  dotsEl.innerHTML=tutSteps.map((_,i)=>`<div class="tut-dot ${i===tutIdx?'on':''}"></div>`).join('');

  // buttons
  document.getElementById('tutPrevBtn').style.display=tutIdx===0?'none':'flex';
  document.getElementById('tutNextBtn').textContent=tutIdx===total-1?'âœ… ÙÙ‡Ù…Øª!':'Ø§Ù„ØªØ§Ù„ÙŠ â–¶';

  // highlight target
  highlightTarget(step);
}

function highlightTarget(step){
  const overlay=document.getElementById('tutOverlay');
  const svg=document.getElementById('tutMaskSvg');
  const card=document.getElementById('tutCard');
  const pulse=document.getElementById('tutPulse');

  // remove old arrow class
  card.className='tut-card';

  let el=null;
  try{el=document.querySelector(step.target);}catch(e){}

  if(!el){
    // no target - center card, full dark overlay
    svg.innerHTML=`<rect width="100%" height="100%" fill="rgba(0,0,0,0.75)"/>`;
    card.classList.add('no-arrow');
    positionCardCenter(card);
    pulse.style.display='none';
    return;
  }

  // scroll element into view smoothly
  el.scrollIntoView({behavior:'smooth',block:'center'});

  // wait for scroll then draw
  setTimeout(()=>{
    const r=el.getBoundingClientRect();
    const vw=window.innerWidth;const vh=window.innerHeight;
    const pad=8;
    const rx=r.left-pad, ry=r.top-pad, rw=r.width+pad*2, rh=r.height+pad*2;
    const br=el.style.borderRadius||'12px';

    // SVG mask with rounded rect cutout
    svg.innerHTML=`
      <defs>
        <mask id="hm">
          <rect width="100%" height="100%" fill="white"/>
          <rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" rx="12" ry="12" fill="black"/>
        </mask>
      </defs>
      <rect width="100%" height="100%" fill="rgba(10,20,30,0.78)" mask="url(#hm)"/>
      <rect x="${rx}" y="${ry}" width="${rw}" height="${rh}" rx="12" ry="12"
            fill="none" stroke="#c8982a" stroke-width="2.5" opacity="0.9"/>
    `;

    // pulse ring
    pulse.style.cssText=`
      position:fixed;
      left:${rx-2}px;top:${ry-2}px;
      width:${rw+4}px;height:${rh+4}px;
      border-radius:14px;
      box-shadow:0 0 0 0 rgba(200,152,42,0.7);
      animation:tutPulse 1.5s infinite;
      pointer-events:none;z-index:7999;display:block;
    `;

    // position card
    const cardW=Math.min(300,vw-28);
    card.style.width=cardW+'px';

    const spaceBelow=vh-(r.bottom+pad);
    const spaceAbove=r.top-pad;
    let cardTop,cardLeft;

    if(spaceBelow>180){
      // place below
      cardTop=r.bottom+pad+16;
      card.classList.add(step.arrow||'arrow-top');
    }else{
      // place above
      cardTop=r.top-pad-16-200;// approx card height
      card.classList.add(step.arrow==='arrow-bottom'?'arrow-bottom':(step.arrow||'arrow-bottom'));
    }
    // horizontal: align to element center, clamp to screen
    cardLeft=r.left+(r.width/2)-(cardW/2);
    cardLeft=Math.max(14,Math.min(cardLeft,vw-cardW-14));
    cardTop=Math.max(70,Math.min(cardTop,vh-240));

    card.style.position='fixed';
    card.style.left=cardLeft+'px';
    card.style.top=cardTop+'px';
    card.style.right='auto';
    card.style.bottom='auto';
    // re-trigger animation
    card.style.animation='none';
    card.offsetHeight;
    card.style.animation='cardIn .4s .05s cubic-bezier(.34,1.56,.64,1) forwards';

  },150);
}

function positionCardCenter(card){
  const vw=window.innerWidth;const vh=window.innerHeight;
  const cardW=Math.min(300,vw-28);
  card.style.width=cardW+'px';
  card.style.position='fixed';
  card.style.left='50%';card.style.top='50%';
  card.style.transform='translate(-50%,-50%)';
  card.style.right='auto';card.style.bottom='auto';
  card.style.animation='none';card.offsetHeight;
  card.style.animation='cardIn .4s cubic-bezier(.34,1.56,.64,1) forwards';
}

function tutNext(){
  if(tutIdx<tutSteps.length-1){tutIdx++;renderTutStep();}else tutSkip();
}
function tutPrev(){if(tutIdx>0){tutIdx--;renderTutStep();}}
function tutSkip(){
  const ov=document.getElementById('tutOverlay');
  ov.classList.remove('active');
  ov.style.display='none';
  document.getElementById('tutMaskSvg').innerHTML='';
  document.getElementById('tutPulse').style.display='none';
  const card=document.getElementById('tutCard');
  card.style.transform='';
  card.style.animation='none';
}
</script>
</body>
</html>
